<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مرافق | Morafik</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        
        body { background-color: var(--light-bg); color: #333; overflow-x: hidden; min-height: 100vh; }

        /* Loader */
        #loadingScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top: 5px solid var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Inputs & Buttons */
        input, textarea, select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 0.95rem; margin-bottom: 15px; background: #fff; transition: 0.3s; }
        input:focus { border-color: var(--secondary-color); }
        .btn { padding: 12px 25px; background: var(--secondary-color); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn:hover { transform: translateY(-2px); }
        .btn-red { background: var(--accent-color); }

        /* Header */
        header { background: var(--glass); backdrop-filter: blur(10px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .logo { font-size: 24px; font-weight: 900; color: var(--secondary-color); display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; align-items: center; gap: 15px; }
        .nav-links button { background: transparent; border: none; font-size: 16px; cursor: pointer; color: #2c3e50; font-weight: 500; }
        .lang-btn { border: 2px solid var(--secondary-color) !important; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        
        .notif-icon { position: relative; font-size: 22px; cursor: pointer; margin: 0 10px; color: var(--primary-color); }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: var(--accent-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; justify-content: center; align-items: center; border: 2px solid white; }

        /* Hero Section - Centered */
        .hero-section { 
            position: relative; height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; color: white; overflow: hidden;
        }
        .hero-bg {
            position: absolute; inset: 0;
            background: url('https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
            z-index: -1; animation: heroZoom 20s infinite alternate;
        }
        @keyframes heroZoom { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
        .hero-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 0; }
        .hero-content { position: relative; z-index: 2; padding: 20px; max-width: 800px; }

        /* Dashboards & Sections */
        section { padding-top: 100px; min-height: 100vh; display: none; padding-bottom: 50px; }
        section.active { display: block; }
        .dashboard-content { padding: 0 5%; max-width: 1200px; margin: 0 auto; }
        
        .profile-card { background: white; padding: 30px; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); margin-bottom: 30px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 25px; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); border: 1px solid #eee; }
        .stat-box h3 { font-size: 2.2rem; color: var(--secondary-color); font-weight: 800; }
        
        .req-card { background: white; padding: 25px; border-radius: var(--radius); box-shadow: 0 4px 15px rgba(0,0,0,0.03); border-right: 5px solid var(--secondary-color); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; }

        /* Modals (Popups) */
        .modal { display: none; position: fixed; z-index: 2000; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); overflow-y: auto; }
        .modal.open { display: block; }
        .modal-content { background: #fff; margin: 5% auto; padding: 30px; width: 90%; max-width: 550px; border-radius: 24px; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close { float: left; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }

        /* Star Rating */
        .star-rating { display: flex; flex-direction: row-reverse; justify-content: center; gap: 10px; margin: 20px 0; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 30px; color: #ddd; cursor: pointer; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: gold; }

        /* Admin Table */
        .admin-table { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .admin-table td { padding: 15px; background: white; border: 1px solid #eee; }

        footer { background: var(--primary-color); color: white; padding: 60px 5%; margin-top: 60px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 40px; }
        footer li { margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 15px; }
            .hero-content h1 { font-size: 2.2rem !important; }
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loadingScreen"><div class="spinner"></div></div>

    <!-- Header -->
    <header>
        <div class="logo"><i class="fas fa-hands-helping"></i> <span data-i18n="logo">مرافق | Morafik</span></div>
        <div class="nav-links">
            <button onclick="changeLang()" class="lang-btn">FR / AR</button>
            <div id="notifWrapper" class="notif-icon" onclick="openModal('notifModal')" style="display:none;">
                <i class="fas fa-bell"></i>
                <span id="notifBadge" class="notif-badge" style="display:none;">0</span>
            </div>
            <button onclick="location.reload()" data-i18n="home">الرئيسية</button>
            <button onclick="openModal('loginModal')" id="navLogin" data-i18n="login">دخول</button>
            <button onclick="openModal('registerModal')" id="navReg" data-i18n="register">حساب جديد</button>
            <button onclick="logout()" id="navLogout" class="btn btn-red" style="display:none; font-size:14px;" data-i18n="logout">خروج</button>
        </div>
    </header>

    <!-- Hero Section -->
    <section id="hero" class="hero-section active">
        <div class="hero-bg"></div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 data-i18n="heroTitle" style="font-size:3.5rem; margin-bottom:20px; font-weight:800;">مرافقة ابنك بأمان</h1>
            <p data-i18n="heroSub" style="font-size: 1.5rem; margin-bottom: 35px; opacity: 0.9;">نربطك بأفضل المرافقين والأخصائيين النفسيين في الجزائر</p>
            <button class="btn" style="padding: 18px 50px; font-size: 1.2rem; border-radius: 50px;" onclick="openModal('registerModal')" data-i18n="startNow">ابدأ الآن</button>
        </div>
    </section>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2 style="text-align: center; margin-bottom: 30px;" data-i18n="loginTitle">تسجيل الدخول</h2>
            <input type="text" id="loginEmail" data-i18n-ph="emailPh" placeholder="البريد الإلكتروني">
            <input type="password" id="loginPass" data-i18n-ph="passPh" placeholder="كلمة المرور">
            <button class="btn" style="width: 100%;" onclick="handleLogin()" data-i18n="loginBtn">دخول</button>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <h2 style="text-align: center; margin-bottom: 25px;" data-i18n="regTitle">إنشاء حساب</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" style="flex:1; background:#eee; color:#333;" id="roleParent" onclick="setRole('parent')" data-i18n="roleParent">ولي</button>
                <button class="btn" style="flex:1; background:#eee; color:#333;" id="roleComp" onclick="setRole('companion')" data-i18n="roleComp">مرافق</button>
            </div>
            <input type="text" id="regName" placeholder="الاسم الكامل">
            <input type="email" id="regEmail" placeholder="البريد الإلكتروني">
            <input type="tel" id="regPhone" placeholder="رقم الهاتف">
            <select id="regWilaya"></select>
            <div id="compFields" style="display: none;">
                <select id="regSpec">
                    <option value="مرافق طفل التوحد" data-i18n="spec1">مرافق طفل التوحد</option>
                    <option value="أخصائي نفساني" data-i18n="spec2">أخصائي نفساني</option>
                </select>
            </div>
            <input type="password" id="regPass" placeholder="كلمة المرور">
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="handleRegister()" data-i18n="regBtn">تسجيل</button>
        </div>
    </div>

    <!-- Parent Dashboard -->
    <section id="parentDash">
        <div class="dashboard-content">
            <div class="profile-card">
                <div><h2 id="pName">User</h2><p data-i18n="roleParent">ولي طفل</p></div>
                <img id="pImg" src="https://via.placeholder.com/100" style="border-radius:50%; width:80px; height:80px; object-fit:cover; border:3px solid var(--secondary-color);">
            </div>
            <div style="background:white; padding:30px; border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:40px;">
                <h3 style="margin-bottom:20px;" data-i18n="searchTitle">بحث عن مرافق</h3>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <select id="searchSpec" style="flex:1"></select>
                    <select id="searchWilaya" style="flex:1"></select>
                    <button class="btn" onclick="searchCompanions()" data-i18n="searchBtn">بحث</button>
                </div>
            </div>
            <div id="searchResults"></div>
            <h3 style="margin-top:40px;" data-i18n="myRequests">طلباتي</h3>
            <div id="parentReqs"></div>
        </div>
    </section>

    <!-- Companion Dashboard -->
    <section id="companionDash">
        <div class="dashboard-content">
            <div class="profile-card">
                <div><h2 id="cName">User</h2><p id="cSpec" style="color:var(--secondary-color); font-weight:bold;"></p></div>
                <img id="cImg" src="https://via.placeholder.com/100" style="border-radius:50%; width:80px; height:80px; object-fit:cover; border:3px solid var(--secondary-color);">
            </div>
            <div class="stats-grid">
                <div class="stat-box"><h3 id="stTotal">0</h3><p data-i18n="totalReq">الطلبات</p></div>
                <div class="stat-box"><h3 id="stNew">0</h3><p data-i18n="newReq">جديدة</p></div>
                <div class="stat-box"><h3 id="stAcc">0</h3><p data-i18n="accReq">مقبولة</p></div>
            </div>
            <h3 data-i18n="incomingReq">الطلبات الواردة</h3>
            <div id="compReqs" style="margin-top:20px;"></div>
        </div>
    </section>

    <!-- Admin Dashboard -->
    <section id="adminDash">
        <div class="dashboard-content">
            <h2 style="margin-bottom:30px;">لوحة تحكم الأدمن</h2>
            <div class="stats-grid">
                <div class="stat-box"><h3 id="adUsers">0</h3><p>المستخدمين</p></div>
                <div class="stat-box"><h3 id="adReqsTotal">0</h3><p>الطلبات</p></div>
                <div class="stat-box"><h3 id="adMsgs">0</h3><p>رسائل</p></div>
            </div>
            <div id="adminMessagesList" style="margin-top:30px;"></div>
        </div>
    </section>

    <!-- Booking Modal (Kept from original) -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bookingModal')">&times;</span>
            <h3 data-i18n="bookTitle">حجز مرافق</h3>
            <input type="hidden" id="bookCompId">
            <input type="text" id="bkChildName" placeholder="اسم الطفل">
            <input type="number" id="bkChildAge" placeholder="السن">
            <select id="bkLevel">
                <option value="ابتدائي" data-i18n="prim">ابتدائي</option>
                <option value="متوسط" data-i18n="mid">متوسط</option>
                <option value="ثانوي" data-i18n="sec">ثانوي</option>
            </select>
            <button class="btn" style="width:100%" onclick="submitBooking()" data-i18n="confirmBook">تأكيد الحجز</button>
        </div>
    </div>

    <!-- Other Modals (Notifications, Rating, Report) - Kept from original -->
    <div id="notifModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('notifModal')">&times;</span>
            <h3 data-i18n="notifTitle">الإشعارات</h3>
            <div id="notifList" style="margin-top:15px;"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div>
            <h4 data-i18n="logo">مرافق | Morafik</h4>
            <p data-i18n="aboutDesc">منصة جزائرية لربط الأولياء بالمرافقين المدرسين.</p>
        </div>
        <div>
            <h4 data-i18n="contact">اتصل بنا</h4>
            <ul>
                <li><i class="fas fa-phone"></i> 0559293773</li>
                <li><i class="fas fa-map-marker-alt"></i> الرويبة، الجزائر العاصمة</li>
            </ul>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o", authDomain: "mourafik-e9161.firebaseapp.com", projectId: "mourafik-e9161", storageBucket: "mourafik-e9161.firebasestorage.app", messagingSenderId: "133465287328", appId: "1:133465287328:web:9de5b3bd709099d885b7c5" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const wilayasAr = ["01 أدرار","02 الشلف","03 الأغواط","04 أم البواقي","05 باتنة","06 بجاية","07 بسكرة","08 بشار","09 البليدة","10 البويرة","11 تمنراست","12 تبسة","13 تلمسان","14 تيارت","15 تيزي وزو","16 الجزائر","17 الجلفة","18 جيجل","19 سطيف","20 سعيدة","21 سكيكدة","22 سيدي بلعباس","23 عنابة","24 قالمة","25 قسنطينة","26 المدية","27 مستغانم","28 المسيلة","29 معسكر","30 ورقلة","31 وهران","32 البيض","33 إليزي","34 برج بوعريريج","35 بومرداس","36 الطارف","37 تندوف","38 تيسمسيلت","39 الوادي","40 خنشلة","41 سوق أهراس","42 تيبازة","43 ميلة","44 عين الدفلى","45 النعامة","46 عين تموشنت","47 غرداية","48 غليزان","49 تيميمون","50 برج باجي مختار","51 أولاد جلال","52 بني عباس","53 عين صالح","54 عين قزام","55 تقرت","56 جانت","57 المغير","58 المنيعة"];
        const wilayasFr = ["01 Adrar","02 Chlef","03 Laghouat","04 Oum El Bouaghi","05 Batna","06 Béjaïa","07 Biskra","08 Béchar","09 Blida","10 Bouira","11 Tamanrasset","12 Tébessa","13 Tlemcen","14 Tiaret","15 Tizi Ouzou","16 Alger","17 Djelfa","18 Jijel","19 Sétif","20 Saïda","21 Skikda","22 Sidi Bel Abbès","23 Annaba","24 Guelma","25 Constantine","26 Médéa","27 Mostaganem","28 M'Sila","29 Mascara","30 Ouargla","31 Oran","32 El Bayadh","33 Illizi","34 Bordj Bou Arréridj","35 Boumerdès","36 El Tarf","37 Tindouf","38 Tissemsilt","39 El Oued","40 Khenchela","41 Souk Ahras","42 Tipaza","43 Mila","44 Aïn Defla","45 Naâma","46 Aïn Témouchent","47 Ghardaïa","48 Relizane","49 Timimoun","50 Bordj Badji Mokhtar","51 Ouled Djellal","52 Béni Abbès","53 In Salah","54 In Guezzam","55 Touggourt","56 Djanet","57 El M'Ghair","58 El Meniaa"];

        const i18n = {
            ar: { 
                logo: "مرافق | Morafik", home: "الرئيسية", login: "دخول", register: "حساب جديد", logout: "خروج", heroTitle: "مرافقة ابنك بأمان", heroSub: "نربطك بأفضل المرافقين والأخصائيين النفسيين في الجزائر", startNow: "ابدأ الآن", loginTitle: "تسجيل الدخول", loginBtn: "دخول", regTitle: "إنشاء حساب", roleParent: "ولي طفل", roleComp: "مرافق", searchTitle: "بحث عن مرافق", searchBtn: "بحث", myRequests: "طلباتي", incomingReq: "الطلبات الواردة", bookTitle: "حجز مرافق", confirmBook: "تأكيد الحجز", notifTitle: "الإشعارات", contact: "اتصل بنا", aboutDesc: "منصة جزائرية لربط الأولياء بالمرافقين المدرسين.",
                spec1: "مرافق طفل التوحد", spec2: "أخصائي نفساني", emailPh: "البريد الإلكتروني", passPh: "كلمة المرور", wait: "في الانتظار...", prim:"ابتدائي", mid:"متوسط", sec:"ثانوي"
            },
            fr: { 
                logo: "Morafik | Algérie", home: "Accueil", login: "Connexion", register: "Inscription", logout: "Déconnexion", heroTitle: "Accompagner votre enfant en toute sécurité", heroSub: "Nous vous mettons en relation avec les meilleurs accompagnateurs en Algérie", startNow: "Commencer", loginTitle: "Se Connecter", loginBtn: "Connexion", regTitle: "Inscription", roleParent: "Parent", roleComp: "Accompagnateur", searchTitle: "Chercher un accompagnateur", searchBtn: "Chercher", myRequests: "Mes demandes", incomingReq: "Demandes reçues", bookTitle: "Réserver", confirmBook: "Confirmer", notifTitle: "Notifications", contact: "Contactez-nous", aboutDesc: "Plateforme algérienne pour l'accompagnement scolaire.",
                spec1: "Accompagnateur Autisme", spec2: "Psychologue", emailPh: "Email", passPh: "Mot de passe", wait: "En attente...", prim:"Primaire", mid:"CEM", sec:"Lycée"
            }
        };

        let curLang = 'ar';
        let currentUser = null;
        let selectedRole = 'parent';

        window.openModal = (id) => document.getElementById(id).classList.add('open');
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');

        window.changeLang = () => {
            curLang = curLang === 'ar' ? 'fr' : 'ar';
            document.dir = curLang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = i18n[curLang][el.getAttribute('data-i18n')]);
            document.querySelectorAll('[data-i18n-ph]').forEach(el => el.placeholder = i18n[curLang][el.getAttribute('data-i18n-ph')]);
            populateSelects();
        };

        function populateSelects() {
            const list = curLang === 'ar' ? wilayasAr : wilayasFr;
            ['regWilaya', 'searchWilaya'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.innerHTML = ''; list.forEach((w, i) => el.innerHTML += `<option value="${wilayasAr[i]}">${w}</option>`); }
            });
            const sSpec = document.getElementById('searchSpec');
            if(sSpec) { sSpec.innerHTML = `<option value="مرافق طفل التوحد">${i18n[curLang].spec1}</option><option value="أخصائي نفساني">${i18n[curLang].spec2}</option>`; }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    currentUser = snap.data();
                    document.getElementById('navLogin').style.display = 'none';
                    document.getElementById('navReg').style.display = 'none';
                    document.getElementById('navLogout').style.display = 'block';
                    document.getElementById('notifWrapper').style.display = 'block';
                    
                    // إخفاء الهيرو عند تسجيل الدخول
                    document.getElementById('hero').style.display = 'none';
                    
                    if(currentUser.role === 'parent') { router('parentDash'); initParent(); }
                    else if(currentUser.role === 'companion') { router('companionDash'); initComp(); }
                    else if(currentUser.email === 'admin@morafik.dz') { router('adminDash'); initAdmin(); }
                }
            } else {
                document.getElementById('hero').style.display = 'flex';
                document.getElementById('navLogin').style.display = 'block';
                document.getElementById('navReg').style.display = 'block';
                document.getElementById('navLogout').style.display = 'none';
            }
            document.getElementById('loadingScreen').style.display = 'none';
        });

        window.router = (id) => {
            document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            window.scrollTo(0,0);
        };

        window.setRole = (r) => {
            selectedRole = r;
            document.getElementById('roleParent').style.background = r === 'parent' ? 'var(--secondary-color)' : '#eee';
            document.getElementById('roleComp').style.background = r === 'companion' ? 'var(--secondary-color)' : '#eee';
            document.getElementById('compFields').style.display = r === 'companion' ? 'block' : 'none';
        };

        window.handleLogin = async () => {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
            try { await signInWithEmailAndPassword(auth, e, p); closeModal('loginModal'); } catch { Swal.fire('Error', 'Invalid login', 'error'); }
        };

        window.handleRegister = async () => {
            const e = document.getElementById('regEmail').value, p = document.getElementById('regPass').value, n = document.getElementById('regName').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                const data = { uid: cred.user.uid, fullName: n, email: e, phone: document.getElementById('regPhone').value, wilaya: document.getElementById('regWilaya').value, role: selectedRole, createdAt: serverTimestamp() };
                if(selectedRole === 'companion') data.specialty = document.getElementById('regSpec').value;
                await setDoc(doc(db, "users", cred.user.uid), data);
                closeModal('registerModal');
            } catch(err) { Swal.fire('Error', err.message, 'error'); }
        };

        window.logout = () => signOut(auth).then(()=>location.reload());

        // Basic Dashboard Logic (Restored)
        function initParent() {
            document.getElementById('pName').innerText = currentUser.fullName;
            loadParentReqs();
        }
        function initComp() {
            document.getElementById('cName').innerText = currentUser.fullName;
            document.getElementById('cSpec').innerText = currentUser.specialty;
            loadCompReqs();
        }

        window.searchCompanions = async () => {
            const s = document.getElementById('searchSpec').value, w = document.getElementById('searchWilaya').value;
            const res = document.getElementById('searchResults');
            res.innerHTML = 'Loading...';
            const q = query(collection(db, "users"), where("role", "==", "companion"), where("specialty", "==", s), where("wilaya", "==", w));
            const snap = await getDocs(q);
            let html = '';
            snap.forEach(d => {
                const u = d.data();
                html += `<div class="req-card"><div><strong>${u.fullName}</strong><br>${u.specialty}</div><button class="btn" onclick="openBookModal('${u.uid}')">${i18n[curLang].loginBtn}</button></div>`;
            });
            res.innerHTML = html || 'No results';
        };

        window.openBookModal = (id) => { document.getElementById('bookCompId').value = id; openModal('bookingModal'); };

        window.submitBooking = async () => {
            const cid = document.getElementById('bookCompId').value;
            await addDoc(collection(db, "requests"), { parentId: currentUser.uid, parentName: currentUser.fullName, companionId: cid, childName: document.getElementById('bkChildName').value, reqStatus: 'pending', timestamp: serverTimestamp() });
            closeModal('bookingModal');
            Swal.fire('Success', 'Request sent', 'success');
        };

        async function loadParentReqs() {
            const snap = await getDocs(query(collection(db, "requests"), where("parentId", "==", currentUser.uid)));
            let html = ''; snap.forEach(d => { const r = d.data(); html += `<div class="req-card"><div>${r.childName}</div><div>${r.reqStatus}</div></div>`; });
            document.getElementById('parentReqs').innerHTML = html;
        }

        async function loadCompReqs() {
            const snap = await getDocs(query(collection(db, "requests"), where("companionId", "==", currentUser.uid)));
            let html = '', count = 0; snap.forEach(d => { count++; const r = d.data(); html += `<div class="req-card"><div>${r.parentName}</div><div>${r.childName}</div></div>`; });
            document.getElementById('compReqs').innerHTML = html;
            document.getElementById('stTotal').innerText = count;
        }

        populateSelects();
        setTimeout(()=>document.getElementById('loadingScreen').style.display='none', 2000);
    </script>
</body>
</html>
