<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مرافق | Morafik</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f3f4f6;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        body { background-color: var(--light-bg); color: #333; overflow-x: hidden; min-height: 100vh; transition: 0.3s; }

        /* Loader */
        #loadingScreen { 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff; 
            z-index: 99999; /* Z-index عالي جداً */
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            transition: opacity 0.5s ease, visibility 0.5s; 
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top: 5px solid var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* General UI */
        .fade-in { animation: fadeIn 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        input, select, textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 0.95rem; margin-bottom: 15px; background: #fff; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1); }
        
        .btn { padding: 12px 25px; background: var(--secondary-color); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
        .btn:hover { background: #2980b9; transform: translateY(-2px); }
        .btn-red { background: var(--accent-color); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }
        .btn-red:hover { background: #c0392b; }

        /* Header */
        header { background: var(--glass); backdrop-filter: blur(10px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .logo { font-size: 24px; font-weight: 900; color: var(--secondary-color); display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; align-items: center; gap: 15px; }
        .nav-links button { background: transparent; border: none; font-size: 16px; cursor: pointer; color: #2c3e50; font-weight: 500; transition: 0.3s; }
        .nav-links button:hover { color: var(--secondary-color); }
        .lang-btn { border: 2px solid var(--secondary-color) !important; padding: 5px 15px; border-radius: 20px; font-weight: bold; }
        
        .notif-icon { position: relative; font-size: 22px; cursor: pointer; margin: 0 10px; color: var(--primary-color); }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: var(--accent-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; justify-content: center; align-items: center; border: 2px solid white; }

        /* Sections */
        section { padding-top: 100px; min-height: 100vh; display: none; padding-bottom: 50px; }
        
        .hero-section { 
            background: url('https://images.unsplash.com/photo-1544717305-2782549b5136?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80') center/cover;
            position: relative; display: flex; align-items: center; justify-content: center; text-align: center; color: white; 
        }
        .hero-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
        .hero-content { position: relative; z-index: 2; padding: 20px; max-width: 800px; }
        
        .dashboard-content { padding: 0 5%; max-width: 1200px; margin: 0 auto; }
        .profile-card { background: white; padding: 30px; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); margin-bottom: 30px; flex-wrap: wrap; gap: 20px; border: 1px solid #fff; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 25px; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); border: 1px solid #eee; }
        .stat-box h3 { font-size: 2.5rem; color: var(--secondary-color); margin: 0; font-weight: 800; }
        
        .req-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 15px rgba(0,0,0,0.03); border-right: 5px solid var(--secondary-color); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; animation: fadeIn 0.5s ease; }
        
        /* Modals */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 24px; animation: fadeIn 0.3s; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .close { float: left; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; transition: 0.3s; }
        .close:hover { color: var(--accent-color); }

        .edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        .file-upload-wrapper { border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .file-upload-wrapper:hover { border-color: var(--secondary-color); background: #f9fbfd; }

        /* Admin Specific Styles */
        .admin-section-title { font-size: 1.2rem; color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; margin: 30px 0 15px; }
        .admin-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
        .admin-table th, .admin-table td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: right; }
        .admin-table th { background: #f8f9fa; color: var(--secondary-color); font-weight: bold; }
        .msg-card { background: white; padding: 15px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 10px; }

        footer { background: var(--primary-color); color: white; padding: 60px 5%; margin-top: 60px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 40px; }
        footer li { margin-bottom: 12px; cursor: pointer; opacity: 0.8; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        footer li:hover { opacity: 1; padding-right: 5px; color: var(--secondary-color); }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 15px; padding: 15px; }
            .stats-grid { grid-template-columns: 1fr; }
            .edit-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .req-card { flex-direction: column; }
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:bold;">جاري التحميل... (Loading)</p>
    </div>

    <!-- Header -->
    <header>
        <div class="logo"><i class="fas fa-hands-helping"></i> <span data-i18n="logo">مرافق | Morafik</span></div>
        <div class="nav-links">
            <button onclick="changeLang()" class="lang-btn">FR / AR</button>
            <div id="notifWrapper" class="notif-icon" onclick="openNotifModal()" style="display:none;">
                <i class="fas fa-bell"></i>
                <span id="notifBadge" class="notif-badge" style="display:none;">0</span>
            </div>
            <button onclick="router('hero')" data-i18n="home">الرئيسية</button>
            <button onclick="router('login')" id="navLogin" data-i18n="login">دخول</button>
            <button onclick="router('register')" id="navReg" data-i18n="register">حساب جديد</button>
            <button onclick="logout()" id="navLogout" class="btn-red" style="display:none; font-size:14px;" data-i18n="logout">خروج</button>
        </div>
    </header>

    <!-- Hero -->
    <section id="hero" class="hero-section fade-in" style="display: flex;">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 data-i18n="heroTitle">مرافقة لطفل في المدرسة</h1>
            <p data-i18n="heroSub" style="font-size: 1.4rem; margin-bottom: 30px; opacity: 0.9;">نربطك بأفضل المرافقين والأخصائيين النفسيين</p>
            <button class="btn" style="padding: 15px 40px; font-size: 1.1rem;" onclick="router('register')" data-i18n="startNow">ابدأ الآن</button>
        </div>
    </section>

    <!-- Login -->
    <section id="login">
        <div class="modal-content" style="max-width: 400px; margin-top: 80px;">
            <h2 style="text-align: center; margin-bottom: 30px;" data-i18n="loginTitle">تسجيل الدخول</h2>
            <input type="text" id="loginEmail" data-i18n-ph="emailPh" placeholder="البريد الإلكتروني">
            <input type="password" id="loginPass" data-i18n-ph="passPh" placeholder="كلمة المرور">
            <button class="btn" style="width: 100%;" onclick="handleLogin()" data-i18n="loginBtn">دخول</button>
            <div style="text-align: center; margin-top: 20px;">
                <span data-i18n="noAccount">ليس لديك حساب؟</span> <a href="#" onclick="router('register')" style="color: var(--secondary-color); font-weight: bold;" data-i18n="createOne">إنشاء حساب</a>
            </div>
        </div>
    </section>

    <!-- Register -->
    <section id="register">
        <div class="modal-content" style="margin-top: 40px;">
            <h2 style="text-align: center; margin-bottom: 25px;" data-i18n="regTitle">إنشاء حساب</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" style="flex:1; background:#eee; color:#333;" id="roleParent" onclick="setRole('parent')" data-i18n="roleParent">ولي</button>
                <button class="btn" style="flex:1; background:#eee; color:#333;" id="roleComp" onclick="setRole('companion')" data-i18n="roleComp">مرافق</button>
            </div>
            
            <input type="text" id="regName" data-i18n-ph="namePh" placeholder="الاسم الكامل">
            <input type="email" id="regEmail" data-i18n-ph="emailPh" placeholder="البريد الإلكتروني">
            <input type="tel" id="regPhone" data-i18n-ph="phonePh" placeholder="رقم الهاتف">
            <select id="regWilaya"></select>

            <div id="compFields" style="display: none;">
                <select id="regSpec">
                    <option value="مرافق طفل التوحد" data-i18n="spec1">مرافق طفل التوحد</option>
                    <option value="أخصائي نفساني" data-i18n="spec2">أخصائي نفساني</option>
                </select>
                <div class="file-upload-wrapper">
                    <label data-i18n="certLabel">ارفع الشهادة (PDF)</label>
                    <input type="file" id="regDoc" accept="application/pdf" style="margin-top:10px;">
                </div>
            </div>

            <input type="password" id="regPass" data-i18n-ph="passPh" placeholder="كلمة المرور">
            <input type="password" id="regConfPass" data-i18n-ph="confPassPh" placeholder="تأكيد كلمة المرور">
            
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="handleRegister()" data-i18n="regBtn">تسجيل</button>
            <div style="text-align: center; margin-top: 20px;">
                <span data-i18n="haveAccount">لديك حساب بالفعل؟</span> <a href="#" onclick="router('login')" style="color: var(--secondary-color); font-weight: bold;" data-i18n="loginBtn">دخول</a>
            </div>
        </div>
    </section>

    <!-- Parent Dashboard -->
    <section id="parentDash">
        <div class="dashboard-content fade-in">
            <div class="profile-card">
                <div>
                    <h2 id="pName">User</h2>
                    <p data-i18n="roleParent" style="color:#666; margin-top:5px;">ولي طفل</p>
                    <button class="btn" style="margin-top:15px; font-size:0.9rem; padding: 8px 20px;" onclick="openEditModal()" data-i18n="editProfile">تعديل الملف <i class="fas fa-pen"></i></button>
                </div>
                <img id="pImg" src="https://via.placeholder.com/100" style="border-radius:50%; width:100px; height:100px; object-fit:cover; border:3px solid var(--secondary-color);">
            </div>

            <div style="background:white; padding:30px; border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:40px;">
                <h3 style="margin-bottom:20px; color:var(--primary-color);" data-i18n="searchTitle">بحث عن مرافق</h3>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <select id="searchSpec" style="flex:1; margin:0;">
                        <option value="مرافق طفل التوحد" data-i18n="spec1">مرافق طفل التوحد</option>
                        <option value="أخصائي نفساني" data-i18n="spec2">أخصائي نفساني</option>
                    </select>
                    <select id="searchWilaya" style="flex:1; margin:0;"></select>
                    <button class="btn" onclick="searchCompanions()" data-i18n="searchBtn">بحث</button>
                </div>
            </div>

            <div id="searchResults"></div>
            <h3 style="margin: 40px 0 20px;" data-i18n="myRequests">طلباتي</h3>
            <div id="parentReqs"></div>
        </div>
    </section>

    <!-- Companion Dashboard -->
    <section id="companionDash">
        <div class="dashboard-content fade-in">
            <div class="profile-card">
                <div>
                    <h2 id="cName">User</h2>
                    <p id="cSpec" style="color:var(--secondary-color); font-weight:bold; margin-top:5px;"></p>
                    <div style="margin-top:15px;">
                        <input type="checkbox" id="availToggle" onchange="toggleAvail()"> <label for="availToggle" data-i18n="available" style="font-weight:bold;">متاح للعمل</label>
                    </div>
                    <button class="btn" style="margin-top:15px; font-size:0.9rem; padding: 8px 20px;" onclick="openEditModal()" data-i18n="editProfile">تعديل الملف <i class="fas fa-pen"></i></button>
                </div>
                <img id="cImg" src="https://via.placeholder.com/100" style="border-radius:50%; width:100px; height:100px; object-fit:cover; border:3px solid var(--secondary-color);">
            </div>

            <div class="stats-grid">
                <div class="stat-box"><h3 id="stTotal">0</h3><p data-i18n="totalReq">الطلبات</p></div>
                <div class="stat-box"><h3 id="stNew">0</h3><p data-i18n="newReq">جديدة</p></div>
                <div class="stat-box"><h3 id="stAcc">0</h3><p data-i18n="accReq">مقبولة</p></div>
                <div class="stat-box"><h3><i class="fas fa-star" style="color:#f1c40f"></i></h3><p data-i18n="ratingScore">التقييم</p></div>
            </div>

            <h3 data-i18n="incomingReq" style="margin-bottom:20px;">الطلبات الواردة</h3>
            <div id="compReqs"></div>
        </div>
    </section>

    <!-- Admin Dashboard -->
    <section id="adminDash">
        <div class="dashboard-content">
            <h2 style="margin-bottom:30px;">لوحة تحكم الأدمن (Admin Dashboard)</h2>
            
            <!-- Admin Stats -->
            <div class="stats-grid">
                <div class="stat-box"><h3 id="adUsers">0</h3><p>المستخدمين (Users)</p></div>
                <div class="stat-box"><h3 id="adReqsTotal">0</h3><p>الطلبات (Total Requests)</p></div>
                <div class="stat-box"><h3 id="adReqsAcc" style="color:green">0</h3><p>مقبولة (Accepted)</p></div>
                <div class="stat-box"><h3 id="adMsgs">0</h3><p>رسائل/ابلاغات (Messages)</p></div>
            </div>

            <!-- Send Notification -->
            <div class="admin-section-title">إرسال إشعار (Send Notification)</div>
            <div style="background:white; padding:20px; border-radius:12px; box-shadow:var(--shadow); display:flex; gap:10px; flex-wrap:wrap;">
                <input type="text" id="adminNotifText" placeholder="نص الإشعار..." style="flex:2; margin:0;">
                <select id="adminNotifTarget" style="flex:1; margin:0;">
                    <option value="all">الكل (All)</option>
                    <option value="parent">أولياء (Parents)</option>
                    <option value="companion">مرافقين (Companions)</option>
                </select>
                <button class="btn" onclick="sendAdminNotif()">إرسال (Send)</button>
            </div>

            <!-- Messages/Reports -->
            <div class="admin-section-title">الرسائل والإبلاغات (Messages & Reports)</div>
            <div id="adminMessagesList" style="max-height:300px; overflow-y:auto; margin-bottom:30px;"></div>

            <!-- Transactions -->
            <div class="admin-section-title">سجل التعاملات (All Transactions)</div>
            <div style="overflow-x:auto; margin-bottom:30px;">
                <table class="admin-table" id="adminTransTable">
                    <thead><tr><th>التاريخ</th><th>الولي</th><th>المرافق</th><th>الطفل</th><th>الحالة</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <!-- Users List -->
            <div class="admin-section-title">قائمة المستخدمين (Users List)</div>
            <div style="overflow-x:auto;">
                <table class="admin-table" id="admTable">
                    <thead><tr><th>الاسم</th><th>الدور</th><th>الحالة</th><th>إجراء</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bookingModal')">&times;</span>
            <h3 style="margin-bottom:20px;" data-i18n="bookTitle">حجز مرافق</h3>
            <input type="hidden" id="bookCompId">
            <div class="edit-grid">
                <div><label data-i18n="childName">اسم الطفل</label><input type="text" id="bkChildName"></div>
                <div><label data-i18n="childAge">السن</label><input type="number" id="bkChildAge"></div>
                <div class="full-width">
                    <label data-i18n="eduLevel">المستوى الدراسي</label>
                    <select id="bkLevel">
                        <option value="ابتدائي" data-i18n="prim">ابتدائي</option>
                        <option value="متوسط" data-i18n="mid">متوسط</option>
                        <option value="ثانوي" data-i18n="sec">ثانوي</option>
                        <option value="مركز" data-i18n="center">مركز خاص</option>
                        <option value="لا يدرس" data-i18n="none">لا يدرس</option>
                    </select>
                </div>
                <div>
                    <label data-i18n="childStatus">حالة الطفل</label>
                    <select id="bkStatus">
                        <option value="عادي" data-i18n="norm">عادي</option>
                        <option value="طفل التوحد" data-i18n="aut">طفل التوحد</option>
                    </select>
                </div>
                <div>
                    <label data-i18n="followType">نوع المتابعة</label>
                    <select id="bkType">
                        <option value="مرافقة مستمرة" data-i18n="cont">مرافقة مستمرة</option>
                        <option value="حصص فقط" data-i18n="sess">حصص فقط</option>
                    </select>
                </div>
            </div>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="submitBooking()" data-i18n="confirmBook">تأكيد الحجز</button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('editModal')">&times;</span>
            <h3 style="margin-bottom:25px;" data-i18n="editTitle">تعديل الملف الشخصي</h3>
            <div class="edit-grid">
                <div class="full-width"><div class="section-title" data-i18n="personalInfo">المعلومات الشخصية</div></div>
                <div><label data-i18n="fullName">الاسم</label><input type="text" id="edName"></div>
                <div><label data-i18n="phone">الهاتف</label><input type="tel" id="edPhone"></div>
                <div class="full-width"><label data-i18n="wilaya">الولاية</label><select id="edWilaya"></select></div>
                <div class="full-width"><div class="section-title" data-i18n="securityDocs">الأمان والوثائق</div></div>
                <div class="file-upload-wrapper">
                    <i class="fas fa-camera" style="font-size:20px; margin-bottom:5px;"></i><br>
                    <label data-i18n="profilePic">تحديث الصورة</label>
                    <input type="file" id="edImg" accept="image/*" style="display:none;" onchange="alert(curLang=='ar'?'تم اختيار الصورة':'Image selected')">
                </div>
                <div id="compEditFields" class="file-upload-wrapper" style="display:none;">
                    <i class="fas fa-file-pdf" style="font-size:20px; margin-bottom:5px;"></i><br>
                    <label data-i18n="updateCert">تحديث الشهادة</label>
                    <input type="file" id="edCert" accept="application/pdf" style="display:none;" onchange="alert(curLang=='ar'?'تم اختيار الملف':'File selected')">
                </div>
                <div class="full-width"><label data-i18n="newPass">كلمة مرور جديدة (اختياري)</label><input type="password" id="edPass"></div>
            </div>
            <button class="btn" style="width:100%; margin-top:20px;" onclick="saveProfile()" data-i18n="saveChanges">حفظ التغييرات</button>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('ratingModal')">&times;</span>
            <h3 style="margin-bottom:20px;" data-i18n="rateTitle">تقييم الخدمة</h3>
            <input type="hidden" id="rateReqId">
            <label data-i18n="ratingScore">التقييم (1-5)</label>
            <select id="rtScore">
                <option value="5">⭐⭐⭐⭐⭐ (5)</option>
                <option value="4">⭐⭐⭐⭐ (4)</option>
                <option value="3">⭐⭐⭐ (3)</option>
                <option value="2">⭐⭐ (2)</option>
                <option value="1">⭐ (1)</option>
            </select>
            <label data-i18n="yourReview">رأيك (اختياري)</label>
            <textarea id="rtReview" rows="3"></textarea>
            <button class="btn" style="width:100%" onclick="submitRating()" data-i18n="submitRate">إرسال التقييم</button>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('notifModal')">&times;</span>
            <h3 data-i18n="notifTitle">الإشعارات</h3>
            <div id="notifList" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div>
            <h4 data-i18n="aboutUs">من نحن</h4>
            <p data-i18n="aboutDesc">منصة لربط الأولياء بالمرافقين.</p>
        </div>
        <div>
            <h4 data-i18n="impLinks">روابط هامة</h4>
            <ul>
                <li onclick="openReportModal('Privacy')" data-i18n="privacy"><i class="fas fa-shield-alt"></i> سياسة الخصوصية</li>
                <li onclick="openReportModal('Contact')" data-i18n="contact"><i class="fas fa-phone"></i> اتصل بنا</li>
                <li onclick="openReportModal('Report')" data-i18n="report"><i class="fas fa-exclamation-circle"></i> الابلاغ عن مشكل</li>
            </ul>
        </div>
    </footer>

    <!-- EMERGENCY LOADER REMOVER -->
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                var loader = document.getElementById('loadingScreen');
                if(loader) {
                    loader.style.opacity = '0';
                    loader.style.visibility = 'hidden';
                }
            }, 3000); // 3 seconds max wait
        });
    </script>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o",
            authDomain: "mourafik-e9161.firebaseapp.com",
            projectId: "mourafik-e9161",
            storageBucket: "mourafik-e9161.firebasestorage.app",
            messagingSenderId: "133465287328",
            appId: "1:133465287328:web:9de5b3bd709099d885b7c5",
            measurementId: "G-MDJXPZ7G5L"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Data & Translation ---
        const wilayasAr = [ "01 أدرار", "02 الشلف", "03 الأغواط", "04 أم البواقي", "05 باتنة", "06 بجاية", "07 بسكرة", "08 بشار", "09 البليدة", "10 البويرة", "11 تمنراست", "12 تبسة", "13 تلمسان", "14 تيارت", "15 تيزي وزو", "16 الجزائر", "17 الجلفة", "18 جيجل", "19 سطيف", "20 سعيدة", "21 سكيكدة", "22 سيدي بلعباس", "23 عنابة", "24 قالمة", "25 قسنطينة", "26 المدية", "27 مستغانم", "28 المسيلة", "29 معسكر", "30 ورقلة", "31 وهران", "32 البيض", "33 إليزي", "34 برج بوعريريج", "35 بومرداس", "36 الطارف", "37 تندوف", "38 تيسمسيلت", "39 الوادي", "40 خنشلة", "41 سوق أهراس", "42 تيبازة", "43 ميلة", "44 عين الدفلى", "45 النعامة", "46 عين تموشنت", "47 غرداية", "48 غليزان", "49 تيميمون", "50 برج باجي مختار", "51 أولاد جلال", "52 بني عباس", "53 عين صالح", "54 عين قزام", "55 تقرت", "56 جانت", "57 المغير", "58 المنيعة" ];
        const wilayasFr = [ "01 Adrar", "02 Chlef", "03 Laghouat", "04 Oum El Bouaghi", "05 Batna", "06 Béjaïa", "07 Biskra", "08 Béchar", "09 Blida", "10 Bouira", "11 Tamanrasset", "12 Tébessa", "13 Tlemcen", "14 Tiaret", "15 Tizi Ouzou", "16 Alger", "17 Djelfa", "18 Jijel", "19 Sétif", "20 Saïda", "21 Skikda", "22 Sidi Bel Abbès", "23 Annaba", "24 Guelma", "25 Constantine", "26 Médéa", "27 Mostaganem", "28 M'Sila", "29 Mascara", "30 Ouargla", "31 Oran", "32 El Bayadh", "33 Illizi", "34 Bordj Bou Arréridj", "35 Boumerdès", "36 El Tarf", "37 Tindouf", "38 Tissemsilt", "39 El Oued", "40 Khenchela", "41 Souk Ahras", "42 Tipaza", "43 Mila", "44 Aïn Defla", "45 Naâma", "46 Aïn Témouchent", "47 Ghardaïa", "48 Relizane", "49 Timimoun", "50 Bordj Badji Mokhtar", "51 Ouled Djellal", "52 Béni Abbès", "53 In Salah", "54 In Guezzam", "55 Touggourt", "56 Djanet", "57 El M'Ghair", "58 El Meniaa" ];

        const i18n = {
            ar: {
                logo: "مرافق | Morafik", home: "الرئيسية", login: "دخول", register: "حساب جديد", logout: "خروج",
                heroTitle: "مرافقة لطفل في المدرسة", heroSub: "نربطك بأفضل المرافقين والأخصائيين النفسيين", startNow: "ابدأ الآن",
                loginTitle: "تسجيل الدخول", loginBtn: "دخول", noAccount: "ليس لديك حساب؟", createOne: "إنشاء حساب",
                regTitle: "إنشاء حساب", roleParent: "ولي طفل", roleComp: "مرافق / أخصائي", regBtn: "تسجيل",
                haveAccount: "لديك حساب بالفعل؟", editProfile: "تعديل الملف", searchTitle: "بحث عن مرافق", searchBtn: "بحث",
                myRequests: "طلباتي", totalReq: "الطلبات", newReq: "جديدة", accReq: "مقبولة", incomingReq: "الطلبات الواردة",
                bookTitle: "حجز مرافق", childName: "اسم الطفل", childAge: "السن", eduLevel: "المستوى الدراسي",
                childStatus: "حالة الطفل", followType: "نوع المتابعة", confirmBook: "تأكيد الحجز",
                editTitle: "تعديل الملف الشخصي", personalInfo: "المعلومات الشخصية", securityDocs: "الأمان والوثائق",
                profilePic: "تحديث الصورة", fullName: "الاسم الكامل", phone: "رقم الهاتف",
                wilaya: "الولاية", updateCert: "تحديث الشهادة (PDF)", newPass: "كلمة مرور جديدة", saveChanges: "حفظ التغييرات",
                rateTitle: "تقييم الخدمة", ratingScore: "التقييم", yourReview: "رأيك", submitRate: "إرسال",
                notifTitle: "الإشعارات", aboutUs: "من نحن", aboutDesc: "منصة جزائرية للمرافقة المدرسية",
                impLinks: "روابط هامة", privacy: "سياسة الخصوصية", contact: "اتصل بنا", report: "الابلاغ عن مشكل",
                certLabel: "الشهادة (PDF)", available: "متاح للعمل", spec1: "مرافق طفل التوحد", spec2: "أخصائي نفساني",
                prim: "ابتدائي", mid: "متوسط", sec: "ثانوي", center: "مركز خاص", none: "لا يدرس",
                norm: "عادي", aut: "طفل التوحد", cont: "مرافقة مستمرة", sess: "حصص فقط",
                emailPh: "البريد الإلكتروني", passPh: "كلمة المرور", namePh: "الاسم الكامل", phonePh: "رقم الهاتف", confPassPh: "تأكيد كلمة المرور",
                wait: "في الانتظار...", acc: "مقبول", rej: "مرفوض", comp: "مكتمل", accept: "قبول", reject: "رفض", book: "حجز"
            },
            fr: {
                logo: "Morafik | Algérie", home: "Accueil", login: "Connexion", register: "Inscription", logout: "Déconnexion",
                heroTitle: "Accompagnement Scolaire", heroSub: "Trouvez le meilleur accompagnateur pour votre enfant", startNow: "Commencer",
                loginTitle: "Se connecter", loginBtn: "Connexion", noAccount: "Pas de compte?", createOne: "Créer un compte",
                regTitle: "Inscription", roleParent: "Parent", roleComp: "Accompagnateur", regBtn: "S'inscrire",
                haveAccount: "Déjà inscrit?", editProfile: "Modifier Profil", searchTitle: "Chercher un accompagnateur", searchBtn: "Chercher",
                myRequests: "Mes demandes", totalReq: "Total", newReq: "Nouveaux", accReq: "Acceptées", incomingReq: "Demandes reçues",
                bookTitle: "Réserver", childName: "Nom de l'enfant", childAge: "Âge", eduLevel: "Niveau scolaire",
                childStatus: "État de l'enfant", followType: "Type de suivi", confirmBook: "Confirmer",
                editTitle: "Modifier Profil", personalInfo: "Infos Personnelles", securityDocs: "Sécurité & Documents",
                profilePic: "Changer Photo", fullName: "Nom complet", phone: "Téléphone",
                wilaya: "Wilaya", updateCert: "Mise à jour Certificat", newPass: "Nouveau mot de passe", saveChanges: "Enregistrer",
                rateTitle: "Évaluer", ratingScore: "Note", yourReview: "Avis", submitRate: "Envoyer",
                notifTitle: "Notifications", aboutUs: "À propos", aboutDesc: "Plateforme d'accompagnement scolaire",
                impLinks: "Liens utiles", privacy: "Confidentialité", contact: "Contactez-nous", report: "Signaler un problème",
                certLabel: "Certificat (PDF)", available: "Disponible", spec1: "Accompagnateur Autisme", spec2: "Psychologue",
                prim: "Primaire", mid: "CEM", sec: "Lycée", center: "Centre spécialisé", none: "Pas scolarisé",
                norm: "Normal", aut: "Autiste", cont: "Continue", sess: "Séances",
                emailPh: "Email", passPh: "Mot de passe", namePh: "Nom complet", phonePh: "Numéro de téléphone", confPassPh: "Confirmer mot de passe",
                wait: "En attente...", acc: "Accepté", rej: "Refusé", comp: "Terminé", accept: "Accepter", reject: "Refuser", book: "Réserver"
            }
        };

        let curLang = 'ar';
        let currentUser = null;
        let selectedRole = 'parent';

        // --- Core Functions ---
        window.changeLang = () => {
            curLang = curLang === 'ar' ? 'fr' : 'ar';
            document.dir = curLang === 'ar' ? 'rtl' : 'ltr';
            
            // Text Elements
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const k = el.getAttribute('data-i18n');
                if(i18n[curLang][k]) el.innerText = i18n[curLang][k];
            });

            // Input Placeholders
            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const k = el.getAttribute('data-i18n-ph');
                if(i18n[curLang][k]) el.placeholder = i18n[curLang][k];
            });

            // Refresh Selects (Wilayas & Specs)
            window.populateSelects();
            // Re-render requests to translate status text
            if(currentUser && currentUser.role === 'parent') loadParentReqs();
            if(currentUser && currentUser.role === 'companion') loadCompReqs();
            if(document.getElementById('searchResults').innerHTML !== '') searchCompanions();
        };

        window.router = (route) => {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            const map = { 'hero':'hero', 'login':'login', 'register':'register', 'parent':'parentDash', 'companion':'companionDash', 'admin':'adminDash' };
            const el = document.getElementById(map[route] || 'hero');
            if(el) { el.style.display = (route === 'hero') ? 'flex' : 'block'; el.classList.remove('fade-in'); void el.offsetWidth; el.classList.add('fade-in'); }
        };

        window.populateSelects = () => {
            const list = curLang === 'ar' ? wilayasAr : wilayasFr;
            ['regWilaya', 'searchWilaya', 'edWilaya'].forEach(id => {
                const el = document.getElementById(id);
                if(el) {
                    const currentVal = el.value; 
                    el.innerHTML = '';
                    list.forEach((w, index) => {
                        const val = wilayasAr[index]; 
                        el.innerHTML += `<option value="${val}">${w}</option>`;
                    });
                    if(currentVal) el.value = currentVal;
                }
            });
            ['searchSpec', 'regSpec'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.options[0].text = i18n[curLang].spec1; el.options[1].text = i18n[curLang].spec2; }
            });
        };
        
        window.setRole = (r) => {
            selectedRole = r;
            document.getElementById('roleParent').style.background = r === 'parent' ? 'var(--secondary-color)' : '#eee';
            document.getElementById('roleParent').style.color = r === 'parent' ? '#fff' : '#333';
            document.getElementById('roleComp').style.background = r === 'companion' ? 'var(--secondary-color)' : '#eee';
            document.getElementById('roleComp').style.color = r === 'companion' ? '#fff' : '#333';
            document.getElementById('compFields').style.display = r === 'companion' ? 'block' : 'none';
        };

        window.openModal = (id) => document.getElementById(id).style.display = 'block';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        onAuthStateChanged(auth, async (user) => {
            const l = document.getElementById('loadingScreen');
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    currentUser = snap.data();
                    if(currentUser.isBlocked) { await signOut(auth); Swal.fire('Error','Account Blocked','error'); l.style.display = 'none'; return; }
                    document.getElementById('navLogin').style.display = 'none';
                    document.getElementById('navReg').style.display = 'none';
                    document.getElementById('navLogout').style.display = 'block';
                    document.getElementById('notifWrapper').style.display = 'block';
                    if(currentUser.role === 'parent') { initParent(); window.router('parent'); }
                    else if(currentUser.role === 'companion') { initComp(); window.router('companion'); }
                    else if(currentUser.email === 'admin' || user.email === 'admin@morafik.dz') { initAdmin(); window.router('admin'); }
                }
            } else {
                document.getElementById('navLogin').style.display = 'block';
                document.getElementById('navReg').style.display = 'block';
                document.getElementById('navLogout').style.display = 'none';
                document.getElementById('notifWrapper').style.display = 'none';
                if(document.getElementById('parentDash').style.display === 'block' || document.getElementById('companionDash').style.display === 'block') window.router('hero');
            }
            if(l) l.style.opacity = 0; // Handled by emergency script mostly, but this ensures it
        });

        window.handleLogin = async () => {
            const e = document.getElementById('loginEmail').value;
            const p = document.getElementById('loginPass').value;
            if(e === 'admin' && p === 'abobob123') { initAdmin(); window.router('admin'); return; }
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { Swal.fire(curLang=='ar'?'خطأ':'Error', curLang=='ar'?'بيانات غير صحيحة':'Invalid Credentials', 'error'); }
        };

        window.handleRegister = async () => {
            const e = document.getElementById('regEmail').value;
            const p = document.getElementById('regPass').value;
            if(p !== document.getElementById('regConfPass').value) return Swal.fire(curLang=='ar'?'خطأ':'Error', curLang=='ar'?'كلمات المرور غير متطابقة':'Passwords mismatch', 'error');
            try {
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                const data = {
                    uid: cred.user.uid,
                    fullName: document.getElementById('regName').value,
                    email: e,
                    phone: document.getElementById('regPhone').value,
                    wilaya: document.getElementById('regWilaya').value,
                    role: selectedRole,
                    isBlocked: false,
                    password_stored: p, 
                    createdAt: serverTimestamp()
                };
                if(selectedRole === 'companion') {
                    data.specialty = document.getElementById('regSpec').value;
                    data.isAvailable = true;
                }
                await setDoc(doc(db, "users", cred.user.uid), data);
                Swal.fire(curLang=='ar'?'تم':'Success', curLang=='ar'?'تم إنشاء الحساب':'Account Created', 'success');
            } catch(err) { Swal.fire('Error', err.message, 'error'); }
        };

        window.logout = () => signOut(auth).then(()=>location.reload());

        function initParent() {
            document.getElementById('pName').innerText = currentUser.fullName;
            document.getElementById('pImg').src = currentUser.photoURL || "https://via.placeholder.com/100";
            populateSelects();
            loadParentReqs();
            loadNotifications();
        }

        window.searchCompanions = async () => {
            const s = document.getElementById('searchSpec').value;
            const w = document.getElementById('searchWilaya').value;
            const res = document.getElementById('searchResults');
            res.innerHTML = '<p style="text-align:center">Loading...</p>';
            const q = query(collection(db, "users"), where("role", "==", "companion"), where("specialty", "==", s), where("wilaya", "==", w));
            const snap = await getDocs(q);
            res.innerHTML = '';
            if(snap.empty) { res.innerHTML = `<p style="text-align:center; padding:20px; color:#999;">${curLang=='ar'?'لا يوجد نتائج':'No results'}</p>`; return; }
            snap.forEach(d => {
                const u = d.data();
                if(u.isBlocked) return;
                const statusTxt = u.isAvailable ? (curLang=='ar'?'متاح':'Available') : (curLang=='ar'?'مشغول':'Busy');
                res.innerHTML += `
                    <div class="req-card">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <img src="${u.photoURL || 'https://via.placeholder.com/50'}" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">
                            <div><strong style="font-size:1.1rem;">${u.fullName}</strong><br><small style="color:#666;">${u.specialty}</small></div>
                        </div>
                        <div style="text-align:${curLang=='ar'?'left':'right'}">
                            <span style="color:${u.isAvailable?'green':'red'}; font-weight:bold;">● ${statusTxt}</span>
                            <br><button class="btn" style="margin-top:10px; padding:8px 20px;" onclick="openBookModal('${u.uid}')">${i18n[curLang].book}</button>
                        </div>
                    </div>`;
            });
        };

        window.openBookModal = (cid) => { document.getElementById('bookCompId').value = cid; openModal('bookingModal'); };

        window.submitBooking = async () => {
            const cid = document.getElementById('bookCompId').value;
            const data = {
                parentId: currentUser.uid,
                parentName: currentUser.fullName,
                companionId: cid, 
                childName: document.getElementById('bkChildName').value,
                age: document.getElementById('bkChildAge').value,
                level: document.getElementById('bkLevel').value,
                status: document.getElementById('bkStatus').value,
                type: document.getElementById('bkType').value,
                reqStatus: 'pending',
                timestamp: serverTimestamp()
            };
            if(!data.childName || !data.age) return Swal.fire('Error', curLang=='ar'?'املأ الحقول':'Fill fields', 'warning');
            await addDoc(collection(db, "requests"), data);
            await addDoc(collection(db, "notifications"), { targetId: cid, msg: `New request from ${currentUser.fullName}`, read: false, timestamp: serverTimestamp() });
            closeModal('bookingModal');
            Swal.fire(curLang=='ar'?'تم':'Done', curLang=='ar'?'تم الارسال':'Sent', 'success');
            loadParentReqs();
        };

        async function loadParentReqs() {
            const div = document.getElementById('parentReqs');
            const q = query(collection(db, "requests"), where("parentId", "==", currentUser.uid));
            const snap = await getDocs(q);
            div.innerHTML = '';
            let docs = [];
            snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
            docs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            
            if(docs.length === 0) { div.innerHTML = `<p style="text-align:center; color:#999">${curLang=='ar'?'لا يوجد طلبات':'No requests'}</p>`; return; }

            for (const r of docs) {
                const compSnap = await getDoc(doc(db, "users", r.companionId));
                const comp = compSnap.exists() ? compSnap.data() : {fullName:'Unknown', phone:'-'};
                
                let statusHTML = '';
                if(r.reqStatus === 'pending') statusHTML = `<span style="color:orange; font-weight:bold;">${i18n[curLang].wait}</span>`;
                else if(r.reqStatus === 'accepted') {
                    statusHTML = `<div style="background:#f0fff4; padding:15px; border-radius:12px; border:1px solid #c6f6d5;"><p style="color:green; font-weight:bold; margin-bottom:5px;">${i18n[curLang].acc}!</p><p>Phone: <strong>${comp.phone}</strong></p><hr style="margin:8px 0; border:0; border-top:1px solid #ddd;"><div style="display:flex; gap:10px; margin-top:5px;"><button class="btn" style="padding:5px 10px; font-size:12px;" onclick="openRateModal('${r.id}')">Rate</button></div></div>`;
                } else if(r.reqStatus === 'completed') {
                    statusHTML = `<span style="color:blue; font-weight:bold;">${i18n[curLang].comp} (${r.rating}⭐)</span>`;
                } else {
                    statusHTML = `<span style="color:red; font-weight:bold;">${i18n[curLang].rej}</span>`;
                }
                div.innerHTML += `<div class="req-card"><div class="req-details"><strong style="font-size:1.1rem;">To: ${comp.fullName}</strong><p>${r.childName}</p><small style="color:#888;">${r.timestamp ? r.timestamp.toDate().toLocaleDateString() : ''}</small></div><div style="width:100%; max-width:280px;">${statusHTML}</div></div>`;
            }
        }

        window.openRateModal = (rid) => { document.getElementById('rateReqId').value = rid; openModal('ratingModal'); };
        window.submitRating = async () => {
            const rid = document.getElementById('rateReqId').value;
            await updateDoc(doc(db, "requests", rid), { reqStatus: 'completed', rating: document.getElementById('rtScore').value, review: document.getElementById('rtReview').value });
            closeModal('ratingModal');
            Swal.fire(curLang=='ar'?'شكرا':'Thanks', '', 'success');
            loadParentReqs();
        };

        function initComp() {
            document.getElementById('cName').innerText = currentUser.fullName;
            document.getElementById('cSpec').innerText = currentUser.specialty;
            document.getElementById('cImg').src = currentUser.photoURL || "https://via.placeholder.com/100";
            document.getElementById('availToggle').checked = currentUser.isAvailable;
            loadCompReqs();
            loadNotifications();
        }

        window.toggleAvail = async () => { await updateDoc(doc(db, "users", currentUser.uid), { isAvailable: document.getElementById('availToggle').checked }); };

        async function loadCompReqs() {
            const div = document.getElementById('compReqs');
            const q = query(collection(db, "requests"), where("companionId", "==", currentUser.uid));
            const snap = await getDocs(q);
            div.innerHTML = '';
            let docs = [];
            snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
            docs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

            let total=0, fresh=0, acc=0, rateSum=0, rateCount=0;
            
            for(const r of docs) {
                total++;
                if(r.reqStatus === 'pending') fresh++;
                if(r.reqStatus === 'accepted' || r.reqStatus === 'completed') acc++;
                if(r.reqStatus === 'completed' && r.rating) { rateSum += parseInt(r.rating); rateCount++; }
                
                let phoneDisplay = '';
                if(r.reqStatus === 'accepted' || r.reqStatus === 'completed') {
                    const parentSnap = await getDoc(doc(db, "users", r.parentId));
                    const parentData = parentSnap.exists() ? parentSnap.data() : { phone: 'N/A' };
                    phoneDisplay = `<p style="margin-top:5px; color:var(--primary-color); font-weight:bold;">📞 ${parentData.phone}</p>`;
                }

                let actions = '';
                if(r.reqStatus === 'pending') {
                    actions = `<button class="btn" style="background:green; color:white; font-size:13px; margin-bottom:5px;" onclick="ansReq('${r.id}','accepted','${r.parentId}')">${i18n[curLang].accept}</button><button class="btn btn-red" style="font-size:13px;" onclick="ansReq('${r.id}','rejected','${r.parentId}')">${i18n[curLang].reject}</button>`;
                } else {
                    let stTxt = r.reqStatus;
                    if(stTxt=='accepted') stTxt = i18n[curLang].acc;
                    if(stTxt=='rejected') stTxt = i18n[curLang].rej;
                    if(stTxt=='completed') stTxt = i18n[curLang].comp;
                    actions = `<span style="font-weight:bold; color:${r.reqStatus=='rejected'?'red':'green'}">${stTxt}</span>`;
                }

                div.innerHTML += `
                    <div class="req-card">
                        <div class="req-details">
                            <strong>From: ${r.parentName}</strong>
                            <p>${r.childName} (${r.age})</p>
                            <p>${r.level} | ${r.status} | ${r.type}</p>
                            ${phoneDisplay}
                        </div>
                        <div class="req-actions" style="text-align:center;">${actions}</div>
                    </div>
                `;
            }
            
            document.getElementById('stTotal').innerText = total;
            document.getElementById('stNew').innerText = fresh;
            document.getElementById('stAcc').innerText = acc;
            let avg = rateCount > 0 ? (rateSum / rateCount).toFixed(1) : 0;
            document.querySelectorAll('[data-i18n="ratingScore"]').forEach(el => { el.innerHTML = (curLang=='ar'?'التقييم':'Note') + `<br><span style="font-size:1.5rem; color:#333;">${avg}/5</span>`; });
        }

        window.ansReq = async (rid, st, pid) => {
            await updateDoc(doc(db, "requests", rid), { reqStatus: st });
            await addDoc(collection(db, "notifications"), { targetId: pid, msg: `Your request was ${st}`, read: false, timestamp: serverTimestamp() });
            if(st === 'accepted') await addDoc(collection(db, "logs"), { text: `Success: ${currentUser.fullName} accepted request`, timestamp: serverTimestamp() });
            loadCompReqs();
        };

        // --- Notifications ---
        async function loadNotifications() {
            const q = query(collection(db, "notifications"), where("targetId", "==", currentUser.uid));
            const snap = await getDocs(q);
            const list = document.getElementById('notifList');
            const badge = document.getElementById('notifBadge');
            list.innerHTML = '';
            let docs = [];
            snap.forEach(d => docs.push(d.data()));
            docs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
            let unread = 0;
            docs.forEach(n => {
                if(!n.read) unread++;
                list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; background:${n.read?'#fff':'#f9f9f9'}">${n.msg} <br><small style="color:gray">${n.timestamp?n.timestamp.toDate().toLocaleTimeString():''}</small></div>`;
            });
            if(unread > 0) { badge.style.display = 'flex'; badge.innerText = unread; } else { badge.style.display = 'none'; }
        }

        window.openNotifModal = async () => { openModal('notifModal'); document.getElementById('notifBadge').style.display = 'none'; };

        // --- Footer Actions ---
        window.openReportModal = async (type) => {
            if(!currentUser) return Swal.fire('Error', 'Please Login first', 'warning');
            const { value: text } = await Swal.fire({
                title: type === 'Report' ? (curLang=='ar'?'ابلاغ':'Report') : (curLang=='ar'?'اتصل بنا':'Contact Us'),
                input: 'textarea',
                inputPlaceholder: curLang=='ar'?'اكتب رسالتك هنا...':'Write your message...',
                showCancelButton: true
            });
            if(text) {
                await addDoc(collection(db, "messages"), { type, text, from: currentUser.fullName, uid: currentUser.uid, timestamp: serverTimestamp() });
                Swal.fire(curLang=='ar'?'تم':'Sent', '', 'success');
            }
        };

        // --- Admin ---
        function initAdmin() {
            getDocs(collection(db, "users")).then(snap => document.getElementById('adUsers').innerText = snap.size);
            loadAdminStats();
            loadAdminMessages();
            loadAllTransactions();
            renderAdmin();
        }

        async function loadAdminStats() {
            const reqs = await getDocs(collection(db, "requests"));
            let total=0, acc=0;
            reqs.forEach(d => { total++; if(d.data().reqStatus === 'accepted' || d.data().reqStatus === 'completed') acc++; });
            document.getElementById('adReqsTotal').innerText = total;
            document.getElementById('adReqsAcc').innerText = acc;
            
            const msgs = await getDocs(collection(db, "messages"));
            document.getElementById('adMsgs').innerText = msgs.size;
        }

        async function loadAdminMessages() {
            const snap = await getDocs(query(collection(db, "messages"), orderBy("timestamp", "desc")));
            const div = document.getElementById('adminMessagesList');
            div.innerHTML = '';
            snap.forEach(d => {
                const m = d.data();
                div.innerHTML += `<div class="msg-card"><strong>${m.type}</strong> from ${m.from}<p>${m.text}</p><small>${m.timestamp?.toDate().toLocaleString()}</small></div>`;
            });
        }

        async function loadAllTransactions() {
            const snap = await getDocs(query(collection(db, "requests"), orderBy("timestamp", "desc")));
            const tb = document.querySelector('#adminTransTable tbody');
            tb.innerHTML = '';
            
            for(const d of snap.docs) {
                const r = d.data();
                const compSnap = await getDoc(doc(db, "users", r.companionId));
                const compName = compSnap.exists() ? compSnap.data().fullName : 'Unknown';
                tb.innerHTML += `<tr><td>${r.timestamp?.toDate().toLocaleDateString()}</td><td>${r.parentName}</td><td>${compName}</td><td>${r.childName}</td><td>${r.reqStatus}</td></tr>`;
            }
        }

        window.sendAdminNotif = async () => {
            const msg = document.getElementById('adminNotifText').value;
            const target = document.getElementById('adminNotifTarget').value;
            if(!msg) return;

            let q = collection(db, "users");
            if(target !== 'all') q = query(collection(db, "users"), where("role", "==", target));
            
            const users = await getDocs(q);
            const batch = [];
            users.forEach(u => {
                // In a real app we'd batch write, here we loop addDoc for simplicity
                addDoc(collection(db, "notifications"), { targetId: u.id, msg: `Admin: ${msg}`, read: false, timestamp: serverTimestamp() });
            });
            Swal.fire('Sent', `Sent to ${users.size} users`, 'success');
        };

        async function renderAdmin() {
            const tb = document.querySelector('#admTable tbody'); tb.innerHTML = '';
            const snap = await getDocs(collection(db, "users"));
            snap.forEach(d => {
                const u = d.data();
                tb.innerHTML += `<tr><td style="padding:10px;">${u.fullName}</td><td>${u.role}</td><td>${u.isBlocked?'Blocked':'Active'}</td><td><button onclick="toggleBlock('${d.id}',${u.isBlocked})">${u.isBlocked?'Unblock':'Block'}</button></td></tr>`;
            });
        }
        window.toggleBlock = async(id, st) => { await updateDoc(doc(db, "users", id), { isBlocked: !st }); renderAdmin(); };

        // --- Edit Profile ---
        window.openEditModal = () => {
            document.getElementById('edName').value = currentUser.fullName;
            document.getElementById('edPhone').value = currentUser.phone;
            populateSelects();
            document.getElementById('edWilaya').value = currentUser.wilaya;
            if(currentUser.role === 'companion') document.getElementById('compEditFields').style.display = 'block';
            openModal('editModal');
        };

        window.saveProfile = async () => {
            const name = document.getElementById('edName').value;
            const phone = document.getElementById('edPhone').value;
            const wilaya = document.getElementById('edWilaya').value;
            const pass = document.getElementById('edPass').value;
            const file = document.getElementById('edImg').files[0];
            
            let updates = { fullName: name, phone: phone, wilaya: wilaya };
            if(pass) { try { await updatePassword(auth.currentUser, pass); updates.password_stored = pass; } catch(e) { return Swal.fire('Error', 'Re-login required', 'error'); } }
            if(file) {
                const reader = new FileReader();
                reader.onload = async (e) => { updates.photoURL = e.target.result; await finishUpdate(updates); };
                reader.readAsDataURL(file);
                return;
            }
            await finishUpdate(updates);
        };

        async function finishUpdate(updates) {
            await updateDoc(doc(db, "users", currentUser.uid), updates);
            currentUser = { ...currentUser, ...updates };
            closeModal('editModal');
            Swal.fire(curLang=='ar'?'تم':'Updated', '', 'success');
            if(currentUser.role==='parent') initParent(); else initComp();
        }

        window.populateSelects();
    </script>
</body>
</html>
