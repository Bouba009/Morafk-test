<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø±Ø§ÙÙ‚ - Morafik</title>
    
    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-color: #1e293b;
            --accent-color: #10b981;
            --gold: #f59e0b;
            --bg-light: #f8fafc;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-light);
            overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
            opacity: 0; transition: opacity 0.5s ease;
        }
        body.loaded { opacity: 1; }
        html[lang="fr"] body { font-family: 'Roboto', sans-serif; }
        main { flex: 1; }

        /* Loader */
        #page-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Landing Page */
        .landing-hero {
            position: relative; min-height: 90vh;
            display: flex; align-items: center; justify-content: center;
            color: white; text-align: center; background-color: #1e293b;
        }
        .landing-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* ØµÙˆØ±Ø© Ø£Ø®ØµØ§Ø¦ÙŠØ© (Ø§Ù…Ø±Ø£Ø©) */
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1551834916-2419f773123c?auto=format&fit=crop&q=80&w=1000');
            background-size: cover; background-position: center top; z-index: 1;
            animation: zoomMove 20s infinite alternate ease-in-out;
        }
        @keyframes zoomMove { 0% { transform: scale(1); } 100% { transform: scale(1.15); } }
        .landing-content { position: relative; z-index: 2; padding: 20px; }
        .landing-content h1 { font-size: 2.5rem; font-weight: 900; text-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .btn-start {
            background: var(--accent-color); color: white; font-size: 1.3rem; padding: 12px 50px;
            border-radius: 50px; font-weight: bold; box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            transition: transform 0.3s; text-decoration: none; border: none;
        }
        .btn-start:hover { transform: scale(1.05); background: #059669; color: #fff; }

        /* UI Components */
        .custom-card {
            background: white; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .view-section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .view-section.active { display: block; opacity: 1; }
        .role-selector { cursor: pointer; border: 2px solid #e2e8f0; padding: 15px; border-radius: 12px; transition: all 0.2s; background: #fff; }
        .role-selector.active { border-color: var(--accent-color); background-color: #ecfdf5; }
        
        .form-label { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: #475569; }
        .profile-img-preview { width: 90px; height: 90px; object-fit: cover; border-radius: 50%; border: 3px solid var(--accent-color); }
        
        /* Stats Cards */
        .stat-box { padding: 20px; border-radius: 12px; color: white; position: relative; overflow: hidden; }
        .stat-box h3 { font-weight: 900; margin-bottom: 0; font-size: 2.5rem; }
        .stat-box span { font-size: 0.9rem; opacity: 0.9; }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); }
        .bg-gradient-danger { background: linear-gradient(45deg, #e74a3b, #be2617); }

        /* Mobile Table */
        @media (max-width: 768px) {
            .mobile-table thead { display: none; }
            .mobile-table tbody tr { display: block; background: white; margin-bottom: 15px; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
            .mobile-table td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border: none; border-bottom: 1px dashed #eee; }
            .mobile-table td:last-child { border-bottom: none; }
            .mobile-table td::before { content: attr(data-label); font-weight: bold; color: #64748b; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="page-loader">
        <div class="spinner"></div>
        <h5 class="fw-bold text-muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h5>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand bg-white shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-dark d-flex align-items-center" href="#" onclick="goHome()">
                <i class="bi bi-balloon-heart-fill text-success me-2 fs-4"></i> <span data-i18n="app_name">Ù…Ø±Ø§ÙÙ‚</span>
            </a>
            
            <div class="d-flex align-items-center gap-2">
                <div id="guestNav" class="d-flex gap-2">
                    <button class="btn btn-sm btn-link text-decoration-none text-dark fw-bold" onclick="goHome()" data-i18n="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    <button class="btn btn-sm btn-outline-primary rounded-pill fw-bold" onclick="goToLogin()" data-i18n="login">Ø¯Ø®ÙˆÙ„</button>
                </div>
                
                <button class="btn btn-sm fw-bold border-2 border-primary text-primary rounded-pill ms-2" onclick="toggleLanguage()" id="langSwitcher">FR</button>
                
                <!-- User Nav -->
                <div id="userNav" class="d-none d-flex align-items-center gap-2">
                    <!-- Notification Bell -->
                    <button class="btn btn-light btn-sm position-relative rounded-circle border" onclick="openNotifications()">
                        <i class="bi bi-bell-fill text-warning"></i>
                        <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle d-none"></span>
                    </button>
                    
                    <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="openEditProfileModal()">
                        <i class="bi bi-gear-fill"></i> <span class="d-none d-md-inline" data-i18n="settings">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
                    </button>
                    <span id="userInfo" class="text-secondary small fw-bold d-none d-md-block mx-2"></span>
                    <button class="btn btn-light btn-sm text-danger border fw-bold rounded-pill" onclick="logout()">
                        <i class="bi bi-box-arrow-left"></i> <span class="d-none d-md-inline" data-i18n="logout">Ø®Ø±ÙˆØ¬</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <!-- 0. LANDING VIEW -->
        <section id="landingView" class="view-section active">
            <div class="landing-hero">
                <div class="landing-bg"></div>
                <div class="landing-content container">
                    <h1 class="mb-3" data-i18n="welcome_title">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¹Ø§Ø¦Ù„Ø© Ù…Ø±Ø§ÙÙ‚</h1>
                    <p class="subtitle mb-5 text-white fs-4" data-i18n="slogan">Ø·ÙÙ„Ùƒ ÙÙŠ Ø£ÙŠØ§Ø¯ÙŠ Ø¢Ù…Ù†Ø© .. ÙˆÙ…Ø®ØªØµÙŠÙ† ØªØ«Ù‚ Ø¨Ù‡Ù…</p>
                    <button class="btn-start" onclick="startNow()" data-i18n="start_now">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† <i class="bi bi-arrow-left"></i></button>
                </div>
            </div>
        </section>

        <!-- 1. AUTH SCREEN -->
        <section id="authView" class="view-section">
            <div class="container py-5">
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-5">
                        <div class="custom-card p-4 shadow-lg">
                            <h3 class="text-center fw-bold mb-4" data-i18n="app_name">Ù…Ø±Ø§ÙÙ‚</h3>
                            <ul class="nav nav-pills mb-4 nav-justified p-1 bg-light rounded-pill">
                                <li class="nav-item"><button class="nav-link active rounded-pill" id="tab-login" data-bs-toggle="pill" data-bs-target="#login-content" data-i18n="login">Ø¯Ø®ÙˆÙ„</button></li>
                                <li class="nav-item"><button class="nav-link rounded-pill" id="tab-register" data-bs-toggle="pill" data-bs-target="#register-content" data-i18n="register">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button></li>
                            </ul>
                            
                            <div class="tab-content">
                                <!-- Login -->
                                <div class="tab-pane fade show active" id="login-content">
                                    <form id="loginForm">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="email_label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                            <input type="text" class="form-control" id="loginEmail" required data-i18n-placeholder="email_placeholder">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="pass_label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                            <input type="password" class="form-control" id="loginPass" required data-i18n-placeholder="password_placeholder">
                                        </div>
                                        <div class="text-end mb-4"><a href="#" class="text-decoration-none small text-muted" onclick="openForgotPassModal()" data-i18n="forgot_password">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a></div>
                                        <button type="submit" class="btn btn-primary w-100 py-2 rounded-3 fw-bold" data-i18n="login_btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
                                    </form>
                                    <div class="mt-3 text-center small text-muted">Ù„Ù„ØªØ¬Ø±Ø¨Ø© ÙƒÙ…Ø³Ø¤ÙˆÙ„: admin / abobob123</div>
                                </div>
                                <!-- Register -->
                                <div class="tab-pane fade" id="register-content">
                                    <form id="registerForm">
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <div class="role-selector text-center active" onclick="selectRole('parent', this)">
                                                    <i class="bi bi-person-fill fs-3 text-primary"></i> <div class="small fw-bold mt-1" data-i18n="role_parent">ÙˆÙ„ÙŠ Ø£Ù…Ø±</div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="role-selector text-center" onclick="selectRole('caregiver', this)">
                                                    <i class="bi bi-heart-pulse-fill fs-3 text-danger"></i> <div class="small fw-bold mt-1" data-i18n="role_caregiver">Ù…Ø±Ø§ÙÙ‚Ø© / Ù…Ø®ØªØµ</div>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" id="regRole" value="parent">
                                        <div class="mb-2">
                                            <label class="form-label" data-i18n="fullname">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                                            <input type="text" class="form-control" id="regName" data-i18n-placeholder="fullname" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label" data-i18n="email_label">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                                            <input type="email" class="form-control" id="regEmail" data-i18n-placeholder="email_placeholder" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label" data-i18n="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                                            <input type="tel" class="form-control" id="regPhone" data-i18n-placeholder="phone" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label" data-i18n="pass_label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                            <input type="password" class="form-control" id="regPass" data-i18n-placeholder="password_placeholder" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label" data-i18n="wilaya">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label>
                                            <select class="form-select dynamic-wilaya" id="regWilaya" required></select>
                                        </div>
                                        <div id="caregiverFields" class="d-none mt-3 p-3 bg-light rounded border">
                                            <div class="mb-2">
                                                <label class="form-label" data-i18n="service_type">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                                                <select class="form-select dynamic-service" id="regService"></select>
                                            </div>
                                            <div class="mb-0"><label class="small fw-bold" data-i18n="upload_cert">Ø±ÙØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (PDF)</label><input type="file" class="form-control" id="regCert" accept=".pdf"></div>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100 mt-3 py-2 fw-bold" data-i18n="create_account_btn">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. PARENT VIEW -->
        <section id="parentView" class="view-section">
            <div class="container py-4">
                <!-- Parent Simple Dashboard -->
                <div class="row g-3 mb-4">
                    <div class="col-4"><div class="stat-box bg-gradient-primary text-center"><h3><i class="bi bi-send"></i></h3><span id="pStatTotal">0</span> <span data-i18n="stat_total_req">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span></div></div>
                    <div class="col-4"><div class="stat-box bg-gradient-success text-center"><h3><i class="bi bi-check-circle"></i></h3><span id="pStatAccepted">0</span> <span data-i18n="stat_accepted">Ù…Ù‚Ø¨ÙˆÙ„Ø©</span></div></div>
                    <div class="col-4"><div class="stat-box bg-gradient-warning text-center"><h3><i class="bi bi-hourglass-split"></i></h3><span id="pStatPending">0</span> <span data-i18n="stat_new_req">Ø§Ù†ØªØ¸Ø§Ø±</span></div></div>
                </div>

                <h4 class="fw-bold text-primary mb-3"><i class="bi bi-search"></i> <span data-i18n="search_title">Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø®ØªØµ</span></h4>
                <div class="custom-card p-3 mb-4">
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <label class="form-label" data-i18n="wilaya">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label>
                            <select class="form-select dynamic-wilaya" id="searchWilaya"><option value="Ø§Ù„ÙƒÙ„" data-i18n="all_wilayas">ÙƒÙ„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª</option></select>
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label" data-i18n="service_type">Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                            <select class="form-select dynamic-service" id="searchService"><option value="Ø§Ù„ÙƒÙ„" data-i18n="all_services">ÙƒÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</option></select>
                        </div>
                        <div class="col-8 col-md-4">
                            <label class="form-label" data-i18n="child_age">Ø¹Ù…Ø± Ø§Ù„Ø·ÙÙ„</label>
                            <input type="number" class="form-control" id="searchAge">
                        </div>
                        <div class="col-4 col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100 fw-bold" onclick="performSearch()" data-i18n="search_btn">Ø¨Ø­Ø«</button>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-5" id="resultsArea"></div>
                <h5 class="fw-bold border-bottom pb-2 mb-3" data-i18n="my_requests">Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h5>
                <div class="custom-card p-0"><table class="table table-hover mb-0 mobile-table"><thead class="table-light"><tr><th data-i18n="th_caregiver">Ø§Ù„Ù…Ø®ØªØµ</th><th data-i18n="th_service">Ø§Ù„Ø·ÙÙ„</th><th data-i18n="th_status">Ø§Ù„Ø­Ø§Ù„Ø©</th><th data-i18n="th_action">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="myRequestsTable"></tbody></table></div>
            </div>
        </section>

        <!-- 3. CAREGIVER VIEW -->
        <section id="caregiverView" class="view-section">
            <div class="container py-4">
                <div class="custom-card p-3 mb-4 d-flex align-items-center bg-white border-start border-4 border-success">
                    <img id="dashboardProfileImg" src="" class="profile-img-preview me-3">
                    <div class="flex-grow-1">
                        <h5 class="mb-1 fw-bold" id="cgNameProfile"></h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="availabilityToggle" onchange="toggleAvailability()">
                            <label class="form-check-label fw-bold small" for="availabilityToggle" id="availabilityLabel" data-i18n="status_online">Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                        </div>
                    </div>
                </div>
                <!-- Caregiver Dashboard Stats -->
                <div class="row mb-4 g-3">
                    <div class="col-6 col-md-3"><div class="stat-box bg-gradient-primary text-center"><h3 id="cgStatTotal">0</h3><span data-i18n="stat_total_req">Ø§Ù„ÙƒÙ„</span></div></div>
                    <div class="col-6 col-md-3"><div class="stat-box bg-gradient-warning text-center"><h3 id="cgStatPending">0</h3><span data-i18n="stat_new_req">Ø§Ù†ØªØ¸Ø§Ø±</span></div></div>
                    <div class="col-6 col-md-3"><div class="stat-box bg-gradient-success text-center"><h3 id="cgStatAccepted">0</h3><span data-i18n="stat_accepted">Ù…Ù‚Ø¨ÙˆÙ„Ø©</span></div></div>
                    <div class="col-6 col-md-3"><div class="stat-box bg-gradient-danger text-center"><h3 id="cgStatRejected">0</h3><span data-i18n="stat_rejected">Ù…Ø±ÙÙˆØ¶Ø©</span></div></div>
                </div>
                <h5 class="fw-bold mb-3"><i class="bi bi-inbox-fill text-primary"></i> <span data-i18n="incoming_requests">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</span></h5>
                <div class="custom-card p-0"><table class="table mb-0 mobile-table align-middle"><thead class="table-light"><tr><th data-i18n="th_parent">Ø§Ù„ÙˆÙ„ÙŠ</th><th data-i18n="th_child">Ø§Ù„Ø·ÙÙ„</th><th data-i18n="th_details">Ø§Ù„ØªÙØ§ØµÙŠÙ„</th><th data-i18n="th_days">Ø§Ù„Ø£ÙŠØ§Ù…</th><th data-i18n="th_action">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody id="incomingRequestsTable"></tbody></table></div>
            </div>
        </section>
        
        <!-- 4. ADMIN VIEW (Full Control) -->
        <section id="adminView" class="view-section">
            <div class="container py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold text-primary mb-0">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… <span class="badge bg-danger fs-6">Admin</span></h3>
                    <button class="btn btn-dark btn-sm rounded-pill" onclick="openSendNotifModal()"><i class="bi bi-megaphone-fill"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</button>
                </div>

                <!-- Admin Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3"><div class="stat-box bg-gradient-primary"><h3><i class="bi bi-people"></i> <span id="statTotalUsers" class="float-end">0</span></h3><span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span></div></div>
                    <div class="col-md-3"><div class="stat-box bg-gradient-success"><h3><i class="bi bi-heart-pulse"></i> <span id="statCaregivers" class="float-end">0</span></h3><span>Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø§Øª</span></div></div>
                    <div class="col-md-3"><div class="stat-box bg-gradient-warning"><h3><i class="bi bi-chat-right-text"></i> <span id="statReportsCount" class="float-end">0</span></h3><span>Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰</span></div></div>
                    <div class="col-md-3"><div class="stat-box bg-gradient-danger"><h3><i class="bi bi-check2-all"></i> <span id="statSuccessOps" class="float-end">0</span></h3><span>Ø¹Ù…Ù„ÙŠØ§Øª Ù†Ø§Ø¬Ø­Ø©</span></div></div>
                </div>

                <div class="row g-4 mb-4">
                    <!-- Top Caregivers -->
                    <div class="col-lg-5">
                        <div class="custom-card h-100 p-4">
                            <h5 class="fw-bold mb-3 text-success"><i class="bi bi-trophy-fill"></i> Ø£Ù†Ø¬Ø­ Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø§Øª</h5>
                            <table class="table table-borderless align-middle mb-0"><tbody id="adminTopCaregivers"></tbody></table>
                        </div>
                    </div>
                    <!-- Transactions -->
                    <div class="col-lg-7">
                        <div class="custom-card h-100 p-4">
                            <h5 class="fw-bold mb-3 text-primary"><i class="bi bi-graph-up-arrow"></i> Ø§Ù„ØªØ¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h5>
                            <div class="table-responsive"><table class="table table-sm table-hover align-middle"><thead class="table-light"><tr><th>Ø§Ù„ÙˆÙ„ÙŠ</th><th>Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody id="adminDailyTrans"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <!-- User Management -->
                <div class="custom-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0"><i class="bi bi-people-fill"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h5>
                        <input type="text" class="form-control w-50" id="adminSearch" placeholder="Ø¨Ø­Ø«..." onkeyup="loadAdminDashboard()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle table-bordered">
                            <thead class="table-light"><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Email</th><th class="text-danger">Pass</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody id="adminUsersTable"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Reports -->
                <div class="custom-card p-4 mb-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-envelope-exclamation-fill"></i> Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„</h5>
                    <div class="table-responsive"><table class="table table-striped table-sm"><thead class="table-dark"><tr><th>Ø§Ù„Ù…Ø±Ø³Ù„</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø±Ø³Ø§Ù„Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody id="adminReportsTable"></tbody></table></div>
                </div>
            </div>
        </section>
    </main>

    <!-- ================= MODALS ================= -->
    
    <!-- Request Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" data-i18n="request_service">ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø®Ø¯Ù…Ø©</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sendRequestForm">
                        <input type="hidden" id="targetCaregiverId">
                        <div class="mb-3"><label class="form-label" data-i18n="child_name">Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</label><input type="text" class="form-control" id="reqChildName" required></div>
                        <div class="row">
                            <div class="col-6 mb-3"><label class="form-label" data-i18n="child_age">Ø§Ù„Ø¹Ù…Ø±</label><input type="number" class="form-control" id="reqChildAge" required></div>
                            <div class="col-6 mb-3">
                                <label class="form-label" data-i18n="school_level">Ø§Ù„Ø·ÙˆØ± Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label>
                                <select class="form-select" id="reqSchoolLevel" required>
                                    <option value="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ" data-i18n="lvl_primary">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                                    <option value="Ù…ØªÙˆØ³Ø·" data-i18n="lvl_middle">Ù…ØªÙˆØ³Ø·</option>
                                    <option value="Ø«Ø§Ù†ÙˆÙŠ" data-i18n="lvl_secondary">Ø«Ø§Ù†ÙˆÙŠ</option>
                                    <option value="ØºÙŠØ± Ù…ØªÙ…Ø¯Ø±Ø³" data-i18n="lvl_none">ØºÙŠØ± Ù…ØªÙ…Ø¯Ø±Ø³</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="child_condition">Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙÙ„</label>
                            <select class="form-select" id="reqChildCondition" required>
                                <option value="Ø¹Ø§Ø¯ÙŠ" data-i18n="cond_normal">Ø¹Ø§Ø¯ÙŠ</option>
                                <option value="Ø·ÙŠÙ ØªÙˆØ­Ø¯" data-i18n="cond_autism">Ø·ÙŠÙ ØªÙˆØ­Ø¯</option>
                                <option value="ØªØ£Ø®Ø± Ù†Ø·Ù‚" data-i18n="cond_speech">ØªØ£Ø®Ø± Ù†Ø·Ù‚</option>
                                <option value="ÙØ±Ø· Ø­Ø±ÙƒØ©" data-i18n="cond_adhd">ÙØ±Ø· Ø­Ø±ÙƒØ©</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="duration">Ø§Ù„Ù…Ø¯Ø©</label>
                            <select class="form-select" id="reqDuration">
                                <option value="Ø¬Ù„Ø³Ø©" data-i18n="dur_session">Ø¬Ù„Ø³Ø© ÙˆØ§Ø­Ø¯Ø©</option>
                                <option value="Ø´Ù‡Ø±" data-i18n="1_month">Ø´Ù‡Ø±</option>
                                <option value="ÙØµÙ„ Ø¯Ø±Ø§Ø³ÙŠ" data-i18n="dur_term">ÙØµÙ„ Ø¯Ø±Ø§Ø³ÙŠ</option>
                                <option value="Ø³Ù†Ø© Ø¯Ø±Ø§Ø³ÙŠØ©" data-i18n="dur_year">Ø·ÙŠÙ„Ø© Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</option>
                            </select>
                        </div>
                        <div class="mb-3"><label class="form-label" data-i18n="days">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø©</label><input type="text" class="form-control" id="reqDays" required placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø£Ø­Ø¯ØŒ Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡..."></div>
                        <button type="submit" class="btn btn-primary w-100 fw-bold" data-i18n="confirm_send">ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" data-i18n="edit_profile">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="text-center mb-3">
                            <div class="position-relative d-inline-block">
                                <img id="editImgPreview" src="" class="profile-img-preview">
                                <label for="editProfilePic" class="position-absolute bottom-0 start-0 bg-primary text-white p-1 rounded-circle" style="cursor: pointer;"><i class="bi bi-camera-fill small"></i></label>
                            </div>
                            <input type="file" id="editProfilePic" class="d-none" accept="image/*">
                        </div>
                        <div class="mb-3"><label class="form-label" data-i18n="fullname">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" class="form-control" id="editName" required></div>
                        <div class="mb-3"><label class="form-label" data-i18n="phone">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" class="form-control" id="editPhone" required></div>
                        <div class="mb-3"><label class="form-label" data-i18n="wilaya">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label><select class="form-select dynamic-wilaya" id="editWilaya" required></select></div>
                        <div class="bg-light p-3 rounded mb-3 border">
                            <h6 class="text-danger small fw-bold mb-2" data-i18n="change_pass">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h6>
                            <input type="text" class="form-control form-control-sm" id="editNewPass">
                        </div>
                        <div id="caregiverEditFields" class="d-none pt-2">
                            <h6 class="text-primary fw-bold mb-2" data-i18n="pro_info">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù†ÙŠØ©</h6>
                            <div class="mb-2"><select class="form-select dynamic-service" id="editService"></select></div>
                        </div>
                        <button type="submit" class="btn btn-success w-100 fw-bold mt-2" data-i18n="save">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal fade" id="notifModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="notifList" class="list-group list-group-flush">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Send Notification Modal -->
    <div class="modal fade" id="adminSendNotifModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø§Ù…</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form onsubmit="sendAdminNotification(event)">
                        <div class="mb-3">
                            <label class="form-label">Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©</label>
                            <select class="form-select" id="notifTarget">
                                <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
                                <option value="parent">Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</option>
                                <option value="caregiver">Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø§Øª/Ø§Ù„Ù…Ø®ØªØµÙŠÙ†</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</label>
                            <textarea class="form-control" id="notifMsg" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ø³Ù… (ÙØ±ÙŠÙ‚ Ù…Ø±Ø§ÙÙ‚)</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            setTimeout(() => { document.getElementById('page-loader').style.display = 'none'; document.body.classList.add('loaded'); }, 800);

            // --- DATA ---
            const wilayas = [
                {id:1,ar:"Ø£Ø¯Ø±Ø§Ø±",fr:"Adrar"},{id:16,ar:"Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±",fr:"Alger"},{id:31,ar:"ÙˆÙ‡Ø±Ø§Ù†",fr:"Oran"},{id:25,ar:"Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©",fr:"Constantine"},
                {id:19,ar:"Ø³Ø·ÙŠÙ",fr:"SÃ©tif"},{id:23,ar:"Ø¹Ù†Ø§Ø¨Ø©",fr:"Annaba"},{id:30,ar:"ÙˆØ±Ù‚Ù„Ø©",fr:"Ouargla"},{id:8,ar:"Ø¨Ø´Ø§Ø±",fr:"BÃ©char"}
            ];

            const services = [
                {code:"srv_psych",ar:"Ø§Ø³ØªØ´Ø§Ø±Ø© (Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ)",fr:"Consultation (Psychologue)"},
                {code:"srv_autism",ar:"Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯",fr:"Accompagnateur enfant autiste"},
                {code:"srv_speech",ar:"Ø£Ø±Ø·ÙˆÙÙˆÙ†ÙŠØ§ (ØªØµØ­ÙŠØ­ Ø§Ù„Ù†Ø·Ù‚)",fr:"Orthophoniste"},
                {code:"srv_nurse",ar:"Ù…Ù…Ø±Ø¶ Ù…Ù†Ø²Ù„ÙŠ",fr:"Infirmier Ã  domicile"}
            ];

            const translations = {
                ar: {
                    app_name:"Ù…Ø±Ø§ÙÙ‚", home:"Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", login:"Ø¯Ø®ÙˆÙ„", register:"Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", start_now:"Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†",
                    welcome_title:"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¹Ø§Ø¦Ù„Ø© Ù…Ø±Ø§ÙÙ‚", slogan:"Ø·ÙÙ„Ùƒ ÙÙŠ Ø£ÙŠØ§Ø¯ÙŠ Ø¢Ù…Ù†Ø©",
                    role_parent:"ÙˆÙ„ÙŠ Ø£Ù…Ø±", role_caregiver:"Ù…Ø±Ø§ÙÙ‚Ø© / Ù…Ø®ØªØµ",
                    email_label:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", email_placeholder:"Ù…Ø«Ø§Ù„: user@mail.com",
                    pass_label:"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", password_placeholder:"******",
                    fullname:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", phone:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", wilaya:"Ø§Ù„ÙˆÙ„Ø§ÙŠØ©",
                    search_title:"Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø®ØªØµ", all_wilayas:"ÙƒÙ„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª", all_services:"ÙƒÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª",
                    search_btn:"Ø¨Ø­Ø«", service_type:"Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©",
                    child_age:"Ø¹Ù…Ø± Ø§Ù„Ø·ÙÙ„", child_name:"Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„", school_level:"Ø§Ù„Ø·ÙˆØ± Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ",
                    lvl_primary:"Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", lvl_middle:"Ù…ØªÙˆØ³Ø·", lvl_secondary:"Ø«Ø§Ù†ÙˆÙŠ", lvl_none:"ØºÙŠØ± Ù…ØªÙ…Ø¯Ø±Ø³",
                    child_condition:"Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙÙ„", cond_normal:"Ø¹Ø§Ø¯ÙŠ", cond_autism:"Ø·ÙŠÙ ØªÙˆØ­Ø¯", cond_speech:"ØªØ£Ø®Ø± Ù†Ø·Ù‚", cond_adhd:"ÙØ±Ø· Ø­Ø±ÙƒØ©",
                    duration:"Ø§Ù„Ù…Ø¯Ø©", dur_session:"Ø¬Ù„Ø³Ø© ÙˆØ§Ø­Ø¯Ø©", dur_term:"ÙØµÙ„ Ø¯Ø±Ø§Ø³ÙŠ", dur_year:"Ø³Ù†Ø© Ø¯Ø±Ø§Ø³ÙŠØ©", "1_month":"Ø´Ù‡Ø±",
                    days:"Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø©", confirm_send:"ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„",
                    edit_profile:"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„", save:"Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª", change_pass:"ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", pro_info:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù†ÙŠØ©",
                    upload_cert:"Ø±ÙØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©",
                    th_caregiver:"Ø§Ù„Ù…Ø®ØªØµ", th_service:"Ø§Ù„Ø·ÙÙ„", th_status:"Ø§Ù„Ø­Ø§Ù„Ø©", th_action:"Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡",
                    status_online:"Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©", incoming_requests:"Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©", th_parent:"Ø§Ù„ÙˆÙ„ÙŠ", th_child:"Ø§Ù„Ø·ÙÙ„", th_details:"Ø§Ù„ØªÙØ§ØµÙŠÙ„",
                    stat_total_req:"Ø§Ù„ÙƒÙ„", stat_new_req:"Ø§Ù†ØªØ¸Ø§Ø±", stat_accepted:"Ù…Ù‚Ø¨ÙˆÙ„Ø©", stat_rejected:"Ù…Ø±ÙÙˆØ¶Ø©",
                    settings:"Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", logout:"Ø®Ø±ÙˆØ¬", forgot_password:"Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ", login_btn:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", create_account_btn:"Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",
                    my_requests:"Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©"
                },
                fr: {
                    app_name:"Morafik", home:"Accueil", login:"Connexion", register:"Inscription", start_now:"Commencer",
                    welcome_title:"Bienvenue chez Morafik", slogan:"Votre enfant en sÃ©curitÃ©",
                    role_parent:"Parent", role_caregiver:"SpÃ©cialiste",
                    email_label:"Email", email_placeholder:"ex: user@mail.com",
                    pass_label:"Mot de passe", password_placeholder:"******",
                    fullname:"Nom complet", phone:"TÃ©lÃ©phone", wilaya:"Wilaya",
                    search_title:"Trouver un spÃ©cialiste", all_wilayas:"Toutes Wilayas", all_services:"Tous Services",
                    search_btn:"Rechercher", service_type:"Service",
                    child_age:"Ã‚ge enfant", child_name:"Nom enfant", school_level:"Niveau scolaire",
                    lvl_primary:"Primaire", lvl_middle:"Moyen", lvl_secondary:"LycÃ©e", lvl_none:"Aucun",
                    child_condition:"Ã‰tat de l'enfant", cond_normal:"Normal", cond_autism:"Autiste", cond_speech:"Retard parole", cond_adhd:"TDAH",
                    duration:"DurÃ©e", dur_session:"SÃ©ance", dur_term:"Trimestre", dur_year:"AnnÃ©e scolaire", "1_month":"1 Mois",
                    days:"Jours prÃ©fÃ©rÃ©s", confirm_send:"Confirmer",
                    edit_profile:"Modifier Profil", save:"Enregistrer", change_pass:"Changer mot de passe", pro_info:"Infos pro",
                    upload_cert:"DiplÃ´me (PDF)",
                    th_caregiver:"SpÃ©cialiste", th_service:"Enfant", th_status:"Statut", th_action:"Action",
                    status_online:"En Service", incoming_requests:"Demandes reÃ§ues", th_parent:"Parent", th_child:"Enfant", th_details:"DÃ©tails",
                    stat_total_req:"Total", stat_new_req:"Attente", stat_accepted:"AcceptÃ©", stat_rejected:"RefusÃ©",
                    settings:"ParamÃ¨tres", logout:"DÃ©connexion", forgot_password:"Mot de passe oubliÃ©?", login_btn:"Se connecter", create_account_btn:"CrÃ©er compte",
                    my_requests:"Mes demandes"
                }
            };

            let currentLang = 'ar';
            function t(key) { return translations[currentLang][key] || key; }

            // Init DB (Mock Data)
            const initialUsers = [
                { id: 'c1', name: 'Ø¯. Ø³Ø§Ø±Ø© (Ù†ÙØ³Ø§Ù†ÙŠØ©)', email: 'doc@test.com', pass: '123', role: 'caregiver', phone: '0550112233', wilaya: 'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', service: 'Ø§Ø³ØªØ´Ø§Ø±Ø© (Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ)', isAvailable: true, photo: "https://cdn-icons-png.flaticon.com/512/3304/3304567.png", isBanned: false },
                { id: 'p1', name: 'Ø£Ø­Ù…Ø¯ Ø§Ù„ÙˆÙ„ÙŠ', email: 'parent@test.com', pass: '123', role: 'parent', phone: '0555000000', wilaya: 'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', photo: "https://cdn-icons-png.flaticon.com/512/3011/3011270.png", isBanned: false }
            ];
            if (!localStorage.getItem('users')) localStorage.setItem('users', JSON.stringify(initialUsers));
            if (!localStorage.getItem('requests')) localStorage.setItem('requests', JSON.stringify([]));
            if (!localStorage.getItem('notifications')) localStorage.setItem('notifications', JSON.stringify([]));

            const DB = {
                getUsers: () => JSON.parse(localStorage.getItem('users')),
                saveUser: (u) => { const us = DB.getUsers(); us.push(u); localStorage.setItem('users', JSON.stringify(us)); },
                saveAllUsers: (us) => localStorage.setItem('users', JSON.stringify(us)),
                updateUser: (updatedUser) => { const users = DB.getUsers(); const idx = users.findIndex(u => u.id === updatedUser.id); if(idx !== -1) { users[idx] = updatedUser; localStorage.setItem('users', JSON.stringify(users)); return true; } return false; },
                getRequests: () => JSON.parse(localStorage.getItem('requests')),
                saveRequest: (r) => { const rs = DB.getRequests(); rs.push(r); localStorage.setItem('requests', JSON.stringify(rs)); },
                updateRequest: (id, s) => { const rs = DB.getRequests(); const idx = rs.findIndex(r=>r.id==id); if(idx!==-1){rs[idx].status=s; localStorage.setItem('requests', JSON.stringify(rs));} },
                getNotifs: () => JSON.parse(localStorage.getItem('notifications')),
                saveNotif: (n) => { const ns = DB.getNotifs(); ns.push(n); localStorage.setItem('notifications', JSON.stringify(ns)); }
            };

            let currentUser = null;

            // --- NAVIGATION ---
            window.switchView = function(viewId) {
                document.querySelectorAll('.view-section').forEach(el => { el.classList.remove('active'); el.style.opacity=0; });
                const target = document.getElementById(viewId);
                target.classList.add('active');
                setTimeout(()=>target.style.opacity=1, 50);
                window.scrollTo(0,0);
            };

            window.goHome = function() { if(currentUser) return; switchView('landingView'); };
            window.goToLogin = function() { switchView('authView'); new bootstrap.Tab(document.querySelector('#tab-login')).show(); };
            window.startNow = function() { switchView('authView'); new bootstrap.Tab(document.querySelector('#tab-register')).show(); };

            window.logout = function() {
                currentUser = null;
                document.getElementById('guestNav').classList.remove('d-none');
                document.getElementById('userNav').classList.add('d-none');
                document.getElementById('loginForm').reset();
                switchView('landingView');
            };

            // --- AUTH ---
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const pass = document.getElementById('loginPass').value;
                
                if(email === 'admin' && pass === 'abobob123') {
                    currentUser = { name: 'Admin', role: 'admin' };
                    document.getElementById('guestNav').classList.add('d-none');
                    document.getElementById('userNav').classList.remove('d-none');
                    document.getElementById('userInfo').innerText = 'Admin';
                    loadAdminDashboard();
                    switchView('adminView'); return;
                }

                const user = DB.getUsers().find(u => u.email === email && u.pass === pass);
                if(user) {
                    if(user.isBanned) { Swal.fire({icon:'error', title:'Ù…Ø­Ø¸ÙˆØ±', text:'ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©'}); return; }
                    currentUser = user;
                    document.getElementById('guestNav').classList.add('d-none');
                    document.getElementById('userNav').classList.remove('d-none');
                    document.getElementById('userInfo').innerText = user.name;
                    checkNotifications();
                    if(user.role === 'parent') { switchView('parentView'); performSearch(); loadMyRequests(); loadParentStats(); }
                    else { switchView('caregiverView'); loadCaregiverDashboard(); }
                } else {
                    Swal.fire({icon:'error', title: t('alert_error'), text:'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'});
                }
            });

            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const role = document.getElementById('regRole').value;
                const newUser = { id: 'u' + Date.now(), name: document.getElementById('regName').value, email: document.getElementById('regEmail').value, phone: document.getElementById('regPhone').value, pass: document.getElementById('regPass').value, role: role, wilaya: document.getElementById('regWilaya').value, photo: "https://cdn-icons-png.flaticon.com/512/149/149071.png", isAvailable: true, isBanned: false };
                if (role === 'caregiver') { newUser.service = document.getElementById('regService').value; }
                DB.saveUser(newUser); 
                Swal.fire({icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„'});
                new bootstrap.Tab(document.querySelector('#tab-login')).show(); document.getElementById('registerForm').reset();
            });

            // --- NOTIFICATIONS SYSTEM ---
            window.checkNotifications = function() {
                const notifs = DB.getNotifs().filter(n => n.target === 'all' || n.target === currentUser.role);
                const badge = document.getElementById('notifBadge');
                if(notifs.length > 0) {
                    badge.classList.remove('d-none');
                } else {
                    badge.classList.add('d-none');
                }
            };
            window.openNotifications = function() {
                const list = document.getElementById('notifList');
                list.innerHTML = '';
                const notifs = DB.getNotifs().filter(n => n.target === 'all' || n.target === currentUser.role).reverse();
                
                if(notifs.length === 0) list.innerHTML = '<div class="p-3 text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
                
                notifs.forEach(n => {
                    list.innerHTML += `<div class="list-group-item"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 text-primary fw-bold">${n.sender || 'ÙØ±ÙŠÙ‚ Ù…Ø±Ø§ÙÙ‚'}</h6><small class="text-muted">${n.date}</small></div><p class="mb-1 small">${n.message}</p></div>`;
                });
                new bootstrap.Modal(document.getElementById('notifModal')).show();
                document.getElementById('notifBadge').classList.add('d-none');
            };

            // --- PARENT ---
            window.loadParentStats = function() {
                const reqs = DB.getRequests().filter(r => r.parentId === currentUser.id);
                document.getElementById('pStatTotal').innerText = reqs.length;
                document.getElementById('pStatAccepted').innerText = reqs.filter(r=>r.status==='accepted').length;
                document.getElementById('pStatPending').innerText = reqs.filter(r=>r.status==='pending').length;
            };

            window.performSearch = function() {
                const container = document.getElementById('resultsArea');
                const sWilaya = document.getElementById('searchWilaya').value;
                const sService = document.getElementById('searchService').value;
                
                container.innerHTML = '';
                DB.getUsers().filter(u => u.role === 'caregiver' && !u.isBanned && u.isAvailable 
                    && (sWilaya === 'Ø§Ù„ÙƒÙ„' || u.wilaya === sWilaya)
                    && (sService === 'Ø§Ù„ÙƒÙ„' || u.service === sService)
                ).forEach(c => {
                    const sObj = services.find(s=>s.ar === c.service || s.fr === c.service);
                    const displayService = sObj ? (currentLang==='ar'?sObj.ar:sObj.fr) : c.service;
                    container.innerHTML += `<div class="col-md-4"><div class="custom-card p-3 text-center h-100"><img src="${c.photo}" class="profile-img-preview mb-2"><h5 class="fw-bold">${c.name}</h5><p class="small text-muted mb-3">${displayService}<br>ğŸ“ ${c.wilaya}</p><button class="btn btn-outline-primary w-100 fw-bold mt-auto" onclick="openRequestModal('${c.id}')">${t('request_service')}</button></div></div>`;
                });
                if(container.innerHTML === '') container.innerHTML = '<div class="col-12 text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
            };

            window.openRequestModal = function(id) {
                document.getElementById('targetCaregiverId').value = id;
                new bootstrap.Modal(document.getElementById('requestModal')).show();
            };

            document.getElementById('sendRequestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const req = {
                    id: Date.now(), parentId: currentUser.id, parentName: currentUser.name, parentPhone: currentUser.phone, 
                    caregiverId: document.getElementById('targetCaregiverId').value,
                    childName: document.getElementById('reqChildName').value, childAge: document.getElementById('reqChildAge').value,
                    schoolLevel: document.getElementById('reqSchoolLevel').value, childCondition: document.getElementById('reqChildCondition').value,
                    duration: document.getElementById('reqDuration').value, days: document.getElementById('reqDays').value, status: 'pending'
                };
                DB.saveRequest(req);
                bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
                Swal.fire({icon:'success', title: t('alert_success')});
                loadMyRequests(); loadParentStats();
            });

            window.loadMyRequests = function() {
                const tbody = document.getElementById('myRequestsTable'); tbody.innerHTML = '';
                DB.getRequests().filter(r => r.parentId === currentUser.id).forEach(r => {
                    const cg = DB.getUsers().find(u => u.id == r.caregiverId) || {name:'?'};
                    let status = r.status === 'pending' ? `<span class="badge bg-warning text-dark">${t('stat_new_req')}</span>` : (r.status === 'accepted' ? `<span class="badge bg-success">${t('stat_accepted')}</span>` : `<span class="badge bg-danger">${t('stat_rejected')}</span>`);
                    tbody.innerHTML += `<tr><td data-label="${t('th_caregiver')}">${cg.name}</td><td data-label="${t('th_service')}">${r.childName}</td><td data-label="${t('th_status')}">${status}</td><td data-label="${t('th_action')}">${r.status==='accepted'?`<a href="tel:${cg.phone}" class="btn btn-sm btn-success">ğŸ“</a>`:'-'}</td></tr>`;
                });
            };

            // --- CAREGIVER ---
            window.loadCaregiverDashboard = function() {
                document.getElementById('cgNameProfile').innerText = currentUser.name;
                document.getElementById('dashboardProfileImg').src = currentUser.photo;
                const toggle = document.getElementById('availabilityToggle');
                toggle.checked = currentUser.isAvailable;
                
                const reqs = DB.getRequests().filter(r => r.caregiverId == currentUser.id);
                document.getElementById('cgStatTotal').innerText = reqs.length;
                document.getElementById('cgStatPending').innerText = reqs.filter(r=>r.status==='pending').length;
                document.getElementById('cgStatAccepted').innerText = reqs.filter(r=>r.status==='accepted').length;
                document.getElementById('cgStatRejected').innerText = reqs.filter(r=>r.status==='rejected').length;
                
                const tbody = document.getElementById('incomingRequestsTable'); tbody.innerHTML = '';
                reqs.forEach(r => {
                    let action = r.status === 'pending' ? `<button class="btn btn-sm btn-success ms-1" onclick="handleReq(${r.id},'accepted')">âœ”</button><button class="btn btn-sm btn-danger" onclick="handleReq(${r.id},'rejected')">âœ˜</button>` : (r.status === 'accepted' ? t('stat_accepted') : t('stat_rejected'));
                    
                    // Logic to show Parent phone
                    let parentInfo = r.parentName;
                    if(r.status === 'accepted') {
                        // Find parent user to ensure we have latest phone or use stored one
                        const pUser = DB.getUsers().find(u => u.id === r.parentId);
                        const pPhone = pUser ? pUser.phone : r.parentPhone;
                        parentInfo += `<br><a href="tel:${pPhone}" class="badge bg-success text-decoration-none"><i class="bi bi-telephone-fill"></i> ${pPhone}</a>`;
                    }

                    let details = `<div class="small">${r.childAge} Ø³Ù†ÙˆØ§Øª | ${r.schoolLevel}<br><span class="text-danger fw-bold">${r.childCondition}</span><br>${r.duration}</div>`;
                    tbody.innerHTML += `<tr><td data-label="${t('th_parent')}">${parentInfo}</td><td data-label="${t('th_child')}">${r.childName}</td><td data-label="${t('th_details')}">${details}</td><td data-label="${t('th_days')}">${r.days}</td><td data-label="${t('th_action')}">${action}</td></tr>`;
                });
            };
            window.handleReq = function(id, status) { DB.updateRequest(id, status); loadCaregiverDashboard(); };
            window.toggleAvailability = function() { currentUser.isAvailable = document.getElementById('availabilityToggle').checked; DB.updateUser(currentUser); };

            // --- ADMIN DASHBOARD ---
            window.loadAdminDashboard = function() {
                const users = DB.getUsers();
                const reqs = DB.getRequests();
                
                // Stats
                document.getElementById('statTotalUsers').innerText = users.length;
                document.getElementById('statCaregivers').innerText = users.filter(u=>u.role==='caregiver').length;
                document.getElementById('statReportsCount').innerText = 0; // Placeholder
                document.getElementById('statSuccessOps').innerText = reqs.filter(r=>r.status==='accepted').length;

                // Top Caregivers
                const successCounts = {};
                reqs.filter(r => r.status === 'accepted').forEach(r => { successCounts[r.caregiverId] = (successCounts[r.caregiverId] || 0) + 1; });
                const topCgs = Object.keys(successCounts).map(id => { const u = users.find(x => x.id === id); return u ? { ...u, count: successCounts[id] } : null; }).filter(u => u).sort((a, b) => b.count - a.count).slice(0, 5);
                
                const topTable = document.getElementById('adminTopCaregivers'); topTable.innerHTML = '';
                topCgs.forEach((c, i) => {
                    topTable.innerHTML += `<tr class="border-bottom"><td style="width:40px"><img src="${c.photo}" width="35" class="rounded-circle"></td><td><div class="fw-bold small">${c.name}</div><small class="text-muted">${c.service}</small></td><td class="text-end"><span class="badge bg-primary rounded-pill">${c.count}</span></td></tr>`;
                });

                // Daily Transactions
                const transTable = document.getElementById('adminDailyTrans'); transTable.innerHTML = '';
                reqs.slice(-5).reverse().forEach(r => {
                    const cg = users.find(u => u.id === r.caregiverId) || {name: '?'};
                    const st = r.status === 'accepted' ? '<span class="badge bg-success">âœ”</span>' : (r.status === 'rejected' ? '<span class="badge bg-danger">âœ˜</span>' : '<span class="badge bg-warning">â³</span>');
                    transTable.innerHTML += `<tr><td>${r.parentName}</td><td>${cg.name}</td><td>${st}</td></tr>`;
                });

                // Users Table with Ban
                const uTable = document.getElementById('adminUsersTable'); uTable.innerHTML = '';
                const term = document.getElementById('adminSearch').value.toLowerCase();
                users.filter(u => u.name.toLowerCase().includes(term) || u.phone.includes(term)).forEach(u => {
                    const statusBadge = u.isBanned ? '<span class="badge bg-danger">Ù…Ø­Ø¸ÙˆØ±</span>' : '<span class="badge bg-success">Ù†Ø´Ø·</span>';
                    const actionBtn = u.isBanned ? `<button class="btn btn-sm btn-success" onclick="toggleBan('${u.id}')">ÙÙƒ Ø­Ø¸Ø±</button>` : `<button class="btn btn-sm btn-outline-danger" onclick="toggleBan('${u.id}')">Ø­Ø¸Ø±</button>`;
                    uTable.innerHTML += `<tr><td>${u.name}</td><td>${u.role}</td><td>${u.phone}</td><td class="small">${u.email}</td><td class="text-danger font-monospace">${u.pass}</td><td>${statusBadge}</td><td>${actionBtn}</td></tr>`;
                });
            };

            window.toggleBan = function(uid) {
                const users = DB.getUsers();
                const u = users.find(x => x.id === uid);
                if(u) { u.isBanned = !u.isBanned; DB.saveAllUsers(users); loadAdminDashboard(); }
            };

            window.openSendNotifModal = function() { new bootstrap.Modal(document.getElementById('adminSendNotifModal')).show(); };
            window.sendAdminNotification = function(e) {
                e.preventDefault();
                const target = document.getElementById('notifTarget').value;
                const msg = document.getElementById('notifMsg').value;
                DB.saveNotif({ target: target, message: msg, date: new Date().toLocaleDateString(), sender: 'ÙØ±ÙŠÙ‚ Ù…Ø±Ø§ÙÙ‚' });
                bootstrap.Modal.getInstance(document.getElementById('adminSendNotifModal')).hide();
                Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„');
            };

            // --- EDIT PROFILE ---
            document.getElementById('editProfilePic').addEventListener('change', function(e) { if (e.target.files[0]) { const r = new FileReader(); r.onload = (ev) => document.getElementById('editImgPreview').src = ev.target.result; r.readAsDataURL(e.target.files[0]); } });
            
            window.openEditProfileModal = function() {
                if(!currentUser) return;
                document.getElementById('editName').value = currentUser.name;
                document.getElementById('editPhone').value = currentUser.phone;
                document.getElementById('editWilaya').value = currentUser.wilaya;
                document.getElementById('editImgPreview').src = currentUser.photo;
                if(currentUser.role === 'caregiver') { document.getElementById('caregiverEditFields').classList.remove('d-none'); document.getElementById('editService').value = currentUser.service; } 
                else { document.getElementById('caregiverEditFields').classList.add('d-none'); }
                new bootstrap.Modal(document.getElementById('editProfileModal')).show();
            };

            document.getElementById('editProfileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                currentUser.name = document.getElementById('editName').value;
                currentUser.phone = document.getElementById('editPhone').value;
                currentUser.wilaya = document.getElementById('editWilaya').value;
                const newPass = document.getElementById('editNewPass').value;
                if(newPass) currentUser.pass = newPass;
                const img = document.getElementById('editImgPreview').src;
                if(img && !img.includes('window.location')) currentUser.photo = img;
                if(currentUser.role === 'caregiver') currentUser.service = document.getElementById('editService').value;

                DB.updateUser(currentUser);
                bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                Swal.fire({icon:'success', title: t('save')});
                document.getElementById('userInfo').innerText = currentUser.name;
                if(currentUser.role === 'caregiver') loadCaregiverDashboard();
            });

            // --- UTILS ---
            window.toggleLanguage = function() {
                currentLang = currentLang === 'ar' ? 'fr' : 'ar';
                document.documentElement.lang = currentLang;
                document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
                document.getElementById('langSwitcher').innerText = currentLang === 'ar' ? 'FR' : 'AR';
                document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = t(el.getAttribute('data-i18n')));
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.getAttribute('data-i18n-placeholder')));
                populateDropdowns();
            };

            window.selectRole = function(role, elem) {
                document.querySelectorAll('.role-selector').forEach(el => el.classList.remove('active'));
                elem.classList.add('active');
                document.getElementById('regRole').value = role;
                document.getElementById('caregiverFields').classList.toggle('d-none', role !== 'caregiver');
            };

            function populateDropdowns() {
                const wSelects = document.querySelectorAll('.dynamic-wilaya');
                wSelects.forEach(sel => {
                    const currentVal = sel.value; const isSearch = sel.id === 'searchWilaya';
                    let html = isSearch ? `<option value="Ø§Ù„ÙƒÙ„">${t('all_wilayas')}</option>` : ``;
                    wilayas.forEach(w => { html += `<option value="${w.ar}">${currentLang === 'ar' ? w.ar : w.fr}</option>`; });
                    sel.innerHTML = html; if(currentVal && currentVal !== 'Ø§Ù„ÙƒÙ„') sel.value = currentVal;
                });
                const sSelects = document.querySelectorAll('.dynamic-service');
                sSelects.forEach(sel => {
                    const currentVal = sel.value; const isSearch = sel.id === 'searchService';
                    let html = isSearch ? `<option value="Ø§Ù„ÙƒÙ„">${t('all_services')}</option>` : ``;
                    services.forEach(s => { html += `<option value="${s.ar}">${currentLang === 'ar' ? s.ar : s.fr}</option>`; });
                    sel.innerHTML = html; if(currentVal && currentVal !== 'Ø§Ù„ÙƒÙ„') sel.value = currentVal;
                });
            }

            populateDropdowns();
            switchView('landingView');
        });
    </script>
</body>
</html>
