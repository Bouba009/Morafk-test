<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±Ø§ÙÙ‚ | Morafik</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f3f4f6;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        body { background-color: var(--light-bg); color: #333; overflow-x: hidden; min-height: 100vh; transition: 0.3s; }

        /* Loader Fix: pointer-events none prevents blocking clicks */
        #loadingScreen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #fff; z-index: 99999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            transition: opacity 0.3s ease; 
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top: 5px solid var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Helpers */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        input, select, textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 0.95rem; margin-bottom: 15px; background: #fff; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--secondary-color); box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1); }
        
        .btn { padding: 12px 25px; background: var(--secondary-color); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.2s; box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3); }
        .btn:active { transform: scale(0.98); }
        .btn-red { background: var(--accent-color); box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3); }

        /* Header */
        header { background: var(--glass); backdrop-filter: blur(10px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .logo { font-size: 24px; font-weight: 900; color: var(--secondary-color); display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; align-items: center; gap: 15px; }
        .nav-links button { background: transparent; border: none; font-size: 16px; cursor: pointer; color: #2c3e50; font-weight: 500; transition: 0.3s; }
        
        .notif-icon { position: relative; font-size: 22px; cursor: pointer; margin: 0 10px; color: var(--primary-color); }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: var(--accent-color); color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; justify-content: center; align-items: center; border: 2px solid white; }

        /* Sections */
        section { padding-top: 100px; min-height: 100vh; display: none; padding-bottom: 50px; }
        
        .hero-section { 
            background: url('https://images.unsplash.com/photo-1544717305-2782549b5136?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80') center/cover;
            position: relative; display: flex; align-items: center; justify-content: center; text-align: center; color: white; 
        }
        .hero-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); }
        .hero-content { position: relative; z-index: 2; padding: 20px; max-width: 800px; }
        
        .dashboard-content { padding: 0 5%; max-width: 1200px; margin: 0 auto; }
        .profile-card { background: white; padding: 30px; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); margin-bottom: 30px; flex-wrap: wrap; gap: 20px; border: 1px solid #fff; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 25px; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); border: 1px solid #eee; }
        .stat-box h3 { font-size: 2.5rem; color: var(--secondary-color); margin: 0; font-weight: 800; }
        
        .req-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 15px rgba(0,0,0,0.03); border-right: 5px solid var(--secondary-color); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px; animation: fadeIn 0.5s ease; }
        
        /* Modals */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); overflow-y: auto; backdrop-filter: blur(5px); }
        .modal-content { background-color: #fff; margin: 5% auto; padding: 30px; width: 90%; max-width: 600px; border-radius: 24px; animation: fadeIn 0.3s; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .close { float: left; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; transition: 0.3s; }
        .close:hover { color: var(--accent-color); }

        .edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        .file-upload-wrapper { border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .file-upload-wrapper:hover { border-color: var(--secondary-color); background: #f9fbfd; }

        /* Admin Table */
        .admin-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow); }
        .admin-table th, .admin-table td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: right; }
        .admin-table th { background: #f8f9fa; color: var(--secondary-color); font-weight: bold; }
        .msg-card { background: white; padding: 15px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 10px; position: relative; }
        .msg-tag { position: absolute; top: 10px; left: 10px; font-size: 12px; background: #eee; padding: 2px 8px; border-radius: 10px; }

        footer { background: var(--primary-color); color: white; padding: 60px 5%; margin-top: 60px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 40px; }
        footer li { margin-bottom: 12px; opacity: 0.8; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
        footer li a { color: white; text-decoration: none; }

        .phone-link { color: var(--secondary-color); font-weight: bold; text-decoration: none; border-bottom: 1px dashed var(--secondary-color); }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 15px; padding: 15px; }
            .stats-grid, .edit-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .req-card { flex-direction: column; }
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loadingScreen">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:bold;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„... (Loading)</p>
    </div>

    <!-- Header -->
    <header>
        <div class="logo"><i class="fas fa-hands-helping"></i> <span data-i18n="logo">Ù…Ø±Ø§ÙÙ‚ | Morafik</span></div>
        <div class="nav-links">
            <button onclick="changeLang()" class="lang-btn">FR / AR</button>
            <div id="notifWrapper" class="notif-icon" onclick="openNotifModal()" style="display:none;">
                <i class="fas fa-bell"></i>
                <span id="notifBadge" class="notif-badge" style="display:none;">0</span>
            </div>
            <button onclick="router('hero')" data-i18n="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <button onclick="router('login')" id="navLogin" data-i18n="login">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="router('register')" id="navReg" data-i18n="register">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            <button onclick="logout()" id="navLogout" class="btn-red" style="display:none; font-size:14px;" data-i18n="logout">Ø®Ø±ÙˆØ¬</button>
        </div>
    </header>

    <!-- Hero -->
    <section id="hero" class="hero-section fade-in" style="display: flex;">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 data-i18n="heroTitle">Ù…Ø±Ø§ÙÙ‚Ø© Ù„Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©</h1>
            <p data-i18n="heroSub" style="font-size: 1.4rem; margin-bottom: 30px; opacity: 0.9;">Ù†Ø±Ø¨Ø·Ùƒ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ† ÙˆØ§Ù„Ø£Ø®ØµØ§Ø¦ÙŠÙŠÙ† Ø§Ù„Ù†ÙØ³ÙŠÙŠÙ†</p>
            <button class="btn" style="padding: 15px 40px; font-size: 1.1rem;" onclick="router('register')" data-i18n="startNow">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
        </div>
    </section>

    <!-- Login -->
    <section id="login">
        <div class="modal-content" style="max-width: 400px; margin-top: 80px;">
            <h2 style="text-align: center; margin-bottom: 30px;" data-i18n="loginTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <input type="text" id="loginEmail" data-i18n-ph="emailPh" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="loginPass" data-i18n-ph="passPh" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn" style="width: 100%;" onclick="handleLogin()" data-i18n="loginBtn">Ø¯Ø®ÙˆÙ„</button>
            <div style="text-align: center; margin-top: 20px;">
                <span data-i18n="noAccount">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</span> <a href="#" onclick="router('register')" style="color: var(--secondary-color); font-weight: bold;" data-i18n="createOne">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</a>
            </div>
        </div>
    </section>

    <!-- Register -->
    <section id="register">
        <div class="modal-content" style="margin-top: 40px;">
            <h2 style="text-align: center; margin-bottom: 25px;" data-i18n="regTitle">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" style="flex:1; background:#eee; color:#333;" id="roleParent" onclick="setRole('parent')" data-i18n="roleParent">ÙˆÙ„ÙŠ</button>
                <button class="btn" style="flex:1; background:#eee; color:#333;" id="roleComp" onclick="setRole('companion')" data-i18n="roleComp">Ù…Ø±Ø§ÙÙ‚</button>
            </div>
            
            <input type="text" id="regName" data-i18n-ph="namePh" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="email" id="regEmail" data-i18n-ph="emailPh" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="tel" id="regPhone" data-i18n-ph="phonePh" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <select id="regWilaya"></select>

            <div id="compFields" style="display: none;">
                <select id="regSpec">
                    <option value="Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯" data-i18n="spec1">Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯</option>
                    <option value="Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ" data-i18n="spec2">Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ</option>
                </select>
                <div class="file-upload-wrapper">
                    <label data-i18n="certLabel">Ø§Ø±ÙØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (PDF)</label>
                    <input type="file" id="regDoc" accept="application/pdf" style="margin-top:10px;">
                </div>
            </div>

            <input type="password" id="regPass" data-i18n-ph="passPh" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <input type="password" id="regConfPass" data-i18n-ph="confPassPh" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            
            <button class="btn" style="width: 100%; margin-top: 10px;" onclick="handleRegister()" data-i18n="regBtn">ØªØ³Ø¬ÙŠÙ„</button>
            <div style="text-align: center; margin-top: 20px;">
                <span data-i18n="haveAccount">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ</span> <a href="#" onclick="router('login')" style="color: var(--secondary-color); font-weight: bold;" data-i18n="loginBtn">Ø¯Ø®ÙˆÙ„</a>
            </div>
        </div>
    </section>

    <!-- Parent Dashboard -->
    <section id="parentDash">
        <div class="dashboard-content fade-in">
            <div class="profile-card">
                <div>
                    <h2 id="pName">User</h2>
                    <p data-i18n="roleParent" style="color:#666; margin-top:5px;">ÙˆÙ„ÙŠ Ø·ÙÙ„</p>
                    <button class="btn" style="margin-top:15px; font-size:0.9rem; padding: 8px 20px;" onclick="openEditModal()" data-i18n="editProfile">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button>
                </div>
                <img id="pImg" src="https://via.placeholder.com/100" style="border-radius:50%; width:100px; height:100px; object-fit:cover; border:3px solid var(--secondary-color);">
            </div>

            <div style="background:white; padding:30px; border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:40px;">
                <h3 style="margin-bottom:20px; color:var(--primary-color);" data-i18n="searchTitle">Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±Ø§ÙÙ‚</h3>
                <div style="display:flex; gap:15px; flex-wrap:wrap;">
                    <select id="searchSpec" style="flex:1; margin:0;">
                        <option value="Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯" data-i18n="spec1">Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯</option>
                        <option value="Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ" data-i18n="spec2">Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ</option>
                    </select>
                    <select id="searchWilaya" style="flex:1; margin:0;"></select>
                    <button class="btn" onclick="searchCompanions()" data-i18n="searchBtn">Ø¨Ø­Ø«</button>
                </div>
            </div>

            <div id="searchResults"></div>
            <h3 style="margin: 40px 0 20px;" data-i18n="myRequests">Ø·Ù„Ø¨Ø§ØªÙŠ</h3>
            <div id="parentReqs"></div>
        </div>
    </section>

    <!-- Companion Dashboard -->
    <section id="companionDash">
        <div class="dashboard-content fade-in">
            <div class="profile-card">
                <div>
                    <h2 id="cName">User</h2>
                    <p id="cSpec" style="color:var(--secondary-color); font-weight:bold; margin-top:5px;"></p>
                    <div style="margin-top:15px;">
                        <input type="checkbox" id="availToggle" onchange="toggleAvail()"> <label for="availToggle" data-i18n="available" style="font-weight:bold;">Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ù…Ù„</label>
                    </div>
                    <button class="btn" style="margin-top:15px; font-size:0.9rem; padding: 8px 20px;" onclick="openEditModal()" data-i18n="editProfile">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</button>
                </div>
                <img id="cImg" src="https://via.placeholder.com/100" style="border-radius:50%; width:100px; height:100px; object-fit:cover; border:3px solid var(--secondary-color);">
            </div>

            <div class="stats-grid">
                <div class="stat-box"><h3 id="stTotal">0</h3><p data-i18n="totalReq">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p></div>
                <div class="stat-box"><h3 id="stNew">0</h3><p data-i18n="newReq">Ø¬Ø¯ÙŠØ¯Ø©</p></div>
                <div class="stat-box"><h3 id="stAcc">0</h3><p data-i18n="accReq">Ù…Ù‚Ø¨ÙˆÙ„Ø©</p></div>
                <div class="stat-box"><h3><i class="fas fa-star" style="color:#f1c40f"></i></h3><p data-i18n="ratingScore">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p></div>
            </div>

            <h3 data-i18n="incomingReq" style="margin-bottom:20px;">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
            <div id="compReqs"></div>
        </div>
    </section>

    <!-- Admin Dashboard -->
    <section id="adminDash">
        <div class="dashboard-content">
            <h2 style="margin-bottom:30px;">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
            
            <div class="stats-grid">
                <div class="stat-box"><h3 id="adUsers">0</h3><p>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p></div>
                <div class="stat-box"><h3 id="adReqsTotal">0</h3><p>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p></div>
                <div class="stat-box"><h3 id="adReqsAcc" style="color:green">0</h3><p>Ù…Ù‚Ø¨ÙˆÙ„Ø©</p></div>
                <div class="stat-box"><h3 id="adMsgs">0</h3><p>Ø±Ø³Ø§Ø¦Ù„</p></div>
            </div>

            <div style="background:white; padding:20px; border-radius:12px; box-shadow:var(--shadow); margin-bottom:30px;">
                <h4 style="margin-bottom:15px;">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</h4>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <input type="text" id="adminNotifText" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±..." style="flex:2; margin:0;">
                    <select id="adminNotifTarget" style="flex:1; margin:0;">
                        <option value="all">Ø§Ù„ÙƒÙ„</option>
                        <option value="parent">Ø£ÙˆÙ„ÙŠØ§Ø¡</option>
                        <option value="companion">Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</option>
                    </select>
                    <button class="btn" onclick="sendAdminNotif()">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>

            <div id="adminMessagesList" style="max-height:300px; overflow-y:auto; margin-bottom:30px;"></div>

            <div style="overflow-x:auto;">
                <table class="admin-table" id="admTable">
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('bookingModal')">&times;</span>
            <h3 style="margin-bottom:20px;" data-i18n="bookTitle">Ø­Ø¬Ø² Ù…Ø±Ø§ÙÙ‚</h3>
            <input type="hidden" id="bookCompId">
            <div class="edit-grid">
                <div><label data-i18n="childName">Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</label><input type="text" id="bkChildName"></div>
                <div><label data-i18n="childAge">Ø§Ù„Ø³Ù†</label><input type="number" id="bkChildAge"></div>
                <div class="full-width"><label data-i18n="eduLevel">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</label><select id="bkLevel"><option value="Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option value="Ù…ØªÙˆØ³Ø·">Ù…ØªÙˆØ³Ø·</option><option value="Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù†ÙˆÙŠ</option><option value="Ù…Ø±ÙƒØ²">Ù…Ø±ÙƒØ²</option><option value="Ù„Ø§ ÙŠØ¯Ø±Ø³">Ù„Ø§ ÙŠØ¯Ø±Ø³</option></select></div>
                <div><label data-i18n="childStatus">Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙÙ„</label><select id="bkStatus"><option value="Ø¹Ø§Ø¯ÙŠ">Ø¹Ø§Ø¯ÙŠ</option><option value="Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯">Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯</option></select></div>
                <div><label data-i18n="followType">Ù†ÙˆØ¹ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</label><select id="bkType"><option value="Ù…Ø±Ø§ÙÙ‚Ø© Ù…Ø³ØªÙ…Ø±Ø©">Ù…Ø±Ø§ÙÙ‚Ø© Ù…Ø³ØªÙ…Ø±Ø©</option><option value="Ø­ØµØµ ÙÙ‚Ø·">Ø­ØµØµ ÙÙ‚Ø·</option></select></div>
            </div>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="submitBooking()" data-i18n="confirmBook">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close" onclick="closeModal('editModal')">&times;</span>
            <h3 style="margin-bottom:25px;" data-i18n="editTitle">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            <div class="edit-grid">
                <div class="full-width"><div style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;">Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</div></div>
                <div><label data-i18n="fullName">Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="edName"></div>
                <div><label data-i18n="phone">Ø§Ù„Ù‡Ø§ØªÙ</label><input type="tel" id="edPhone"></div>
                <div class="full-width"><label data-i18n="wilaya">Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</label><select id="edWilaya"></select></div>
                <div class="full-width"><div style="border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:10px;">Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</div></div>
                <div class="file-upload-wrapper">
                    <label data-i18n="profilePic">ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©</label>
                    <input type="file" id="edImg" accept="image/*" style="display:block; margin-top:5px;">
                </div>
                <div id="compEditFields" class="file-upload-wrapper" style="display:none;">
                    <label data-i18n="updateCert">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</label>
                    <input type="file" id="edCert" accept="application/pdf" style="display:block; margin-top:5px;">
                </div>
                <div class="full-width"><label data-i18n="newPass">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input type="password" id="edPass"></div>
            </div>
            <button class="btn" style="width:100%; margin-top:20px;" onclick="saveProfile()" data-i18n="saveChanges">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="ratingModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('ratingModal')">&times;</span>
            <h3 style="margin-bottom:20px;" data-i18n="rateTitle">ØªÙ‚ÙŠÙŠÙ…</h3>
            <input type="hidden" id="rateReqId">
            <select id="rtScore"><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select>
            <textarea id="rtReview" rows="3" placeholder="Ø±Ø£ÙŠÙƒ..."></textarea>
            <button class="btn" style="width:100%" onclick="submitRating()" data-i18n="submitRate">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('reportModal')">&times;</span>
            <h3 id="reportTitle" style="margin-bottom:20px;">Ø§Ø¨Ù„Ø§Øº</h3>
            <input type="hidden" id="reportType">
            <input type="text" id="repName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="email" id="repEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <textarea id="repMsg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø©..." rows="4"></textarea>
            <button class="btn" style="width:100%" onclick="submitReport()">Ø§Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('notifModal')">&times;</span>
            <h3 data-i18n="notifTitle">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            <div id="notifList" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div id="privacyModal" class="modal">
        <div class="modal-content" style="max-height:80vh; overflow-y:auto;">
            <span class="close" onclick="closeModal('privacyModal')">&times;</span>
            <h3>Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</h3>
            <p style="color:#555; line-height:1.6">Ù†Ø­Ù† Ù†Ù„ØªØ²Ù… Ø¨Ø­Ù…Ø§ÙŠØ© Ø®ØµÙˆØµÙŠØªÙƒ. ÙŠØªÙ… Ø¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„ØºØ±Ø¶ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø®Ø¯Ù…Ø© ÙÙ‚Ø· ÙˆÙ„Ø§ ÙŠØªÙ… Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ Ù…Ø¹ Ø£Ø·Ø±Ø§Ù Ø«Ø§Ù„Ø«Ø©.</p>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div>
            <h4 data-i18n="aboutUs">Ù…Ù† Ù†Ø­Ù†</h4>
            <p data-i18n="aboutDesc">Ù…Ù†ØµØ© Ù„Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø¨Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†.</p>
            <p style="margin-top:10px;"><i class="fas fa-map-marker-alt"></i> Ø§Ù„Ø±ÙˆÙŠØ¨Ø©ØŒ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©</p>
        </div>
        <div>
            <h4 data-i18n="impLinks">Ø±ÙˆØ§Ø¨Ø· Ù‡Ø§Ù…Ø©</h4>
            <ul>
                <li onclick="openModal('privacyModal')" style="cursor:pointer;"><i class="fas fa-shield-alt"></i> <span data-i18n="privacy">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</span></li>
                <li><a href="tel:0559293773" style="color:white; text-decoration:none;"><i class="fas fa-phone"></i> 0559293773</a></li>
                <li onclick="openReportModal('Report')" style="cursor:pointer;"><i class="fas fa-exclamation-circle"></i> <span data-i18n="report">Ø§Ù„Ø§Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„</span></li>
            </ul>
        </div>
    </footer>

    <script>
        // Force remove loader after 3s to prevent freezing
        window.addEventListener('load', () => setTimeout(() => {
            const l = document.getElementById('loadingScreen');
            if(l) { l.style.opacity = '0'; setTimeout(()=>l.style.display='none', 500); }
        }, 3000));
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o", authDomain: "mourafik-e9161.firebaseapp.com", projectId: "mourafik-e9161", storageBucket: "mourafik-e9161.firebasestorage.app", messagingSenderId: "133465287328", appId: "1:133465287328:web:9de5b3bd709099d885b7c5", measurementId: "G-MDJXPZ7G5L" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const wilayasAr = ["01 Ø£Ø¯Ø±Ø§Ø±","02 Ø§Ù„Ø´Ù„Ù","03 Ø§Ù„Ø£ØºÙˆØ§Ø·","04 Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ","05 Ø¨Ø§ØªÙ†Ø©","06 Ø¨Ø¬Ø§ÙŠØ©","07 Ø¨Ø³ÙƒØ±Ø©","08 Ø¨Ø´Ø§Ø±","09 Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©","10 Ø§Ù„Ø¨ÙˆÙŠØ±Ø©","11 ØªÙ…Ù†Ø±Ø§Ø³Øª","12 ØªØ¨Ø³Ø©","13 ØªÙ„Ù…Ø³Ø§Ù†","14 ØªÙŠØ§Ø±Øª","15 ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ","16 Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±","17 Ø§Ù„Ø¬Ù„ÙØ©","18 Ø¬ÙŠØ¬Ù„","19 Ø³Ø·ÙŠÙ","20 Ø³Ø¹ÙŠØ¯Ø©","21 Ø³ÙƒÙŠÙƒØ¯Ø©","22 Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³","23 Ø¹Ù†Ø§Ø¨Ø©","24 Ù‚Ø§Ù„Ù…Ø©","25 Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©","26 Ø§Ù„Ù…Ø¯ÙŠØ©","27 Ù…Ø³ØªØºØ§Ù†Ù…","28 Ø§Ù„Ù…Ø³ÙŠÙ„Ø©","29 Ù…Ø¹Ø³ÙƒØ±","30 ÙˆØ±Ù‚Ù„Ø©","31 ÙˆÙ‡Ø±Ø§Ù†","32 Ø§Ù„Ø¨ÙŠØ¶","33 Ø¥Ù„ÙŠØ²ÙŠ","34 Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬","35 Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³","36 Ø§Ù„Ø·Ø§Ø±Ù","37 ØªÙ†Ø¯ÙˆÙ","38 ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª","39 Ø§Ù„ÙˆØ§Ø¯ÙŠ","40 Ø®Ù†Ø´Ù„Ø©","41 Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³","42 ØªÙŠØ¨Ø§Ø²Ø©","43 Ù…ÙŠÙ„Ø©","44 Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰","45 Ø§Ù„Ù†Ø¹Ø§Ù…Ø©","46 Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª","47 ØºØ±Ø¯Ø§ÙŠØ©","48 ØºÙ„ÙŠØ²Ø§Ù†","49 ØªÙŠÙ…ÙŠÙ…ÙˆÙ†","50 Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±","51 Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„","52 Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³","53 Ø¹ÙŠÙ† ØµØ§Ù„Ø­","54 Ø¹ÙŠÙ† Ù‚Ø²Ø§Ù…","55 ØªÙ‚Ø±Øª","56 Ø¬Ø§Ù†Øª","57 Ø§Ù„Ù…ØºÙŠØ±","58 Ø§Ù„Ù…Ù†ÙŠØ¹Ø©"];
        const wilayasFr = ["01 Adrar","02 Chlef","03 Laghouat","04 Oum El Bouaghi","05 Batna","06 BÃ©jaÃ¯a","07 Biskra","08 BÃ©char","09 Blida","10 Bouira","11 Tamanrasset","12 TÃ©bessa","13 Tlemcen","14 Tiaret","15 Tizi Ouzou","16 Alger","17 Djelfa","18 Jijel","19 SÃ©tif","20 SaÃ¯da","21 Skikda","22 Sidi Bel AbbÃ¨s","23 Annaba","24 Guelma","25 Constantine","26 MÃ©dÃ©a","27 Mostaganem","28 M'Sila","29 Mascara","30 Ouargla","31 Oran","32 El Bayadh","33 Illizi","34 Bordj Bou ArrÃ©ridj","35 BoumerdÃ¨s","36 El Tarf","37 Tindouf","38 Tissemsilt","39 El Oued","40 Khenchela","41 Souk Ahras","42 Tipaza","43 Mila","44 AÃ¯n Defla","45 NaÃ¢ma","46 AÃ¯n TÃ©mouchent","47 GhardaÃ¯a","48 Relizane","49 Timimoun","50 Bordj Badji Mokhtar","51 Ouled Djellal","52 BÃ©ni AbbÃ¨s","53 In Salah","54 In Guezzam","55 Touggourt","56 Djanet","57 El M'Ghair","58 El Meniaa"];

        const i18n = {
            ar: { logo: "Ù…Ø±Ø§ÙÙ‚ | Morafik", home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", login: "Ø¯Ø®ÙˆÙ„", register: "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", logout: "Ø®Ø±ÙˆØ¬", heroTitle: "Ù…Ø±Ø§ÙÙ‚Ø© Ù„Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©", heroSub: "Ù†Ø±Ø¨Ø·Ùƒ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†", startNow: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†", loginTitle: "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", loginBtn: "Ø¯Ø®ÙˆÙ„", noAccount: "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ", createOne: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨", regTitle: "Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨", roleParent: "ÙˆÙ„ÙŠ Ø·ÙÙ„", roleComp: "Ù…Ø±Ø§ÙÙ‚ / Ø£Ø®ØµØ§Ø¦ÙŠ", regBtn: "ØªØ³Ø¬ÙŠÙ„", haveAccount: "Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ", editProfile: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù", searchTitle: "Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±Ø§ÙÙ‚", searchBtn: "Ø¨Ø­Ø«", myRequests: "Ø·Ù„Ø¨Ø§ØªÙŠ", totalReq: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª", newReq: "Ø¬Ø¯ÙŠØ¯Ø©", accReq: "Ù…Ù‚Ø¨ÙˆÙ„Ø©", incomingReq: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©", bookTitle: "Ø­Ø¬Ø² Ù…Ø±Ø§ÙÙ‚", childName: "Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„", childAge: "Ø§Ù„Ø³Ù†", eduLevel: "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ", childStatus: "Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙÙ„", followType: "Ù†ÙˆØ¹ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©", confirmBook: "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²", editTitle: "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ", profilePic: "ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©", fullName: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", phone: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", wilaya: "Ø§Ù„ÙˆÙ„Ø§ÙŠØ©", updateCert: "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©", newPass: "ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©", saveChanges: "Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª", rateTitle: "ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©", ratingScore: "Ø§Ù„ØªÙ‚ÙŠÙŠÙ…", yourReview: "Ø±Ø£ÙŠÙƒ", submitRate: "Ø¥Ø±Ø³Ø§Ù„", notifTitle: "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª", aboutUs: "Ù…Ù† Ù†Ø­Ù†", aboutDesc: "Ù…Ù†ØµØ© Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ù„Ù„Ù…Ø±Ø§ÙÙ‚Ø© Ø§Ù„Ù…Ø¯Ø±Ø³ÙŠØ©", impLinks: "Ø±ÙˆØ§Ø¨Ø· Ù‡Ø§Ù…Ø©", privacy: "Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©", contact: "Ø§ØªØµÙ„ Ø¨Ù†Ø§", report: "Ø§Ù„Ø§Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„", certLabel: "Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© (PDF)", available: "Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ù…Ù„", spec1: "Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯", spec2: "Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ", emailPh: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", passPh: "ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", namePh: "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", phonePh: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", confPassPh: "ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", wait: "ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...", acc: "Ù…Ù‚Ø¨ÙˆÙ„", rej: "Ù…Ø±ÙÙˆØ¶", comp: "Ù…ÙƒØªÙ…Ù„", accept: "Ù‚Ø¨ÙˆÙ„", reject: "Ø±ÙØ¶", book: "Ø­Ø¬Ø²" },
            fr: { logo: "Morafik | AlgÃ©rie", home: "Accueil", login: "Connexion", register: "Inscription", logout: "DÃ©connexion", heroTitle: "Accompagnement Scolaire", heroSub: "Trouvez le meilleur accompagnateur", startNow: "Commencer", loginTitle: "Se connecter", loginBtn: "Connexion", noAccount: "Pas de compte?", createOne: "CrÃ©er un compte", regTitle: "Inscription", roleParent: "Parent", roleComp: "Accompagnateur", regBtn: "S'inscrire", haveAccount: "DÃ©jÃ  inscrit?", editProfile: "Modifier Profil", searchTitle: "Chercher un accompagnateur", searchBtn: "Chercher", myRequests: "Mes demandes", totalReq: "Total", newReq: "Nouveaux", accReq: "AcceptÃ©es", incomingReq: "Demandes reÃ§ues", bookTitle: "RÃ©server", childName: "Nom de l'enfant", childAge: "Ã‚ge", eduLevel: "Niveau scolaire", childStatus: "Ã‰tat de l'enfant", followType: "Type de suivi", confirmBook: "Confirmer", editTitle: "Modifier Profil", profilePic: "Changer Photo", fullName: "Nom complet", phone: "TÃ©lÃ©phone", wilaya: "Wilaya", updateCert: "Mise Ã  jour Certificat", newPass: "Nouveau mot de passe", saveChanges: "Enregistrer", rateTitle: "Ã‰valuer", ratingScore: "Note", yourReview: "Avis", submitRate: "Envoyer", notifTitle: "Notifications", aboutUs: "Ã€ propos", aboutDesc: "Plateforme d'accompagnement scolaire", impLinks: "Liens utiles", privacy: "ConfidentialitÃ©", contact: "Contactez-nous", report: "Signaler un problÃ¨me", certLabel: "Certificat (PDF)", available: "Disponible", spec1: "Accompagnateur Autisme", spec2: "Psychologue", emailPh: "Email", passPh: "Mot de passe", namePh: "Nom complet", phonePh: "NumÃ©ro de tÃ©lÃ©phone", confPassPh: "Confirmer mot de passe", wait: "En attente...", acc: "AcceptÃ©", rej: "RefusÃ©", comp: "TerminÃ©", accept: "Accepter", reject: "Refuser", book: "RÃ©server" }
        };

        let curLang = 'ar';
        let currentUser = null;
        let selectedRole = 'parent';

        window.changeLang = () => {
            curLang = curLang === 'ar' ? 'fr' : 'ar';
            document.dir = curLang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = i18n[curLang][el.getAttribute('data-i18n')]);
            document.querySelectorAll('[data-i18n-ph]').forEach(el => el.placeholder = i18n[curLang][el.getAttribute('data-i18n-ph')]);
            populateSelects();
            if(currentUser && currentUser.role === 'parent') loadParentReqs();
            if(currentUser && currentUser.role === 'companion') loadCompReqs();
            if(document.getElementById('searchResults').innerHTML !== '') searchCompanions();
        };

        window.router = (route) => {
            document.querySelectorAll('section').forEach(s => s.style.display = 'none');
            const map = { 'hero':'hero', 'login':'login', 'register':'register', 'parent':'parentDash', 'companion':'companionDash', 'admin':'adminDash' };
            const el = document.getElementById(map[route] || 'hero');
            if(el) { el.style.display = (route === 'hero') ? 'flex' : 'block'; el.classList.remove('fade-in'); void el.offsetWidth; el.classList.add('fade-in'); }
        };

        window.populateSelects = () => {
            const list = curLang === 'ar' ? wilayasAr : wilayasFr;
            ['regWilaya', 'searchWilaya', 'edWilaya'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { const v = el.value; el.innerHTML = ''; list.forEach((w, i) => el.innerHTML += `<option value="${wilayasAr[i]}">${w}</option>`); el.value = v; }
            });
            ['searchSpec', 'regSpec'].forEach(id => {
                const el = document.getElementById(id);
                if(el) { el.options[0].text = i18n[curLang].spec1; el.options[1].text = i18n[curLang].spec2; }
            });
        };
        
        window.setRole = (r) => {
            selectedRole = r;
            document.getElementById('roleParent').style.background = r === 'parent' ? 'var(--secondary-color)' : '#eee';
            document.getElementById('roleParent').style.color = r === 'parent' ? '#fff' : '#333';
            document.getElementById('roleComp').style.background = r === 'companion' ? 'var(--secondary-color)' : '#eee';
            document.getElementById('roleComp').style.color = r === 'companion' ? '#fff' : '#333';
            document.getElementById('compFields').style.display = r === 'companion' ? 'block' : 'none';
        };

        window.openModal = (id) => document.getElementById(id).style.display = 'block';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                if(currentUser && currentUser.uid === user.uid) { document.getElementById('loadingScreen').style.display='none'; return; }
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    currentUser = snap.data();
                    if(currentUser.isBlocked) { await signOut(auth); Swal.fire('Error','Blocked','error'); return; }
                    document.getElementById('navLogin').style.display = 'none'; document.getElementById('navReg').style.display = 'none'; document.getElementById('navLogout').style.display = 'block'; document.getElementById('notifWrapper').style.display = 'block';
                    if(currentUser.role === 'parent') { initParent(); window.router('parent'); }
                    else if(currentUser.role === 'companion') { initComp(); window.router('companion'); }
                    else if(currentUser.email === 'admin' || user.email === 'admin@morafik.dz') { initAdmin(); window.router('admin'); }
                }
            } else {
                currentUser = null; document.getElementById('navLogin').style.display = 'block'; document.getElementById('navReg').style.display = 'block'; document.getElementById('navLogout').style.display = 'none'; document.getElementById('notifWrapper').style.display = 'none';
                if(document.getElementById('parentDash').style.display === 'block' || document.getElementById('companionDash').style.display === 'block') window.router('hero');
            }
            document.getElementById('loadingScreen').style.display = 'none';
        });

        window.handleLogin = async () => {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
            if(e === 'admin' && p === 'abobob123') { initAdmin(); window.router('admin'); return; }
            try { await signInWithEmailAndPassword(auth, e, p); } catch { Swal.fire('Ø®Ø·Ø£', 'Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©', 'error'); }
        };

        window.handleRegister = async () => {
            const e = document.getElementById('regEmail').value, p = document.getElementById('regPass').value;
            if(p !== document.getElementById('regConfPass').value) return Swal.fire('Ø®Ø·Ø£', 'ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©', 'error');
            try {
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                const data = { uid: cred.user.uid, fullName: document.getElementById('regName').value, email: e, phone: document.getElementById('regPhone').value, wilaya: document.getElementById('regWilaya').value, role: selectedRole, isBlocked: false, password_stored: p, createdAt: serverTimestamp() };
                if(selectedRole === 'companion') { data.specialty = document.getElementById('regSpec').value; data.isAvailable = true; }
                await setDoc(doc(db, "users", cred.user.uid), data);
                Swal.fire('ØªÙ…', 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨', 'success');
            } catch(err) { Swal.fire('Ø®Ø·Ø£', err.message, 'error'); }
        };

        window.logout = () => signOut(auth).then(()=>location.reload());

        function initParent() {
            document.getElementById('pName').innerText = currentUser.fullName;
            document.getElementById('pImg').src = currentUser.photoURL || "https://via.placeholder.com/100";
            populateSelects(); loadParentReqs(); loadNotifications();
        }

        window.searchCompanions = async () => {
            const s = document.getElementById('searchSpec').value, w = document.getElementById('searchWilaya').value;
            const res = document.getElementById('searchResults');
            res.innerHTML = '<p style="text-align:center">Loading...</p>';
            const q = query(collection(db, "users"), where("role", "==", "companion"), where("specialty", "==", s), where("wilaya", "==", w));
            const snap = await getDocs(q);
            let html = '';
            snap.forEach(d => {
                const u = d.data(); if(u.isBlocked) return;
                html += `<div class="req-card"><div style="display:flex;gap:10px;align-items:center;"><img src="${u.photoURL||'https://via.placeholder.com/50'}" style="width:60px;height:60px;border-radius:50%;object-fit:cover;"><div><strong>${u.fullName}</strong><br><small>${u.specialty}</small></div></div><div style="text-align:left"><span style="color:${u.isAvailable?'green':'red'};font-weight:bold;">â— ${u.isAvailable?(curLang=='ar'?'Ù…ØªØ§Ø­':'Available'):'Busy'}</span><br><button class="btn" style="margin-top:10px;padding:8px 20px;" onclick="openBookModal('${u.uid}')">${i18n[curLang].book}</button></div></div>`;
            });
            res.innerHTML = html || `<p style="text-align:center;padding:20px;color:#999;">${curLang=='ar'?'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬':'No results'}</p>`;
        };

        window.openBookModal = (cid) => { document.getElementById('bookCompId').value = cid; openModal('bookingModal'); };
        window.submitBooking = async () => {
            const cid = document.getElementById('bookCompId').value;
            const data = { parentId: currentUser.uid, parentName: currentUser.fullName, companionId: cid, childName: document.getElementById('bkChildName').value, age: document.getElementById('bkChildAge').value, level: document.getElementById('bkLevel').value, status: document.getElementById('bkStatus').value, type: document.getElementById('bkType').value, reqStatus: 'pending', timestamp: serverTimestamp() };
            if(!data.childName) return Swal.fire('Error', 'Fill fields', 'warning');
            await addDoc(collection(db, "requests"), data);
            await addDoc(collection(db, "notifications"), { targetId: cid, msg: `New request from ${currentUser.fullName}`, read: false, timestamp: serverTimestamp() });
            closeModal('bookingModal'); Swal.fire('ØªÙ…', 'ØªÙ… Ø§Ù„Ø§Ø±Ø³Ø§Ù„', 'success'); loadParentReqs();
        };

        async function loadParentReqs() {
            const snap = await getDocs(query(collection(db, "requests"), where("parentId", "==", currentUser.uid)));
            let docs = []; snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
            docs.sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0));
            let html = '';
            for(const r of docs) {
                const cSnap = await getDoc(doc(db, "users", r.companionId));
                const c = cSnap.exists() ? cSnap.data() : {fullName:'Unknown', phone:'-'};
                let st = r.reqStatus === 'pending' ? `<span style="color:orange">${i18n[curLang].wait}</span>` : 
                         r.reqStatus === 'accepted' ? `<div style="background:#f0fff4;padding:10px;border-radius:10px;border:1px solid green"><p style="color:green;font-weight:bold">${i18n[curLang].acc}!</p><p>ğŸ“ <a href="tel:${c.phone}" class="phone-link">${c.phone}</a></p><button class="btn" style="font-size:12px;margin-top:5px" onclick="openRateModal('${r.id}')">Rate</button></div>` :
                         r.reqStatus === 'completed' ? `<span style="color:blue">${i18n[curLang].comp}</span>` : `<span style="color:red">${i18n[curLang].rej}</span>`;
                html += `<div class="req-card"><div><strong>To: ${c.fullName}</strong><p>${r.childName}</p></div><div>${st}</div></div>`;
            }
            document.getElementById('parentReqs').innerHTML = html || `<p style="text-align:center;color:#999">No requests</p>`;
        }

        window.openRateModal = (id) => { document.getElementById('rateReqId').value = id; openModal('ratingModal'); };
        window.submitRating = async () => {
            await updateDoc(doc(db, "requests", document.getElementById('rateReqId').value), { reqStatus: 'completed', rating: document.getElementById('rtScore').value, review: document.getElementById('rtReview').value });
            closeModal('ratingModal'); loadParentReqs();
        };

        function initComp() {
            document.getElementById('cName').innerText = currentUser.fullName;
            document.getElementById('cSpec').innerText = currentUser.specialty;
            document.getElementById('cImg').src = currentUser.photoURL || "https://via.placeholder.com/100";
            document.getElementById('availToggle').checked = currentUser.isAvailable;
            loadCompReqs(); loadNotifications();
        }
        window.toggleAvail = async () => { await updateDoc(doc(db, "users", currentUser.uid), { isAvailable: document.getElementById('availToggle').checked }); };

        async function loadCompReqs() {
            const snap = await getDocs(query(collection(db, "requests"), where("companionId", "==", currentUser.uid)));
            let docs = []; snap.forEach(d => docs.push({ id: d.id, ...d.data() }));
            docs.sort((a,b) => (b.timestamp?.seconds||0) - (a.timestamp?.seconds||0));
            let html = '', t=0, n=0, a=0;
            for(const r of docs) {
                t++; if(r.reqStatus==='pending') n++; if(r.reqStatus==='accepted'||r.reqStatus==='completed') a++;
                let phone = '';
                if(r.reqStatus==='accepted'||r.reqStatus==='completed') {
                    const pSnap = await getDoc(doc(db, "users", r.parentId));
                    const p = pSnap.exists() ? pSnap.data() : {phone:'-'};
                    phone = `<br>ğŸ“ <a href="tel:${p.phone}" class="phone-link">${p.phone}</a>`;
                }
                let acts = r.reqStatus==='pending' ? `<button class="btn" style="background:green;font-size:12px" onclick="ansReq('${r.id}','accepted','${r.parentId}')">${i18n[curLang].accept}</button><button class="btn btn-red" style="font-size:12px" onclick="ansReq('${r.id}','rejected','${r.parentId}')">${i18n[curLang].reject}</button>` : `<b>${r.reqStatus}</b>`;
                html += `<div class="req-card"><div><strong>${r.parentName}</strong><p>${r.childName} (${r.age}) - ${r.status}</p>${phone}</div><div>${acts}</div></div>`;
            }
            document.getElementById('compReqs').innerHTML = html;
            document.getElementById('stTotal').innerText = t; document.getElementById('stNew').innerText = n; document.getElementById('stAcc').innerText = a;
        }

        window.ansReq = async (rid, st, pid) => {
            await updateDoc(doc(db, "requests", rid), { reqStatus: st });
            await addDoc(collection(db, "notifications"), { targetId: pid, msg: `Request ${st}`, read: false, timestamp: serverTimestamp() });
            loadCompReqs();
        };

        async function loadNotifications() {
            const snap = await getDocs(query(collection(db, "notifications"), where("targetId", "==", currentUser.uid)));
            let docs = []; snap.forEach(d => docs.push(d.data()));
            docs.sort((a,b)=>(b.timestamp?.seconds||0)-(a.timestamp?.seconds||0));
            let html = '', unread = 0;
            docs.forEach(n => { if(!n.read) unread++; html += `<div style="padding:10px;border-bottom:1px solid #eee">${n.msg}</div>`; });
            document.getElementById('notifList').innerHTML = html;
            if(unread>0) { document.getElementById('notifBadge').style.display='flex'; document.getElementById('notifBadge').innerText=unread; }
        }
        window.openNotifModal = () => { openModal('notifModal'); document.getElementById('notifBadge').style.display='none'; };

        // Footer Actions
        window.openReportModal = async (type) => {
            if(!currentUser) return Swal.fire('Alert', 'Login First', 'warning');
            document.getElementById('reportTitle').innerText = type === 'Report' ? 'Ø§Ø¨Ù„Ø§Øº' : 'Ø§ØªØµÙ„ Ø¨Ù†Ø§';
            document.getElementById('reportType').value = type;
            document.getElementById('repName').value = currentUser.fullName;
            document.getElementById('repEmail').value = currentUser.email;
            openModal('reportModal');
        };
        window.submitReport = async () => {
            await addDoc(collection(db, "messages"), { type: document.getElementById('reportType').value, text: document.getElementById('repMsg').value, name: document.getElementById('repName').value, email: document.getElementById('repEmail').value, uid: currentUser.uid, timestamp: serverTimestamp() });
            closeModal('reportModal'); Swal.fire('ØªÙ…', 'Sent', 'success');
        };

        // Admin
        function initAdmin() { loadAdminData(); renderAdmin(); }
        async function loadAdminData() {
            const u = await getDocs(collection(db, "users")); document.getElementById('adUsers').innerText = u.size;
            const r = await getDocs(collection(db, "requests")); document.getElementById('adReqsTotal').innerText = r.size;
            const m = await getDocs(collection(db, "messages")); document.getElementById('adMsgs').innerText = m.size;
            
            let msgHtml = '';
            m.forEach(d => { const x=d.data(); msgHtml += `<div class="msg-card"><span class="msg-tag">${x.type}</span><br><b>${x.name}</b>: ${x.text}</div>`; });
            document.getElementById('adminMessagesList').innerHTML = msgHtml;
        }
        window.sendAdminNotif = async () => {
            const msg = document.getElementById('adminNotifText').value, target = document.getElementById('adminNotifTarget').value;
            let q = collection(db, "users"); if(target!=='all') q = query(q, where("role","==",target));
            const users = await getDocs(q);
            users.forEach(u => addDoc(collection(db, "notifications"), { targetId: u.id, msg: `Admin: ${msg}`, read: false, timestamp: serverTimestamp() }));
            Swal.fire('Sent', `To ${users.size} users`, 'success');
        };
        async function renderAdmin() {
            const snap = await getDocs(collection(db, "users")); let html = '';
            snap.forEach(d => { const u=d.data(); html += `<tr><td>${u.fullName}</td><td>${u.role}</td><td>${u.isBlocked?'Blocked':'Active'}</td><td><button onclick="toggleBlock('${d.id}',${u.isBlocked})">${u.isBlocked?'Unblock':'Block'}</button></td></tr>`; });
            document.querySelector('#admTable tbody').innerHTML = html;
        }
        window.toggleBlock = async(id,st) => { await updateDoc(doc(db,"users",id),{isBlocked:!st}); renderAdmin(); };

        // Edit Profile
        window.openEditModal = () => {
            document.getElementById('edName').value = currentUser.fullName;
            document.getElementById('edPhone').value = currentUser.phone;
            populateSelects();
            document.getElementById('edWilaya').value = currentUser.wilaya;
            if(currentUser.role === 'companion') document.getElementById('compEditFields').style.display = 'block';
            openModal('editModal');
        };
        window.saveProfile = async () => {
            const file = document.getElementById('edImg').files[0];
            let updates = { fullName: document.getElementById('edName').value, phone: document.getElementById('edPhone').value, wilaya: document.getElementById('edWilaya').value };
            if(file) {
                const reader = new FileReader();
                reader.onload = async (e) => { updates.photoURL = e.target.result; await finishUp(updates); };
                reader.readAsDataURL(file);
            } else await finishUp(updates);
        };
        async function finishUp(updates) {
            await updateDoc(doc(db,"users",currentUser.uid), updates);
            currentUser = {...currentUser, ...updates};
            closeModal('editModal'); Swal.fire('ØªÙ…', 'Updated', 'success');
            if(currentUser.role==='parent') initParent(); else initComp();
        }

        window.populateSelects();
    </script>
</body>
</html>
