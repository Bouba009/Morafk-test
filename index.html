<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±Ø§ÙÙ‚ | Morafik - Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„Ùƒ Ø¨Ø£Ù…Ø§Ù†</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --bg-color: #f3f4f6;
            --text-main: #1f2937;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        
        body { background-color: var(--bg-color); color: var(--text-main); overflow-x: hidden; min-height: 100vh; }

        /* Background */
        .fixed-bg { position: fixed; inset: 0; background: url('https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') center/cover no-repeat; z-index: -10; animation: zoom 25s infinite alternate; }
        @keyframes zoom { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
        .bg-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: -9; backdrop-filter: blur(3px); }

        /* Header */
        header { background: rgba(255,255,255,0.95); padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; position: fixed; width: 100%; top: 0; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .logo { font-size: 22px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; gap: 15px; align-items: center; }
        .nav-btn { background: none; border: none; font-size: 15px; font-weight: bold; cursor: pointer; color: var(--text-main); }
        
        /* Notifications Icon */
        .notif-wrapper { position: relative; cursor: pointer; margin-left: 10px; }
        .notif-icon { font-size: 22px; color: var(--primary); }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 11px; display: flex; justify-content: center; align-items: center; border: 2px solid white; display: none; }

        /* Sections */
        .app-section { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; display: flex; flex-direction: column; z-index: 100; transition: transform 0.6s cubic-bezier(0.7,0,0.3,1); overflow-y: auto; background: var(--bg-color); padding-top: 70px; transform: translateY(100vh); opacity: 0; }
        .app-section.active { transform: translateY(0); opacity: 1; z-index: 500; }
        #heroSection { background: transparent; transform: translateY(0); opacity: 1; z-index: 10; justify-content: center; align-items: center; text-align: center; color: white; padding-top: 0; }
        #heroSection.hidden { opacity: 0; pointer-events: none; }

        /* UI Components */
        .hero-title { font-size: 3.5rem; font-weight: 900; margin-bottom: 20px; text-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .cta-btn { padding: 15px 50px; background: var(--secondary); color: white; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4); }
        
        .container-box { width: 100%; max-width: 500px; margin: 30px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); text-align: center; }
        .dashboard-container { width: 95%; max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }

        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px; background: #f9fafb; font-size: 0.95rem; }
        .full-btn { width: 100%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }

        /* --- DASHBOARD GRID (2 per row strict) --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* 2 Columns Always */
            gap: 15px; 
            margin-bottom: 30px; 
        }
        
        .dash-card {
            padding: 20px; border-radius: 16px; color: white; position: relative; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; height: 120px;
        }
        .dash-card h3 { font-size: 2rem; margin: 0; font-weight: 800; }
        .dash-card p { font-size: 0.9rem; margin: 5px 0 0; opacity: 0.9; }
        .dash-card i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); font-size: 2.5rem; opacity: 0.2; }

        /* Card Colors */
        .bg-1 { background: linear-gradient(135deg, #3b82f6, #2563eb); } /* Blue */
        .bg-2 { background: linear-gradient(135deg, #10b981, #059669); } /* Green */
        .bg-3 { background: linear-gradient(135deg, #ef4444, #dc2626); } /* Red */
        .bg-4 { background: linear-gradient(135deg, #f59e0b, #d97706); } /* Orange */
        .bg-dark { background: linear-gradient(135deg, #1f2937, #111827); }

        /* Request Cards */
        .req-list { display: flex; flex-direction: column; gap: 15px; }
        .req-card { 
            background: white; border-radius: 15px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); 
            border-right: 5px solid #ccc; display: flex; flex-direction: column; gap: 8px; 
        }
        .req-card.pending { border-color: #f59e0b; }
        .req-card.accepted { border-color: #10b981; }
        .req-card.rejected { border-color: #ef4444; }
        
        .time-stamp { font-size: 0.8rem; color: #888; display: flex; align-items: center; gap: 5px; }

        /* Admin Table */
        .admin-table { width: 100%; background: white; border-collapse: collapse; border-radius: 10px; overflow: hidden; margin-top: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .admin-table th { background: var(--primary); color: white; padding: 12px; text-align: right; }
        .admin-table td { padding: 12px; border-bottom: 1px solid #eee; }

        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: white; width: 90%; max-width: 600px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }

        /* Custom Select */
        select { display: none; }
        .custom-select-wrapper { position: relative; width: 100%; margin-bottom: 10px; }
        .custom-select { position: relative; display: flex; flex-direction: column; }
        .custom-select__trigger { padding: 12px; font-size: 0.95rem; color: #333; background: #fff; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .custom-options { position: absolute; display: block; top: 100%; left: 0; right: 0; background: #fff; border: 1px solid #ddd; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); opacity: 0; visibility: hidden; pointer-events: none; transform: translateY(-10px); transition: 0.3s; z-index: 1000; max-height: 200px; overflow-y: auto; }
        .custom-select.open .custom-options { opacity: 1; visibility: visible; pointer-events: all; transform: translateY(0); }
        .custom-option { padding: 10px; cursor: pointer; border-bottom: 1px solid #f5f5f5; }
        .custom-option:hover { background-color: var(--secondary); color: white; }

        @media (max-width: 768px) { .hero-title { font-size: 2.5rem; } }
    </style>
</head>
<body>

    <div class="fixed-bg"></div>
    <div class="bg-overlay"></div>

    <header>
        <div class="logo"><i class="fas fa-hands-helping"></i> <span>Ù…Ø±Ø§ÙÙ‚</span></div>
        <div class="nav-links">
            
            <!-- Notifications -->
            <div class="notif-wrapper" onclick="openNotif()" style="display:none;" id="notifBtn">
                <i class="fas fa-bell notif-icon"></i>
                <span id="notifBadge" class="notif-badge">0</span>
            </div>

            <button class="nav-btn" style="border:1px solid #333; border-radius:15px; padding:2px 10px;" onclick="switchLang()">FR / AR</button>
            
            <div id="guestLinks">
                <button class="nav-btn" onclick="navigateTo('heroSection')" data-i18n="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button class="nav-btn" onclick="navigateTo('loginSection')" data-i18n="login">Ø¯Ø®ÙˆÙ„</button>
            </div>
            <div id="userLinks" style="display:none;">
                <button class="nav-btn" onclick="openProfile()" data-i18n="profile">Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
                <button class="nav-btn" style="color:#ef4444;" onclick="logout()" data-i18n="logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </header>

    <!-- 1. HERO -->
    <section id="heroSection" class="app-section active">
        <h1 class="hero-title" data-i18n="heroTitle">Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„Ùƒ Ø¨Ø£Ù…Ø§Ù†</h1>
        <p style="font-size:1.4rem; color:white; margin-bottom:30px;" data-i18n="heroSub">Ù†Ø±Ø¨Ø·Ùƒ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ† ÙˆØ§Ù„Ø£Ø®ØµØ§Ø¦ÙŠÙŠÙ† Ø§Ù„Ù†ÙØ³ÙŠÙŠÙ†.</p>
        <button class="cta-btn" onclick="navigateTo('registerSection')" data-i18n="startNow">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
    </section>

    <!-- 2. REGISTER -->
    <section id="registerSection" class="app-section">
        <div class="container-box">
            <h2 data-i18n="register">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="setRole('parent')" id="btnRoleParent" style="flex:1; padding:10px; background:var(--primary); color:white; border-radius:10px; border:none;" data-i18n="parent">ÙˆÙ„ÙŠ Ø£Ù…Ø±</button>
                <button onclick="setRole('companion')" id="btnRoleComp" style="flex:1; padding:10px; background:transparent; border:1px solid #ccc; border-radius:10px;" data-i18n="companion">Ù…Ø±Ø§ÙÙ‚</button>
            </div>
            <input type="text" id="regName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" data-ph="fullName">
            <input type="email" id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" data-ph="email">
            <input type="tel" id="regPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" data-ph="phone">
            
            <div class="custom-select-wrapper"><select id="regWilaya"></select></div>

            <div id="compFields" style="display:none;">
                <div class="custom-select-wrapper">
                    <select id="regSpec">
                        <option value="Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯" data-i18n="spec1">Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯</option>
                        <option value="Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ" data-i18n="spec2">Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ</option>
                    </select>
                </div>
                <input type="file" id="regDoc" accept="application/pdf">
            </div>
            <input type="password" id="regPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-ph="pass">
            <button class="full-btn" onclick="handleRegister()" data-i18n="registerBtn">ØªØ³Ø¬ÙŠÙ„</button>
        </div>
    </section>

    <!-- 3. LOGIN -->
    <section id="loginSection" class="app-section">
        <div class="container-box">
            <h2 data-i18n="login">Ø¯Ø®ÙˆÙ„</h2>
            <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" data-ph="email">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-ph="pass">
            <button class="full-btn" onclick="handleLogin()" data-i18n="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </section>

    <!-- 4. PARENT DASHBOARD -->
    <section id="parentDash" class="app-section">
        <div class="dashboard-container">
            <h2 style="color:var(--primary); margin-bottom:20px;"><span data-i18n="welcome">Ù…Ø±Ø­Ø¨Ø§Ù‹</span> <span id="pName"></span></h2>
            
            <!-- Parent Stats (2x2 Grid) -->
            <div class="stats-grid">
                <div class="dash-card bg-1">
                    <i class="fas fa-list"></i>
                    <h3 id="pTotal">0</h3>
                    <p data-i18n="total">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                </div>
                <div class="dash-card bg-2">
                    <i class="fas fa-check"></i>
                    <h3 id="pAccepted">0</h3>
                    <p data-i18n="accepted">Ù…Ù‚Ø¨ÙˆÙ„Ø©</p>
                </div>
                <div class="dash-card bg-3">
                    <i class="fas fa-times"></i>
                    <h3 id="pRejected">0</h3>
                    <p data-i18n="canceled">Ù…Ù„ØºÙŠØ©</p>
                </div>
                <div class="dash-card bg-4">
                    <i class="fas fa-clock"></i>
                    <h3 id="pPending">0</h3>
                    <p data-i18n="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
                </div>
            </div>

            <!-- Search Area -->
            <div style="background:white; padding:20px; border-radius:15px; margin-bottom:30px;">
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                    <div class="custom-select-wrapper" style="flex:1;">
                        <select id="searchSpec">
                            <option value="Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯" data-i18n="spec1">Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯</option>
                            <option value="Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ" data-i18n="spec2">Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ</option>
                        </select>
                    </div>
                    <div class="custom-select-wrapper" style="flex:1;"><select id="searchWilaya"></select></div>
                    <button class="full-btn" style="width:auto; padding:0 30px; height:48px;" onclick="searchCompanions()" data-i18n="search">Ø¨Ø­Ø«</button>
                </div>
                <!-- Search Results -->
                <div id="searchResults" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:15px; margin-top:20px;"></div>
            </div>
            
            <h3 data-i18n="myReqs">Ø·Ù„Ø¨Ø§ØªÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)</h3>
            <div id="parentReqs" class="req-list"></div>
        </div>
    </section>

    <!-- 5. COMPANION DASHBOARD -->
    <section id="companionDash" class="app-section">
        <div class="dashboard-container">
            <div style="background:white; padding:20px; border-radius:15px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                <h2><span data-i18n="dashComp">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚</span> <span id="cName"></span></h2>
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="font-weight:bold; font-size:0.9rem;" data-i18n="available">Ø£Ù†Ø§ Ù…ØªØ§Ø­</span>
                    <label class="switch"><input type="checkbox" id="availToggle" onchange="toggleAvail()"><span class="slider round"></span></label>
                </div>
            </div>

            <!-- Companion Stats (2x2 Grid) -->
            <div class="stats-grid">
                <div class="dash-card bg-1">
                    <i class="fas fa-inbox"></i>
                    <h3 id="stTotal">0</h3>
                    <p data-i18n="total">ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                </div>
                <div class="dash-card bg-4">
                    <i class="fas fa-hourglass-start"></i>
                    <h3 id="stPending">0</h3>
                    <p data-i18n="new">Ø¬Ø¯ÙŠØ¯Ø©</p>
                </div>
                <div class="dash-card bg-2">
                    <i class="fas fa-check-circle"></i>
                    <h3 id="stAccepted">0</h3>
                    <p data-i18n="accepted">Ù…Ù‚Ø¨ÙˆÙ„Ø©</p>
                </div>
                <div class="dash-card bg-3">
                    <i class="fas fa-ban"></i>
                    <h3 id="stRejected">0</h3>
                    <p data-i18n="canceled">Ù…Ù„ØºÙŠØ©</p>
                </div>
            </div>

            <h3 data-i18n="incomingReq">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
            <div id="compReqs" class="req-list"></div>
        </div>
    </section>

    <!-- 6. ADMIN DASHBOARD -->
    <section id="adminDash" class="app-section">
        <div class="dashboard-container">
            <h2 style="color:var(--primary);">Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
            
            <!-- Admin Stats (2x2 Grid) -->
            <div class="stats-grid">
                <div class="dash-card bg-dark">
                    <i class="fas fa-users"></i>
                    <h3 id="adUsersCount">0</h3>
                    <p>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
                </div>
                <div class="dash-card bg-1">
                    <i class="fas fa-file-alt"></i>
                    <h3 id="adReqsCount">0</h3>
                    <p>Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p>
                </div>
                <div class="dash-card bg-4">
                    <i class="fas fa-envelope"></i>
                    <h3 id="adMsgsCount">0</h3>
                    <p>Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</p>
                </div>
                <div class="dash-card bg-2">
                    <i class="fas fa-history"></i>
                    <h3>LOGS</h3>
                    <p>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
                </div>
            </div>

            <!-- Notification Sender -->
            <div style="background:white; padding:20px; border-radius:15px; margin-bottom:20px;">
                <h3>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± (Ø¨Ø§Ø³Ù…: ÙØ±ÙŠÙ‚ Ù…Ø±Ø§ÙÙ‚)</h3>
                <div style="display:flex; gap:10px;">
                    <div class="custom-select-wrapper" style="flex:1;">
                        <select id="notifTarget">
                            <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
                            <option value="parent">Ø§Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡</option>
                            <option value="companion">Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</option>
                        </select>
                    </div>
                    <input type="text" id="notifMsg" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©..." style="flex:2;">
                    <button class="full-btn" style="width:auto;" onclick="sendAdminNotif()">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 2fr 1fr; gap:20px;">
                <!-- Table -->
                <div>
                    <h3>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                    <div style="overflow-x:auto;">
                        <table class="admin-table">
                            <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¯ÙˆØ±</th><th>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody id="usersTable"></tbody>
                        </table>
                    </div>
                </div>
                <!-- Logs/Messages -->
                <div>
                    <h3>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª & Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
                    <div id="logsList" style="background:white; padding:15px; border-radius:10px; max-height:400px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- MODALS -->
    
    <!-- Notifications Modal -->
    <div id="notifModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('notifModal')">&times;</span>
            <h3 data-i18n="notifTitle">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            <div id="notifList" style="margin-top:15px;"></div>
        </div>
    </div>

    <!-- Booking Modal -->
    <div id="bookingModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('bookingModal')">&times;</span>
            <h3 style="text-align:center;">Ø­Ø¬Ø²</h3>
            <input type="hidden" id="bkCompId">
            <input type="text" id="bkChild" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <input type="number" id="bkAge" placeholder="Ø§Ù„Ø³Ù†">
                <div class="custom-select-wrapper"><select id="bkLevel"><option>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ù…ØªÙˆØ³Ø·</option><option>Ø®Ø§Øµ</option></select></div>
            </div>
            <div class="custom-select-wrapper"><select id="bkStatus"><option>Ø·ÙŠÙ Ø§Ù„ØªÙˆØ­Ø¯</option><option>ÙØ±Ø· Ø§Ù„Ø­Ø±ÙƒØ©</option><option>Ø¹Ø§Ø¯ÙŠ</option></select></div>
            <div class="custom-select-wrapper"><select id="bkType"><option>Ø¯ÙˆØ§Ù… ÙƒØ§Ù…Ù„</option><option>Ø¬Ù„Ø³Ø§Øª</option></select></div>
            <button class="full-btn" onclick="submitBooking()" data-i18n="confirm">ØªØ£ÙƒÙŠØ¯</button>
        </div>
    </div>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('profileModal')">&times;</span>
            <h3 style="text-align:center;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</h3>
            <div style="text-align:center; margin-bottom:10px;">
                <img id="profImgPreview" src="https://via.placeholder.com/80" style="width:80px; height:80px; border-radius:50%; object-fit:cover;">
                <br><label for="profImgInput" style="color:var(--secondary); cursor:pointer;">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</label>
                <input type="file" id="profImgInput" style="display:none;" onchange="previewImg(this)">
            </div>
            <input type="text" id="edName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="tel" id="edPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
            <div class="custom-select-wrapper"><select id="edWilaya"></select></div>
            <input type="password" id="edPass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <button class="full-btn" onclick="saveProfile()">Ø­ÙØ¸</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o", authDomain: "mourafik-e9161.firebaseapp.com", projectId: "mourafik-e9161", storageBucket: "mourafik-e9161.firebasestorage.app", messagingSenderId: "133465287328", appId: "1:133465287328:web:9de5b3bd709099d885b7c5", measurementId: "G-MDJXPZ7G5L" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let selectedRole = 'parent';
        let currentLang = 'ar';

        const wilayas = [
            {ar: "01 Ø£Ø¯Ø±Ø§Ø±", fr: "01 Adrar"}, {ar: "02 Ø§Ù„Ø´Ù„Ù", fr: "02 Chlef"}, {ar: "03 Ø§Ù„Ø£ØºÙˆØ§Ø·", fr: "03 Laghouat"},
            {ar: "04 Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", fr: "04 Oum El Bouaghi"}, {ar: "05 Ø¨Ø§ØªÙ†Ø©", fr: "05 Batna"}, {ar: "06 Ø¨Ø¬Ø§ÙŠØ©", fr: "06 BÃ©jaÃ¯a"},
            {ar: "07 Ø¨Ø³ÙƒØ±Ø©", fr: "07 Biskra"}, {ar: "08 Ø¨Ø´Ø§Ø±", fr: "08 BÃ©char"}, {ar: "09 Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", fr: "09 Blida"},
            {ar: "10 Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", fr: "10 Bouira"}, {ar: "11 ØªÙ…Ù†Ø±Ø§Ø³Øª", fr: "11 Tamanrasset"}, {ar: "12 ØªØ¨Ø³Ø©", fr: "12 TÃ©bessa"},
            {ar: "13 ØªÙ„Ù…Ø³Ø§Ù†", fr: "13 Tlemcen"}, {ar: "14 ØªÙŠØ§Ø±Øª", fr: "14 Tiaret"}, {ar: "15 ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", fr: "15 Tizi Ouzou"},
            {ar: "16 Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", fr: "16 Alger"}, {ar: "17 Ø§Ù„Ø¬Ù„ÙØ©", fr: "17 Djelfa"}, {ar: "18 Ø¬ÙŠØ¬Ù„", fr: "18 Jijel"},
            {ar: "19 Ø³Ø·ÙŠÙ", fr: "19 SÃ©tif"}, {ar: "20 Ø³Ø¹ÙŠØ¯Ø©", fr: "20 SaÃ¯da"}, {ar: "21 Ø³ÙƒÙŠÙƒØ¯Ø©", fr: "21 Skikda"},
            {ar: "22 Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", fr: "22 Sidi Bel AbbÃ¨s"}, {ar: "23 Ø¹Ù†Ø§Ø¨Ø©", fr: "23 Annaba"}, {ar: "24 Ù‚Ø§Ù„Ù…Ø©", fr: "24 Guelma"},
            {ar: "25 Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", fr: "25 Constantine"}, {ar: "26 Ø§Ù„Ù…Ø¯ÙŠØ©", fr: "26 MÃ©dÃ©a"}, {ar: "27 Ù…Ø³ØªØºØ§Ù†Ù…", fr: "27 Mostaganem"},
            {ar: "28 Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", fr: "28 M'Sila"}, {ar: "29 Ù…Ø¹Ø³ÙƒØ±", fr: "29 Mascara"}, {ar: "30 ÙˆØ±Ù‚Ù„Ø©", fr: "30 Ouargla"},
            {ar: "31 ÙˆÙ‡Ø±Ø§Ù†", fr: "31 Oran"}, {ar: "32 Ø§Ù„Ø¨ÙŠØ¶", fr: "32 El Bayadh"}, {ar: "33 Ø¥Ù„ÙŠØ²ÙŠ", fr: "33 Illizi"},
            {ar: "34 Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", fr: "34 Bordj Bou ArrÃ©ridj"}, {ar: "35 Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", fr: "35 BoumerdÃ¨s"}, {ar: "36 Ø§Ù„Ø·Ø§Ø±Ù", fr: "36 El Tarf"},
            {ar: "37 ØªÙ†Ø¯ÙˆÙ", fr: "37 Tindouf"}, {ar: "38 ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", fr: "38 Tissemsilt"}, {ar: "39 Ø§Ù„ÙˆØ§Ø¯ÙŠ", fr: "39 El Oued"},
            {ar: "40 Ø®Ù†Ø´Ù„Ø©", fr: "40 Khenchela"}, {ar: "41 Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", fr: "41 Souk Ahras"}, {ar: "42 ØªÙŠØ¨Ø§Ø²Ø©", fr: "42 Tipaza"},
            {ar: "43 Ù…ÙŠÙ„Ø©", fr: "43 Mila"}, {ar: "44 Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", fr: "44 AÃ¯n Defla"}, {ar: "45 Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", fr: "45 NaÃ¢ma"},
            {ar: "46 Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", fr: "46 AÃ¯n TÃ©mouchent"}, {ar: "47 ØºØ±Ø¯Ø§ÙŠØ©", fr: "47 GhardaÃ¯a"}, {ar: "48 ØºÙ„ÙŠØ²Ø§Ù†", fr: "48 Relizane"},
            {ar: "49 ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", fr: "49 Timimoun"}, {ar: "50 Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±", fr: "50 Bordj Badji Mokhtar"}, {ar: "51 Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", fr: "51 Ouled Djellal"},
            {ar: "52 Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", fr: "52 BÃ©ni AbbÃ¨s"}, {ar: "53 Ø¹ÙŠÙ† ØµØ§Ù„Ø­", fr: "53 In Salah"}, {ar: "54 Ø¹ÙŠÙ† Ù‚Ø²Ø§Ù…", fr: "54 In Guezzam"},
            {ar: "55 ØªÙ‚Ø±Øª", fr: "55 Touggourt"}, {ar: "56 Ø¬Ø§Ù†Øª", fr: "56 Djanet"}, {ar: "57 Ø§Ù„Ù…ØºÙŠØ±", fr: "57 El M'Ghair"},
            {ar: "58 Ø§Ù„Ù…Ù†ÙŠØ¹Ø©", fr: "58 El Meniaa"}
        ];

        const dict = {
            ar: { home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", login: "Ø¯Ø®ÙˆÙ„", register: "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", logout: "Ø®Ø±ÙˆØ¬", heroTitle: "Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„Ùƒ Ø¨Ø£Ù…Ø§Ù†", heroSub: "Ù†Ø±Ø¨Ø·Ùƒ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†.", startNow: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†", parent: "ÙˆÙ„ÙŠ Ø£Ù…Ø±", companion: "Ù…Ø±Ø§ÙÙ‚", registerBtn: "ØªØ³Ø¬ÙŠÙ„", loginBtn: "Ø¯Ø®ÙˆÙ„", welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹", search: "Ø¨Ø­Ø«", myReqs: "Ø·Ù„Ø¨Ø§ØªÙŠ", new: "Ø¬Ø¯ÙŠØ¯Ø©", accepted: "Ù…Ù‚Ø¨ÙˆÙ„Ø©", canceled: "Ù…Ù„ØºÙŠØ©", results: "Ø§Ù„Ù†ØªØ§Ø¦Ø¬", dashComp: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚", available: "Ù…ØªØ§Ø­", unavailable: "ØºÙŠØ± Ù…ØªØ§Ø­", incomingReq: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©", notifTitle: "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª", bookTitle: "Ø­Ø¬Ø²", confirm: "ØªØ£ÙƒÙŠØ¯", spec1: "Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯", spec2: "Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ", profile: "Ø¨Ø±ÙˆÙØ§ÙŠÙ„", total: "Ø§Ù„ÙƒÙ„", pending: "Ø§Ù†ØªØ¸Ø§Ø±" },
            fr: { home: "Accueil", login: "Connexion", register: "Inscription", logout: "DÃ©connexion", heroTitle: "Accompagner votre enfant", heroSub: "Nous vous connectons aux meilleurs.", startNow: "Commencer", parent: "Parent", companion: "Accompagnateur", registerBtn: "S'inscrire", loginBtn: "Connexion", welcome: "Bienvenue", search: "Chercher", myReqs: "Mes demandes", new: "Nouveau", accepted: "AcceptÃ©", canceled: "AnnulÃ©", results: "RÃ©sultats", dashComp: "Tableau de bord", available: "Disponible", unavailable: "Indisponible", incomingReq: "Demandes reÃ§ues", notifTitle: "Notifications", bookTitle: "RÃ©server", confirm: "Confirmer", spec1: "Accompagnateur Autiste", spec2: "Psychologue", profile: "Profil", total: "Total", pending: "En attente" }
        };

        // --- Init & UI ---
        function populateSelects() {
            const list = wilayas.map(w => `<option value="${w.ar}">${currentLang==='ar'?w.ar:w.fr}</option>`).join('');
            ['regWilaya', 'searchWilaya', 'edWilaya'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = list; });
        }
        populateSelects();

        // Custom Select Logic (Re-run after populate)
        function renderCustomSelects() {
            document.querySelectorAll('select').forEach(select => {
                if (select.nextElementSibling && select.nextElementSibling.classList.contains('custom-select')) { select.nextElementSibling.remove(); }
                const wrapper = document.createElement('div'); wrapper.classList.add('custom-select');
                const trigger = document.createElement('div'); trigger.classList.add('custom-select__trigger');
                trigger.innerHTML = `<span>${select.options[select.selectedIndex] ? select.options[select.selectedIndex].text : 'Select'}</span> <i class="fas fa-chevron-down"></i>`;
                const options = document.createElement('div'); options.classList.add('custom-options');
                Array.from(select.options).forEach(opt => {
                    const option = document.createElement('div'); option.classList.add('custom-option');
                    option.textContent = opt.text; 
                    option.addEventListener('click', () => {
                        select.value = opt.value; trigger.querySelector('span').textContent = opt.text;
                        wrapper.classList.remove('open'); select.dispatchEvent(new Event('change'));
                    });
                    options.appendChild(option);
                });
                trigger.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open')); wrapper.classList.toggle('open'); });
                wrapper.appendChild(trigger); wrapper.appendChild(options); select.parentNode.insertBefore(wrapper, select.nextSibling);
            });
        }
        window.addEventListener('click', () => document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open')));
        setTimeout(renderCustomSelects, 300);

        window.switchLang = () => {
            currentLang = currentLang === 'ar' ? 'fr' : 'ar';
            document.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = dict[currentLang][el.getAttribute('data-i18n')]);
            populateSelects(); renderCustomSelects();
        };

        window.navigateTo = (id) => {
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            if(id === 'heroSection') { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('active'); }
            else { document.getElementById('heroSection').classList.add('hidden'); setTimeout(()=>document.getElementById(id).classList.add('active'),50); }
        };

        window.setRole = (r) => {
            selectedRole = r;
            document.getElementById('btnRoleParent').style.background = r==='parent'?'var(--primary)':'transparent';
            document.getElementById('btnRoleParent').style.color = r==='parent'?'white':'#333';
            document.getElementById('btnRoleComp').style.background = r==='companion'?'var(--primary)':'transparent';
            document.getElementById('btnRoleComp').style.color = r==='companion'?'white':'#333';
            document.getElementById('compFields').style.display = r==='companion'?'block':'none';
        };

        window.closeModal = (id) => document.getElementById(id).classList.remove('open');
        window.openProfile = () => {
            document.getElementById('edName').value = currentUser.fullName;
            document.getElementById('edPhone').value = currentUser.phone;
            if(currentUser.photoURL) document.getElementById('profImgPreview').src = currentUser.photoURL;
            document.getElementById('profileModal').classList.add('open');
        };
        window.previewImg = (input) => {
            if(input.files && input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => document.getElementById('profImgPreview').src = e.target.result;
                r.readAsDataURL(input.files[0]);
            }
        };

        // --- Auth ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                document.getElementById('guestLinks').style.display='none';
                document.getElementById('userLinks').style.display='flex';
                document.getElementById('notifBtn').style.display='block';
                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists()) {
                    currentUser = snap.data();
                    if(currentUser.isBlocked) { await signOut(auth); Swal.fire('Error', 'Blocked', 'error'); return; }
                    
                    if(currentUser.role === 'admin') {
                        navigateTo('adminDash'); loadAdminData();
                    } else if(currentUser.role === 'parent') {
                        document.getElementById('pName').innerText = currentUser.fullName;
                        navigateTo('parentDash'); loadParentReqs();
                    } else {
                        document.getElementById('cName').innerText = currentUser.fullName;
                        document.getElementById('statusToggle').style.display='flex';
                        document.getElementById('availToggle').checked = currentUser.isAvailable;
                        navigateTo('companionDash'); loadCompReqs();
                    }
                    loadNotifications();
                }
            } else {
                document.getElementById('guestLinks').style.display='block';
                document.getElementById('userLinks').style.display='none';
                document.getElementById('notifBtn').style.display='none';
                document.getElementById('statusToggle').style.display='none';
                navigateTo('heroSection');
            }
        });

        window.handleRegister = async () => {
            const email = document.getElementById('regEmail').value, pass = document.getElementById('regPass').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const data = {
                    uid: cred.user.uid, fullName: document.getElementById('regName').value, email: email,
                    phone: document.getElementById('regPhone').value, wilaya: document.getElementById('regWilaya').value,
                    role: selectedRole, password_stored: pass, isBlocked: false, photoURL: '', createdAt: serverTimestamp()
                };
                if(selectedRole==='companion') { data.specialty = document.getElementById('regSpec').value; data.isAvailable=true; }
                await setDoc(doc(db, "users", cred.user.uid), data);
                Swal.fire('Success', 'Registered', 'success');
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        window.handleLogin = async () => {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
            if(e === 'admin' && p === 'abobob123') { currentUser = { role:'admin', fullName:'Admin' }; showAdmin(); return; }
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { Swal.fire('Error','Invalid','error'); }
        };
        function showAdmin(){ document.getElementById('guestLinks').style.display='none'; document.getElementById('userLinks').style.display='flex'; navigateTo('adminDash'); loadAdminData(); }
        window.logout = () => signOut(auth).then(()=>location.reload());

        window.saveProfile = async () => {
            const updates = { fullName: document.getElementById('edName').value, phone: document.getElementById('edPhone').value, wilaya: document.getElementById('edWilaya').value };
            const file = document.getElementById('profImgInput').files[0];
            const pass = document.getElementById('edPass').value;
            if(pass && auth.currentUser) await updatePassword(auth.currentUser, pass);
            if(file) {
                const r = new FileReader();
                r.onload = async (e) => { updates.photoURL = e.target.result; await finishSave(updates); };
                r.readAsDataURL(file);
            } else await finishSave(updates);
        };
        async function finishSave(upd) { await updateDoc(doc(db,"users",currentUser.uid), upd); currentUser = {...currentUser, ...upd}; closeModal('profileModal'); Swal.fire('Updated'); }

        // --- Parent Logic ---
        window.searchCompanions = async () => {
            document.getElementById('searchResults').innerHTML = 'Loading...';
            const spec = document.getElementById('searchSpec').value;
            const wilaya = document.getElementById('searchWilaya').value;
            
            const snap = await getDocs(query(collection(db, "users"), where("role","==","companion")));
            let html = '';
            snap.forEach(d => {
                const u = d.data();
                if(u.isAvailable && u.specialty === spec && (!currentUser || u.uid !== currentUser.uid)) {
                    if(wilaya !== wilayas[0].ar && u.wilaya !== wilaya) return;
                    html += `
                    <div class="req-card" style="align-items:center;">
                        <img src="${u.photoURL||'https://via.placeholder.com/60'}" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">
                        <h4 style="margin:5px 0;">${u.fullName}</h4>
                        <span style="color:var(--secondary); font-size:0.9rem;">${u.specialty}</span>
                        <p style="font-size:0.8rem; color:#666;">ğŸ“ ${u.wilaya}</p>
                        <button class="full-btn" style="margin-top:10px; padding:8px;" onclick="openBook('${u.uid}')">Ø­Ø¬Ø²</button>
                    </div>`;
                }
            });
            document.getElementById('searchResults').innerHTML = html || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        };

        window.openBook = (id) => { document.getElementById('bkCompId').value=id; document.getElementById('bookingModal').classList.add('open'); };
        window.submitBooking = async () => {
            const data = {
                parentId: currentUser.uid, parentName: currentUser.fullName, parentPhone: currentUser.phone,
                companionId: document.getElementById('bkCompId').value,
                childName: document.getElementById('bkChild').value,
                childDetails: `${document.getElementById('bkAge').value} Ø³Ù†Ø© - ${document.getElementById('bkStatus').value}`,
                reqType: document.getElementById('bkType').value,
                status: 'pending', timestamp: serverTimestamp()
            };
            await addDoc(collection(db, "requests"), data);
            await addDoc(collection(db, "notifications"), { targetId: data.companionId, msg: `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${currentUser.fullName}`, read:false, timestamp: serverTimestamp() });
            closeModal('bookingModal'); Swal.fire('Sent'); loadParentReqs();
        };

        // LOAD PARENT REQUESTS (Sorted Newest Top)
        async function loadParentReqs() {
            // Using JS sort to avoid index issues
            const q = query(collection(db,"requests"), where("parentId","==",currentUser.uid));
            const snap = await getDocs(q);
            let docs = []; snap.forEach(d => docs.push({id:d.id, ...d.data()}));
            docs.sort((a,b) => b.timestamp - a.timestamp); // Newest first

            let html = '', total=0, acc=0, rej=0, pend=0;
            docs.forEach(r => {
                total++;
                if(r.status==='accepted') acc++; else if(r.status==='rejected') rej++; else pend++;
                const stText = r.status==='accepted'?'Ù…Ù‚Ø¨ÙˆÙ„':r.status==='rejected'?'Ù…Ù„ØºÙŠ':'Ø§Ù†ØªØ¸Ø§Ø±';
                const date = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleString('ar') : 'Ø§Ù„Ø¢Ù†';
                
                html += `<div class="req-card ${r.status}">
                    <div style="display:flex; justify-content:space-between;"><strong>${r.childName}</strong> <span>${stText}</span></div>
                    <div class="time-stamp"><i class="far fa-clock"></i> ${date}</div>
                    ${r.status==='accepted'?`<div style="color:green; font-weight:bold;">ğŸ“ Ø§Ù„ÙˆÙ„ÙŠ: ${r.parentPhone}</div>`:''}
                </div>`;
            });
            document.getElementById('parentReqs').innerHTML = html;
            document.getElementById('pTotal').innerText = total;
            document.getElementById('pAccepted').innerText = acc;
            document.getElementById('pRejected').innerText = rej;
            document.getElementById('pPending').innerText = pend;
        }

        // --- Companion Logic ---
        window.toggleAvail = async () => {
            const v = document.getElementById('availToggle').checked;
            if(currentUser) await updateDoc(doc(db,"users",currentUser.uid),{isAvailable:v});
        };

        async function loadCompReqs() {
            const q = query(collection(db,"requests"), where("companionId","==",currentUser.uid));
            const snap = await getDocs(q);
            let docs = []; snap.forEach(d => docs.push({id:d.id, ...d.data()}));
            docs.sort((a,b) => b.timestamp - a.timestamp); // Newest first

            let html = '', total=0, acc=0, pend=0, rej=0;
            docs.forEach(r => {
                total++;
                if(r.status==='accepted') acc++; else if(r.status==='pending') pend++; else rej++;
                const date = r.timestamp ? new Date(r.timestamp.seconds * 1000).toLocaleString('ar') : 'Ø§Ù„Ø¢Ù†';
                
                const acts = r.status==='pending' ? 
                    `<button class="btn-green" onclick="ansReq('${r.id}','accepted','${r.parentId}')">Ù‚Ø¨ÙˆÙ„</button>
                     <button class="btn-red" onclick="ansReq('${r.id}','rejected','${r.parentId}')">Ø±ÙØ¶</button>` : `<span style="font-weight:bold;">${r.status}</span>`;
                
                const phone = r.status==='accepted' ? `<div style="margin-top:5px; color:#1e3a8a;">ğŸ“ Ø§Ù„ÙˆÙ„ÙŠ: ${r.parentPhone}</div>` : '';

                html += `<div class="req-card ${r.status}">
                    <div><strong>Ù…Ù†: ${r.parentName}</strong> <span style="float:left; font-size:0.8rem;">${date}</span></div>
                    <div style="background:#f9f9f9; padding:10px; border-radius:8px;">${r.childName}<br>${r.childDetails}</div>
                    ${phone}
                    <div style="margin-top:10px;">${acts}</div>
                </div>`;
            });
            document.getElementById('compReqs').innerHTML = html;
            document.getElementById('stTotal').innerText = total;
            document.getElementById('stAccepted').innerText = acc;
            document.getElementById('stPending').innerText = pend;
            document.getElementById('stRejected').innerText = rej;
        }

        window.ansReq = async (rid, st, pid) => {
            await updateDoc(doc(db,"requests",rid),{status:st});
            await addDoc(collection(db,"notifications"),{targetId:pid, msg:`ØªÙ… ${st==='accepted'?'Ù‚Ø¨ÙˆÙ„':'Ø±ÙØ¶'} Ø·Ù„Ø¨Ùƒ`, read:false, timestamp:serverTimestamp()});
            loadCompReqs();
        };

        // --- Admin ---
        window.loadAdminData = async () => {
            const uSnap = await getDocs(collection(db, "users"));
            const rSnap = await getDocs(collection(db, "requests"));
            const mSnap = await getDocs(collection(db, "notifications")); // Simulated msgs
            
            document.getElementById('adUsersCount').innerText = uSnap.size;
            document.getElementById('adReqsCount').innerText = rSnap.size;
            document.getElementById('adMsgsCount').innerText = mSnap.size;

            let rows = '';
            uSnap.forEach(d => {
                const u = d.data();
                rows += `<tr>
                    <td style="padding:10px;">${u.fullName}</td>
                    <td>${u.role}</td>
                    <td>${u.password_stored||'***'}</td>
                    <td style="color:${u.isBlocked?'red':'green'}">${u.isBlocked?'Ù…Ø­Ø¸ÙˆØ±':'Ù†Ø´Ø·'}</td>
                    <td><button onclick="toggleBlock('${d.id}',${u.isBlocked})">${u.isBlocked?'ÙÙƒ':'Ø­Ø¸Ø±'}</button></td>
                </tr>`;
            });
            document.getElementById('usersTable').innerHTML = rows;
            
            // Logs
            let logsHtml = '';
            rSnap.forEach(d => {
                const r = d.data();
                logsHtml += `<div style="padding:10px; border-bottom:1px solid #eee;">Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯: ${r.childName} (${r.status}) - ${r.timestamp?.toDate().toLocaleDateString()}</div>`;
            });
            document.getElementById('logsList').innerHTML = logsHtml;
        };

        window.toggleBlock = async (uid, s) => { await updateDoc(doc(db,"users",uid),{isBlocked:!s}); loadAdminData(); };
        
        window.sendAdminNotif = async () => {
            const t = document.getElementById('notifTarget').value;
            const m = document.getElementById('notifMsg').value;
            if(!m) return;
            let q = collection(db,"users");
            if(t!=='all') q = query(q, where("role","==",t));
            const s = await getDocs(q);
            s.forEach(u => addDoc(collection(db,"notifications"),{targetId:u.id, msg:`ÙØ±ÙŠÙ‚ Ù…Ø±Ø§ÙÙ‚: ${m}`, read:false, timestamp:serverTimestamp()}));
            Swal.fire('Sent');
        };

        // --- Notifications ---
        window.openNotif = () => { document.getElementById('notifModal').classList.add('open'); document.getElementById('notifBadge').style.display='none'; };
        async function loadNotifications() {
            const q = query(collection(db,"notifications"), where("targetId","==",currentUser.uid));
            const snap = await getDocs(q);
            let docs = []; snap.forEach(d => docs.push(d.data()));
            docs.sort((a,b) => b.timestamp - a.timestamp); // Newest first

            let html = '', c=0;
            docs.forEach(n => {
                if(!n.read) c++;
                html += `<div style="padding:10px; border-bottom:1px solid #eee;">${n.msg}<br><small style="color:#999;">${n.timestamp?.toDate().toLocaleString()}</small></div>`;
            });
            document.getElementById('notifList').innerHTML = html || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            if(c>0) { const b=document.getElementById('notifBadge'); b.style.display='flex'; b.innerText=c; }
        }

    </script>
</body>
</html>
