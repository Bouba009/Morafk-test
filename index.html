<!-- Firebase SDKs + Application Logic -->
    <script type="module">
        // 1. Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…ÙƒØªØ¨Ø§Øª Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ (ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡Ø§)
        const firebaseConfig = {
            apiKey: "AIzaSyAaXp-gUOQ_G2s-kM8JhaqW8TJcJ4Nqcuo",
            authDomain: "comondi-fae4b.firebaseapp.com",
            // ğŸ”´ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ØŒ Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¹Ù…Ù„ ØªØ£ÙƒØ¯ Ù…Ù†Ù‡ ÙÙŠ Realtime Database ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹
            databaseURL: "https://comondi-fae4b-default-rtdb.firebaseio.com", 
            projectId: "comondi-fae4b",
            storageBucket: "comondi-fae4b.firebasestorage.app",
            messagingSenderId: "932777870241",
            appId: "1:932777870241:web:78b0cf3a3cf14046be01e0",
            measurementId: "G-M09RX0V18S"
        };

        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Ù…ØªØºÙŠØ±Ø§Øª Ù…Ø­Ù„ÙŠØ© Ù…ØªØ²Ø§Ù…Ù†Ø©
        let localUsers = [];
        let localRequests = [];
        let localNotifs = [];
        let localReviews = [];
        let localReports = [];
        let currentUser = null; 
        let dataLoaded = false;

        // --- Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙÙˆØ±ÙŠØ© (Realtime Sync) ---
        function initListeners() {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            onValue(ref(db, 'users'), (snapshot) => {
                const data = snapshot.val();
                localUsers = data ? Object.values(data) : [];
                if(localUsers.length === 0) seedDatabase();
                checkDataLoaded();
                refreshUI(); 
            });

            // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            onValue(ref(db, 'requests'), (snapshot) => {
                const data = snapshot.val();
                localRequests = data ? Object.values(data) : [];
                refreshUI();
            });

            // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            onValue(ref(db, 'notifications'), (snapshot) => {
                const data = snapshot.val();
                localNotifs = data ? Object.values(data) : [];
                checkNotifications(); 
            });

            // Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
            onValue(ref(db, 'reviews'), (snapshot) => {
                const data = snapshot.val();
                localReviews = data ? Object.values(data) : [];
            });
            
             // Ø¬Ù„Ø¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            onValue(ref(db, 'reports'), (snapshot) => {
                const data = snapshot.val();
                localReports = data ? Object.values(data) : [];
                if(currentUser && currentUser.role === 'admin') loadAdminDashboard();
            });
        }

        function checkDataLoaded() {
            if(!dataLoaded) {
                dataLoaded = true;
                const loader = document.getElementById('page-loader');
                if(loader) loader.style.display = 'none';
                document.body.classList.add('loaded');
            }
        }

        function refreshUI() {
            if(!currentUser) return;
            if(currentUser.role === 'parent') {
                loadParentStats();
                loadMyRequests();
                if(document.getElementById('resultsArea').innerHTML !== '') performSearch();
            } else if (currentUser.role === 'caregiver') {
                loadCaregiverDashboard();
            } else if (currentUser.role === 'admin') {
                loadAdminDashboard();
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§ÙØªØ±Ø§Ø¶ÙŠÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù„Ø£ÙˆÙ„ Ù…Ø±Ø©
        function seedDatabase() {
            const initialUsers = [
                { id: 'c1', name: 'Ø¯. Ø³Ø§Ø±Ø© (Ù†ÙØ³Ø§Ù†ÙŠØ©)', email: 'doc@test.com', pass: '123', role: 'caregiver', phone: '0550112233', wilaya: 'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', service: 'Ø§Ø³ØªØ´Ø§Ø±Ø© (Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ)', isAvailable: true, photo: "https://cdn-icons-png.flaticon.com/512/3304/3304567.png", isBanned: false },
                { id: 'p1', name: 'Ø£Ø­Ù…Ø¯ Ø§Ù„ÙˆÙ„ÙŠ', email: 'parent@test.com', pass: '123', role: 'parent', phone: '0555000000', wilaya: 'Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±', photo: "https://cdn-icons-png.flaticon.com/512/3011/3011270.png", isBanned: false }
            ];
            // Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ø­Ø¯Ø§Ù‹ ØªÙ„Ùˆ Ø§Ù„Ø¢Ø®Ø±
            initialUsers.forEach(u => set(ref(db, 'users/' + u.id), u));
        }

        // --- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
        const DB = {
            getUsers: () => localUsers,
            saveUser: (u) => { set(ref(db, 'users/' + u.id), u).catch((e) => Swal.fire('Error', e.message, 'error')); },
            updateUser: (updatedUser) => { update(ref(db, 'users/' + updatedUser.id), updatedUser); },
            getRequests: () => localRequests,
            saveRequest: (r) => { set(ref(db, 'requests/' + r.id), r); },
            updateRequest: (id, status) => { update(ref(db, 'requests/' + id), { status: status }); },
            updateRequestRating: (id) => { update(ref(db, 'requests/' + id), { isRated: true }); },
            getNotifs: () => localNotifs,
            saveNotif: (n) => { const newRef = push(ref(db, 'notifications')); set(newRef, n); },
            getReviews: () => localReviews,
            saveReview: (rev) => { set(ref(db, 'reviews/' + rev.id), rev); },
            getReports: () => localReports,
            saveReport: (rep) => { const newRef = push(ref(db, 'reports')); set(newRef, rep); }
        };

        // --- Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
        document.addEventListener("DOMContentLoaded", function() {
            initListeners(); 
            
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© (Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª)
            const wilayas = [
                {id:1,ar:"Ø£Ø¯Ø±Ø§Ø±",fr:"Adrar"},{id:2,ar:"Ø§Ù„Ø´Ù„Ù",fr:"Chlef"},{id:3,ar:"Ø§Ù„Ø£ØºÙˆØ§Ø·",fr:"Laghouat"},{id:4,ar:"Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ",fr:"Oum El Bouaghi"},
                {id:5,ar:"Ø¨Ø§ØªÙ†Ø©",fr:"Batna"},{id:6,ar:"Ø¨Ø¬Ø§ÙŠØ©",fr:"BÃ©jaÃ¯a"},{id:7,ar:"Ø¨Ø³ÙƒØ±Ø©",fr:"Biskra"},{id:8,ar:"Ø¨Ø´Ø§Ø±",fr:"BÃ©char"},
                {id:9,ar:"Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©",fr:"Blida"},{id:10,ar:"Ø§Ù„Ø¨ÙˆÙŠØ±Ø©",fr:"Bouira"},{id:11,ar:"ØªÙ…Ù†Ø±Ø§Ø³Øª",fr:"Tamanrasset"},{id:12,ar:"ØªØ¨Ø³Ø©",fr:"TÃ©bessa"},
                {id:13,ar:"ØªÙ„Ù…Ø³Ø§Ù†",fr:"Tlemcen"},{id:14,ar:"ØªÙŠØ§Ø±Øª",fr:"Tiaret"},{id:15,ar:"ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ",fr:"Tizi Ouzou"},{id:16,ar:"Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±",fr:"Alger"},
                {id:17,ar:"Ø§Ù„Ø¬Ù„ÙØ©",fr:"Djelfa"},{id:18,ar:"Ø¬ÙŠØ¬Ù„",fr:"Jijel"},{id:19,ar:"Ø³Ø·ÙŠÙ",fr:"SÃ©tif"},{id:20,ar:"Ø³Ø¹ÙŠØ¯Ø©",fr:"SaÃ¯da"},
                {id:21,ar:"Ø³ÙƒÙŠÙƒØ¯Ø©",fr:"Skikda"},{id:22,ar:"Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³",fr:"Sidi Bel AbbÃ¨s"},{id:23,ar:"Ø¹Ù†Ø§Ø¨Ø©",fr:"Annaba"},{id:24,ar:"Ù‚Ø§Ù„Ù…Ø©",fr:"Guelma"},
                {id:25,ar:"Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©",fr:"Constantine"},{id:26,ar:"Ø§Ù„Ù…Ø¯ÙŠØ©",fr:"MÃ©dÃ©a"},{id:27,ar:"Ù…Ø³ØªØºØ§Ù†Ù…",fr:"Mostaganem"},{id:28,ar:"Ø§Ù„Ù…Ø³ÙŠÙ„Ø©",fr:"M'Sila"},
                {id:29,ar:"Ù…Ø¹Ø³ÙƒØ±",fr:"Mascara"},{id:30,ar:"ÙˆØ±Ù‚Ù„Ø©",fr:"Ouargla"},{id:31,ar:"ÙˆÙ‡Ø±Ø§Ù†",fr:"Oran"},{id:32,ar:"Ø§Ù„Ø¨ÙŠØ¶",fr:"El Bayadh"},
                {id:33,ar:"Ø¥Ù„ÙŠØ²ÙŠ",fr:"Illizi"},{id:34,ar:"Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬",fr:"Bordj Bou Arreridj"},{id:35,ar:"Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³",fr:"BoumerdÃ¨s"},{id:36,ar:"Ø§Ù„Ø·Ø§Ø±Ù",fr:"El Tarf"},
                {id:37,ar:"ØªÙ†Ø¯ÙˆÙ",fr:"Tindouf"},{id:38,ar:"ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª",fr:"Tissemsilt"},{id:39,ar:"Ø§Ù„ÙˆØ§Ø¯ÙŠ",fr:"El Oued"},{id:40,ar:"Ø®Ù†Ø´Ù„Ø©",fr:"Khenchela"},
                {id:41,ar:"Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³",fr:"Souk Ahras"},{id:42,ar:"ØªÙŠØ¨Ø§Ø²Ø©",fr:"Tipaza"},{id:43,ar:"Ù…ÙŠÙ„Ø©",fr:"Mila"},{id:44,ar:"Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰",fr:"AÃ¯n Defla"},
                {id:45,ar:"Ø§Ù„Ù†Ø¹Ø§Ù…Ø©",fr:"NaÃ¢ma"},{id:46,ar:"Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª",fr:"AÃ¯n TÃ©mouchent"},{id:47,ar:"ØºØ±Ø¯Ø§ÙŠØ©",fr:"GhardaÃ¯a"},{id:48,ar:"ØºÙ„ÙŠØ²Ø§Ù†",fr:"Relizane"},
                {id:49,ar:"ØªÙŠÙ…ÙŠÙ…ÙˆÙ†",fr:"Timimoun"},{id:50,ar:"Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±",fr:"Bordj Badji Mokhtar"},{id:51,ar:"Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„",fr:"Ouled Djellal"},{id:52,ar:"Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³",fr:"BÃ©ni AbbÃ¨s"},
                {id:53,ar:"Ø¥Ù† ØµØ§Ù„Ø­",fr:"In Salah"},{id:54,ar:"Ø¥Ù† Ù‚Ø²Ø§Ù…",fr:"In Guezzam"},{id:55,ar:"ØªÙˆÙ‚Ø±Øª",fr:"Touggourt"},{id:56,ar:"Ø¬Ø§Ù†Øª",fr:"Djanet"},
                {id:57,ar:"Ø§Ù„Ù…ØºÙŠØ±",fr:"El M'Ghair"},{id:58,ar:"Ø§Ù„Ù…Ù†ÙŠØ¹Ø©",fr:"El Meniaa"}
            ];

            const services = [
                {code:"srv_psych",ar:"Ø§Ø³ØªØ´Ø§Ø±Ø© (Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ)",fr:"Consultation (Psychologue)"},
                {code:"srv_autism",ar:"Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯",fr:"Accompagnateur enfant autiste"},
                {code:"srv_speech",ar:"Ø£Ø±Ø·ÙˆÙÙˆÙ†ÙŠØ§ (ØªØµØ­ÙŠØ­ Ø§Ù„Ù†Ø·Ù‚)",fr:"Orthophoniste"},
            ];

             const translations = {
                ar: {
                    app_name:"Ù…Ø±Ø§ÙÙ‚", home:"Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", login:"Ø¯Ø®ÙˆÙ„", register:"Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", start_now:"Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†",
                    welcome_title:"Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¹Ø§Ø¦Ù„Ø© Ù…Ø±Ø§ÙÙ‚", slogan:"Ø·ÙÙ„Ùƒ ÙÙŠ Ø£ÙŠØ§Ø¯ÙŠ Ø¢Ù…Ù†Ø©",
                    role_parent:"ÙˆÙ„ÙŠ Ø£Ù…Ø±", role_caregiver:"Ù…Ø±Ø§ÙÙ‚Ø© / Ù…Ø®ØªØµ",
                    email_label:"Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", email_placeholder:"Ù…Ø«Ø§Ù„: user@mail.com",
                    pass_label:"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", password_placeholder:"******",
                    fullname:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", phone:"Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ", wilaya:"Ø§Ù„ÙˆÙ„Ø§ÙŠØ©",
                    search_title:"Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø®ØªØµ", all_wilayas:"ÙƒÙ„ Ø§Ù„ÙˆÙ„Ø§ÙŠØ§Øª", all_services:"ÙƒÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª",
                    search_btn:"Ø¨Ø­Ø«", service_type:"Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©",
                    child_age:"Ø¹Ù…Ø± Ø§Ù„Ø·ÙÙ„", child_name:"Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„", school_level:"Ø§Ù„Ø·ÙˆØ± Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ",
                    lvl_primary:"Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ", lvl_middle:"Ù…ØªÙˆØ³Ø·", lvl_secondary:"Ø«Ø§Ù†ÙˆÙŠ", lvl_none:"ØºÙŠØ± Ù…ØªÙ…Ø¯Ø±Ø³",
                    child_condition:"Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙÙ„", cond_normal:"Ø¹Ø§Ø¯ÙŠ", cond_autism:"Ø·ÙŠÙ ØªÙˆØ­Ø¯", cond_speech:"ØªØ£Ø®Ø± Ù†Ø·Ù‚", cond_adhd:"ÙØ±Ø· Ø­Ø±ÙƒØ©",
                    duration:"Ø§Ù„Ù…Ø¯Ø©", dur_session:"Ø¬Ù„Ø³Ø© ÙˆØ§Ø­Ø¯Ø©", dur_term:"ÙØµÙ„ Ø¯Ø±Ø§Ø³ÙŠ", dur_year:"Ø³Ù†Ø© Ø¯Ø±Ø§Ø³ÙŠØ©", "1_month":"Ø´Ù‡Ø±",
                    days:"Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙØ¶Ù„Ø©", confirm_send:"ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„",
                    edit_profile:"ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„", save:"Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª", change_pass:"ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±", pro_info:"Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ù‡Ù†ÙŠØ©",
                    upload_cert:"Ø±ÙØ¹ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©",
                    th_caregiver:"Ø§Ù„Ù…Ø®ØªØµ", th_service:"Ø§Ù„Ø·ÙÙ„", th_status:"Ø§Ù„Ø­Ø§Ù„Ø©", th_action:"Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡",
                    status_online:"Ø£Ù†Ø§ ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©", incoming_requests:"Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©", th_parent:"Ø§Ù„ÙˆÙ„ÙŠ", th_child:"Ø§Ù„Ø·ÙÙ„", th_details:"Ø§Ù„ØªÙØ§ØµÙŠÙ„",
                    stat_total_req:"Ø§Ù„ÙƒÙ„", stat_new_req:"Ø§Ù†ØªØ¸Ø§Ø±", stat_accepted:"Ù…Ù‚Ø¨ÙˆÙ„Ø©", stat_rejected:"Ù…Ø±ÙÙˆØ¶Ø©",
                    settings:"Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª", logout:"Ø®Ø±ÙˆØ¬", forgot_password:"Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ", login_btn:"ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", create_account_btn:"Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨",
                    my_requests:"Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©",
                    admin_panel:"Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…", send_notif:"Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±", stat_users:"Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†", stat_caregivers:"Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø§Øª", stat_reports:"Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰",
                    successful_ops:"Ø¹Ù…Ù„ÙŠØ§Øª Ù†Ø§Ø¬Ø­Ø©", successful_caregivers:"Ø£Ù†Ø¬Ø­ Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø§Øª", daily_transactions:"Ø§Ù„ØªØ¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©", manage_users:"Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†",
                    reports_messages:"Ø§Ù„Ø´ÙƒØ§ÙˆÙ‰ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„", sender:"Ø§Ù„Ù…Ø±Ø³Ù„", type:"Ø§Ù„Ù†ÙˆØ¹", message:"Ø§Ù„Ø±Ø³Ø§Ù„Ø©", date:"Ø§Ù„ØªØ§Ø±ÙŠØ®",
                    target_audience:"Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©", all:"Ø§Ù„Ø¬Ù…ÙŠØ¹", send:"Ø¥Ø±Ø³Ø§Ù„", notifications:"Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª", search_placeholder:"Ø¨Ø­Ø«...",
                    th_name:"Ø§Ù„Ø§Ø³Ù…", th_role:"Ø§Ù„Ù†ÙˆØ¹", alert_error:"Ø®Ø·Ø£", alert_sent:"ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„",
                    rate_caregiver:"ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø±Ø§ÙÙ‚Ø©", comment_placeholder:"Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§...", submit_rating:"Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",
                    about_us:"Ù…Ù† Ù†Ø­Ù†", privacy_policy:"Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©", contact_us:"ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§", report_issue:"Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©", copyright:"Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2024",
                    about_content:"Ù…Ù†ØµØ© Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ù…Ø¨ØªÙƒØ±Ø© ØªÙ‡Ø¯Ù Ù„Ø±Ø¨Ø· Ø§Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø®ØªØµÙŠÙ†. Ù…Ù‚Ø±Ù†Ø§ ÙÙŠ Ø±ÙˆÙŠØ¨Ø©ØŒ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©. Ù†Ø³Ø¹Ù‰ Ù„ØªÙˆÙÙŠØ± Ø¨ÙŠØ¦Ø© Ø¢Ù…Ù†Ø© Ù„Ø·ÙÙ„Ùƒ.",
                    privacy_content:"Ù†Ø­Ù† Ù†Ù„ØªØ²Ù… Ø¨Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ù„ØºØ±Ø¶ ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø®Ø¯Ù…Ø© ÙˆÙ„Ù† ÙŠØªÙ… Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ Ù…Ø¹ Ø£Ø·Ø±Ø§Ù Ø«Ø§Ù„Ø«Ø© Ø¯ÙˆÙ† Ù…ÙˆØ§ÙÙ‚ØªÙƒ.",
                    location_text:"Ø±ÙˆÙŠØ¨Ø©ØŒ Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± Ø§Ù„Ø¹Ø§ØµÙ…Ø©", recover_hint:"Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±."
                },
                fr: {
                    app_name:"Morafik", home:"Accueil", login:"Connexion", register:"Inscription", start_now:"Commencer",
                    welcome_title:"Bienvenue chez Morafik", slogan:"Votre enfant en sÃ©curitÃ©",
                    role_parent:"Parent", role_caregiver:"SpÃ©cialiste",
                    email_label:"Email", email_placeholder:"ex: user@mail.com",
                    pass_label:"Mot de passe", password_placeholder:"******",
                    fullname:"Nom complet", phone:"TÃ©lÃ©phone", wilaya:"Wilaya",
                    search_title:"Trouver un spÃ©cialiste", all_wilayas:"Toutes Wilayas", all_services:"Tous Services",
                    search_btn:"Rechercher", service_type:"Service",
                    child_age:"Ã‚ge enfant", child_name:"Nom enfant", school_level:"Niveau scolaire",
                    lvl_primary:"Primaire", lvl_middle:"Moyen", lvl_secondary:"LycÃ©e", lvl_none:"Aucun",
                    child_condition:"Ã‰tat de l'enfant", cond_normal:"Normal", cond_autism:"Autiste", cond_speech:"Retard parole", cond_adhd:"TDAH",
                    duration:"DurÃ©e", dur_session:"SÃ©ance", dur_term:"Trimestre", dur_year:"AnnÃ©e scolaire", "1_month":"1 Mois",
                    days:"Jours prÃ©fÃ©rÃ©s", confirm_send:"Confirmer",
                    edit_profile:"Modifier Profil", save:"Enregistrer", change_pass:"Changer mot de passe", pro_info:"Infos pro",
                    upload_cert:"DiplÃ´me (PDF)",
                    th_caregiver:"SpÃ©cialiste", th_service:"Enfant", th_status:"Statut", th_action:"Action",
                    status_online:"En Service", incoming_requests:"Demandes reÃ§ues", th_parent:"Parent", th_child:"Enfant", th_details:"DÃ©tails",
                    stat_total_req:"Total", stat_new_req:"Attente", stat_accepted:"AcceptÃ©", stat_rejected:"RefusÃ©",
                    settings:"ParamÃ¨tres", logout:"DÃ©connexion", forgot_password:"Mot de passe oubliÃ©?", login_btn:"Se connecter", create_account_btn:"CrÃ©er compte",
                    my_requests:"Mes demandes",
                    admin_panel:"Panneau Admin", send_notif:"Envoyer Notif", stat_users:"Utilisateurs", stat_caregivers:"SpÃ©cialistes", stat_reports:"Signalements",
                    successful_ops:"OpÃ©rations rÃ©ussies", successful_caregivers:"Top SpÃ©cialistes", daily_transactions:"Transactions du jour", manage_users:"GÃ©rer utilisateurs",
                    reports_messages:"Signalements & Messages", sender:"ExpÃ©diteur", type:"Type", message:"Message", date:"Date",
                    target_audience:"Cible", all:"Tous", send:"Envoyer", notifications:"Notifications", search_placeholder:"Rechercher...",
                    th_name:"Nom", th_role:"RÃ´le", alert_error:"Erreur", alert_sent:"EnvoyÃ©",
                    rate_caregiver:"Noter le spÃ©cialiste", comment_placeholder:"Votre commentaire...", submit_rating:"Envoyer l'avis",
                    about_us:"Ã€ propos", privacy_policy:"ConfidentialitÃ©", contact_us:"Contactez-nous", report_issue:"Signaler problÃ¨me", copyright:"Tous droits rÃ©servÃ©s Â© 2024",
                    about_content:"Plateforme algÃ©rienne innovante reliant les parents aux meilleurs spÃ©cialistes. BasÃ©e Ã  Rouiba, Alger. Nous assurons un environnement sÃ»r.",
                    privacy_content:"Nous protÃ©geons vos donnÃ©es. Toutes les infos sont utilisÃ©es uniquement pour le service et ne seront pas partagÃ©es sans accord.",
                    location_text:"Rouiba, Alger", recover_hint:"Entrez votre email pour rÃ©cupÃ©rer le mot de passe."
                }
            };

            let currentLang = 'ar';
            function t(key) { return translations[currentLang][key] || key; }

            // --- NAVIGATION ---
            window.switchView = function(viewId) {
                document.querySelectorAll('.view-section').forEach(el => { el.classList.remove('active'); el.style.opacity=0; });
                const target = document.getElementById(viewId);
                target.classList.add('active');
                setTimeout(()=>target.style.opacity=1, 50);
                window.scrollTo(0,0);
            };

            window.goHome = function() { if(currentUser) return; switchView('landingView'); };
            window.goToLogin = function() { switchView('authView'); new bootstrap.Tab(document.querySelector('#tab-login')).show(); };
            window.startNow = function() { switchView('authView'); new bootstrap.Tab(document.querySelector('#tab-register')).show(); };
            window.openModal = function(id) { new bootstrap.Modal(document.getElementById(id)).show(); };

            window.logout = function() {
                currentUser = null;
                document.getElementById('guestNav').classList.remove('d-none');
                document.getElementById('userNav').classList.add('d-none');
                document.getElementById('loginForm').reset();
                switchView('landingView');
            };

            // --- AUTH ---
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value.trim().toLowerCase();
                const pass = document.getElementById('loginPass').value;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¯Ù…Ù†
                if(email === 'admin' && pass === 'abobob123') {
                    currentUser = { name: 'Admin', role: 'admin' };
                    document.getElementById('guestNav').classList.add('d-none');
                    document.getElementById('userNav').classList.remove('d-none');
                    document.getElementById('userInfo').innerText = 'Admin';
                    loadAdminDashboard();
                    switchView('adminView'); return;
                }

                const user = DB.getUsers().find(u => u.email.toLowerCase() === email && u.pass === pass);
                if(user) {
                    if(user.isBanned) { Swal.fire({icon:'error', title:'Ù…Ø­Ø¸ÙˆØ±', text:'ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©'}); return; }
                    currentUser = user;
                    document.getElementById('guestNav').classList.add('d-none');
                    document.getElementById('userNav').classList.remove('d-none');
                    document.getElementById('userInfo').innerText = user.name;
                    checkNotifications();
                    if(user.role === 'parent') { switchView('parentView'); performSearch(); loadMyRequests(); loadParentStats(); }
                    else { switchView('caregiverView'); loadCaregiverDashboard(); }
                } else {
                    Swal.fire({icon:'error', title: t('alert_error'), text:'Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©'});
                }
            });

            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const role = document.getElementById('regRole').value;
                const uid = 'u' + Date.now();
                const newUser = { 
                    id: uid, 
                    name: document.getElementById('regName').value, 
                    email: document.getElementById('regEmail').value, 
                    phone: document.getElementById('regPhone').value, 
                    pass: document.getElementById('regPass').value, 
                    role: role, 
                    wilaya: document.getElementById('regWilaya').value, 
                    photo: "https://cdn-icons-png.flaticon.com/512/149/149071.png", 
                    isAvailable: true, 
                    isBanned: false 
                };
                if (role === 'caregiver') { newUser.service = document.getElementById('regService').value; }
                
                DB.saveUser(newUser); 
                
                Swal.fire({icon:'success', title:'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„'});
                new bootstrap.Tab(document.querySelector('#tab-login')).show(); document.getElementById('registerForm').reset();
            });

            // --- REPORTING ---
            window.submitReport = function(e, type) {
                e.preventDefault();
                const emailInput = e.target.querySelector('input[type="email"]');
                const msgInput = e.target.querySelector('textarea');
                
                const email = emailInput ? emailInput.value : (currentUser ? currentUser.email : 'Anonymous');
                const msg = msgInput.value;

                const rep = {
                    sender: email,
                    type: type,
                    message: msg,
                    date: new Date().toLocaleDateString()
                };
                DB.saveReport(rep);
                bootstrap.Modal.getInstance(e.target.closest('.modal')).hide();
                e.target.reset();
                Swal.fire(t('alert_sent'));
            };

            // --- NOTIFICATIONS ---
            window.checkNotifications = function() {
                const notifs = DB.getNotifs().filter(n => n.target === 'all' || n.target === currentUser.role);
                const badge = document.getElementById('notifBadge');
                if(notifs.length > 0) { badge.classList.remove('d-none'); } else { badge.classList.add('d-none'); }
            };
            window.openNotifications = function() {
                const list = document.getElementById('notifList'); list.innerHTML = '';
                const notifs = DB.getNotifs().filter(n => n.target === 'all' || n.target === currentUser.role).reverse();
                if(notifs.length === 0) list.innerHTML = '<div class="p-3 text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
                notifs.forEach(n => { list.innerHTML += `<div class="list-group-item"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 text-primary fw-bold">${n.sender || 'ÙØ±ÙŠÙ‚ Ù…Ø±Ø§ÙÙ‚'}</h6><small class="text-muted">${n.date}</small></div><p class="mb-1 small">${n.message}</p></div>`; });
                new bootstrap.Modal(document.getElementById('notifModal')).show();
                document.getElementById('notifBadge').classList.add('d-none');
            };

            // --- PARENT ---
            window.loadParentStats = function() {
                const reqs = DB.getRequests().filter(r => r.parentId === currentUser.id);
                document.getElementById('pStatTotal').innerText = reqs.length;
                document.getElementById('pStatAccepted').innerText = reqs.filter(r=>r.status==='accepted').length;
                document.getElementById('pStatPending').innerText = reqs.filter(r=>r.status==='pending').length;
            };

            window.performSearch = function() {
                const container = document.getElementById('resultsArea');
                const sWilaya = document.getElementById('searchWilaya').value;
                const sService = document.getElementById('searchService').value;
                
                container.innerHTML = '';
                DB.getUsers().filter(u => u.role === 'caregiver' && !u.isBanned && u.isAvailable 
                    && (sWilaya === 'Ø§Ù„ÙƒÙ„' || u.wilaya === sWilaya)
                    && (sService === 'Ø§Ù„ÙƒÙ„' || u.service === sService)
                ).forEach(c => {
                    const reviews = DB.getReviews().filter(r => r.caregiverId === c.id);
                    const count = reviews.length;
                    const sum = reviews.reduce((acc, r) => acc + parseInt(r.stars), 0);
                    const avg = count ? (sum / count).toFixed(1) : 0;
                    
                    let starsHtml = '';
                    for(let i=1; i<=5; i++) {
                        starsHtml += `<i class="bi bi-star${i <= Math.round(avg) ? '-fill text-warning' : ' text-muted'}" style="font-size:0.9rem"></i>`;
                    }

                    const sObj = services.find(s=>s.ar === c.service || s.fr === c.service);
                    const displayService = sObj ? (currentLang==='ar'?sObj.ar:sObj.fr) : c.service;
                    
                    container.innerHTML += `
                        <div class="col-md-4">
                            <div class="custom-card p-3 text-center h-100">
                                <img src="${c.photo}" class="profile-img-preview mb-2">
                                <h5 class="fw-bold mb-1">${c.name}</h5>
                                <div class="mb-2">${starsHtml} <small class="text-muted">(${avg})</small></div>
                                <p class="small text-muted mb-3">${displayService}<br>ğŸ“ ${c.wilaya}</p>
                                <button class="btn btn-outline-primary w-100 fw-bold mt-auto" onclick="openRequestModal('${c.id}')">${t('request_service')}</button>
                            </div>
                        </div>`;
                });
                if(container.innerHTML === '') container.innerHTML = '<div class="col-12 text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
            };

            window.openRequestModal = function(id) { document.getElementById('targetCaregiverId').value = id; new bootstrap.Modal(document.getElementById('requestModal')).show(); };

            document.getElementById('sendRequestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const rid = Date.now();
                const req = {
                    id: rid, parentId: currentUser.id, parentName: currentUser.name, parentPhone: currentUser.phone, 
                    caregiverId: document.getElementById('targetCaregiverId').value,
                    childName: document.getElementById('reqChildName').value, childAge: document.getElementById('reqChildAge').value,
                    schoolLevel: document.getElementById('reqSchoolLevel').value, childCondition: document.getElementById('reqChildCondition').value,
                    duration: document.getElementById('reqDuration').value, days: document.getElementById('reqDays').value, status: 'pending', isRated: false
                };
                DB.saveRequest(req);
                bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
                Swal.fire({icon:'success', title: t('alert_success')});
            });

            window.loadMyRequests = function() {
                const tbody = document.getElementById('myRequestsTable'); tbody.innerHTML = '';
                DB.getRequests().filter(r => r.parentId === currentUser.id).forEach(r => {
                    const cg = DB.getUsers().find(u => u.id == r.caregiverId) || {name:'?'};
                    let status = r.status === 'pending' ? `<span class="badge bg-warning text-dark">${t('stat_new_req')}</span>` : (r.status === 'accepted' ? `<span class="badge bg-success">${t('stat_accepted')}</span>` : `<span class="badge bg-danger">${t('stat_rejected')}</span>`);
                    
                    let action = '-';
                    if(r.status==='accepted') {
                        action = `<a href="tel:${cg.phone}" class="btn btn-sm btn-success rounded-circle ms-1"><i class="bi bi-telephone-fill"></i></a>`;
                        if(!r.isRated) {
                            action += `<button class="btn btn-sm btn-warning rounded-circle text-dark" onclick="openRateModal('${r.id}', '${cg.id}', '${cg.name}')"><i class="bi bi-star-fill"></i></button>`;
                        }
                    }
                    
                    tbody.innerHTML += `<tr><td data-label="${t('th_caregiver')}">${cg.name}</td><td data-label="${t('th_service')}">${r.childName}</td><td data-label="${t('th_status')}">${status}</td><td data-label="${t('th_action')}">${action}</td></tr>`;
                });
            };

            // --- RATING SYSTEM ---
            window.openRateModal = function(rid, cid, cname) {
                document.getElementById('rateRequestId').value = rid;
                document.getElementById('rateCaregiverId').value = cid;
                document.getElementById('rateCgName').innerText = cname;
                document.getElementById('ratingValue').value = "0";
                document.getElementById('rateComment').value = "";
                document.querySelectorAll('#starContainer i').forEach(s => s.classList.remove('text-warning'));
                new bootstrap.Modal(document.getElementById('rateModal')).show();
            };

            document.querySelectorAll('#starContainer i').forEach(star => {
                star.addEventListener('click', function() {
                    const val = this.getAttribute('data-val');
                    document.getElementById('ratingValue').value = val;
                    document.querySelectorAll('#starContainer i').forEach(s => {
                        if(s.getAttribute('data-val') <= val) s.classList.add('text-warning');
                        else s.classList.remove('text-warning');
                    });
                });
            });

            window.submitReview = function() {
                const rid = document.getElementById('rateRequestId').value;
                const stars = document.getElementById('ratingValue').value;
                
                if(stars == "0") { Swal.fire('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ…'); return; }

                const review = {
                    id: Date.now(),
                    requestId: rid,
                    caregiverId: document.getElementById('rateCaregiverId').value,
                    parentId: currentUser.id,
                    stars: stars,
                    comment: document.getElementById('rateComment').value,
                    date: new Date().toLocaleDateString()
                };

                DB.saveReview(review);
                DB.updateRequestRating(rid); 
                bootstrap.Modal.getInstance(document.getElementById('rateModal')).hide();
                Swal.fire({icon:'success', title: t('alert_sent')});
            };

            // --- CAREGIVER ---
            window.loadCaregiverDashboard = function() {
                document.getElementById('cgNameProfile').innerText = currentUser.name;
                document.getElementById('dashboardProfileImg').src = currentUser.photo;
                const toggle = document.getElementById('availabilityToggle');
                toggle.checked = currentUser.isAvailable;
                
                const reqs = DB.getRequests().filter(r => r.caregiverId == currentUser.id);
                document.getElementById('cgStatTotal').innerText = reqs.length;
                document.getElementById('cgStatPending').innerText = reqs.filter(r=>r.status==='pending').length;
                document.getElementById('cgStatAccepted').innerText = reqs.filter(r=>r.status==='accepted').length;
                document.getElementById('cgStatRejected').innerText = reqs.filter(r=>r.status==='rejected').length;
                
                const tbody = document.getElementById('incomingRequestsTable'); tbody.innerHTML = '';
                reqs.forEach(r => {
                    let action = r.status === 'pending' ? `<button class="btn btn-sm btn-success ms-1" onclick="handleReq(${r.id},'accepted')">âœ”</button><button class="btn btn-sm btn-danger" onclick="handleReq(${r.id},'rejected')">âœ˜</button>` : (r.status === 'accepted' ? t('stat_accepted') : t('stat_rejected'));
                    let parentInfo = r.parentName;
                    if(r.status === 'accepted') {
                        const pUser = DB.getUsers().find(u => u.id === r.parentId);
                        const pPhone = pUser ? pUser.phone : r.parentPhone;
                        parentInfo += `<br><a href="tel:${pPhone}" class="badge bg-success text-decoration-none"><i class="bi bi-telephone-fill"></i> ${pPhone}</a>`;
                    }
                    let details = `<div class="small">${r.childAge} | ${r.schoolLevel}<br><span class="text-danger fw-bold">${r.childCondition}</span><br>${r.duration}</div>`;
                    tbody.innerHTML += `<tr><td data-label="${t('th_parent')}">${parentInfo}</td><td data-label="${t('th_child')}">${r.childName}</td><td data-label="${t('th_details')}">${details}</td><td data-label="${t('th_days')}">${r.days}</td><td data-label="${t('th_action')}">${action}</td></tr>`;
                });
            };
            window.handleReq = function(id, status) { DB.updateRequest(id, status); };
            window.toggleAvailability = function() { 
                currentUser.isAvailable = document.getElementById('availabilityToggle').checked; 
                DB.updateUser(currentUser); 
            };

            // --- ADMIN ---
            window.loadAdminDashboard = function() {
                const users = DB.getUsers(); const reqs = DB.getRequests();
                const reports = DB.getReports();
                
                document.getElementById('statTotalUsers').innerText = users.length;
                document.getElementById('statCaregivers').innerText = users.filter(u=>u.role==='caregiver').length;
                document.getElementById('statReportsCount').innerText = reports.length; 
                document.getElementById('statSuccessOps').innerText = reqs.filter(r=>r.status==='accepted').length;

                const successCounts = {};
                reqs.filter(r => r.status === 'accepted').forEach(r => { successCounts[r.caregiverId] = (successCounts[r.caregiverId] || 0) + 1; });
                const topCgs = Object.keys(successCounts).map(id => { const u = users.find(x => x.id === id); return u ? { ...u, count: successCounts[id] } : null; }).filter(u => u).sort((a, b) => b.count - a.count).slice(0, 5);
                const topTable = document.getElementById('adminTopCaregivers'); topTable.innerHTML = '';
                topCgs.forEach((c, i) => { topTable.innerHTML += `<tr class="border-bottom"><td style="width:40px"><img src="${c.photo}" width="35" class="rounded-circle"></td><td><div class="fw-bold small">${c.name}</div><small class="text-muted">${c.service}</small></td><td class="text-end"><span class="badge bg-primary rounded-pill">${c.count}</span></td></tr>`; });

                const transTable = document.getElementById('adminDailyTrans'); transTable.innerHTML = '';
                reqs.slice(-5).reverse().forEach(r => {
                    const cg = users.find(u => u.id === r.caregiverId) || {name: '?'};
                    const st = r.status === 'accepted' ? '<span class="badge bg-success">âœ”</span>' : (r.status === 'rejected' ? '<span class="badge bg-danger">âœ˜</span>' : '<span class="badge bg-warning">â³</span>');
                    transTable.innerHTML += `<tr><td>${r.parentName}</td><td>${cg.name}</td><td>${st}</td></tr>`;
                });

                const uTable = document.getElementById('adminUsersTable'); uTable.innerHTML = '';
                const term = document.getElementById('adminSearch').value.toLowerCase();
                users.filter(u => u.name.toLowerCase().includes(term) || u.phone.includes(term)).forEach(u => {
                    const statusBadge = u.isBanned ? '<span class="badge bg-danger">Ù…Ø­Ø¸ÙˆØ±</span>' : '<span class="badge bg-success">Ù†Ø´Ø·</span>';
                    const actionBtn = u.isBanned ? `<button class="btn btn-sm btn-success" onclick="toggleBan('${u.id}')">ÙÙƒ Ø­Ø¸Ø±</button>` : `<button class="btn btn-sm btn-outline-danger" onclick="toggleBan('${u.id}')">Ø­Ø¸Ø±</button>`;
                    uTable.innerHTML += `<tr><td>${u.name}</td><td>${u.role}</td><td>${u.phone}</td><td class="small">${u.email}</td><td class="text-danger font-monospace">${u.pass}</td><td>${statusBadge}</td><td>${actionBtn}</td></tr>`;
                });

                const rTable = document.getElementById('adminReportsTable'); rTable.innerHTML = '';
                reports.reverse().forEach(r => {
                    rTable.innerHTML += `<tr><td>${r.sender}</td><td>${r.type}</td><td>${r.message}</td><td>${r.date}</td></tr>`;
                });
            };

            window.toggleBan = function(uid) {
                const u = DB.getUsers().find(x => x.id === uid);
                if(u) { 
                    u.isBanned = !u.isBanned; 
                    DB.updateUser(u);
                }
            };

            window.openSendNotifModal = function() { new bootstrap.Modal(document.getElementById('adminSendNotifModal')).show(); };
            window.sendAdminNotification = function(e) {
                e.preventDefault();
                const target = document.getElementById('notifTarget').value;
                const msg = document.getElementById('notifMsg').value;
                DB.saveNotif({ target: target, message: msg, date: new Date().toLocaleDateString(), sender: 'ÙØ±ÙŠÙ‚ Ù…Ø±Ø§ÙÙ‚' });
                bootstrap.Modal.getInstance(document.getElementById('adminSendNotifModal')).hide();
                Swal.fire(t('alert_sent'));
            };

            // --- EDIT PROFILE ---
            document.getElementById('editProfilePic').addEventListener('change', function(e) { if (e.target.files[0]) { const r = new FileReader(); r.onload = (ev) => document.getElementById('editImgPreview').src = ev.target.result; r.readAsDataURL(e.target.files[0]); } });
            
            window.openEditProfileModal = function() {
                if(!currentUser) return;
                document.getElementById('editName').value = currentUser.name;
                document.getElementById('editPhone').value = currentUser.phone;
                document.getElementById('editWilaya').value = currentUser.wilaya;
                document.getElementById('editImgPreview').src = currentUser.photo;
                if(currentUser.role === 'caregiver') { document.getElementById('caregiverEditFields').classList.remove('d-none'); document.getElementById('editService').value = currentUser.service; } 
                else { document.getElementById('caregiverEditFields').classList.add('d-none'); }
                new bootstrap.Modal(document.getElementById('editProfileModal')).show();
            };

            document.getElementById('editProfileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                currentUser.name = document.getElementById('editName').value;
                currentUser.phone = document.getElementById('editPhone').value;
                currentUser.wilaya = document.getElementById('editWilaya').value;
                const newPass = document.getElementById('editNewPass').value;
                if(newPass) currentUser.pass = newPass;
                const img = document.getElementById('editImgPreview').src;
                if(img && !img.includes('window.location')) currentUser.photo = img;
                if(currentUser.role === 'caregiver') currentUser.service = document.getElementById('editService').value;

                DB.updateUser(currentUser);
                bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                Swal.fire({icon:'success', title: t('save')});
                document.getElementById('userInfo').innerText = currentUser.name;
            });

            // --- UTILS ---
            window.toggleLanguage = function() {
                currentLang = currentLang === 'ar' ? 'fr' : 'ar';
                document.documentElement.lang = currentLang;
                document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
                document.getElementById('langSwitcher').innerText = currentLang === 'ar' ? 'FR' : 'AR';
                document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = t(el.getAttribute('data-i18n')));
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.getAttribute('data-i18n-placeholder')));
                populateDropdowns();
                refreshUI();
            };

            window.selectRole = function(role, elem) {
                document.querySelectorAll('.role-selector').forEach(el => el.classList.remove('active'));
                elem.classList.add('active');
                document.getElementById('regRole').value = role;
                document.getElementById('caregiverFields').classList.toggle('d-none', role !== 'caregiver');
            };

            function populateDropdowns() {
                const wSelects = document.querySelectorAll('.dynamic-wilaya');
                wSelects.forEach(sel => {
                    const currentVal = sel.value; const isSearch = sel.id === 'searchWilaya';
                    let html = isSearch ? `<option value="Ø§Ù„ÙƒÙ„">${t('all_wilayas')}</option>` : ``;
                    wilayas.forEach(w => { html += `<option value="${w.ar}">${currentLang === 'ar' ? w.ar : w.fr}</option>`; });
                    sel.innerHTML = html; if(currentVal && currentVal !== 'Ø§Ù„ÙƒÙ„') sel.value = currentVal;
                });
                const sSelects = document.querySelectorAll('.dynamic-service');
                sSelects.forEach(sel => {
                    const currentVal = sel.value; const isSearch = sel.id === 'searchService';
                    let html = isSearch ? `<option value="Ø§Ù„ÙƒÙ„">${t('all_services')}</option>` : ``;
                    services.forEach(s => { html += `<option value="${s.ar}">${currentLang === 'ar' ? s.ar : s.fr}</option>`; });
                    sel.innerHTML = html; if(currentVal && currentVal !== 'Ø§Ù„ÙƒÙ„') sel.value = currentVal;
                });
            }

            populateDropdowns();
            switchView('landingView');
        });
    </script>
