<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مرافق | Morafik</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        
        body { background-color: var(--light-bg); color: #333; min-height: 100vh; }

        /* Loader */
        #loadingScreen { position: fixed; inset: 0; background: #fff; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top: 5px solid var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Header */
        header { background: var(--glass); backdrop-filter: blur(10px); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: fixed; width: 100%; top: 0; z-index: 1000; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        .logo { font-size: 24px; font-weight: 900; color: var(--secondary-color); display: flex; align-items: center; gap: 10px; }
        .nav-links { display: flex; align-items: center; gap: 15px; }
        .nav-links button { background: transparent; border: none; font-size: 16px; cursor: pointer; color: #2c3e50; font-weight: 500; }
        .lang-btn { border: 2px solid var(--secondary-color) !important; padding: 5px 15px; border-radius: 20px; font-weight: bold; }

        /* Hero Section - Centered Vertically and Horizontally */
        .hero-section { 
            position: relative; height: 100vh; width: 100%; display: flex; align-items: center; justify-content: center; text-align: center; color: white; overflow: hidden; 
        }
        .hero-bg {
            position: absolute; inset: 0;
            background: url('https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
            z-index: -1; animation: heroZoom 20s infinite alternate;
        }
        @keyframes heroZoom { from { transform: scale(1); } to { transform: scale(1.1); } }
        .hero-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 0; }
        .hero-content { position: relative; z-index: 2; width: 90%; max-width: 800px; }

        /* Standard Section Padding */
        section { padding-top: 100px; display: none; padding-bottom: 50px; }
        section.active { display: block; }

        /* Inputs & Buttons */
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 12px; margin-bottom: 15px; }
        .btn { padding: 12px 25px; background: var(--secondary-color); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .btn-red { background: var(--accent-color); }

        /* Modals (Popups) */
        .modal { display: none; position: fixed; z-index: 3000; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); overflow-y: auto; }
        .modal.open { display: block; }
        .modal-content { background: #fff; margin: 50px auto; padding: 30px; width: 90%; max-width: 450px; border-radius: 24px; position: relative; animation: modalSlide 0.3s ease-out; }
        @keyframes modalSlide { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .close { float: left; font-size: 28px; cursor: pointer; color: #999; }

        /* Dashboards Styles */
        .dashboard-content { padding: 0 5%; max-width: 1200px; margin: 0 auto; }
        .profile-card { background: white; padding: 25px; border-radius: var(--radius); display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); margin-bottom: 25px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-box { background: white; padding: 20px; border-radius: var(--radius); text-align: center; box-shadow: var(--shadow); }
        .req-card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 15px; border-right: 5px solid var(--secondary-color); }

        footer { background: var(--primary-color); color: white; padding: 40px 5%; margin-top: 50px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; }
        ul { list-style: none; }
        a { color: inherit; text-decoration: none; }

        @media (max-width: 768px) {
            header { flex-direction: column; gap: 10px; text-align: center; }
            .hero-content h1 { font-size: 2rem !important; }
        }
    </style>
</head>
<body>

    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <header>
        <div class="logo"><i class="fas fa-hands-helping"></i> <span data-i18n="logo">مرافق | Morafik</span></div>
        <div class="nav-links">
            <button onclick="changeLang()" class="lang-btn">FR / AR</button>
            <button onclick="window.location.reload()" data-i18n="home">الرئيسية</button>
            <button onclick="openModal('loginModal')" id="navLogin" data-i18n="login">دخول</button>
            <button onclick="openModal('registerModal')" id="navReg" data-i18n="register">حساب جديد</button>
            <button onclick="logout()" id="navLogout" class="btn btn-red" style="display:none; padding: 5px 15px;" data-i18n="logout">خروج</button>
        </div>
    </header>

    <!-- Hero Section (Only shown before login) -->
    <section id="heroSection" class="hero-section" style="display: flex;">
        <div class="hero-bg"></div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <h1 data-i18n="heroTitle" style="font-size:3.5rem; margin-bottom:20px; font-weight:800;">مرافقة ابنك بأمان</h1>
            <p data-i18n="heroSub" style="font-size: 1.5rem; margin-bottom: 35px; opacity: 0.9;">نربطك بأفضل المرافقين والأخصائيين النفسيين في الجزائر</p>
            <button class="btn" style="padding: 18px 50px; font-size: 1.2rem; border-radius: 50px;" onclick="openModal('registerModal')" data-i18n="startNow">ابدأ الآن</button>
        </div>
    </section>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('loginModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:25px;" data-i18n="loginTitle">تسجيل الدخول</h2>
            <input type="text" id="loginEmail" data-i18n-ph="emailPh" placeholder="البريد الإلكتروني">
            <input type="password" id="loginPass" data-i18n-ph="passPh" placeholder="كلمة المرور">
            <button class="btn" style="width:100%" onclick="handleLogin()" data-i18n="loginBtn">دخول</button>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeModal('registerModal')">&times;</span>
            <h2 style="text-align:center; margin-bottom:20px;" data-i18n="regTitle">إنشاء حساب جديد</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" style="flex:1; background:#eee; color:#333;" id="roleParent" onclick="setRole('parent')" data-i18n="roleParent">ولي أمر</button>
                <button class="btn" style="flex:1; background:#eee; color:#333;" id="roleComp" onclick="setRole('companion')" data-i18n="roleComp">مرافق</button>
            </div>
            <input type="text" id="regName" placeholder="الاسم الكامل">
            <input type="email" id="regEmail" placeholder="البريد الإلكتروني">
            <input type="tel" id="regPhone" placeholder="رقم الهاتف">
            <select id="regWilaya"></select>
            <div id="compFields" style="display:none;">
                <select id="regSpec">
                    <option value="مرافق طفل التوحد">مرافق طفل التوحد</option>
                    <option value="أخصائي نفساني">أخصائي نفساني</option>
                </select>
            </div>
            <input type="password" id="regPass" placeholder="كلمة المرور">
            <button class="btn" style="width:100%" onclick="handleRegister()" data-i18n="regBtn">تسجيل</button>
        </div>
    </div>

    <!-- Parent Dashboard -->
    <section id="parentDash">
        <div class="dashboard-content">
            <div class="profile-card">
                <div>
                    <h2 id="pName">مرحباً</h2>
                    <p data-i18n="roleParent">ولي أمر طفل</p>
                </div>
                <img id="pImg" src="https://via.placeholder.com/80" style="border-radius:50%; width:80px; height:80px; border:3px solid var(--secondary-color);">
            </div>
            <div style="background:white; padding:25px; border-radius:16px; box-shadow:var(--shadow);">
                <h3 data-i18n="searchTitle">البحث عن مرافق</h3>
                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:15px;">
                    <select id="searchSpec" style="flex:1;"></select>
                    <select id="searchWilaya" style="flex:1;"></select>
                    <button class="btn" onclick="searchCompanions()" data-i18n="searchBtn">بحث</button>
                </div>
            </div>
            <div id="searchResults" style="margin-top:20px;"></div>
            <h3 style="margin:30px 0 15px;" data-i18n="myRequests">طلباتي</h3>
            <div id="parentReqs"></div>
        </div>
    </section>

    <!-- Companion Dashboard -->
    <section id="companionDash">
        <div class="dashboard-content">
            <div class="profile-card">
                <div>
                    <h2 id="cName">مرحباً</h2>
                    <p id="cSpec" style="color:var(--secondary-color); font-weight:bold;"></p>
                </div>
                <img id="cImg" src="https://via.placeholder.com/80" style="border-radius:50%; width:80px; height:80px; border:3px solid var(--secondary-color);">
            </div>
            <div class="stats-grid">
                <div class="stat-box"><h3 id="stTotal">0</h3><p data-i18n="totalReq">إجمالي الطلبات</p></div>
                <div class="stat-box"><h3 id="stAcc">0</h3><p data-i18n="accReq">المقبولة</p></div>
            </div>
            <h3 data-i18n="incomingReq">الطلبات الواردة</h3>
            <div id="compReqs" style="margin-top:15px;"></div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div>
            <h4 data-i18n="logo">مرافق | Morafik</h4>
            <p data-i18n="aboutDesc">منصة لربط الأولياء بأفضل المرافقين المدرسين في الجزائر.</p>
        </div>
        <div>
            <h4 data-i18n="contact">اتصل بنا</h4>
            <p>0559293773</p>
            <p>الرويبة، الجزائر العاصمة</p>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o", authDomain: "mourafik-e9161.firebaseapp.com", projectId: "mourafik-e9161", storageBucket: "mourafik-e9161.firebasestorage.app", messagingSenderId: "133465287328", appId: "1:133465287328:web:9de5b3bd709099d885b7c5" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const i18n = {
            ar: {
                heroTitle: "مرافقة ابنك بأمان", heroSub: "نربطك بأفضل المرافقين والأخصائيين النفسيين في الجزائر",
                login: "دخول", register: "حساب جديد", logout: "خروج", startNow: "ابدأ الآن",
                roleParent: "ولي أمر", roleComp: "مرافق", loginTitle: "تسجيل الدخول", regTitle: "إنشاء حساب جديد",
                searchTitle: "البحث عن مرافق", searchBtn: "بحث", myRequests: "طلباتي", incomingReq: "الطلبات الواردة", logo: "مرافق | Morafik"
            },
            fr: {
                heroTitle: "Accompagner votre enfant en toute sécurité", heroSub: "Nous vous mettons en relation avec les meilleurs accompagnateurs en Algérie",
                login: "Connexion", register: "Inscription", logout: "Déconnexion", startNow: "Commencer",
                roleParent: "Parent", roleComp: "Accompagnateur", loginTitle: "Se Connecter", regTitle: "Créer un compte",
                searchTitle: "Chercher un accompagnateur", searchBtn: "Chercher", myRequests: "Mes demandes", incomingReq: "Demandes reçues", logo: "Morafik | Algérie"
            }
        };

        let curLang = 'ar';
        let currentUser = null;
        let selectedRole = 'parent';

        // Initialization
        window.addEventListener('load', () => {
            populateWilayas();
            setTimeout(() => document.getElementById('loadingScreen').style.display = 'none', 1000);
        });

        // Modals Logic
        window.openModal = (id) => document.getElementById(id).classList.add('open');
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');

        // Language
        window.changeLang = () => {
            curLang = curLang === 'ar' ? 'fr' : 'ar';
            document.dir = curLang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = i18n[curLang][el.getAttribute('data-i18n')]);
            populateWilayas();
        };

        // Auth State
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const snap = await getDoc(doc(db, "users", user.uid));
                if (snap.exists()) {
                    currentUser = snap.data();
                    document.getElementById('navLogin').style.display = 'none';
                    document.getElementById('navReg').style.display = 'none';
                    document.getElementById('navLogout').style.display = 'block';
                    
                    // إخفاء الخلفية تماماً
                    document.getElementById('heroSection').style.display = 'none';
                    
                    if (currentUser.role === 'parent') {
                        document.getElementById('parentDash').classList.add('active');
                        document.getElementById('pName').innerText = currentUser.fullName;
                    } else {
                        document.getElementById('companionDash').classList.add('active');
                        document.getElementById('cName').innerText = currentUser.fullName;
                        document.getElementById('cSpec').innerText = currentUser.specialty;
                    }
                }
            } else {
                document.getElementById('heroSection').style.display = 'flex';
                document.getElementById('parentDash').classList.remove('active');
                document.getElementById('companionDash').classList.remove('active');
                document.getElementById('navLogin').style.display = 'block';
                document.getElementById('navReg').style.display = 'block';
                document.getElementById('navLogout').style.display = 'none';
            }
        });

        window.handleLogin = async () => {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
            try {
                await signInWithEmailAndPassword(auth, e, p);
                closeModal('loginModal');
            } catch { Swal.fire('Error', 'Invalid Email or Password', 'error'); }
        };

        window.handleRegister = async () => {
            const e = document.getElementById('regEmail').value, p = document.getElementById('regPass').value, n = document.getElementById('regName').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, e, p);
                const data = { uid: cred.user.uid, fullName: n, email: e, role: selectedRole, wilaya: document.getElementById('regWilaya').value, createdAt: serverTimestamp() };
                if (selectedRole === 'companion') data.specialty = document.getElementById('regSpec').value;
                await setDoc(doc(db, "users", cred.user.uid), data);
                closeModal('registerModal');
                Swal.fire('Success', 'Account Created', 'success');
            } catch (err) { Swal.fire('Error', err.message, 'error'); }
        };

        window.setRole = (r) => {
            selectedRole = r;
            document.getElementById('roleParent').style.background = r === 'parent' ? 'var(--secondary-color)' : '#eee';
            document.getElementById('roleParent').style.color = r === 'parent' ? '#fff' : '#333';
            document.getElementById('roleComp').style.background = r === 'companion' ? 'var(--secondary-color)' : '#eee';
            document.getElementById('roleComp').style.color = r === 'companion' ? '#fff' : '#333';
            document.getElementById('compFields').style.display = r === 'companion' ? 'block' : 'none';
        };

        window.logout = () => signOut(auth).then(() => window.location.reload());

        function populateWilayas() {
            const wilayas = ["01 Adrar", "02 Chlef", "03 Laghouat", "04 Oum El Bouaghi", "05 Batna", "06 Béjaïa", "07 Biskra", "08 Béchar", "09 Blida", "10 Bouira", "11 Tamanrasset", "12 Tébessa", "13 Tlemcen", "14 Tiaret", "15 Tizi Ouzou", "16 Alger", "17 Djelfa", "18 Jijel", "19 Sétif", "20 Saïda", "21 Skikda", "22 Sidi Bel Abbès", "23 Annaba", "24 Guelma", "25 Constantine", "26 Médéa", "27 Mostaganem", "28 M'Sila", "29 Mascara", "30 Ouargla", "31 Oran", "32 El Bayadh", "33 Illizi", "34 Bordj Bou Arréridj", "35 Boumerdès", "36 El Tarf", "37 Tindouf", "38 Tissemsilt", "39 El Oued", "40 Khenchela", "41 Souk Ahras", "42 Tipaza", "43 Mila", "44 Aïn Defla", "45 Naâma", "46 Aïn Témouchent", "47 Ghardaïa", "48 Relizane", "49 Timimoun", "50 برج باجي مختار", "51 أولاد جلال", "52 بني عباس", "53 عين صالح", "54 عين قزام", "55 تقرت", "56 جانت", "57 المغير", "58 المنيعة"];
            const select = document.getElementById('regWilaya');
            const searchW = document.getElementById('searchWilaya');
            select.innerHTML = ''; searchW.innerHTML = '';
            wilayas.forEach(w => {
                select.innerHTML += `<option value="${w}">${w}</option>`;
                searchW.innerHTML += `<option value="${w}">${w}</option>`;
            });
        }
    </script>
</body>
</html>
