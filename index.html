<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مرافق - Morafik</title>
    
    <!-- Bootstrap 5 RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        :root {
            --primary-color: #1e293b;
            --accent-color: #10b981;
            --gold: #f59e0b;
            --bg-light: #f8fafc;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-light);
            overflow-x: hidden;
            display: flex; flex-direction: column; min-height: 100vh;
            opacity: 0; transition: opacity 0.5s ease;
        }
        body.loaded { opacity: 1; }
        html[lang="fr"] body { font-family: 'Roboto', sans-serif; }
        main { flex: 1; }

        /* Loader */
        #page-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-color); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Landing Page Animation */
        .landing-hero {
            position: relative; min-height: 90vh;
            display: flex; align-items: center; justify-content: center;
            color: white; text-align: center; background-color: #1e293b;
            overflow: hidden;
        }
        .landing-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.8)), url('https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?q=80&w=1000&auto=format&fit=crop');
            background-size: cover; background-position: center top; z-index: 1;
            transform-origin: center;
            animation: zoomMove 20s infinite alternate ease-in-out; 
            will-change: transform;
        }
        @keyframes zoomMove { 0% { transform: scale(1); } 100% { transform: scale(1.15); } }
        
        .landing-content { position: relative; z-index: 2; padding: 20px; }
        
        /* GLOWING TEXT EFFECT */
        .glow-text {
            font-size: 2.5rem; font-weight: 900; 
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(255, 255, 255, 0.5), 0 0 30px var(--accent-color);
        }

        .btn-start {
            background: var(--accent-color); color: white; font-size: 1.3rem; padding: 12px 50px;
            border-radius: 50px; font-weight: bold; box-shadow: 0 0 20px rgba(16, 185, 129, 0.4);
            transition: transform 0.3s; text-decoration: none; border: none;
        }
        .btn-start:hover { transform: scale(1.05); background: #059669; color: #fff; }

        /* UI Components */
        .custom-card {
            background: white; border-radius: 16px; border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .view-section { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .view-section.active { display: block; opacity: 1; }
        .role-selector { cursor: pointer; border: 2px solid #e2e8f0; padding: 15px; border-radius: 12px; transition: all 0.2s; background: #fff; }
        .role-selector.active { border-color: var(--accent-color); background-color: #ecfdf5; }
        
        .form-label { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; color: #475569; }
        .profile-img-preview { width: 90px; height: 90px; object-fit: cover; border-radius: 50%; border: 3px solid var(--accent-color); }
        
        /* Stats Cards */
        .stat-box { padding: 20px; border-radius: 12px; color: white; position: relative; overflow: hidden; }
        /* INCREASED FONT SIZE FOR ADMIN DASHBOARD */
        .stat-box h3 { font-weight: 900; margin-bottom: 0; font-size: 3.5rem; } 
        .stat-box span { font-size: 0.9rem; opacity: 0.9; }
        
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); }
        .bg-gradient-danger { background: linear-gradient(45deg, #e74a3b, #be2617); }

        /* Star Rating Styles */
        .star-rating i { font-size: 2rem; color: #e2e8f0; cursor: pointer; transition: color 0.2s; }
        .star-rating i.active { color: var(--gold); }

        /* Footer Styles */
        .app-footer { background-color: #fff; border-top: 1px solid #eee; padding: 20px 0; margin-top: auto; }
        .footer-link { color: #64748b; text-decoration: none; font-size: 0.9rem; cursor: pointer; transition: color 0.2s; }
        .footer-link:hover { color: var(--primary-color); text-decoration: underline; }

        /* Mobile Table */
        @media (max-width: 768px) {
            .mobile-table thead { display: none; }
            .mobile-table tbody tr { display: block; background: white; margin-bottom: 15px; border-radius: 12px; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid #eee; }
            .mobile-table td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border: none; border-bottom: 1px dashed #eee; }
            .mobile-table td:last-child { border-bottom: none; }
            .mobile-table td::before { content: attr(data-label); font-weight: bold; color: #64748b; font-size: 0.9rem; }
        }
    </style>
</head>
<body>

    <!-- LOADING SCREEN -->
    <div id="page-loader">
        <div class="spinner"></div>
        <h5 class="fw-bold text-muted">...</h5>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-expand bg-white shadow-sm sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-dark d-flex align-items-center" href="#" onclick="goHome()">
                <i class="bi bi-balloon-heart-fill text-success me-2 fs-4"></i> <span data-i18n="app_name">مرافق</span>
            </a>
            
            <div class="d-flex align-items-center gap-2">
                <div id="guestNav" class="d-flex gap-2">
                    <button class="btn btn-sm btn-link text-decoration-none text-dark fw-bold" onclick="goHome()" data-i18n="home">الرئيسية</button>
                    <button class="btn btn-sm btn-outline-primary rounded-pill fw-bold" onclick="goToLogin()" data-i18n="login">دخول</button>
                </div>
                
                <button class="btn btn-sm fw-bold border-2 border-primary text-primary rounded-pill ms-2" onclick="toggleLanguage()" id="langSwitcher">FR</button>
                
                <!-- User Nav -->
                <div id="userNav" class="d-none d-flex align-items-center gap-2">
                    <button class="btn btn-light btn-sm position-relative rounded-circle border" onclick="openNotifications()">
                        <i class="bi bi-bell-fill text-warning"></i>
                        <span id="notifBadge" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle d-none"></span>
                    </button>
                    
                    <button class="btn btn-outline-primary btn-sm rounded-pill" onclick="openEditProfileModal()">
                        <i class="bi bi-gear-fill"></i> <span class="d-none d-md-inline" data-i18n="settings">إعدادات</span>
                    </button>
                    <span id="userInfo" class="text-secondary small fw-bold d-none d-md-block mx-2"></span>
                    <button class="btn btn-light btn-sm text-danger border fw-bold rounded-pill" onclick="logout()">
                        <i class="bi bi-box-arrow-left"></i> <span class="d-none d-md-inline" data-i18n="logout">خروج</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <!-- 0. LANDING VIEW -->
        <section id="landingView" class="view-section active">
            <div class="landing-hero">
                <div class="landing-bg"></div>
                <div class="landing-content container">
                    <!-- GLOWING TEXT ADDED HERE -->
                    <h1 class="mb-3 glow-text" data-i18n="welcome_title">أهلاً بك في عائلة مرافق</h1>
                    <p class="subtitle mb-5 text-white fs-4" data-i18n="slogan"> حيث أفظل الاخصائيين و المرافقين <                 <button class="btn-start" onclick="startNow()" data-i18n="start_now">ابدأ الآن <i class="bi bi-arrow-left"></i></button>
                </div>
            </div>
        </section>

        <!-- 1. AUTH SCREEN -->
        <section id="authView" class="view-section">
            <div class="container py-5">
                <div class="row justify-content-center">
                    <div class="col-md-8 col-lg-5">
                        <div class="custom-card p-4 shadow-lg">
                            <h3 class="text-center fw-bold mb-4" data-i18n="app_name">مرافق</h3>
                            <ul class="nav nav-pills mb-4 nav-justified p-1 bg-light rounded-pill">
                                <li class="nav-item"><button class="nav-link active rounded-pill" id="tab-login" data-bs-toggle="pill" data-bs-target="#login-content" data-i18n="login">دخول</button></li>
                                <li class="nav-item"><button class="nav-link rounded-pill" id="tab-register" data-bs-toggle="pill" data-bs-target="#register-content" data-i18n="register">حساب جديد</button></li>
                            </ul>
                            
                            <div class="tab-content">
                                <!-- Login -->
                                <div class="tab-pane fade show active" id="login-content">
                                    <form id="loginForm">
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="email_label">البريد الإلكتروني</label>
                                            <input type="text" class="form-control" id="loginEmail" required data-i18n-placeholder="email_placeholder">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label" data-i18n="pass_label">كلمة المرور</label>
                                            <input type="password" class="form-control" id="loginPass" required data-i18n-placeholder="password_placeholder">
                                        </div>
                                        <div class="text-end mb-4"><a href="#" class="text-decoration-none small text-muted" onclick="openForgotPassModal()" data-i18n="forgot_password">نسيت كلمة المرور؟</a></div>
                                        <button type="submit" class="btn btn-primary w-100 py-2 rounded-3 fw-bold" data-i18n="login_btn">تسجيل الدخول</button>
                                    </form>
                                    <div class="mt-3 text-center small text-muted">للتجربة كمسؤول: admin / abobob123</div>
                                </div>
                                <!-- Register -->
                                <div class="tab-pane fade" id="register-content">
                                    <form id="registerForm">
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <div class="role-selector text-center active" onclick="selectRole('parent', this)">
                                                    <i class="bi bi-person-fill fs-3 text-primary"></i> <div class="small fw-bold mt-1" data-i18n="role_parent">ولي أمر</div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="role-selector text-center" onclick="selectRole('caregiver', this)">
                                                    <i class="bi bi-heart-pulse-fill fs-3 text-danger"></i> <div class="small fw-bold mt-1" data-i18n="role_caregiver">مرافقة / مختص</div>
                                                </div>
                                            </div>
                                        </div>
                                        <input type="hidden" id="regRole" value="parent">
                                        <div class="mb-2">
                                            <label class="form-label" data-i18n="fullname">الاسم الكامل</label>
                                            <input type="text" class="form-control" id="regName" data-i18n-placeholder="fullname" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label" data-i18n="email_label">البريد الإلكتروني</label>
                                            <input type="email" class="form-control" id="regEmail" data-i18n-placeholder="email_placeholder" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label" data-i18n="phone">رقم الهاتف</label>
                                            <input type="tel" class="form-control" id="regPhone" data-i18n-placeholder="phone" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label" data-i18n="pass_label">كلمة المرور</label>
                                            <input type="password" class="form-control" id="regPass" data-i18n-placeholder="password_placeholder" required>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label" data-i18n="wilaya">الولاية</label>
                                            <select class="form-select dynamic-wilaya" id="regWilaya" required></select>
                                        </div>
                                        <div id="caregiverFields" class="d-none mt-3 p-3 bg-light rounded border">
                                            <div class="mb-2">
                                                <label class="form-label" data-i18n="service_type">نوع الخدمة</label>
                                                <select class="form-select dynamic-service" id="regService"></select>
                                            </div>
                                            <div class="mb-0"><label class="small fw-bold" data-i18n="upload_cert">رفع الشهادة (PDF)</label><input type="file" class="form-control" id="regCert" accept=".pdf"></div>
                                        </div>
                                        <button type="submit" class="btn btn-success w-100 mt-3 py-2 fw-bold" data-i18n="create_account_btn">إنشاء حساب</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 2. PARENT VIEW -->
        <section id="parentView" class="view-section">
            <div class="container py-4">
                <!-- Parent Simple Dashboard -->
                <div class="row g-3 mb-4">
                    <div class="col-4"><div class="stat-box bg-gradient-primary text-center"><h3><i class="bi bi-send"></i></h3><span id="pStatTotal">0</span> <span data-i18n="stat_total_req">الطلبات</span></div></div>
                    <div class="col-4"><div class="stat-box bg-gradient-success text-center"><h3><i class="bi bi-check-circle"></i></h3><span id="pStatAccepted">0</span> <span data-i18n="stat_accepted">مقبولة</span></div></div>
                    <div class="col-4"><div class="stat-box bg-gradient-warning text-center"><h3><i class="bi bi-hourglass-split"></i></h3><span id="pStatPending">0</span> <span data-i18n="stat_new_req">انتظار</span></div></div>
                </div>

                <h4 class="fw-bold text-primary mb-3"><i class="bi bi-search"></i> <span data-i18n="search_title">ابحث عن مختص</span></h4>
                <div class="custom-card p-3 mb-4">
                    <div class="row g-2">
                        <div class="col-6 col-md-3">
                            <label class="form-label" data-i18n="wilaya">الولاية</label>
                            <select class="form-select dynamic-wilaya" id="searchWilaya"><option value="الكل" data-i18n="all_wilayas">كل الولايات</option></select>
                        </div>
                        <div class="col-6 col-md-3">
                            <label class="form-label" data-i18n="service_type">الخدمة</label>
                            <select class="form-select dynamic-service" id="searchService"><option value="الكل" data-i18n="all_services">كل الخدمات</option></select>
                        </div>
                        <div class="col-8 col-md-4">
                            <label class="form-label" data-i18n="child_age">عمر الطفل</label>
                            <input type="number" class="form-control" id="searchAge">
                        </div>
                        <div class="col-4 col-md-2 d-flex align-items-end">
                            <button class="btn btn-primary w-100 fw-bold" onclick="performSearch()" data-i18n="search_btn">بحث</button>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-5" id="resultsArea"></div>
                <h5 class="fw-bold border-bottom pb-2 mb-3" data-i18n="my_requests">طلباتي السابقة</h5>
                <div class="custom-card p-0"><table class="table table-hover mb-0 mobile-table"><thead class="table-light"><tr><th data-i18n="th_caregiver">المختص</th><th data-i18n="th_service">الطفل</th><th data-i18n="th_status">الحالة</th><th data-i18n="th_action">الإجراء</th></tr></thead><tbody id="myRequestsTable"></tbody></table></div>
            </div>
        </section>

        <!-- 3. CAREGIVER VIEW -->
        <section id="caregiverView" class="view-section">
            <div class="container py-4">
                <div class="custom-card p-3 mb-4 d-flex align-items-center bg-white border-start border-4 border-success">
                    <img id="dashboardProfileImg" src="" class="profile-img-preview me-3">
                    <div class="flex-grow-1">
                        <h5 class="mb-1 fw-bold" id="cgNameProfile"></h5>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="availabilityToggle" onchange="toggleAvailability()">
                            <label class="form-check-label fw-bold small" for="availabilityToggle" id="availabilityLabel" data-i18n="status_online">أنا في الخدمة</label>
                        </div>
                    </div>
                </div>
                <!-- Caregiver Dashboard Stats -->
                <div class="row mb-4 g-3">
                    <div class="col-6 col-md-3"><div class="stat-box bg-gradient-primary text-center"><h3 id="cgStatTotal">0</h3><span data-i18n="stat_total_req">الكل</span></div></div>
                    <div class="col-6 col-md-3"><div class="stat-box bg-gradient-warning text-center"><h3 id="cgStatPending">0</h3><span data-i18n="stat_new_req">انتظار</span></div></div>
                    <div class="col-6 col-md-3"><div class="stat-box bg-gradient-success text-center"><h3 id="cgStatAccepted">0</h3><span data-i18n="stat_accepted">مقبولة</span></div></div>
                    <div class="col-6 col-md-3"><div class="stat-box bg-gradient-danger text-center"><h3 id="cgStatRejected">0</h3><span data-i18n="stat_rejected">مرفوضة</span></div></div>
                </div>
                <h5 class="fw-bold mb-3"><i class="bi bi-inbox-fill text-primary"></i> <span data-i18n="incoming_requests">الطلبات الواردة</span></h5>
                <div class="custom-card p-0"><table class="table mb-0 mobile-table align-middle"><thead class="table-light"><tr><th data-i18n="th_parent">الولي</th><th data-i18n="th_child">الطفل</th><th data-i18n="th_details">التفاصيل</th><th data-i18n="th_days">الأيام</th><th data-i18n="th_action">الإجراء</th></tr></thead><tbody id="incomingRequestsTable"></tbody></table></div>
            </div>
        </section>
        
        <!-- 4. ADMIN VIEW -->
        <section id="adminView" class="view-section">
            <div class="container py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="fw-bold text-primary mb-0" data-i18n="admin_panel">لوحة التحكم <span class="badge bg-danger fs-6">Admin</span></h3>
                    <button class="btn btn-dark btn-sm rounded-pill" onclick="openSendNotifModal()"><i class="bi bi-megaphone-fill"></i> <span data-i18n="send_notif">إرسال إشعار</span></button>
                </div>

                <!-- Admin Stats (BIG NUMBERS) -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3"><div class="stat-box bg-gradient-primary"><h3><i class="bi bi-people"></i> <span id="statTotalUsers" class="float-end">0</span></h3><span data-i18n="stat_users">المستخدمين</span></div></div>
                    <div class="col-md-3"><div class="stat-box bg-gradient-success"><h3><i class="bi bi-heart-pulse"></i> <span id="statCaregivers" class="float-end">0</span></h3><span data-i18n="stat_caregivers">المرافقات</span></div></div>
                    <div class="col-md-3"><div class="stat-box bg-gradient-warning"><h3><i class="bi bi-chat-right-text"></i> <span id="statReportsCount" class="float-end">0</span></h3><span data-i18n="stat_reports">الشكاوى</span></div></div>
                    <div class="col-md-3"><div class="stat-box bg-gradient-danger"><h3><i class="bi bi-check2-all"></i> <span id="statSuccessOps" class="float-end">0</span></h3><span data-i18n="successful_ops">عمليات ناجحة</span></div></div>
                </div>

                <div class="row g-4 mb-4">
                    <div class="col-lg-5">
                        <div class="custom-card h-100 p-4">
                            <h5 class="fw-bold mb-3 text-success"><i class="bi bi-trophy-fill"></i> <span data-i18n="successful_caregivers">أنجح المرافقات</span></h5>
                            <table class="table table-borderless align-middle mb-0"><tbody id="adminTopCaregivers"></tbody></table>
                        </div>
                    </div>
                    <div class="col-lg-7">
                        <div class="custom-card h-100 p-4">
                            <h5 class="fw-bold mb-3 text-primary"><i class="bi bi-graph-up-arrow"></i> <span data-i18n="daily_transactions">التعاملات اليومية</span></h5>
                            <div class="table-responsive"><table class="table table-sm table-hover align-middle"><thead class="table-light"><tr><th data-i18n="th_parent">الولي</th><th data-i18n="th_caregiver">المرافقة</th><th data-i18n="th_status">الحالة</th></tr></thead><tbody id="adminDailyTrans"></tbody></table></div>
                        </div>
                    </div>
                </div>

                <div class="custom-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0"><i class="bi bi-people-fill"></i> <span data-i18n="manage_users">إدارة المستخدمين</span></h5>
                        <input type="text" class="form-control w-50" id="adminSearch" data-i18n-placeholder="search_placeholder" onkeyup="loadAdminDashboard()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle table-bordered">
                            <thead class="table-light"><tr><th data-i18n="th_name">الاسم</th><th data-i18n="th_role">النوع</th><th data-i18n="phone">الهاتف</th><th>Email</th><th class="text-danger">Pass</th><th data-i18n="th_status">الحالة</th><th data-i18n="th_action">إجراء</th></tr></thead>
                            <tbody id="adminUsersTable"></tbody>
                        </table>
                    </div>
                </div>

                <div class="custom-card p-4 mb-4">
                    <h5 class="fw-bold mb-3"><i class="bi bi-envelope-exclamation-fill"></i> <span data-i18n="reports_messages">الشكاوى والرسائل</span></h5>
                    <div class="table-responsive"><table class="table table-striped table-sm"><thead class="table-dark"><tr><th data-i18n="sender">المرسل</th><th data-i18n="type">النوع</th><th data-i18n="message">الرسالة</th><th data-i18n="date">التاريخ</th></tr></thead><tbody id="adminReportsTable"></tbody></table></div>
                </div>
            </div>
        </section>
    </main>

    <!-- FOOTER WITH LINKS -->
    <footer class="app-footer">
        <div class="container text-center">
            <h5 class="fw-bold text-dark mb-3" data-i18n="app_name">مرافق</h5>
            <div class="d-flex justify-content-center flex-wrap gap-3 mb-3">
                <span class="footer-link" onclick="openModal('aboutModal')" data-i18n="about_us">من نحن</span>
                <span class="footer-link" onclick="openModal('privacyModal')" data-i18n="privacy_policy">سياسة الخصوصية</span>
                <span class="footer-link" onclick="openModal('contactModal')" data-i18n="contact_us">تواصل معنا</span>
            </div>
            <div class="mb-3 text-muted small">
                <i class="bi bi-geo-alt-fill text-danger"></i> <span data-i18n="location_text">رويبة، الجزائر العاصمة</span>
            </div>
            <button class="btn btn-sm btn-outline-danger rounded-pill mb-3" onclick="openModal('reportModal')">
                <i class="bi bi-exclamation-triangle"></i> <span data-i18n="report_issue">الإبلاغ عن مشكلة</span>
            </button>
            <p class="small text-muted mb-0" data-i18n="copyright">جميع الحقوق محفوظة &copy; 2024</p>
        </div>
    </footer>

    <!-- ================= MODALS ================= -->
    
    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" data-i18n="about_us">من نحن</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" data-i18n="about_content">منصة جزائرية مبتكرة تهدف لربط الأولياء بأفضل المختصين. مقرنا في رويبة، الجزائر العاصمة. نسعى لتوفير بيئة آمنة لطفلك.</div>
            </div>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div class="modal fade" id="privacyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" data-i18n="privacy_policy">سياسة الخصوصية</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body" data-i18n="privacy_content">نحن نلتزم بحماية بياناتك الشخصية. جميع المعلومات تستخدم فقط لغرض تحسين الخدمة ولن يتم مشاركتها مع أطراف ثالثة دون موافقتك.</div>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" data-i18n="contact_us">تواصل معنا</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <p class="mb-2"><i class="bi bi-geo-alt-fill text-danger"></i> <span data-i18n="location_text">رويبة، الجزائر العاصمة</span></p>
                    <p class="mb-3"><i class="bi bi-envelope-fill text-primary"></i> contact@morafik.dz</p>
                    <form onsubmit="submitReport(event, 'رسالة تواصل')">
                        <div class="mb-3"><input type="text" class="form-control" placeholder="الاسم" required></div>
                        <div class="mb-3"><textarea class="form-control" rows="3" placeholder="الرسالة" required></textarea></div>
                        <button type="submit" class="btn btn-primary w-100" data-i18n="send">إرسال</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Modal -->
    <div class="modal fade" id="reportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white"><h5 class="modal-title" data-i18n="report_issue">الإبلاغ عن مشكلة</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form onsubmit="submitReport(event, 'بلاغ عن مشكلة')">
                        <div class="mb-3"><textarea class="form-control" rows="4" placeholder="تفاصيل المشكلة..." required></textarea></div>
                        <button type="submit" class="btn btn-danger w-100" data-i18n="send">إرسال البلاغ</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Modal -->
    <div class="modal fade" id="requestModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" data-i18n="request_service">تقديم طلب خدمة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sendRequestForm">
                        <input type="hidden" id="targetCaregiverId">
                        <div class="mb-3"><label class="form-label" data-i18n="child_name">اسم الطفل</label><input type="text" class="form-control" id="reqChildName" required></div>
                        <div class="row">
                            <div class="col-6 mb-3"><label class="form-label" data-i18n="child_age">العمر</label><input type="number" class="form-control" id="reqChildAge" required></div>
                            <div class="col-6 mb-3">
                                <label class="form-label" data-i18n="school_level">الطور الدراسي</label>
                                <select class="form-select" id="reqSchoolLevel" required>
                                    <option value="ابتدائي" data-i18n="lvl_primary">ابتدائي</option>
                                    <option value="متوسط" data-i18n="lvl_middle">متوسط</option>
                                    <option value="ثانوي" data-i18n="lvl_secondary">ثانوي</option>
                                    <option value="غير متمدرس" data-i18n="lvl_none">غير متمدرس</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="child_condition">حالة الطفل</label>
                            <select class="form-select" id="reqChildCondition" required>
                                <option value="عادي" data-i18n="cond_normal">عادي</option>
                                <option value="طيف توحد" data-i18n="cond_autism">طيف توحد</option>
                                <option value="تأخر نطق" data-i18n="cond_speech">تأخر نطق</option>
                                <option value="فرط حركة" data-i18n="cond_adhd">فرط حركة</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="duration">المدة</label>
                            <select class="form-select" id="reqDuration">
                                <option value="جلسة" data-i18n="dur_session">جلسة واحدة</option>
                                <option value="شهر" data-i18n="1_month">شهر</option>
                                <option value="فصل دراسي" data-i18n="dur_term">فصل دراسي</option>
                                <option value="سنة دراسية" data-i18n="dur_year">طيلة العام الدراسي</option>
                            </select>
                        </div>
                        <div class="mb-3"><label class="form-label" data-i18n="days">الأيام المفضلة</label><input type="text" class="form-control" id="reqDays" required placeholder="مثال: الأحد، الثلاثاء..."></div>
                        <button type="submit" class="btn btn-primary w-100 fw-bold" data-i18n="confirm_send">تأكيد وإرسال</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Rating Modal -->
    <div class="modal fade" id="rateModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" data-i18n="rate_caregiver">تقييم المرافقة</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <h6 id="rateCgName" class="mb-3"></h6>
                    <div class="star-rating mb-3 d-flex justify-content-center gap-2" id="starContainer">
                        <i class="bi bi-star-fill" data-val="1"></i>
                        <i class="bi bi-star-fill" data-val="2"></i>
                        <i class="bi bi-star-fill" data-val="3"></i>
                        <i class="bi bi-star-fill" data-val="4"></i>
                        <i class="bi bi-star-fill" data-val="5"></i>
                    </div>
                    <input type="hidden" id="ratingValue" value="0">
                    <input type="hidden" id="rateRequestId">
                    <input type="hidden" id="rateCaregiverId">
                    <div class="mb-3">
                        <textarea id="rateComment" class="form-control" rows="3" data-i18n-placeholder="comment_placeholder" placeholder="اكتب تعليقك هنا..."></textarea>
                    </div>
                    <button onclick="submitReview()" class="btn btn-dark w-100" data-i18n="submit_rating">إرسال التقييم</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" data-i18n="edit_profile">تعديل البروفايل</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="text-center mb-3">
                            <div class="position-relative d-inline-block">
                                <img id="editImgPreview" src="" class="profile-img-preview">
                                <label for="editProfilePic" class="position-absolute bottom-0 start-0 bg-primary text-white p-1 rounded-circle" style="cursor: pointer;"><i class="bi bi-camera-fill small"></i></label>
                            </div>
                            <input type="file" id="editProfilePic" class="d-none" accept="image/*">
                        </div>
                        <div class="mb-3"><label class="form-label" data-i18n="fullname">الاسم الكامل</label><input type="text" class="form-control" id="editName" required></div>
                        <div class="mb-3"><label class="form-label" data-i18n="phone">رقم الهاتف</label><input type="tel" class="form-control" id="editPhone" required></div>
                        <div class="mb-3"><label class="form-label" data-i18n="wilaya">الولاية</label><select class="form-select dynamic-wilaya" id="editWilaya" required></select></div>
                        <div class="bg-light p-3 rounded mb-3 border">
                            <h6 class="text-danger small fw-bold mb-2" data-i18n="change_pass">تغيير كلمة المرور</h6>
                            <input type="text" class="form-control form-control-sm" id="editNewPass">
                        </div>
                        <div id="caregiverEditFields" class="d-none pt-2">
                            <h6 class="text-primary fw-bold mb-2" data-i18n="pro_info">معلومات مهنية</h6>
                            <div class="mb-2"><select class="form-select dynamic-service" id="editService"></select></div>
                        </div>
                        <button type="submit" class="btn btn-success w-100 fw-bold mt-2" data-i18n="save">حفظ التغييرات</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal fade" id="notifModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title fw-bold" data-i18n="notifications">الإشعارات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="notifList" class="list-group list-group-flush">
                        <!-- Filled by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Send Notification Modal -->
    <div class="modal fade" id="adminSendNotifModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" data-i18n="send_notif">إرسال إشعار عام</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form onsubmit="sendAdminNotification(event)">
                        <div class="mb-3">
                            <label class="form-label" data-i18n="target_audience">الفئة المستهدفة</label>
                            <select class="form-select" id="notifTarget">
                                <option value="all" data-i18n="all">الجميع</option>
                                <option value="parent" data-i18n="role_parent">أولياء الأمور</option>
                                <option value="caregiver" data-i18n="role_caregiver">المرافقات/المختصين</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="message">نص الرسالة</label>
                            <textarea class="form-control" id="notifMsg" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" data-i18n="send">إرسال باسم (فريق مرافق)</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal fade" id="forgotPassModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" data-i18n="forgot_password">نسيت كلمة المرور؟</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted" data-i18n="recover_hint">أدخل بريدك الإلكتروني لاستعادة كلمة المرور.</p>
                    <input type="email" class="form-control mb-3" placeholder="user@mail.com">
                    <button class="btn btn-primary w-100" onclick="bootstrap.Modal.getInstance(document.getElementById('forgotPassModal')).hide();Swal.fire('تم الإرسال')">إرسال</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            setTimeout(() => { document.getElementById('page-loader').style.display = 'none'; document.body.classList.add('loaded'); }, 800);

            // --- DATA: FULL 58 WILAYAS ---
            const wilayas = [
                {id:1,ar:"أدرار",fr:"Adrar"},{id:2,ar:"الشلف",fr:"Chlef"},{id:3,ar:"الأغواط",fr:"Laghouat"},{id:4,ar:"أم البواقي",fr:"Oum El Bouaghi"},
                {id:5,ar:"باتنة",fr:"Batna"},{id:6,ar:"بجاية",fr:"Béjaïa"},{id:7,ar:"بسكرة",fr:"Biskra"},{id:8,ar:"بشار",fr:"Béchar"},
                {id:9,ar:"البليدة",fr:"Blida"},{id:10,ar:"البويرة",fr:"Bouira"},{id:11,ar:"تمنراست",fr:"Tamanrasset"},{id:12,ar:"تبسة",fr:"Tébessa"},
                {id:13,ar:"تلمسان",fr:"Tlemcen"},{id:14,ar:"تيارت",fr:"Tiaret"},{id:15,ar:"تيزي وزو",fr:"Tizi Ouzou"},{id:16,ar:"الجزائر",fr:"Alger"},
                {id:17,ar:"الجلفة",fr:"Djelfa"},{id:18,ar:"جيجل",fr:"Jijel"},{id:19,ar:"سطيف",fr:"Sétif"},{id:20,ar:"سعيدة",fr:"Saïda"},
                {id:21,ar:"سكيكدة",fr:"Skikda"},{id:22,ar:"سيدي بلعباس",fr:"Sidi Bel Abbès"},{id:23,ar:"عنابة",fr:"Annaba"},{id:24,ar:"قالمة",fr:"Guelma"},
                {id:25,ar:"قسنطينة",fr:"Constantine"},{id:26,ar:"المدية",fr:"Médéa"},{id:27,ar:"مستغانم",fr:"Mostaganem"},{id:28,ar:"المسيلة",fr:"M'Sila"},
                {id:29,ar:"معسكر",fr:"Mascara"},{id:30,ar:"ورقلة",fr:"Ouargla"},{id:31,ar:"وهران",fr:"Oran"},{id:32,ar:"البيض",fr:"El Bayadh"},
                {id:33,ar:"إليزي",fr:"Illizi"},{id:34,ar:"برج بوعريريج",fr:"Bordj Bou Arreridj"},{id:35,ar:"بومرداس",fr:"Boumerdès"},{id:36,ar:"الطارف",fr:"El Tarf"},
                {id:37,ar:"تندوف",fr:"Tindouf"},{id:38,ar:"تيسمسيلت",fr:"Tissemsilt"},{id:39,ar:"الوادي",fr:"El Oued"},{id:40,ar:"خنشلة",fr:"Khenchela"},
                {id:41,ar:"سوق أهراس",fr:"Souk Ahras"},{id:42,ar:"تيبازة",fr:"Tipaza"},{id:43,ar:"ميلة",fr:"Mila"},{id:44,ar:"عين الدفلى",fr:"Aïn Defla"},
                {id:45,ar:"النعامة",fr:"Naâma"},{id:46,ar:"عين تموشنت",fr:"Aïn Témouchent"},{id:47,ar:"غرداية",fr:"Ghardaïa"},{id:48,ar:"غليزان",fr:"Relizane"},
                {id:49,ar:"تيميمون",fr:"Timimoun"},{id:50,ar:"برج باجي مختار",fr:"Bordj Badji Mokhtar"},{id:51,ar:"أولاد جلال",fr:"Ouled Djellal"},{id:52,ar:"بني عباس",fr:"Béni Abbès"},
                {id:53,ar:"إن صالح",fr:"In Salah"},{id:54,ar:"إن قزام",fr:"In Guezzam"},{id:55,ar:"توقرت",fr:"Touggourt"},{id:56,ar:"جانت",fr:"Djanet"},
                {id:57,ar:"المغير",fr:"El M'Ghair"},{id:58,ar:"المنيعة",fr:"El Meniaa"}
            ];

            const services = [
                {code:"srv_psych",ar:"استشارة (أخصائي نفساني)",fr:"Consultation (Psychologue)"},
                {code:"srv_autism",ar:"مرافق طفل التوحد",fr:"Accompagnateur enfant autiste"},
                {code:"srv_speech",ar:"أرطوفونيا (تصحيح النطق)",fr:"Orthophoniste"},
                {code:"srv_nurse",ar:"ممرض منزلي",fr:"Infirmier à domicile"}
            ];

            const translations = {
                ar: {
                    app_name:"مرافق", home:"الرئيسية", login:"دخول", register:"حساب جديد", start_now:"ابدأ الآن",
                    welcome_title:"أهلاً بك في عائلة مرافق", slogan:"طفلك في أيادي آمنة",
                    role_parent:"ولي أمر", role_caregiver:"مرافقة / مختص",
                    email_label:"البريد الإلكتروني", email_placeholder:"مثال: user@mail.com",
                    pass_label:"كلمة المرور", password_placeholder:"******",
                    fullname:"الاسم الكامل", phone:"رقم الهاتف", wilaya:"الولاية",
                    search_title:"ابحث عن مختص", all_wilayas:"كل الولايات", all_services:"كل الخدمات",
                    search_btn:"بحث", service_type:"نوع الخدمة",
                    child_age:"عمر الطفل", child_name:"اسم الطفل", school_level:"الطور الدراسي",
                    lvl_primary:"ابتدائي", lvl_middle:"متوسط", lvl_secondary:"ثانوي", lvl_none:"غير متمدرس",
                    child_condition:"حالة الطفل", cond_normal:"عادي", cond_autism:"طيف توحد", cond_speech:"تأخر نطق", cond_adhd:"فرط حركة",
                    duration:"المدة", dur_session:"جلسة واحدة", dur_term:"فصل دراسي", dur_year:"سنة دراسية", "1_month":"شهر",
                    days:"الأيام المفضلة", confirm_send:"تأكيد وإرسال",
                    edit_profile:"تعديل البروفايل", save:"حفظ التغييرات", change_pass:"تغيير كلمة المرور", pro_info:"معلومات مهنية",
                    upload_cert:"رفع الشهادة المهنية",
                    th_caregiver:"المختص", th_service:"الطفل", th_status:"الحالة", th_action:"الإجراء",
                    status_online:"أنا في الخدمة", incoming_requests:"الطلبات الواردة", th_parent:"الولي", th_child:"الطفل", th_details:"التفاصيل",
                    stat_total_req:"الكل", stat_new_req:"انتظار", stat_accepted:"مقبولة", stat_rejected:"مرفوضة",
                    settings:"إعدادات", logout:"خروج", forgot_password:"نسيت كلمة المرور؟", login_btn:"تسجيل الدخول", create_account_btn:"إنشاء حساب",
                    my_requests:"طلباتي السابقة",
                    admin_panel:"لوحة التحكم", send_notif:"إرسال إشعار", stat_users:"المستخدمين", stat_caregivers:"المرافقات", stat_reports:"الشكاوى",
                    successful_ops:"عمليات ناجحة", successful_caregivers:"أنجح المرافقات", daily_transactions:"التعاملات اليومية", manage_users:"إدارة المستخدمين",
                    reports_messages:"الشكاوى والرسائل", sender:"المرسل", type:"النوع", message:"الرسالة", date:"التاريخ",
                    target_audience:"الفئة المستهدفة", all:"الجميع", send:"إرسال", notifications:"الإشعارات", search_placeholder:"بحث...",
                    th_name:"الاسم", th_role:"النوع", alert_error:"خطأ", alert_sent:"تم الإرسال",
                    rate_caregiver:"تقييم المرافقة", comment_placeholder:"اكتب تعليقك هنا...", submit_rating:"إرسال التقييم",
                    about_us:"من نحن", privacy_policy:"سياسة الخصوصية", contact_us:"تواصل معنا", report_issue:"الإبلاغ عن مشكلة", copyright:"جميع الحقوق محفوظة © 2024",
                    about_content:"منصة جزائرية مبتكرة تهدف لربط الأولياء بأفضل المختصين. مقرنا في رويبة، الجزائر العاصمة. نسعى لتوفير بيئة آمنة لطفلك.",
                    privacy_content:"نحن نلتزم بحماية بياناتك الشخصية. جميع المعلومات تستخدم فقط لغرض تحسين الخدمة ولن يتم مشاركتها مع أطراف ثالثة دون موافقتك.",
                    location_text:"رويبة، الجزائر العاصمة", recover_hint:"أدخل بريدك الإلكتروني لاستعادة كلمة المرور."
                },
                fr: {
                    app_name:"Morafik", home:"Accueil", login:"Connexion", register:"Inscription", start_now:"Commencer",
                    welcome_title:"Bienvenue chez Morafik", slogan:"Votre enfant en sécurité",
                    role_parent:"Parent", role_caregiver:"Spécialiste",
                    email_label:"Email", email_placeholder:"ex: user@mail.com",
                    pass_label:"Mot de passe", password_placeholder:"******",
                    fullname:"Nom complet", phone:"Téléphone", wilaya:"Wilaya",
                    search_title:"Trouver un spécialiste", all_wilayas:"Toutes Wilayas", all_services:"Tous Services",
                    search_btn:"Rechercher", service_type:"Service",
                    child_age:"Âge enfant", child_name:"Nom enfant", school_level:"Niveau scolaire",
                    lvl_primary:"Primaire", lvl_middle:"Moyen", lvl_secondary:"Lycée", lvl_none:"Aucun",
                    child_condition:"État de l'enfant", cond_normal:"Normal", cond_autism:"Autiste", cond_speech:"Retard parole", cond_adhd:"TDAH",
                    duration:"Durée", dur_session:"Séance", dur_term:"Trimestre", dur_year:"Année scolaire", "1_month":"1 Mois",
                    days:"Jours préférés", confirm_send:"Confirmer",
                    edit_profile:"Modifier Profil", save:"Enregistrer", change_pass:"Changer mot de passe", pro_info:"Infos pro",
                    upload_cert:"Diplôme (PDF)",
                    th_caregiver:"Spécialiste", th_service:"Enfant", th_status:"Statut", th_action:"Action",
                    status_online:"En Service", incoming_requests:"Demandes reçues", th_parent:"Parent", th_child:"Enfant", th_details:"Détails",
                    stat_total_req:"Total", stat_new_req:"Attente", stat_accepted:"Accepté", stat_rejected:"Refusé",
                    settings:"Paramètres", logout:"Déconnexion", forgot_password:"Mot de passe oublié?", login_btn:"Se connecter", create_account_btn:"Créer compte",
                    my_requests:"Mes demandes",
                    admin_panel:"Panneau Admin", send_notif:"Envoyer Notif", stat_users:"Utilisateurs", stat_caregivers:"Spécialistes", stat_reports:"Signalements",
                    successful_ops:"Opérations réussies", successful_caregivers:"Top Spécialistes", daily_transactions:"Transactions du jour", manage_users:"Gérer utilisateurs",
                    reports_messages:"Signalements & Messages", sender:"Expéditeur", type:"Type", message:"Message", date:"Date",
                    target_audience:"Cible", all:"Tous", send:"Envoyer", notifications:"Notifications", search_placeholder:"Rechercher...",
                    th_name:"Nom", th_role:"Rôle", alert_error:"Erreur", alert_sent:"Envoyé",
                    rate_caregiver:"Noter le spécialiste", comment_placeholder:"Votre commentaire...", submit_rating:"Envoyer l'avis",
                    about_us:"À propos", privacy_policy:"Confidentialité", contact_us:"Contactez-nous", report_issue:"Signaler problème", copyright:"Tous droits réservés © 2024",
                    about_content:"Plateforme algérienne innovante reliant les parents aux meilleurs spécialistes. Basée à Rouiba, Alger. Nous assurons un environnement sûr.",
                    privacy_content:"Nous protégeons vos données. Toutes les infos sont utilisées uniquement pour le service et ne seront pas partagées sans accord.",
                    location_text:"Rouiba, Alger", recover_hint:"Entrez votre email pour récupérer le mot de passe."
                }
            };

            let currentLang = 'ar';
            function t(key) { return translations[currentLang][key] || key; }

            // Init DB
            const initialUsers = [
                { id: 'c1', name: 'د. سارة (نفسانية)', email: 'doc@test.com', pass: '123', role: 'caregiver', phone: '0550112233', wilaya: 'الجزائر', service: 'استشارة (أخصائي نفساني)', isAvailable: true, photo: "https://cdn-icons-png.flaticon.com/512/3304/3304567.png", isBanned: false },
                { id: 'p1', name: 'أحمد الولي', email: 'parent@test.com', pass: '123', role: 'parent', phone: '0555000000', wilaya: 'الجزائر', photo: "https://cdn-icons-png.flaticon.com/512/3011/3011270.png", isBanned: false }
            ];
            if (!localStorage.getItem('users')) localStorage.setItem('users', JSON.stringify(initialUsers));
            if (!localStorage.getItem('requests')) localStorage.setItem('requests', JSON.stringify([]));
            if (!localStorage.getItem('notifications')) localStorage.setItem('notifications', JSON.stringify([]));
            if (!localStorage.getItem('reviews')) localStorage.setItem('reviews', JSON.stringify([]));

            const DB = {
                getUsers: () => JSON.parse(localStorage.getItem('users')),
                saveUser: (u) => { const us = DB.getUsers(); us.push(u); localStorage.setItem('users', JSON.stringify(us)); },
                saveAllUsers: (us) => localStorage.setItem('users', JSON.stringify(us)),
                updateUser: (updatedUser) => { const users = DB.getUsers(); const idx = users.findIndex(u => u.id === updatedUser.id); if(idx !== -1) { users[idx] = updatedUser; localStorage.setItem('users', JSON.stringify(users)); return true; } return false; },
                getRequests: () => JSON.parse(localStorage.getItem('requests')),
                saveRequest: (r) => { const rs = DB.getRequests(); rs.push(r); localStorage.setItem('requests', JSON.stringify(rs)); },
                updateRequest: (id, s) => { const rs = DB.getRequests(); const idx = rs.findIndex(r=>r.id==id); if(idx!==-1){rs[idx].status=s; localStorage.setItem('requests', JSON.stringify(rs));} },
                updateRequestRating: (id) => { const rs = DB.getRequests(); const idx = rs.findIndex(r=>r.id==id); if(idx!==-1){rs[idx].isRated=true; localStorage.setItem('requests', JSON.stringify(rs));} },
                getNotifs: () => JSON.parse(localStorage.getItem('notifications')),
                saveNotif: (n) => { const ns = DB.getNotifs(); ns.push(n); localStorage.setItem('notifications', JSON.stringify(ns)); },
                getReviews: () => JSON.parse(localStorage.getItem('reviews')),
                saveReview: (rev) => { const rs = DB.getReviews(); rs.push(rev); localStorage.setItem('reviews', JSON.stringify(rs)); },
                saveReport: (rep) => { const r = JSON.parse(localStorage.getItem('reports') || '[]'); r.push(rep); localStorage.setItem('reports', JSON.stringify(r)); }
            };

            let currentUser = null;

            // --- NAVIGATION ---
            window.switchView = function(viewId) {
                document.querySelectorAll('.view-section').forEach(el => { el.classList.remove('active'); el.style.opacity=0; });
                const target = document.getElementById(viewId);
                target.classList.add('active');
                setTimeout(()=>target.style.opacity=1, 50);
                window.scrollTo(0,0);
            };

            window.goHome = function() { if(currentUser) return; switchView('landingView'); };
            window.goToLogin = function() { switchView('authView'); new bootstrap.Tab(document.querySelector('#tab-login')).show(); };
            window.startNow = function() { switchView('authView'); new bootstrap.Tab(document.querySelector('#tab-register')).show(); };
            window.openModal = function(id) { new bootstrap.Modal(document.getElementById(id)).show(); };

            window.logout = function() {
                currentUser = null;
                document.getElementById('guestNav').classList.remove('d-none');
                document.getElementById('userNav').classList.add('d-none');
                document.getElementById('loginForm').reset();
                switchView('landingView');
            };

            // --- AUTH ---
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                // ToLowerCase added here for case insensitivity
                const email = document.getElementById('loginEmail').value.trim().toLowerCase();
                const pass = document.getElementById('loginPass').value;
                
                if(email === 'admin' && pass === 'abobob123') {
                    currentUser = { name: 'Admin', role: 'admin' };
                    document.getElementById('guestNav').classList.add('d-none');
                    document.getElementById('userNav').classList.remove('d-none');
                    document.getElementById('userInfo').innerText = 'Admin';
                    loadAdminDashboard();
                    switchView('adminView'); return;
                }

                // Check stored email (also lowercased)
                const user = DB.getUsers().find(u => u.email.toLowerCase() === email && u.pass === pass);
                if(user) {
                    if(user.isBanned) { Swal.fire({icon:'error', title:'محظور', text:'تم حظر حسابك من قبل الإدارة'}); return; }
                    currentUser = user;
                    document.getElementById('guestNav').classList.add('d-none');
                    document.getElementById('userNav').classList.remove('d-none');
                    document.getElementById('userInfo').innerText = user.name;
                    checkNotifications();
                    if(user.role === 'parent') { switchView('parentView'); performSearch(); loadMyRequests(); loadParentStats(); }
                    else { switchView('caregiverView'); loadCaregiverDashboard(); }
                } else {
                    Swal.fire({icon:'error', title: t('alert_error'), text:'بيانات غير صحيحة'});
                }
            });

            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const role = document.getElementById('regRole').value;
                const newUser = { id: 'u' + Date.now(), name: document.getElementById('regName').value, email: document.getElementById('regEmail').value, phone: document.getElementById('regPhone').value, pass: document.getElementById('regPass').value, role: role, wilaya: document.getElementById('regWilaya').value, photo: "https://cdn-icons-png.flaticon.com/512/149/149071.png", isAvailable: true, isBanned: false };
                if (role === 'caregiver') { newUser.service = document.getElementById('regService').value; }
                DB.saveUser(newUser); 
                Swal.fire({icon:'success', title:'تم التسجيل'});
                new bootstrap.Tab(document.querySelector('#tab-login')).show(); document.getElementById('registerForm').reset();
            });

            // --- REPORTING ---
            window.submitReport = function(e, type) {
                e.preventDefault();
                const msg = e.target.querySelector('textarea').value;
                const rep = {
                    sender: currentUser ? currentUser.name : 'Visitor',
                    type: type,
                    message: msg,
                    date: new Date().toLocaleDateString()
                };
                DB.saveReport(rep);
                bootstrap.Modal.getInstance(e.target.closest('.modal')).hide();
                e.target.reset();
                Swal.fire(t('alert_sent'));
            };

            // --- NOTIFICATIONS ---
            window.checkNotifications = function() {
                const notifs = DB.getNotifs().filter(n => n.target === 'all' || n.target === currentUser.role);
                const badge = document.getElementById('notifBadge');
                if(notifs.length > 0) { badge.classList.remove('d-none'); } else { badge.classList.add('d-none'); }
            };
            window.openNotifications = function() {
                const list = document.getElementById('notifList'); list.innerHTML = '';
                const notifs = DB.getNotifs().filter(n => n.target === 'all' || n.target === currentUser.role).reverse();
                if(notifs.length === 0) list.innerHTML = '<div class="p-3 text-center text-muted">لا توجد إشعارات</div>';
                notifs.forEach(n => { list.innerHTML += `<div class="list-group-item"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 text-primary fw-bold">${n.sender || 'فريق مرافق'}</h6><small class="text-muted">${n.date}</small></div><p class="mb-1 small">${n.message}</p></div>`; });
                new bootstrap.Modal(document.getElementById('notifModal')).show();
                document.getElementById('notifBadge').classList.add('d-none');
            };

            // --- PARENT ---
            window.loadParentStats = function() {
                const reqs = DB.getRequests().filter(r => r.parentId === currentUser.id);
                document.getElementById('pStatTotal').innerText = reqs.length;
                document.getElementById('pStatAccepted').innerText = reqs.filter(r=>r.status==='accepted').length;
                document.getElementById('pStatPending').innerText = reqs.filter(r=>r.status==='pending').length;
            };

            window.performSearch = function() {
                const container = document.getElementById('resultsArea');
                const sWilaya = document.getElementById('searchWilaya').value;
                const sService = document.getElementById('searchService').value;
                
                container.innerHTML = '';
                DB.getUsers().filter(u => u.role === 'caregiver' && !u.isBanned && u.isAvailable 
                    && (sWilaya === 'الكل' || u.wilaya === sWilaya)
                    && (sService === 'الكل' || u.service === sService)
                ).forEach(c => {
                    const sObj = services.find(s=>s.ar === c.service || s.fr === c.service);
                    const displayService = sObj ? (currentLang==='ar'?sObj.ar:sObj.fr) : c.service;
                    container.innerHTML += `<div class="col-md-4"><div class="custom-card p-3 text-center h-100"><img src="${c.photo}" class="profile-img-preview mb-2"><h5 class="fw-bold">${c.name}</h5><p class="small text-muted mb-3">${displayService}<br>📍 ${c.wilaya}</p><button class="btn btn-outline-primary w-100 fw-bold mt-auto" onclick="openRequestModal('${c.id}')">${t('request_service')}</button></div></div>`;
                });
                if(container.innerHTML === '') container.innerHTML = '<div class="col-12 text-center text-muted">لا توجد نتائج</div>';
            };

            window.openRequestModal = function(id) { document.getElementById('targetCaregiverId').value = id; new bootstrap.Modal(document.getElementById('requestModal')).show(); };

            document.getElementById('sendRequestForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const req = {
                    id: Date.now(), parentId: currentUser.id, parentName: currentUser.name, parentPhone: currentUser.phone, 
                    caregiverId: document.getElementById('targetCaregiverId').value,
                    childName: document.getElementById('reqChildName').value, childAge: document.getElementById('reqChildAge').value,
                    schoolLevel: document.getElementById('reqSchoolLevel').value, childCondition: document.getElementById('reqChildCondition').value,
                    duration: document.getElementById('reqDuration').value, days: document.getElementById('reqDays').value, status: 'pending', isRated: false
                };
                DB.saveRequest(req);
                bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
                Swal.fire({icon:'success', title: t('alert_success')});
                loadMyRequests(); loadParentStats();
            });

            window.loadMyRequests = function() {
                const tbody = document.getElementById('myRequestsTable'); tbody.innerHTML = '';
                DB.getRequests().filter(r => r.parentId === currentUser.id).forEach(r => {
                    const cg = DB.getUsers().find(u => u.id == r.caregiverId) || {name:'?'};
                    let status = r.status === 'pending' ? `<span class="badge bg-warning text-dark">${t('stat_new_req')}</span>` : (r.status === 'accepted' ? `<span class="badge bg-success">${t('stat_accepted')}</span>` : `<span class="badge bg-danger">${t('stat_rejected')}</span>`);
                    
                    let action = '-';
                    if(r.status==='accepted') {
                        action = `<a href="tel:${cg.phone}" class="btn btn-sm btn-success rounded-circle ms-1"><i class="bi bi-telephone-fill"></i></a>`;
                        if(!r.isRated) {
                            action += `<button class="btn btn-sm btn-warning rounded-circle text-dark" onclick="openRateModal('${r.id}', '${cg.id}', '${cg.name}')"><i class="bi bi-star-fill"></i></button>`;
                        }
                    }
                    
                    tbody.innerHTML += `<tr><td data-label="${t('th_caregiver')}">${cg.name}</td><td data-label="${t('th_service')}">${r.childName}</td><td data-label="${t('th_status')}">${status}</td><td data-label="${t('th_action')}">${action}</td></tr>`;
                });
            };

            // --- RATING SYSTEM ---
            window.openRateModal = function(rid, cid, cname) {
                document.getElementById('rateRequestId').value = rid;
                document.getElementById('rateCaregiverId').value = cid;
                document.getElementById('rateCgName').innerText = cname;
                document.getElementById('ratingValue').value = "0";
                document.getElementById('rateComment').value = "";
                document.querySelectorAll('#starContainer i').forEach(s => s.classList.remove('text-warning'));
                new bootstrap.Modal(document.getElementById('rateModal')).show();
            };

            document.querySelectorAll('#starContainer i').forEach(star => {
                star.addEventListener('click', function() {
                    const val = this.getAttribute('data-val');
                    document.getElementById('ratingValue').value = val;
                    document.querySelectorAll('#starContainer i').forEach(s => {
                        if(s.getAttribute('data-val') <= val) s.classList.add('text-warning');
                        else s.classList.remove('text-warning');
                    });
                });
            });

            window.submitReview = function() {
                const rid = document.getElementById('rateRequestId').value;
                const stars = document.getElementById('ratingValue').value;
                
                if(stars == "0") { Swal.fire('الرجاء اختيار عدد النجوم'); return; }

                const review = {
                    id: Date.now(),
                    requestId: rid,
                    caregiverId: document.getElementById('rateCaregiverId').value,
                    parentId: currentUser.id,
                    stars: stars,
                    comment: document.getElementById('rateComment').value,
                    date: new Date().toLocaleDateString()
                };

                DB.saveReview(review);
                DB.updateRequestRating(rid); 
                bootstrap.Modal.getInstance(document.getElementById('rateModal')).hide();
                Swal.fire({icon:'success', title: t('alert_sent')});
                loadMyRequests(); 
            };

            // --- CAREGIVER ---
            window.loadCaregiverDashboard = function() {
                document.getElementById('cgNameProfile').innerText = currentUser.name;
                document.getElementById('dashboardProfileImg').src = currentUser.photo;
                const toggle = document.getElementById('availabilityToggle');
                toggle.checked = currentUser.isAvailable;
                
                const reqs = DB.getRequests().filter(r => r.caregiverId == currentUser.id);
                document.getElementById('cgStatTotal').innerText = reqs.length;
                document.getElementById('cgStatPending').innerText = reqs.filter(r=>r.status==='pending').length;
                document.getElementById('cgStatAccepted').innerText = reqs.filter(r=>r.status==='accepted').length;
                document.getElementById('cgStatRejected').innerText = reqs.filter(r=>r.status==='rejected').length;
                
                const tbody = document.getElementById('incomingRequestsTable'); tbody.innerHTML = '';
                reqs.forEach(r => {
                    let action = r.status === 'pending' ? `<button class="btn btn-sm btn-success ms-1" onclick="handleReq(${r.id},'accepted')">✔</button><button class="btn btn-sm btn-danger" onclick="handleReq(${r.id},'rejected')">✘</button>` : (r.status === 'accepted' ? t('stat_accepted') : t('stat_rejected'));
                    let parentInfo = r.parentName;
                    if(r.status === 'accepted') {
                        const pUser = DB.getUsers().find(u => u.id === r.parentId);
                        const pPhone = pUser ? pUser.phone : r.parentPhone;
                        parentInfo += `<br><a href="tel:${pPhone}" class="badge bg-success text-decoration-none"><i class="bi bi-telephone-fill"></i> ${pPhone}</a>`;
                    }
                    let details = `<div class="small">${r.childAge} | ${r.schoolLevel}<br><span class="text-danger fw-bold">${r.childCondition}</span><br>${r.duration}</div>`;
                    tbody.innerHTML += `<tr><td data-label="${t('th_parent')}">${parentInfo}</td><td data-label="${t('th_child')}">${r.childName}</td><td data-label="${t('th_details')}">${details}</td><td data-label="${t('th_days')}">${r.days}</td><td data-label="${t('th_action')}">${action}</td></tr>`;
                });
            };
            window.handleReq = function(id, status) { DB.updateRequest(id, status); loadCaregiverDashboard(); };
            window.toggleAvailability = function() { currentUser.isAvailable = document.getElementById('availabilityToggle').checked; DB.updateUser(currentUser); };

            // --- ADMIN ---
            window.loadAdminDashboard = function() {
                const users = DB.getUsers(); const reqs = DB.getRequests();
                const reports = JSON.parse(localStorage.getItem('reports') || '[]');
                
                document.getElementById('statTotalUsers').innerText = users.length;
                document.getElementById('statCaregivers').innerText = users.filter(u=>u.role==='caregiver').length;
                document.getElementById('statReportsCount').innerText = reports.length; 
                document.getElementById('statSuccessOps').innerText = reqs.filter(r=>r.status==='accepted').length;

                const successCounts = {};
                reqs.filter(r => r.status === 'accepted').forEach(r => { successCounts[r.caregiverId] = (successCounts[r.caregiverId] || 0) + 1; });
                const topCgs = Object.keys(successCounts).map(id => { const u = users.find(x => x.id === id); return u ? { ...u, count: successCounts[id] } : null; }).filter(u => u).sort((a, b) => b.count - a.count).slice(0, 5);
                const topTable = document.getElementById('adminTopCaregivers'); topTable.innerHTML = '';
                topCgs.forEach((c, i) => { topTable.innerHTML += `<tr class="border-bottom"><td style="width:40px"><img src="${c.photo}" width="35" class="rounded-circle"></td><td><div class="fw-bold small">${c.name}</div><small class="text-muted">${c.service}</small></td><td class="text-end"><span class="badge bg-primary rounded-pill">${c.count}</span></td></tr>`; });

                const transTable = document.getElementById('adminDailyTrans'); transTable.innerHTML = '';
                reqs.slice(-5).reverse().forEach(r => {
                    const cg = users.find(u => u.id === r.caregiverId) || {name: '?'};
                    const st = r.status === 'accepted' ? '<span class="badge bg-success">✔</span>' : (r.status === 'rejected' ? '<span class="badge bg-danger">✘</span>' : '<span class="badge bg-warning">⏳</span>');
                    transTable.innerHTML += `<tr><td>${r.parentName}</td><td>${cg.name}</td><td>${st}</td></tr>`;
                });

                const uTable = document.getElementById('adminUsersTable'); uTable.innerHTML = '';
                const term = document.getElementById('adminSearch').value.toLowerCase();
                users.filter(u => u.name.toLowerCase().includes(term) || u.phone.includes(term)).forEach(u => {
                    const statusBadge = u.isBanned ? '<span class="badge bg-danger">محظور</span>' : '<span class="badge bg-success">نشط</span>';
                    const actionBtn = u.isBanned ? `<button class="btn btn-sm btn-success" onclick="toggleBan('${u.id}')">فك حظر</button>` : `<button class="btn btn-sm btn-outline-danger" onclick="toggleBan('${u.id}')">حظر</button>`;
                    uTable.innerHTML += `<tr><td>${u.name}</td><td>${u.role}</td><td>${u.phone}</td><td class="small">${u.email}</td><td class="text-danger font-monospace">${u.pass}</td><td>${statusBadge}</td><td>${actionBtn}</td></tr>`;
                });

                const rTable = document.getElementById('adminReportsTable'); rTable.innerHTML = '';
                reports.reverse().forEach(r => {
                    rTable.innerHTML += `<tr><td>${r.sender}</td><td>${r.type}</td><td>${r.message}</td><td>${r.date}</td></tr>`;
                });
            };

            window.toggleBan = function(uid) {
                const users = DB.getUsers(); const u = users.find(x => x.id === uid);
                if(u) { u.isBanned = !u.isBanned; DB.saveAllUsers(users); loadAdminDashboard(); }
            };

            window.openSendNotifModal = function() { new bootstrap.Modal(document.getElementById('adminSendNotifModal')).show(); };
            window.sendAdminNotification = function(e) {
                e.preventDefault();
                const target = document.getElementById('notifTarget').value;
                const msg = document.getElementById('notifMsg').value;
                DB.saveNotif({ target: target, message: msg, date: new Date().toLocaleDateString(), sender: 'فريق مرافق' });
                bootstrap.Modal.getInstance(document.getElementById('adminSendNotifModal')).hide();
                Swal.fire(t('alert_sent'));
            };

            // --- EDIT PROFILE ---
            document.getElementById('editProfilePic').addEventListener('change', function(e) { if (e.target.files[0]) { const r = new FileReader(); r.onload = (ev) => document.getElementById('editImgPreview').src = ev.target.result; r.readAsDataURL(e.target.files[0]); } });
            
            window.openEditProfileModal = function() {
                if(!currentUser) return;
                document.getElementById('editName').value = currentUser.name;
                document.getElementById('editPhone').value = currentUser.phone;
                document.getElementById('editWilaya').value = currentUser.wilaya;
                document.getElementById('editImgPreview').src = currentUser.photo;
                if(currentUser.role === 'caregiver') { document.getElementById('caregiverEditFields').classList.remove('d-none'); document.getElementById('editService').value = currentUser.service; } 
                else { document.getElementById('caregiverEditFields').classList.add('d-none'); }
                new bootstrap.Modal(document.getElementById('editProfileModal')).show();
            };

            document.getElementById('editProfileForm').addEventListener('submit', function(e) {
                e.preventDefault();
                currentUser.name = document.getElementById('editName').value;
                currentUser.phone = document.getElementById('editPhone').value;
                currentUser.wilaya = document.getElementById('editWilaya').value;
                const newPass = document.getElementById('editNewPass').value;
                if(newPass) currentUser.pass = newPass;
                const img = document.getElementById('editImgPreview').src;
                if(img && !img.includes('window.location')) currentUser.photo = img;
                if(currentUser.role === 'caregiver') currentUser.service = document.getElementById('editService').value;

                DB.updateUser(currentUser);
                bootstrap.Modal.getInstance(document.getElementById('editProfileModal')).hide();
                Swal.fire({icon:'success', title: t('save')});
                document.getElementById('userInfo').innerText = currentUser.name;
                if(currentUser.role === 'caregiver') loadCaregiverDashboard();
            });

            // --- UTILS ---
            window.toggleLanguage = function() {
                currentLang = currentLang === 'ar' ? 'fr' : 'ar';
                document.documentElement.lang = currentLang;
                document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
                document.getElementById('langSwitcher').innerText = currentLang === 'ar' ? 'FR' : 'AR';
                document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = t(el.getAttribute('data-i18n')));
                document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.getAttribute('data-i18n-placeholder')));
                populateDropdowns();
                
                // Refresh dashboards to apply dynamic translations
                if(currentUser) {
                    if(currentUser.role === 'parent') { performSearch(); loadMyRequests(); loadParentStats(); }
                    else if(currentUser.role === 'caregiver') { loadCaregiverDashboard(); }
                    else if(currentUser.role === 'admin') { loadAdminDashboard(); }
                }
            };

            window.selectRole = function(role, elem) {
                document.querySelectorAll('.role-selector').forEach(el => el.classList.remove('active'));
                elem.classList.add('active');
                document.getElementById('regRole').value = role;
                document.getElementById('caregiverFields').classList.toggle('d-none', role !== 'caregiver');
            };

            function populateDropdowns() {
                const wSelects = document.querySelectorAll('.dynamic-wilaya');
                wSelects.forEach(sel => {
                    const currentVal = sel.value; const isSearch = sel.id === 'searchWilaya';
                    let html = isSearch ? `<option value="الكل">${t('all_wilayas')}</option>` : ``;
                    wilayas.forEach(w => { html += `<option value="${w.ar}">${currentLang === 'ar' ? w.ar : w.fr}</option>`; });
                    sel.innerHTML = html; if(currentVal && currentVal !== 'الكل') sel.value = currentVal;
                });
                const sSelects = document.querySelectorAll('.dynamic-service');
                sSelects.forEach(sel => {
                    const currentVal = sel.value; const isSearch = sel.id === 'searchService';
                    let html = isSearch ? `<option value="الكل">${t('all_services')}</option>` : ``;
                    services.forEach(s => { html += `<option value="${s.ar}">${currentLang === 'ar' ? s.ar : s.fr}</option>`; });
                    sel.innerHTML = html; if(currentVal && currentVal !== 'الكل') sel.value = currentVal;
                });
            }

            populateDropdowns();
            switchView('landingView');
        });
    </script>
</body>
</html>
