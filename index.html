<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±Ø§ÙÙ‚ | Morafik - Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„Ùƒ Ø¨Ø£Ù…Ø§Ù†</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --accent: #ef4444;
            --success: #10b981;
            --bg-color: #f3f4f6;
            --text-main: #1f2937;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        
        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            overflow-x: hidden; 
            min-height: 100vh; 
        }

        /* Fixed Background */
        .fixed-bg {
            position: fixed; inset: 0;
            background: url('https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
            z-index: -10;
            animation: zoomEffect 25s infinite alternate ease-in-out;
        }
        @keyframes zoomEffect { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
        .bg-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: -9; backdrop-filter: blur(3px); }

        /* Header */
        header { 
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); 
            padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; 
            position: fixed; width: 100%; top: 0; z-index: 2000; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        
        /* Logo Style */
        .logo-img { height: 50px; width: auto; object-fit: contain; }

        .nav-links { display: flex; gap: 30px; align-items: center; } /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© */
        .nav-btn { background: none; border: none; font-size: 16px; font-weight: 700; cursor: pointer; color: var(--text-main); transition: 0.3s; }
        .nav-btn:hover { color: var(--secondary); }
        
        /* Notifications */
        .notif-btn { position: relative; cursor: pointer; font-size: 22px; color: var(--primary); margin: 0 15px; }
        .badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; border-radius: 50%; font-size: 10px; width: 18px; height: 18px; display: flex; justify-content: center; align-items: center; }

        /* Sections */
        .app-section {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            display: flex; flex-direction: column; 
            z-index: 100; transition: transform 0.6s cubic-bezier(0.7, 0, 0.3, 1);
            overflow-y: auto; background: var(--bg-color);
            padding-top: 80px; transform: translateY(100vh); opacity: 0;
        }
        .app-section.active { transform: translateY(0); opacity: 1; z-index: 500; }
        #heroSection { background: transparent; transform: translateY(0); opacity: 1; z-index: 10; justify-content: center; align-items: center; text-align: center; color: white; padding-top: 0; }
        #heroSection.hidden { opacity: 0; pointer-events: none; }

        /* UI Elements */
        .hero-title { font-size: 3.5rem; font-weight: 900; margin-bottom: 20px; text-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .cta-btn { padding: 15px 50px; background: var(--secondary); color: white; border: none; border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4); }
        
        .container-box { width: 100%; max-width: 500px; margin: 30px auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; }
        .dashboard-container { width: 95%; max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }

        input, textarea { width: 100%; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 10px; background: #f9fafb; font-size: 0.95rem; }
        
        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 30px; }
        .dash-card { padding: 20px; border-radius: 16px; color: white; position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; height: 120px; }
        .dash-card h3 { font-size: 2rem; margin: 0; font-weight: 800; }
        .bg-1 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bg-2 { background: linear-gradient(135deg, #10b981, #059669); }
        .bg-3 { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .bg-4 { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .bg-dark { background: linear-gradient(135deg, #1f2937, #111827); }

        /* Request Cards */
        .req-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .req-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-right: 5px solid #ccc; display: flex; flex-direction: column; gap: 8px; }
        .req-card.pending { border-color: #f59e0b; }
        .req-card.accepted { border-color: #10b981; }
        .req-card.rejected { border-color: #ef4444; }

        /* Rating Stars */
        .star-rating { direction: rtl; display: flex; justify-content: center; gap: 5px; }
        .star-rating input { display: none; }
        .star-rating label { font-size: 25px; color: #ddd; cursor: pointer; transition: 0.2s; }
        .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color: gold; }

        /* Footer Links in Hero */
        .hero-footer { position: absolute; bottom: 20px; display: flex; gap: 25px; color: #eee; font-size: 0.95rem; background: rgba(0,0,0,0.4); padding: 10px 20px; border-radius: 30px; backdrop-filter: blur(5px); }
        .hero-footer span { cursor: pointer; border-bottom: 1px dashed transparent; transition: 0.3s; }
        .hero-footer span:hover { color: white; border-bottom: 1px solid white; }

        /* Admin Table */
        .admin-table { width: 100%; background: white; border-collapse: collapse; border-radius: 10px; margin-top: 10px; }
        .admin-table th { background: var(--primary); color: white; padding: 12px; text-align: right; }
        .admin-table td { padding: 12px; border-bottom: 1px solid #eee; }

        /* Select */
        select { display: none; }
        .custom-select-wrapper { position: relative; width: 100%; margin-bottom: 10px; }
        .custom-select-trigger { padding: 12px; background: white; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; display: flex; justify-content: space-between; }
        .custom-options { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 10px; z-index: 1000; display: none; max-height: 200px; overflow-y: auto; }
        .custom-options.open { display: block; }
        .custom-option { padding: 10px; cursor: pointer; border-bottom: 1px solid #f5f5f5; }
        .custom-option:hover { background: var(--secondary); color: white; }

        /* Switch */
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-box { background: white; width: 90%; max-width: 600px; padding: 25px; border-radius: 20px; max-height: 90vh; overflow-y: auto; }

        .full-btn { width: 100%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; }

        @media (max-width: 768px) { .req-grid { grid-template-columns: 1fr; } .hero-title { font-size: 2.5rem; } .hero-footer { flex-wrap: wrap; justify-content: center; width: 90%; } }
    </style>
</head>
<body>

    <div class="fixed-bg"></div>
    <div class="bg-overlay"></div>

    <header>
        <div class="logo">
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgGmf6afcKjxaL9hB_Cv4AZ_JBvtuXheqwzIvoGu49lm9A6mXRYLoz-ZDhZcXaQD4cU3RXi6d4lAfDskoqsSRXdjLwDeTvF1XPINU0cdIhHcO6Q_sBlABLu4lSngQyylUTgQ-R7f7ELF3Y4RxtoFY1Wn_33Mv_6UsC7WNIKRuuOfxXlsU9uU9zjAt4a2CM/s320/Picsart_26-01-29_13-14-09-750.png" alt="Morafik Logo" class="logo-img">
        </div>
        
        <!-- Companion Toggle -->
        <div id="statusToggle" style="display:none; align-items:center; gap:8px; background:#f0fdf4; padding:5px 12px; border-radius:20px;">
            <span id="statusText" style="font-size:0.85rem; font-weight:bold; color:#15803d;">ÙÙŠ Ø§Ù„Ø®Ø¯Ù…Ø©</span>
            <label class="switch"><input type="checkbox" id="headerAvailToggle" onchange="toggleAvail()"><span class="slider round"></span></label>
        </div>

        <div class="nav-links">
            <button class="nav-btn" style="border:1px solid #333; border-radius:15px; padding:2px 10px;" onclick="switchLang()">FR / AR</button>
            <div id="notifBtn" class="notif-btn" onclick="openNotif()" style="display:none;">
                <i class="fas fa-bell"></i><span id="notifBadge" class="badge" style="display:none;">0</span>
            </div>
            <div id="guestLinks">
                <button class="nav-btn" onclick="navigateTo('heroSection')" data-i18n="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                <button class="nav-btn" onclick="navigateTo('loginSection')" data-i18n="login">Ø¯Ø®ÙˆÙ„</button>
            </div>
            <div id="userLinks" style="display:none;">
                <button class="nav-btn" onclick="openProfile()" data-i18n="profile">Ø¨Ø±ÙˆÙØ§ÙŠÙ„</button>
                <button class="nav-btn" style="color:#ef4444;" onclick="logout()" data-i18n="logout">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </header>

    <!-- 1. HERO -->
    <section id="heroSection" class="app-section active">
        <h1 class="hero-title" data-i18n="heroTitle">Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„Ùƒ Ø¨Ø£Ù…Ø§Ù†</h1>
        <p style="font-size:1.4rem; color:white; margin-bottom:30px;" data-i18n="heroSub">Ù†Ø±Ø¨Ø·Ùƒ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ† ÙˆØ§Ù„Ø£Ø®ØµØ§Ø¦ÙŠÙŠÙ† Ø§Ù„Ù†ÙØ³ÙŠÙŠÙ†.</p>
        <button class="cta-btn" onclick="navigateTo('registerSection')" data-i18n="startNow">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
        
        <div class="hero-footer">
            <span onclick="openModal('infoModal', 'about')" data-i18n="about">Ù…Ù† Ù†Ø­Ù†</span>
            <span onclick="openModal('infoModal', 'privacy')" data-i18n="privacy">Ø§Ù„Ø®ØµÙˆØµÙŠØ©</span>
            <span onclick="openModal('infoModal', 'location')" data-i18n="location">Ù…ÙˆÙ‚Ø¹Ù†Ø§</span>
            <span onclick="openContact('contact')" data-i18n="contact">Ø§ØªØµÙ„ Ø¨Ù†Ø§</span>
            <span onclick="openContact('report')" style="color:#fca5a5;" data-i18n="report">Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</span>
        </div>
    </section>

    <!-- 2. REGISTER -->
    <section id="registerSection" class="app-section">
        <div class="container-box">
            <h2 data-i18n="register">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="setRole('parent')" id="btnRoleParent" style="flex:1; padding:10px; background:var(--primary); color:white; border-radius:10px; border:none;" data-i18n="parent">ÙˆÙ„ÙŠ Ø·ÙÙ„</button>
                <button onclick="setRole('companion')" id="btnRoleComp" style="flex:1; padding:10px; background:transparent; border:1px solid #ccc; border-radius:10px;" data-i18n="companion">Ù…Ø±Ø§ÙÙ‚</button>
            </div>
            <input type="text" id="regName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="email" id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="tel" id="regPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <div class="custom-select-wrapper"><select id="regWilaya"></select></div>
            <div id="compFields" style="display:none;">
                <div class="custom-select-wrapper"><select id="regSpec"><option value="Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯">Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯</option><option value="Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ">Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ</option></select></div>
                <input type="file" id="regDoc" accept="application/pdf">
            </div>
            <input type="password" id="regPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="full-btn" onclick="handleRegister()" data-i18n="registerBtn">ØªØ³Ø¬ÙŠÙ„</button>
        </div>
    </section>

    <!-- 3. LOGIN -->
    <section id="loginSection" class="app-section">
        <div class="container-box">
            <h2 data-i18n="login">Ø¯Ø®ÙˆÙ„</h2>
            <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="full-btn" onclick="handleLogin()" data-i18n="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </section>

    <!-- 4. PARENT DASHBOARD -->
    <section id="parentDash" class="app-section">
        <div class="dashboard-container">
            <h2 style="color:var(--primary); margin-bottom:20px;"><span data-i18n="welcome">Ù…Ø±Ø­Ø¨Ø§Ù‹</span> <span id="pName"></span></h2>
            
            <div class="stats-grid">
                <div class="dash-card bg-1"><h3 id="pTotal">0</h3><p data-i18n="new">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p></div>
                <div class="dash-card bg-2"><h3 id="pAccepted">0</h3><p data-i18n="accepted">Ù…Ù‚Ø¨ÙˆÙ„Ø©</p></div>
                <div class="dash-card bg-3"><h3 id="pRejected">0</h3><p data-i18n="canceled">Ù…Ù„ØºÙŠØ©</p></div>
                <div class="dash-card bg-4"><h3 id="pPending">0</h3><p data-i18n="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p></div>
            </div>

            <div style="background:white; padding:20px; border-radius:15px; margin-bottom:30px;">
                <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:10px;">
                    <div class="custom-select-wrapper"><select id="searchSpec"><option value="Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯" data-i18n="spec1">Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯</option><option value="Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ" data-i18n="spec2">Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ</option></select></div>
                    <div class="custom-select-wrapper"><select id="searchWilaya"></select></div>
                    <button class="full-btn" style="width:auto; padding:0 30px;" onclick="searchCompanions()" data-i18n="search">Ø¨Ø­Ø«</button>
                </div>
            </div>
            
            <h3 data-i18n="results">Ø§Ù„Ù†ØªØ§Ø¦Ø¬</h3>
            <div id="searchResults" class="req-grid"></div>
            <h3 style="margin-top:30px;" data-i18n="myReqs">Ø·Ù„Ø¨Ø§ØªÙŠ</h3>
            <div id="parentReqs" class="req-grid"></div>
        </div>
    </section>

    <!-- 5. COMPANION DASHBOARD -->
    <section id="companionDash" class="app-section">
        <div class="dashboard-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 style="color:var(--primary);"><span data-i18n="dashComp">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚</span> <span id="cName"></span></h2>
            </div>

            <div class="stats-grid">
                <div class="dash-card bg-1"><h3 id="stTotal">0</h3><p data-i18n="total">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p></div>
                <div class="dash-card bg-4"><h3 id="stPending">0</h3><p data-i18n="new">Ø¬Ø¯ÙŠØ¯Ø©</p></div>
                <div class="dash-card bg-2"><h3 id="stAccepted">0</h3><p data-i18n="accepted">Ù…Ù‚Ø¨ÙˆÙ„Ø©</p></div>
                <div class="dash-card bg-3"><h3 id="stRejected">0</h3><p data-i18n="canceled">Ù…Ù„ØºÙŠØ©</p></div>
            </div>

            <h3 data-i18n="incomingReq">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
            <div id="compReqs" class="req-grid"></div>
        </div>
    </section>

    <!-- 6. ADMIN DASHBOARD -->
    <section id="adminDash" class="app-section">
        <div class="dashboard-container">
            <h2 style="color:var(--primary);">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</h2>
            <div class="stats-grid">
                <div class="dash-card bg-dark"><h3>USERS</h3><p id="adUsersCount">0</p></div>
                <div class="dash-card bg-1"><h3>REQ</h3><p id="adReqsCount">0</p></div>
                <div class="dash-card bg-4"><h3>MSG</h3><p id="adMsgsCount">0</p></div>
                <div class="dash-card bg-2"><h3>LOGS</h3><p>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</p></div>
            </div>

            <div style="background:white; padding:20px; border-radius:15px; margin-bottom:30px;">
                <h3>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± (ÙØ±ÙŠÙ‚ Ù…Ø±Ø§ÙÙ‚)</h3>
                <div style="display:flex; gap:10px;">
                    <div class="custom-select-wrapper" style="flex:1;"><select id="notifTarget"><option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹</option><option value="parent">Ø§Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡</option><option value="companion">Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</option></select></div>
                    <input type="text" id="notifMsg" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø©..." style="flex:2;">
                    <button class="full-btn" style="width:auto;" onclick="sendAdminNotif()">Ø¥Ø±Ø³Ø§Ù„</button>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div>
                    <h3>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
                    <div id="logsList" style="background:white; padding:15px; border-radius:10px; max-height:400px; overflow-y:auto;"></div>
                </div>
                <div>
                    <h3>Ø§Ù„Ø´ÙƒØ§ÙˆÙŠ ÙˆØ§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
                    <div id="reportsList" style="background:white; padding:15px; border-radius:10px; max-height:400px; overflow-y:auto;"></div>
                </div>
            </div>
            
            <h3 style="margin-top:20px;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <table class="admin-table"><tbody id="usersTable"></tbody></table>
        </div>
    </section>

    <!-- MODALS -->
    
    <!-- Profile Edit -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('profileModal')">&times;</span>
            <h3 style="text-align:center;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„</h3>
            <div style="text-align:center; margin-bottom:15px;">
                <img id="profImgPreview" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; object-fit:cover;">
                <br><label for="profImgInput" style="color:var(--secondary); cursor:pointer;">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</label>
                <input type="file" id="profImgInput" style="display:none;" onchange="previewImg(this)">
            </div>
            <input type="text" id="edName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="tel" id="edPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
            <div class="custom-select-wrapper"><select id="edWilaya"></select></div>
            <input type="password" id="edPass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©">
            <button class="full-btn" onclick="saveProfile()">Ø­ÙØ¸</button>
        </div>
    </div>

    <!-- Booking -->
    <div id="bookingModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('bookingModal')">&times;</span>
            <h3 style="text-align:center;" data-i18n="bookTitle">Ø­Ø¬Ø²</h3>
            <input type="hidden" id="bkCompId">
            <input type="text" id="bkChild" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <input type="number" id="bkAge" placeholder="Ø§Ù„Ø³Ù†">
                <div class="custom-select-wrapper"><select id="bkLevel"><option>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ù…ØªÙˆØ³Ø·</option><option>Ø®Ø§Øµ</option></select></div>
            </div>
            <div class="custom-select-wrapper"><select id="bkStatus"><option>Ø·ÙŠÙ Ø§Ù„ØªÙˆØ­Ø¯</option><option>ÙØ±Ø· Ø§Ù„Ø­Ø±ÙƒØ©</option><option>Ø¹Ø§Ø¯ÙŠ</option></select></div>
            <div class="custom-select-wrapper"><select id="bkType"><option>Ø¯ÙˆØ§Ù… ÙƒØ§Ù…Ù„</option><option>Ø¬Ù„Ø³Ø§Øª</option></select></div>
            <button class="full-btn" onclick="submitBooking()" data-i18n="confirm">ØªØ£ÙƒÙŠØ¯</button>
        </div>
    </div>

    <!-- Rate Modal -->
    <div id="rateModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('rateModal')">&times;</span>
            <h3 style="text-align:center;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
            <input type="hidden" id="rateReqId">
            <div class="star-rating">
                <input type="radio" id="s5" name="rating" value="5"><label for="s5">â˜…</label>
                <input type="radio" id="s4" name="rating" value="4"><label for="s4">â˜…</label>
                <input type="radio" id="s3" name="rating" value="3"><label for="s3">â˜…</label>
                <input type="radio" id="s2" name="rating" value="2"><label for="s2">â˜…</label>
                <input type="radio" id="s1" name="rating" value="1"><label for="s1">â˜…</label>
            </div>
            <textarea id="rateReview" rows="3" placeholder="ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea>
            <button class="full-btn" onclick="submitRating()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
        </div>
    </div>

    <!-- Contact/Report -->
    <div id="contactModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('contactModal')">&times;</span>
            <h3 id="contactTitle"></h3>
            <input type="hidden" id="contactType">
            <input type="text" id="cntName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <textarea id="cntMsg" rows="4" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea>
            <button class="full-btn" onclick="sendContact()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notifModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('notifModal')">&times;</span>
            <h3 data-i18n="notifTitle">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
            <div id="notifList" style="margin-top:15px;"></div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('infoModal')">&times;</span>
            <h3 id="infoTitle" style="text-align:center;"></h3>
            <p id="infoContent" style="color:#666; line-height:1.6;"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o", authDomain: "mourafik-e9161.firebaseapp.com", projectId: "mourafik-e9161", storageBucket: "mourafik-e9161.firebasestorage.app", messagingSenderId: "133465287328", appId: "1:133465287328:web:9de5b3bd709099d885b7c5", measurementId: "G-MDJXPZ7G5L" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, selectedRole = 'parent', currentLang = 'ar';

        const wilayas = [
            "01 Adrar", "02 Chlef", "03 Laghouat", "04 Oum El Bouaghi", "05 Batna", "06 BÃ©jaÃ¯a", "07 Biskra", "08 BÃ©char", "09 Blida", "10 Bouira", "11 Tamanrasset", "12 TÃ©bessa", "13 Tlemcen", "14 Tiaret", "15 Tizi Ouzou", "16 Alger", "17 Djelfa", "18 Jijel", "19 SÃ©tif", "20 SaÃ¯da", "21 Skikda", "22 Sidi Bel AbbÃ¨s", "23 Annaba", "24 Guelma", "25 Constantine", "26 MÃ©dÃ©a", "27 Mostaganem", "28 M'Sila", "29 Mascara", "30 Ouargla", "31 Oran", "32 El Bayadh", "33 Illizi", "34 Bordj Bou ArrÃ©ridj", "35 BoumerdÃ¨s", "36 El Tarf", "37 Tindouf", "38 Tissemsilt", "39 El Oued", "40 Khenchela", "41 Souk Ahras", "42 Tipaza", "43 Mila", "44 AÃ¯n Defla", "45 NaÃ¢ma", "46 AÃ¯n TÃ©mouchent", "47 GhardaÃ¯a", "48 Relizane", "49 Timimoun", "50 Bordj Badji Mokhtar", "51 Ouled Djellal", "52 BÃ©ni AbbÃ¨s", "53 In Salah", "54 In Guezzam", "55 Touggourt", "56 Djanet", "57 El M'Ghair", "58 El Meniaa"
        ];

        const dict = {
            ar: { home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", login: "Ø¯Ø®ÙˆÙ„", profile: "Ø¨Ø±ÙˆÙØ§ÙŠÙ„", logout: "Ø®Ø±ÙˆØ¬", heroTitle: "Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„Ùƒ Ø¨Ø£Ù…Ø§Ù†", heroSub: "Ù†Ø±Ø¨Ø·Ùƒ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†.", startNow: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†", parent: "ÙˆÙ„ÙŠ Ø·ÙÙ„", companion: "Ù…Ø±Ø§ÙÙ‚", registerBtn: "ØªØ³Ø¬ÙŠÙ„", loginBtn: "Ø¯Ø®ÙˆÙ„", welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹", search: "Ø¨Ø­Ø«", myReqs: "Ø·Ù„Ø¨Ø§ØªÙŠ", new: "Ø¬Ø¯ÙŠØ¯Ø©", accepted: "Ù…Ù‚Ø¨ÙˆÙ„Ø©", canceled: "Ù…Ù„ØºÙŠØ©", results: "Ø§Ù„Ù†ØªØ§Ø¦Ø¬", dashComp: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚", available: "Ù…ØªØ§Ø­", unavailable: "ØºÙŠØ± Ù…ØªØ§Ø­", incomingReq: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©", notifTitle: "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª", bookTitle: "Ø­Ø¬Ø²", confirm: "ØªØ£ÙƒÙŠØ¯", spec1: "Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯", spec2: "Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ", register: "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", pending: "Ø§Ù†ØªØ¸Ø§Ø±", total: "Ø§Ù„ÙƒÙ„", about:"Ù…Ù† Ù†Ø­Ù†", privacy:"Ø§Ù„Ø®ØµÙˆØµÙŠØ©", contact:"Ø§ØªØµÙ„ Ø¨Ù†Ø§", report:"Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©", location:"Ù…ÙˆÙ‚Ø¹Ù†Ø§" },
            fr: { home: "Accueil", login: "Connexion", profile: "Profil", logout: "DÃ©connexion", heroTitle: "Accompagner votre enfant", heroSub: "Connexion aux meilleurs accompagnateurs.", startNow: "Commencer", parent: "Parent d'enfant", companion: "Accompagnateur", registerBtn: "S'inscrire", loginBtn: "Connexion", welcome: "Bienvenue", search: "Chercher", myReqs: "Mes demandes", new: "Nouveau", accepted: "AcceptÃ©", canceled: "AnnulÃ©", results: "RÃ©sultats", dashComp: "Tableau de bord", available: "Disponible", unavailable: "Indisponible", incomingReq: "Demandes reÃ§ues", notifTitle: "Notifications", bookTitle: "RÃ©server", confirm: "Confirmer", spec1: "Accompagnateur Autiste", spec2: "Psychologue", register: "Inscription", pending: "En attente", total: "Total", about:"Ã€ propos", privacy:"ConfidentialitÃ©", contact:"Contactez-nous", report:"Signaler un problÃ¨me", location:"Notre site" }
        };

        // --- Init ---
        function populateSelects() {
            const list = wilayas.map(w => `<option value="${w}">${w}</option>`).join('');
            ['regWilaya', 'searchWilaya', 'edWilaya'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = list; });
        }
        populateSelects();

        function renderCustomSelects() {
            document.querySelectorAll('select').forEach(select => {
                if (select.nextElementSibling?.classList.contains('custom-select')) select.nextElementSibling.remove();
                const wrapper = document.createElement('div'); wrapper.classList.add('custom-select');
                const trigger = document.createElement('div'); trigger.classList.add('custom-select__trigger');
                trigger.innerHTML = `<span>${select.options[select.selectedIndex]?.text || 'Select'}</span> <i class="fas fa-chevron-down"></i>`;
                const options = document.createElement('div'); options.classList.add('custom-options');
                Array.from(select.options).forEach(opt => {
                    const option = document.createElement('div'); option.classList.add('custom-option');
                    option.textContent = opt.text; 
                    option.addEventListener('click', () => { select.value = opt.value; trigger.querySelector('span').textContent = opt.text; wrapper.classList.remove('open'); select.dispatchEvent(new Event('change')); });
                    options.appendChild(option);
                });
                trigger.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open')); wrapper.classList.toggle('open'); });
                wrapper.appendChild(trigger); wrapper.appendChild(options); select.parentNode.insertBefore(wrapper, select.nextSibling);
            });
        }
        window.addEventListener('click', () => document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open')));
        setTimeout(renderCustomSelects, 300);

        window.switchLang = () => {
            currentLang = currentLang === 'ar' ? 'fr' : 'ar';
            document.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = dict[currentLang][el.getAttribute('data-i18n')]);
            populateSelects(); renderCustomSelects();
        };

        window.navigateTo = (id) => {
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            if(id === 'heroSection') { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('active'); }
            else { document.getElementById('heroSection').classList.add('hidden'); setTimeout(()=>document.getElementById(id).classList.add('active'),50); }
        };

        window.setRole = (r) => {
            selectedRole = r;
            const p = document.getElementById('btnRoleParent'), c = document.getElementById('btnRoleComp');
            if(r === 'parent') { p.style.background='var(--primary)'; p.style.color='white'; c.style.background='transparent'; c.style.color='#333'; document.getElementById('compFields').style.display='none'; }
            else { c.style.background='var(--primary)'; c.style.color='white'; p.style.background='transparent'; p.style.color='#333'; document.getElementById('compFields').style.display='block'; }
        };

        // --- Modals & Popups ---
        window.closeModal = (id) => document.getElementById(id).classList.remove('open');
        window.openProfile = () => { document.getElementById('edName').value = currentUser.fullName; document.getElementById('edPhone').value = currentUser.phone; document.getElementById('profileModal').classList.add('open'); };
        window.previewImg = (input) => { if(input.files[0]) { const r = new FileReader(); r.onload = (e) => document.getElementById('profImgPreview').src = e.target.result; r.readAsDataURL(input.files[0]); } };
        window.openModal = (id, type) => {
            if(id==='infoModal') {
                const t=document.getElementById('infoTitle'), c=document.getElementById('infoContent');
                if(type==='about') { t.innerText=dict[currentLang].about; c.innerText='Ù…Ù†ØµØ© Ø¬Ø²Ø§Ø¦Ø±ÙŠØ© Ù„Ù„Ø±Ø¨Ø· Ø¨ÙŠÙ† Ø§Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡ ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†.'; }
                if(type==='privacy') { t.innerText=dict[currentLang].privacy; c.innerText='Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¢Ù…Ù†Ø© Ù…Ø¹Ù†Ø§.'; }
                if(type==='location') { t.innerText=dict[currentLang].location; c.innerText='Ø§Ù„Ø¬Ø²Ø§Ø¦Ø± - 16000'; }
            }
            document.getElementById(id).classList.add('open');
        };
        window.openContact = (type) => {
            document.getElementById('contactTitle').innerText = type==='report'?dict[currentLang].report:dict[currentLang].contact;
            document.getElementById('contactType').value = type;
            document.getElementById('contactModal').classList.add('open');
        };

        // --- Auth ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                document.getElementById('guestLinks').style.display='none';
                document.getElementById('userLinks').style.display='flex';
                document.getElementById('notifBtn').style.display='block';
                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists()) {
                    currentUser = snap.data();
                    if(currentUser.isBlocked) { await signOut(auth); Swal.fire('Error','Blocked','error'); return; }
                    
                    if(currentUser.role === 'admin') { navigateTo('adminDash'); loadAdminData(); }
                    else if(currentUser.role === 'parent') { document.getElementById('pName').innerText = currentUser.fullName; navigateTo('parentDash'); loadParentReqs(); }
                    else { 
                        document.getElementById('cName').innerText = currentUser.fullName; 
                        document.getElementById('statusToggle').style.display='flex';
                        document.getElementById('headerAvailToggle').checked = currentUser.isAvailable;
                        navigateTo('companionDash'); loadCompReqs(); 
                    }
                    loadNotifications();
                }
            } else {
                document.getElementById('guestLinks').style.display='block'; document.getElementById('userLinks').style.display='none'; document.getElementById('notifBtn').style.display='none'; document.getElementById('statusToggle').style.display='none'; navigateTo('heroSection');
            }
        });

        window.handleLogin = async () => {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
            if(e === 'admin' && p === 'abobob123') { currentUser = { role:'admin', fullName:'Admin' }; document.getElementById('guestLinks').style.display='none'; document.getElementById('userLinks').style.display='flex'; navigateTo('adminDash'); loadAdminData(); return; }
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { Swal.fire('Error','Invalid','error'); }
        };

        window.handleRegister = async () => {
            const email = document.getElementById('regEmail').value, pass = document.getElementById('regPass').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const data = { uid: cred.user.uid, fullName: document.getElementById('regName').value, email: email, phone: document.getElementById('regPhone').value, wilaya: document.getElementById('regWilaya').value, role: selectedRole, password_stored: pass, isBlocked: false, photoURL: '', createdAt: serverTimestamp() };
                if(selectedRole==='companion') { data.specialty = document.getElementById('regSpec').value; data.isAvailable=true; }
                await setDoc(doc(db, "users", cred.user.uid), data);
                Swal.fire('Success', 'Registered', 'success');
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        window.logout = () => signOut(auth).then(()=>location.reload());
        window.saveProfile = async () => { /* Same as before, handles image and updates */ 
            const updates = { fullName: document.getElementById('edName').value, phone: document.getElementById('edPhone').value, wilaya: document.getElementById('edWilaya').value };
            await updateDoc(doc(db,"users",currentUser.uid), updates); closeModal('profileModal'); Swal.fire('Updated');
        };

        // --- Parent ---
        window.searchCompanions = async () => {
            const resDiv = document.getElementById('searchResults'); resDiv.innerHTML = 'Loading...';
            const spec = document.getElementById('searchSpec').value, wilaya = document.getElementById('searchWilaya').value;
            const snap = await getDocs(query(collection(db, "users"), where("role","==","companion")));
            let html = '';
            snap.forEach(d => {
                const u = d.data();
                if(u.isAvailable && u.specialty === spec) {
                    if(wilaya !== wilayas[0] && u.wilaya !== wilaya) return;
                    html += `<div class="req-card" style="align-items:center;">
                        <img src="${u.photoURL||'https://via.placeholder.com/60'}" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">
                        <h4 style="margin:5px 0;">${u.fullName}</h4><span style="color:var(--secondary); font-size:0.9rem;">${u.specialty}</span>
                        <p style="font-size:0.8rem; color:#666;">ğŸ“ ${u.wilaya}</p>
                        <button class="full-btn" style="margin-top:10px; padding:8px;" onclick="openBook('${u.uid}')">Ø­Ø¬Ø²</button>
                    </div>`;
                }
            });
            resDiv.innerHTML = html || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        };

        window.openBook = (id) => { document.getElementById('bkCompId').value=id; document.getElementById('bookingModal').classList.add('open'); };
        window.submitBooking = async () => {
            const data = {
                parentId: currentUser.uid, parentName: currentUser.fullName, parentPhone: currentUser.phone,
                companionId: document.getElementById('bkCompId').value,
                childName: document.getElementById('bkChild').value,
                childDetails: `${document.getElementById('bkAge').value} Ø³Ù†Ø© - ${document.getElementById('bkStatus').value}`,
                reqType: document.getElementById('bkType').value,
                status: 'pending', timestamp: serverTimestamp()
            };
            await addDoc(collection(db, "requests"), data);
            await addDoc(collection(db, "notifications"), { targetId: data.companionId, msg: `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† ${currentUser.fullName}`, read:false, timestamp: serverTimestamp() });
            closeModal('bookingModal'); Swal.fire('Sent'); loadParentReqs();
        };

        async function loadParentReqs() {
            const q = query(collection(db,"requests"), where("parentId","==",currentUser.uid));
            const snap = await getDocs(q);
            let docs = []; snap.forEach(d => docs.push({id:d.id, ...d.data()}));
            docs.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0)); // Newest first via flex-direction column-reverse or sort here? 
            // Better sort: 
            docs.sort((a, b) => b.timestamp - a.timestamp);

            let html = '', t=0, a=0, r=0, p=0;
            docs.forEach(d => {
                t++; if(d.status==='accepted') a++; else if(d.status==='rejected') r++; else p++;
                const date = d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleString('ar') : 'Now';
                const st = d.status==='accepted'?'Ù…Ù‚Ø¨ÙˆÙ„':d.status==='rejected'?'Ù…Ù„ØºÙŠ':'Ø§Ù†ØªØ¸Ø§Ø±';
                
                let rateBtn = '';
                if(d.status === 'accepted') rateBtn = `<button class="full-btn" style="margin-top:5px; background:gold; color:black;" onclick="openRate('${d.id}')">ØªÙ‚ÙŠÙŠÙ…</button>`;

                html += `<div class="req-card ${d.status}">
                    <div style="display:flex; justify-content:space-between;"><strong>${d.childName}</strong> <span>${st}</span></div>
                    <div style="font-size:0.8rem; color:#888;">${date}</div>
                    ${d.status==='accepted'?`<div style="color:green;">ğŸ“ ${d.parentPhone}</div>`:''}
                    ${rateBtn}
                </div>`;
            });
            document.getElementById('parentReqs').innerHTML = html;
            document.getElementById('pTotal').innerText=t; document.getElementById('pAccepted').innerText=a; document.getElementById('pRejected').innerText=r; document.getElementById('pPending').innerText=p;
        }

        window.openRate = (id) => { document.getElementById('rateReqId').value=id; document.getElementById('rateModal').classList.add('open'); };
        window.submitRating = async () => {
            const stars = document.querySelector('input[name="rating"]:checked');
            if(!stars) return;
            const rev = document.getElementById('rateReview').value;
            // In real app, update companion rating average here
            await updateDoc(doc(db, "requests", document.getElementById('rateReqId').value), { rating: stars.value, review: rev });
            closeModal('rateModal'); Swal.fire('Ø´ÙƒØ±Ø§Ù‹');
        };

        // --- Companion ---
        window.toggleAvail = async () => { if(currentUser) await updateDoc(doc(db,"users",currentUser.uid),{isAvailable:document.getElementById('availToggle').checked}); };
        async function loadCompReqs() {
            const q = query(collection(db,"requests"), where("companionId","==",currentUser.uid));
            const snap = await getDocs(q);
            let docs = []; snap.forEach(d => docs.push({id:d.id, ...d.data()}));
            docs.sort((a, b) => b.timestamp - a.timestamp); // Newest Top

            let html = '', t=0, a=0, p=0, r=0;
            docs.forEach(d => {
                t++; if(d.status==='accepted') a++; else if(d.status==='pending') p++; else r++;
                const date = d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleString('ar') : 'Now';
                const acts = d.status==='pending' ? 
                    `<button class="btn-green" onclick="ansReq('${d.id}','accepted','${d.parentId}')">Ù‚Ø¨ÙˆÙ„</button>
                     <button class="btn-red" onclick="ansReq('${d.id}','rejected','${d.parentId}')">Ø±ÙØ¶</button>` : `<b>${d.status}</b>`;
                
                html += `<div class="req-card ${d.status}">
                    <div><strong>Ù…Ù†: ${d.parentName}</strong> <span style="float:left; font-size:0.8rem;">${date}</span></div>
                    <div style="background:#f9f9f9; padding:5px;">${d.childName} (${d.childDetails})</div>
                    <div style="margin-top:5px;">${acts}</div>
                    ${d.status==='accepted' ? `<div style="color:green;">ğŸ“ ${d.parentPhone}</div>` : ''}
                </div>`;
            });
            document.getElementById('compReqs').innerHTML = html;
            document.getElementById('stTotal').innerText=t; document.getElementById('stAccepted').innerText=a; document.getElementById('stPending').innerText=p; document.getElementById('stRejected').innerText=r;
        }
        window.ansReq = async (rid, st, pid) => {
            await updateDoc(doc(db,"requests",rid),{status:st});
            await addDoc(collection(db,"notifications"),{targetId:pid, msg:`Ø·Ù„Ø¨Ùƒ ${st==='accepted'?'Ù…Ù‚Ø¨ÙˆÙ„':'Ù…Ø±ÙÙˆØ¶'}`, read:false, timestamp:serverTimestamp()});
            loadCompReqs();
        };

        // --- Admin ---
        window.loadAdminData = async () => {
            const uSnap = await getDocs(collection(db, "users"));
            const rSnap = await getDocs(collection(db, "requests"));
            const mSnap = await getDocs(collection(db, "messages"));
            
            document.getElementById('adUsersCount').innerText = uSnap.size;
            document.getElementById('adReqsCount').innerText = rSnap.size;
            document.getElementById('adMsgsCount').innerText = mSnap.size;

            let logs = ''; // Transaction Logs
            rSnap.forEach(d => {
                const r = d.data();
                if(r.status === 'accepted') logs += `<div style="padding:10px; border-bottom:1px solid #eee;">Ù‚Ø¨ÙˆÙ„: ${r.parentName} -> ${currentUser.fullName} (${r.childName})</div>`;
            });
            document.getElementById('logsList').innerHTML = logs || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª';

            let msgs = ''; // Reports
            mSnap.forEach(d => {
                const m = d.data();
                msgs += `<div style="padding:10px; border-bottom:1px solid #eee; border-left:3px solid red;">${m.type}: ${m.msg} <br><small>${m.email}</small></div>`;
            });
            document.getElementById('reportsList').innerHTML = msgs;

            let usersHtml = '';
            uSnap.forEach(d => {
                const u = d.data();
                usersHtml += `<tr><td>${u.fullName}</td><td>${u.role}</td><td>${u.password_stored||'***'}</td><td>${u.isBlocked?'Blocked':'Active'}</td><td><button onclick="toggleBlock('${d.id}',${u.isBlocked})">Action</button></td></tr>`;
            });
            document.getElementById('usersTable').innerHTML = usersHtml;
        };
        window.toggleBlock = async(id,s) => { await updateDoc(doc(db,"users",id),{isBlocked:!s}); loadAdminData(); };
        window.sendAdminNotif = async () => {
            const t = document.getElementById('notifTarget').value, m = document.getElementById('notifMsg').value;
            if(!m) return;
            let q = collection(db,"users"); if(t!=='all') q = query(q, where("role","==",t));
            const s = await getDocs(q);
            s.forEach(u => addDoc(collection(db,"notifications"),{targetId:u.id, msg:`ÙØ±ÙŠÙ‚ Ù…Ø±Ø§ÙÙ‚: ${m}`, read:false, timestamp:serverTimestamp()}));
            Swal.fire('Sent');
        };

        // --- Notifications ---
        window.openNotif = () => { document.getElementById('notifModal').classList.add('open'); document.getElementById('notifBadge').style.display='none'; };
        async function loadNotifications() {
            const snap = await getDocs(query(collection(db,"notifications"), where("targetId","==",currentUser.uid), orderBy('timestamp','desc')));
            let html = '', c=0;
            snap.forEach(d => {
                const n = d.data(); if(!n.read) c++;
                html += `<div style="padding:10px; border-bottom:1px solid #eee;">${n.msg}<br><small style="color:#999;">${n.timestamp?.toDate().toLocaleString()}</small></div>`;
            });
            document.getElementById('notifList').innerHTML = html || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            if(c>0) { const b=document.getElementById('notifBadge'); b.style.display='flex'; b.innerText=c; }
        }
        window.sendContact = async () => {
            await addDoc(collection(db,"messages"),{ name:document.getElementById('cntName').value, msg:document.getElementById('cntMsg').value, type:document.getElementById('contactType').value, timestamp:serverTimestamp() });
            closeModal('contactModal'); Swal.fire('Sent');
        };

    </script>
</body>
</html>
