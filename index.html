<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø±Ø§ÙÙ‚ | Morafik - Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„Ùƒ Ø¨Ø£Ù…Ø§Ù†</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --accent: #ef4444;
            --success: #10b981;
            --bg-color: #f3f4f6;
            --text-main: #1f2937;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        
        body { 
            background-color: var(--bg-color); 
            color: var(--text-main); 
            overflow-x: hidden; 
            min-height: 100vh; 
        }

        /* Fixed Background */
        .fixed-bg {
            position: fixed; inset: 0;
            background: url('https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
            z-index: -10;
            animation: zoomEffect 25s infinite alternate ease-in-out;
        }
        @keyframes zoomEffect { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
        .bg-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: -9; backdrop-filter: blur(3px); }

        /* Header */
        header { 
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(12px); 
            padding: 10px 5%; display: flex; justify-content: space-between; align-items: center; 
            position: fixed; width: 100%; top: 0; z-index: 2000; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        
        .logo-img { height: 50px; width: auto; }

        .nav-links { display: flex; gap: 15px; align-items: center; }
        
        .nav-item {
            background: var(--primary); color: white; padding: 8px 15px; border-radius: 12px;
            font-size: 0.9rem; font-weight: bold; border: none; cursor: pointer;
            display: flex; align-items: center; gap: 8px; transition: 0.3s;
            box-shadow: 0 4px 6px rgba(30, 58, 138, 0.2);
        }
        .nav-item:hover { transform: translateY(-2px); background: var(--secondary); }
        .nav-item i { font-size: 1.1rem; }
        .nav-item.logout { background: #fee2e2; color: var(--accent); }
        .nav-item.logout:hover { background: #fecaca; }

        .notif-btn { position: relative; cursor: pointer; font-size: 24px; color: var(--primary); margin-left: 15px; background: white; padding: 8px; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .badge { position: absolute; top: 0; right: 0; background: var(--accent); color: white; border-radius: 50%; font-size: 10px; width: 18px; height: 18px; display: flex; justify-content: center; align-items: center; border: 2px solid white; }

        /* Sections */
        .app-section {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            display: flex; flex-direction: column; 
            z-index: 100; transition: transform 0.6s cubic-bezier(0.7, 0, 0.3, 1);
            overflow-y: auto; background: var(--bg-color);
            padding-top: 100px; transform: translateY(100vh); opacity: 0;
        }
        .app-section.active { transform: translateY(0); opacity: 1; z-index: 500; }
        #heroSection { background: transparent; transform: translateY(0); opacity: 1; z-index: 10; justify-content: center; align-items: center; text-align: center; color: white; padding-top: 0; }
        #heroSection.hidden { opacity: 0; pointer-events: none; }

        /* UI Elements */
        .hero-title { font-size: 3.5rem; font-weight: 900; margin-bottom: 20px; text-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .cta-btn { padding: 15px 60px; background: var(--secondary); color: white; border: none; border-radius: 50px; font-size: 1.3rem; font-weight: bold; cursor: pointer; box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4); }
        
        .container-box { width: 100%; max-width: 500px; margin: 30px auto; background: white; padding: 40px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        .dashboard-container { width: 95%; max-width: 1200px; margin: 0 auto; padding-bottom: 50px; }

        input, textarea { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 12px; background: #fff; font-size: 1rem; transition: 0.3s; }
        input:focus { border-color: var(--secondary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .dash-card { padding: 25px; border-radius: 20px; color: white; position: relative; overflow: hidden; box-shadow: 0 8px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: center; height: 130px; }
        .dash-card h3 { font-size: 2.5rem; margin: 0; font-weight: 800; }
        .dash-card i { position: absolute; left: 20px; font-size: 3rem; opacity: 0.2; }
        
        .bg-1 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bg-2 { background: linear-gradient(135deg, #10b981, #059669); }
        .bg-3 { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .bg-4 { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .bg-dark { background: linear-gradient(135deg, #1f2937, #111827); }

        /* Request Cards */
        .req-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .req-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-right: 6px solid #ccc; display: flex; flex-direction: column; gap: 8px; position: relative; transition: transform 0.2s; }
        .req-card:hover { transform: translateY(-3px); }
        .req-card.pending { border-color: #f59e0b; }
        .req-card.accepted { border-color: #10b981; }
        .req-card.rejected { border-color: #ef4444; }

        /* Admin Specific */
        .admin-section { background: white; padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .admin-table th { background: var(--bg-color); padding: 12px; text-align: right; color: var(--primary); }
        .admin-table td { padding: 12px; border-bottom: 1px solid #eee; }

        /* Fixed Custom Select */
        select { display: none; }
        .custom-select-wrapper { position: relative; width: 100%; margin-bottom: 15px; z-index: 10; }
        .custom-select-trigger { padding: 14px; background: white; border: 1px solid #ddd; border-radius: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 1rem; color: #555; }
        .custom-options { position: absolute; top: 105%; left: 0; right: 0; background: white; border: 1px solid #ddd; border-radius: 12px; z-index: 2000; display: none; max-height: 250px; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.15); }
        .custom-options.open { display: block; }
        .custom-option { padding: 12px; cursor: pointer; border-bottom: 1px solid #f5f5f5; transition: 0.2s; }
        .custom-option:hover { background: var(--secondary); color: white; }

        /* Modals & Switch */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-overlay.open { display: flex; }
        .modal-box { background: white; width: 90%; max-width: 600px; padding: 30px; border-radius: 24px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }

        .switch-wrapper { display: flex; align-items: center; gap: 15px; background: white; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); width: fit-content; margin-top: 15px; border: 1px solid #eee; }
        .switch { position: relative; display: inline-block; width: 45px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; }
        input:checked + .slider:before { transform: translateX(20px); }

        .full-btn { width: 100%; padding: 14px; background: var(--secondary); color: white; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        
        @media (max-width: 768px) { 
            .req-grid { grid-template-columns: 1fr; } 
            .hero-title { font-size: 2.5rem; } 
            .nav-links { gap: 10px; }
            .nav-item span { display: none; } /* Hide text on mobile for buttons, show icon */
            .nav-item i { margin: 0; font-size: 1.2rem; }
        }
    </style>
</head>
<body>

    <div class="fixed-bg"></div>
    <div class="bg-overlay"></div>

    <header>
        <div class="logo">
            <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgGmf6afcKjxaL9hB_Cv4AZ_JBvtuXheqwzIvoGu49lm9A6mXRYLoz-ZDhZcXaQD4cU3RXi6d4lAfDskoqsSRXdjLwDeTvF1XPINU0cdIhHcO6Q_sBlABLu4lSngQyylUTgQ-R7f7ELF3Y4RxtoFY1Wn_33Mv_6UsC7WNIKRuuOfxXlsU9uU9zjAt4a2CM/s320/Picsart_26-01-29_13-14-09-750.png" class="logo-img" alt="Morafik">
        </div>
        
        <div class="nav-links">
            <div id="notifBtn" class="notif-btn" onclick="openNotif()" style="display:none;">
                <i class="fas fa-bell"></i><span id="notifBadge" class="badge" style="display:none;">0</span>
            </div>

            <!-- Buttons -->
            <button class="nav-item" onclick="switchLang()"><i class="fas fa-language"></i> <span>FR/AR</span></button>
            
            <div id="guestLinks" style="display:flex; gap:10px;">
                <button class="nav-item" onclick="navigateTo('heroSection')"><i class="fas fa-home"></i> <span data-i18n="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></button>
                <button class="nav-item" onclick="navigateTo('loginSection')"><i class="fas fa-sign-in-alt"></i> <span data-i18n="login">Ø¯Ø®ÙˆÙ„</span></button>
            </div>
            
            <div id="userLinks" style="display:none; gap:10px;">
                <button class="nav-item" onclick="openProfile()"><i class="fas fa-user-circle"></i> <span data-i18n="profile">Ø¨Ø±ÙˆÙØ§ÙŠÙ„</span></button>
                <button class="nav-item logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Ø®Ø±ÙˆØ¬</span></button>
            </div>
        </div>
    </header>

    <!-- 1. HERO -->
    <section id="heroSection" class="app-section active">
        <h1 class="hero-title" data-i18n="heroTitle">Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„Ùƒ Ø¨Ø£Ù…Ø§Ù†</h1>
        <p style="font-size:1.4rem; color:white; margin-bottom:30px;" data-i18n="heroSub">Ù†Ø±Ø¨Ø·Ùƒ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ† ÙˆØ§Ù„Ø£Ø®ØµØ§Ø¦ÙŠÙŠÙ† Ø§Ù„Ù†ÙØ³ÙŠÙŠÙ†.</p>
        <button class="cta-btn" onclick="navigateTo('registerSection')" data-i18n="startNow">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†</button>
        
        <div class="hero-footer" style="position:absolute; bottom:20px; display:flex; gap:20px; color:#ddd; background:rgba(0,0,0,0.5); padding:10px 20px; border-radius:30px;">
            <span style="cursor:pointer;" onclick="openModal('infoModal', 'about')" data-i18n="about">Ù…Ù† Ù†Ø­Ù†</span>
            <span style="cursor:pointer;" onclick="openModal('infoModal', 'privacy')" data-i18n="privacy">Ø§Ù„Ø®ØµÙˆØµÙŠØ©</span>
            <span style="cursor:pointer;" onclick="openContact('contact')" data-i18n="contact">Ø§ØªØµÙ„ Ø¨Ù†Ø§</span>
            <span style="cursor:pointer;" onclick="openContact('report')" style="color:#fca5a5;" data-i18n="report">Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©</span>
        </div>
    </section>

    <!-- 2. REGISTER -->
    <section id="registerSection" class="app-section">
        <div class="container-box">
            <h2 data-i18n="register">Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button onclick="setRole('parent')" id="btnRoleParent" style="flex:1; padding:12px; background:var(--primary); color:white; border-radius:10px; border:none; font-weight:bold;" data-i18n="parent">ÙˆÙ„ÙŠ Ø·ÙÙ„</button>
                <button onclick="setRole('companion')" id="btnRoleComp" style="flex:1; padding:12px; background:transparent; border:1px solid #ccc; border-radius:10px; font-weight:bold;" data-i18n="companion">Ù…Ø±Ø§ÙÙ‚</button>
            </div>
            <input type="text" id="regName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" data-ph="fullName">
            <input type="email" id="regEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" data-ph="email">
            <input type="tel" id="regPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" data-ph="phone">
            
            <div class="custom-select-wrapper"><select id="regWilaya"></select></div>

            <div id="compFields" style="display:none;">
                <div class="custom-select-wrapper">
                    <select id="regSpec">
                        <option value="Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯" data-i18n="spec1">Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯</option>
                        <option value="Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ" data-i18n="spec2">Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ</option>
                    </select>
                </div>
                <div style="background:#e0f2fe; padding:15px; border-radius:10px; border:1px dashed #3b82f6; margin-bottom:15px; text-align:right;">
                    <p style="margin:0; font-size:0.9rem; color:#1e40af; margin-bottom:5px;">âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø±ÙØ§Ù‚ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„ Ø£Ùˆ Ø§Ù„Ø¯Ø¨Ù„ÙˆÙ… (PDF) Ù„Ø¥Ø«Ø¨Ø§Øª Ø§Ù„ØªØ®ØµØµ</p>
                    <input type="file" id="regDoc" accept="application/pdf">
                </div>
            </div>
            <input type="password" id="regPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-ph="pass">
            <button class="full-btn" onclick="handleRegister()" data-i18n="registerBtn">ØªØ³Ø¬ÙŠÙ„</button>
        </div>
    </section>

    <!-- 3. LOGIN -->
    <section id="loginSection" class="app-section">
        <div class="container-box">
            <h2 data-i18n="login">Ø¯Ø®ÙˆÙ„</h2>
            <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" data-ph="email">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" data-ph="pass">
            <button class="full-btn" onclick="handleLogin()" data-i18n="loginBtn">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </section>

    <!-- 4. PARENT DASHBOARD -->
    <section id="parentDash" class="app-section">
        <div class="dashboard-container">
            <div style="background:white; padding:20px; border-radius:20px; margin-bottom:25px; box-shadow:0 5px 20px rgba(0,0,0,0.05);">
                <h2 style="color:var(--primary); margin:0;"><span data-i18n="welcome">Ù…Ø±Ø­Ø¨Ø§Ù‹</span> <span id="pName"></span></h2>
            </div>
            
            <div class="stats-grid">
                <div class="dash-card bg-1"><i class="fas fa-list"></i><h3 id="pTotal">0</h3><p data-i18n="new">Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p></div>
                <div class="dash-card bg-2"><i class="fas fa-check"></i><h3 id="pAccepted">0</h3><p data-i18n="accepted">Ù…Ù‚Ø¨ÙˆÙ„Ø©</p></div>
                <div class="dash-card bg-3"><i class="fas fa-times"></i><h3 id="pRejected">0</h3><p data-i18n="canceled">Ù…Ù„ØºÙŠØ©</p></div>
                <div class="dash-card bg-4"><i class="fas fa-clock"></i><h3 id="pPending">0</h3><p data-i18n="pending">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p></div>
            </div>

            <!-- Search -->
            <div style="background:white; padding:25px; border-radius:20px; margin-bottom:30px; box-shadow:0 5px 20px rgba(0,0,0,0.05);">
                <h3 style="margin-bottom:20px; color:var(--primary);">Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±Ø§ÙÙ‚ / Ø£Ø®ØµØ§Ø¦ÙŠ</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr auto; gap:15px;">
                    <div class="custom-select-wrapper">
                        <select id="searchSpec">
                            <option value="Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯" data-i18n="spec1">Ù…Ø±Ø§ÙÙ‚ Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯</option>
                            <option value="Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ" data-i18n="spec2">Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ</option>
                        </select>
                    </div>
                    <div class="custom-select-wrapper"><select id="searchWilaya"></select></div>
                    <button class="full-btn" style="width:auto; padding:0 40px;" onclick="searchCompanions()" data-i18n="search">Ø¨Ø­Ø«</button>
                </div>
                <div id="searchResults" class="req-grid" style="margin-top:20px;"></div>
            </div>
            
            <h3 style="margin-top:30px;" data-i18n="myReqs">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
            <div id="parentReqs" class="req-grid"></div>
        </div>
    </section>

    <!-- 5. COMPANION DASHBOARD -->
    <section id="companionDash" class="app-section">
        <div class="dashboard-container">
            <div style="background:white; padding:25px; border-radius:20px; margin-bottom:25px;">
                <h2 style="color:var(--primary); margin:0;"><span data-i18n="dashComp">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚</span> <span id="cName"></span></h2>
                
                <!-- Availability Switch (Separated) -->
                <div class="switch-wrapper">
                    <span id="availLabel" style="font-weight:bold; font-size:0.9rem;" data-i18n="available">Ù…ØªØ§Ø­</span>
                    <label class="switch">
                        <input type="checkbox" id="availToggle" onchange="toggleAvail()">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <div class="stats-grid">
                <div class="dash-card bg-1"><i class="fas fa-inbox"></i><h3 id="stTotal">0</h3><p data-i18n="total">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</p></div>
                <div class="dash-card bg-4"><i class="fas fa-star"></i><h3>4.8</h3><p>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</p></div>
                <div class="dash-card bg-2"><i class="fas fa-check-circle"></i><h3 id="stAccepted">0</h3><p data-i18n="accepted">Ù…Ù‚Ø¨ÙˆÙ„Ø©</p></div>
                <div class="dash-card bg-3"><i class="fas fa-ban"></i><h3 id="stRejected">0</h3><p data-i18n="canceled">Ù…Ù„ØºÙŠØ©</p></div>
            </div>

            <h3 data-i18n="incomingReq">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
            <div id="compReqs" class="req-grid"></div>
        </div>
    </section>

    <!-- 6. ADMIN DASHBOARD (Organized) -->
    <section id="adminDash" class="app-section">
        <div class="dashboard-container">
            <h2 style="color:var(--primary);">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</h2>
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="dash-card bg-dark"><h3>USERS</h3><p id="adUsersCount">0</p></div>
                <div class="dash-card bg-1"><h3>REQ</h3><p id="adReqsCount">0</p></div>
                <div class="dash-card bg-4"><h3>MSG</h3><p id="adMsgsCount">0</p></div>
                <div class="dash-card bg-2"><h3>LOGS</h3><p>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</p></div>
            </div>

            <!-- Clean Layout for Actions -->
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:30px;">
                <!-- Notification Sender -->
                <div class="admin-section">
                    <h3>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</h3>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <div class="custom-select-wrapper" style="margin:0;">
                            <select id="notifTarget">
                                <option value="all">Ø§Ù„Ø¬Ù…ÙŠØ¹</option>
                                <option value="parent">Ø§Ù„Ø£ÙˆÙ„ÙŠØ§Ø¡</option>
                                <option value="companion">Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†</option>
                            </select>
                        </div>
                        <input type="text" id="notifMsg" placeholder="Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©..." style="margin:0;">
                        <button class="full-btn" onclick="sendAdminNotif()">Ø¥Ø±Ø³Ø§Ù„</button>
                    </div>
                </div>

                <!-- Logs/Reports -->
                <div class="admin-section" style="max-height:300px; overflow-y:auto;">
                    <h3>Ø¢Ø®Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</h3>
                    <div id="reportsList"></div>
                </div>
            </div>
            
            <h3 style="margin-top:20px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
            <div style="overflow-x:auto;"><table class="admin-table"><tbody id="usersTable"></tbody></table></div>
        </div>
    </section>

    <!-- MODALS -->
    
    <!-- Profile Edit -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('profileModal')">&times;</span>
            <h3 style="text-align:center;">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù</h3>
            <div style="text-align:center; margin-bottom:15px;">
                <img id="profImgPreview" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid var(--secondary);">
                <br><label for="profImgInput" style="color:var(--secondary); cursor:pointer;">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø©</label>
                <input type="file" id="profImgInput" style="display:none;" onchange="previewImg(this)">
            </div>
            <input type="text" id="edName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="tel" id="edPhone" placeholder="Ø§Ù„Ù‡Ø§ØªÙ">
            <div class="custom-select-wrapper"><select id="edWilaya"></select></div>
            <input type="password" id="edPass" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <button class="full-btn" onclick="saveProfile()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        </div>
    </div>

    <!-- Booking -->
    <div id="bookingModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('bookingModal')">&times;</span>
            <h3 style="text-align:center;" data-i18n="bookTitle">Ø­Ø¬Ø²</h3>
            <input type="hidden" id="bkCompId">
            <input type="text" id="bkChild" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <input type="number" id="bkAge" placeholder="Ø§Ù„Ø³Ù†">
                <div class="custom-select-wrapper"><select id="bkLevel"><option>Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option><option>Ù…ØªÙˆØ³Ø·</option><option>Ø®Ø§Øµ</option></select></div>
            </div>
            <div class="custom-select-wrapper"><select id="bkStatus"><option>Ø·ÙŠÙ Ø§Ù„ØªÙˆØ­Ø¯</option><option>ÙØ±Ø· Ø§Ù„Ø­Ø±ÙƒØ©</option><option>Ø¹Ø§Ø¯ÙŠ</option></select></div>
            <div class="custom-select-wrapper"><select id="bkType"><option>Ø¯ÙˆØ§Ù… ÙƒØ§Ù…Ù„</option><option>Ø¬Ù„Ø³Ø§Øª</option></select></div>
            <button class="full-btn" onclick="submitBooking()" data-i18n="confirm">ØªØ£ÙƒÙŠØ¯</button>
        </div>
    </div>

    <!-- Rating Modal -->
    <div id="rateModal" class="modal-overlay">
        <div class="modal-box">
            <span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('rateModal')">&times;</span>
            <h3 style="text-align:center;">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</h3>
            <input type="hidden" id="rateReqId">
            <div style="text-align:center; font-size:30px; margin:20px 0; color:gold;">
                <i class="fas fa-star" onclick="setRate(1)"></i><i class="fas fa-star" onclick="setRate(2)"></i>
                <i class="fas fa-star" onclick="setRate(3)"></i><i class="fas fa-star" onclick="setRate(4)"></i>
                <i class="fas fa-star" onclick="setRate(5)"></i>
            </div>
            <input type="hidden" id="starValue">
            <textarea id="rateReview" rows="3" placeholder="ØªØ¹Ù„ÙŠÙ‚Ùƒ..."></textarea>
            <button class="full-btn" onclick="submitRating()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
        </div>
    </div>

    <!-- Others -->
    <div id="notifModal" class="modal-overlay"><div class="modal-box"><span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('notifModal')">&times;</span><h3 data-i18n="notifTitle">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3><div id="notifList" style="margin-top:15px;"></div></div></div>
    <div id="contactModal" class="modal-overlay"><div class="modal-box"><span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('contactModal')">&times;</span><h3 id="contactTitle"></h3><input type="hidden" id="contactType"><input type="text" id="cntName" placeholder="Ø§Ù„Ø§Ø³Ù…"><input type="email" id="cntEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"><textarea id="cntMsg" rows="4" placeholder="Ø§Ù„Ø±Ø³Ø§Ù„Ø©..."></textarea><button class="full-btn" onclick="sendContact()">Ø¥Ø±Ø³Ø§Ù„</button></div></div>
    <div id="infoModal" class="modal-overlay"><div class="modal-box"><span style="position:absolute; left:20px; top:20px; cursor:pointer;" onclick="closeModal('infoModal')">&times;</span><h3 id="infoTitle" style="text-align:center;"></h3><p id="infoContent" style="color:#666; line-height:1.6;"></p></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updatePassword } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o", authDomain: "mourafik-e9161.firebaseapp.com", projectId: "mourafik-e9161", storageBucket: "mourafik-e9161.firebasestorage.app", messagingSenderId: "133465287328", appId: "1:133465287328:web:9de5b3bd709099d885b7c5", measurementId: "G-MDJXPZ7G5L" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let selectedRole = 'parent';
        let currentLang = 'ar';

        const wilayas = [
            {ar: "01 Ø£Ø¯Ø±Ø§Ø±", fr: "01 Adrar"}, {ar: "02 Ø§Ù„Ø´Ù„Ù", fr: "02 Chlef"}, {ar: "03 Ø§Ù„Ø£ØºÙˆØ§Ø·", fr: "03 Laghouat"},
            {ar: "04 Ø£Ù… Ø§Ù„Ø¨ÙˆØ§Ù‚ÙŠ", fr: "04 Oum El Bouaghi"}, {ar: "05 Ø¨Ø§ØªÙ†Ø©", fr: "05 Batna"}, {ar: "06 Ø¨Ø¬Ø§ÙŠØ©", fr: "06 BÃ©jaÃ¯a"},
            {ar: "07 Ø¨Ø³ÙƒØ±Ø©", fr: "07 Biskra"}, {ar: "08 Ø¨Ø´Ø§Ø±", fr: "08 BÃ©char"}, {ar: "09 Ø§Ù„Ø¨Ù„ÙŠØ¯Ø©", fr: "09 Blida"},
            {ar: "10 Ø§Ù„Ø¨ÙˆÙŠØ±Ø©", fr: "10 Bouira"}, {ar: "11 ØªÙ…Ù†Ø±Ø§Ø³Øª", fr: "11 Tamanrasset"}, {ar: "12 ØªØ¨Ø³Ø©", fr: "12 TÃ©bessa"},
            {ar: "13 ØªÙ„Ù…Ø³Ø§Ù†", fr: "13 Tlemcen"}, {ar: "14 ØªÙŠØ§Ø±Øª", fr: "14 Tiaret"}, {ar: "15 ØªÙŠØ²ÙŠ ÙˆØ²Ùˆ", fr: "15 Tizi Ouzou"},
            {ar: "16 Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±", fr: "16 Alger"}, {ar: "17 Ø§Ù„Ø¬Ù„ÙØ©", fr: "17 Djelfa"}, {ar: "18 Ø¬ÙŠØ¬Ù„", fr: "18 Jijel"},
            {ar: "19 Ø³Ø·ÙŠÙ", fr: "19 SÃ©tif"}, {ar: "20 Ø³Ø¹ÙŠØ¯Ø©", fr: "20 SaÃ¯da"}, {ar: "21 Ø³ÙƒÙŠÙƒØ¯Ø©", fr: "21 Skikda"},
            {ar: "22 Ø³ÙŠØ¯ÙŠ Ø¨Ù„Ø¹Ø¨Ø§Ø³", fr: "22 Sidi Bel AbbÃ¨s"}, {ar: "23 Ø¹Ù†Ø§Ø¨Ø©", fr: "23 Annaba"}, {ar: "24 Ù‚Ø§Ù„Ù…Ø©", fr: "24 Guelma"},
            {ar: "25 Ù‚Ø³Ù†Ø·ÙŠÙ†Ø©", fr: "25 Constantine"}, {ar: "26 Ø§Ù„Ù…Ø¯ÙŠØ©", fr: "26 MÃ©dÃ©a"}, {ar: "27 Ù…Ø³ØªØºØ§Ù†Ù…", fr: "27 Mostaganem"},
            {ar: "28 Ø§Ù„Ù…Ø³ÙŠÙ„Ø©", fr: "28 M'Sila"}, {ar: "29 Ù…Ø¹Ø³ÙƒØ±", fr: "29 Mascara"}, {ar: "30 ÙˆØ±Ù‚Ù„Ø©", fr: "30 Ouargla"},
            {ar: "31 ÙˆÙ‡Ø±Ø§Ù†", fr: "31 Oran"}, {ar: "32 Ø§Ù„Ø¨ÙŠØ¶", fr: "32 El Bayadh"}, {ar: "33 Ø¥Ù„ÙŠØ²ÙŠ", fr: "33 Illizi"},
            {ar: "34 Ø¨Ø±Ø¬ Ø¨ÙˆØ¹Ø±ÙŠØ±ÙŠØ¬", fr: "34 Bordj Bou ArrÃ©ridj"}, {ar: "35 Ø¨ÙˆÙ…Ø±Ø¯Ø§Ø³", fr: "35 BoumerdÃ¨s"}, {ar: "36 Ø§Ù„Ø·Ø§Ø±Ù", fr: "36 El Tarf"},
            {ar: "37 ØªÙ†Ø¯ÙˆÙ", fr: "37 Tindouf"}, {ar: "38 ØªÙŠØ³Ù…Ø³ÙŠÙ„Øª", fr: "38 Tissemsilt"}, {ar: "39 Ø§Ù„ÙˆØ§Ø¯ÙŠ", fr: "39 El Oued"},
            {ar: "40 Ø®Ù†Ø´Ù„Ø©", fr: "40 Khenchela"}, {ar: "41 Ø³ÙˆÙ‚ Ø£Ù‡Ø±Ø§Ø³", fr: "41 Souk Ahras"}, {ar: "42 ØªÙŠØ¨Ø§Ø²Ø©", fr: "42 Tipaza"},
            {ar: "43 Ù…ÙŠÙ„Ø©", fr: "43 Mila"}, {ar: "44 Ø¹ÙŠÙ† Ø§Ù„Ø¯ÙÙ„Ù‰", fr: "44 AÃ¯n Defla"}, {ar: "45 Ø§Ù„Ù†Ø¹Ø§Ù…Ø©", fr: "45 NaÃ¢ma"},
            {ar: "46 Ø¹ÙŠÙ† ØªÙ…ÙˆØ´Ù†Øª", fr: "46 AÃ¯n TÃ©mouchent"}, {ar: "47 ØºØ±Ø¯Ø§ÙŠØ©", fr: "47 GhardaÃ¯a"}, {ar: "48 ØºÙ„ÙŠØ²Ø§Ù†", fr: "48 Relizane"},
            {ar: "49 ØªÙŠÙ…ÙŠÙ…ÙˆÙ†", fr: "49 Timimoun"}, {ar: "50 Ø¨Ø±Ø¬ Ø¨Ø§Ø¬ÙŠ Ù…Ø®ØªØ§Ø±", fr: "50 Bordj Badji Mokhtar"}, {ar: "51 Ø£ÙˆÙ„Ø§Ø¯ Ø¬Ù„Ø§Ù„", fr: "51 Ouled Djellal"},
            {ar: "52 Ø¨Ù†ÙŠ Ø¹Ø¨Ø§Ø³", fr: "52 BÃ©ni AbbÃ¨s"}, {ar: "53 Ø¹ÙŠÙ† ØµØ§Ù„Ø­", fr: "53 In Salah"}, {ar: "54 Ø¹ÙŠÙ† Ù‚Ø²Ø§Ù…", fr: "54 In Guezzam"},
            {ar: "55 ØªÙ‚Ø±Øª", fr: "55 Touggourt"}, {ar: "56 Ø¬Ø§Ù†Øª", fr: "56 Djanet"}, {ar: "57 Ø§Ù„Ù…ØºÙŠØ±", fr: "57 El M'Ghair"},
            {ar: "58 Ø§Ù„Ù…Ù†ÙŠØ¹Ø©", fr: "58 El Meniaa"}
        ];

        const dict = {
            ar: { home: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", login: "Ø¯Ø®ÙˆÙ„", register: "Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯", logout: "Ø®Ø±ÙˆØ¬", heroTitle: "Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„Ùƒ Ø¨Ø£Ù…Ø§Ù†", heroSub: "Ù†Ø±Ø¨Ø·Ùƒ Ø¨Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ø±Ø§ÙÙ‚ÙŠÙ†.", startNow: "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†", parent: "ÙˆÙ„ÙŠ Ø·ÙÙ„", companion: "Ù…Ø±Ø§ÙÙ‚", registerBtn: "ØªØ³Ø¬ÙŠÙ„", loginBtn: "Ø¯Ø®ÙˆÙ„", welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹", search: "Ø¨Ø­Ø«", myReqs: "Ø·Ù„Ø¨Ø§ØªÙŠ", new: "Ø¬Ø¯ÙŠØ¯Ø©", accepted: "Ù…Ù‚Ø¨ÙˆÙ„Ø©", canceled: "Ù…Ù„ØºÙŠØ©", results: "Ø§Ù„Ù†ØªØ§Ø¦Ø¬", dashComp: "Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø±Ø§ÙÙ‚", available: "Ù…ØªØ§Ø­", unavailable: "ØºÙŠØ± Ù…ØªØ§Ø­", incomingReq: "Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©", notifTitle: "Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª", bookTitle: "Ø­Ø¬Ø²", confirm: "ØªØ£ÙƒÙŠØ¯", spec1: "Ù…Ø±Ø§ÙÙ‚Ø© Ø·ÙÙ„ Ø§Ù„ØªÙˆØ­Ø¯", spec2: "Ø£Ø®ØµØ§Ø¦ÙŠ Ù†ÙØ³Ø§Ù†ÙŠ", profile: "Ø¨Ø±ÙˆÙØ§ÙŠÙ„", total: "Ø§Ù„ÙƒÙ„", pending: "Ø§Ù†ØªØ¸Ø§Ø±", about:"Ù…Ù† Ù†Ø­Ù†", privacy:"Ø§Ù„Ø®ØµÙˆØµÙŠØ©", contact:"Ø§ØªØµÙ„ Ø¨Ù†Ø§", report:"Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø´ÙƒÙ„Ø©", location:"Ù…ÙˆÙ‚Ø¹Ù†Ø§" },
            fr: { home: "Accueil", login: "Connexion", register: "Inscription", logout: "DÃ©connexion", heroTitle: "Accompagner votre enfant", heroSub: "Nous vous connectons aux meilleurs.", startNow: "Commencer", parent: "Parent", companion: "Accompagnateur", registerBtn: "S'inscrire", loginBtn: "Connexion", welcome: "Bienvenue", search: "Chercher", myReqs: "Mes demandes", new: "Nouveau", accepted: "AcceptÃ©", canceled: "AnnulÃ©", results: "RÃ©sultats", dashComp: "Tableau de bord", available: "Disponible", unavailable: "Indisponible", incomingReq: "Demandes reÃ§ues", notifTitle: "Notifications", bookTitle: "RÃ©server", confirm: "Confirmer", spec1: "Accompagnateur Autiste", spec2: "Psychologue", profile: "Profil", total: "Total", pending: "En attente", about:"Ã€ propos", privacy:"ConfidentialitÃ©", contact:"Contactez-nous", report:"Signaler un problÃ¨me", location:"Notre site" }
        };

        // --- Core Functions ---
        function populateSelects() {
            const list = wilayas.map(w => `<option value="${w.ar}">${currentLang==='ar'?w.ar:w.fr}</option>`).join('');
            ['regWilaya', 'searchWilaya', 'edWilaya'].forEach(id => { 
                const el = document.getElementById(id);
                if(el) { el.innerHTML = list; }
            });
        }
        
        function renderCustomSelects() {
            document.querySelectorAll('.custom-select').forEach(el => el.remove()); // Reset first
            document.querySelectorAll('select').forEach(select => {
                const wrapper = document.createElement('div'); wrapper.classList.add('custom-select');
                const trigger = document.createElement('div'); trigger.classList.add('custom-select-trigger');
                trigger.innerHTML = `<span>${select.options[select.selectedIndex]?.text || 'Select'}</span> <i class="fas fa-chevron-down"></i>`;
                const options = document.createElement('div'); options.classList.add('custom-options');
                Array.from(select.options).forEach(opt => {
                    const div = document.createElement('div'); div.classList.add('custom-option');
                    div.textContent = opt.text;
                    div.addEventListener('click', () => {
                        select.value = opt.value; trigger.querySelector('span').textContent = opt.text;
                        wrapper.classList.remove('open'); select.dispatchEvent(new Event('change'));
                    });
                    options.appendChild(div);
                });
                trigger.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.custom-select').forEach(s => s!==wrapper && s.classList.remove('open')); wrapper.classList.toggle('open'); });
                wrapper.appendChild(trigger); wrapper.appendChild(options); select.parentNode.insertBefore(wrapper, select.nextSibling);
            });
        }

        // Global Click to Close
        window.addEventListener('click', () => {
            document.querySelectorAll('.custom-select').forEach(s => s.classList.remove('open'));
            document.querySelectorAll('.modal-overlay').forEach(m => {
                m.addEventListener('click', (e) => { if(e.target === m) m.classList.remove('open'); });
            });
        });

        populateSelects(); setTimeout(renderCustomSelects, 500);

        window.switchLang = () => {
            currentLang = currentLang === 'ar' ? 'fr' : 'ar';
            document.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = dict[currentLang][el.getAttribute('data-i18n')]);
            populateSelects(); setTimeout(renderCustomSelects, 100);
        };

        window.navigateTo = (id) => {
            document.querySelectorAll('.app-section').forEach(el => el.classList.remove('active'));
            if(id === 'heroSection') { document.getElementById(id).classList.remove('hidden'); document.getElementById(id).classList.add('active'); }
            else { document.getElementById('heroSection').classList.add('hidden'); setTimeout(()=>document.getElementById(id).classList.add('active'),50); }
        };

        window.setRole = (r) => {
            selectedRole = r;
            const p = document.getElementById('btnRoleParent'), c = document.getElementById('btnRoleComp');
            if(r === 'parent') { p.style.background='var(--primary)'; p.style.color='white'; c.style.background='transparent'; c.style.color='#333'; document.getElementById('compFields').style.display='none'; }
            else { c.style.background='var(--primary)'; c.style.color='white'; p.style.background='transparent'; p.style.color='#333'; document.getElementById('compFields').style.display='block'; }
        };

        window.closeModal = (id) => document.getElementById(id).classList.remove('open');
        window.openProfile = () => {
            document.getElementById('edName').value = currentUser.fullName;
            document.getElementById('edPhone').value = currentUser.phone;
            if(currentUser.photoURL) document.getElementById('profImgPreview').src = currentUser.photoURL;
            document.getElementById('profileModal').classList.add('open');
        };
        window.previewImg = (input) => { if(input.files[0]) { const r = new FileReader(); r.onload = (e) => document.getElementById('profImgPreview').src = e.target.result; r.readAsDataURL(input.files[0]); } };

        // --- Auth ---
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                document.getElementById('guestLinks').style.display='none';
                document.getElementById('userLinks').style.display='flex';
                document.getElementById('notifBtn').style.display='block';
                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists()) {
                    currentUser = snap.data();
                    if(currentUser.isBlocked) { await signOut(auth); Swal.fire('Error','Blocked','error'); return; }
                    
                    if(currentUser.role === 'admin') { navigateTo('adminDash'); loadAdminData(); }
                    else if(currentUser.role === 'parent') { document.getElementById('pName').innerText = currentUser.fullName; navigateTo('parentDash'); loadParentReqs(); }
                    else { 
                        document.getElementById('cName').innerText = currentUser.fullName; 
                        document.getElementById('availToggle').checked = currentUser.isAvailable;
                        navigateTo('companionDash'); loadCompReqs(); 
                    }
                    loadNotifications();
                }
            } else {
                document.getElementById('guestLinks').style.display='flex'; document.getElementById('userLinks').style.display='none'; document.getElementById('notifBtn').style.display='none'; navigateTo('heroSection');
            }
        });

        window.handleRegister = async () => {
            const email = document.getElementById('regEmail').value, pass = document.getElementById('regPass').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const data = {
                    uid: cred.user.uid, fullName: document.getElementById('regName').value, email: email, phone: document.getElementById('regPhone').value, wilaya: document.getElementById('regWilaya').value, role: selectedRole, password_stored: pass, isBlocked: false, photoURL: '', createdAt: serverTimestamp()
                };
                if(selectedRole==='companion') { data.specialty = document.getElementById('regSpec').value; data.isAvailable=true; }
                await setDoc(doc(db, "users", cred.user.uid), data);
                Swal.fire('Success', 'Registered', 'success');
            } catch(e) { Swal.fire('Error', e.message, 'error'); }
        };

        window.handleLogin = async () => {
            const e = document.getElementById('loginEmail').value, p = document.getElementById('loginPass').value;
            if(e === 'admin' && p === 'abobob123') { currentUser = { role:'admin', fullName:'Admin' }; document.getElementById('guestLinks').style.display='none'; document.getElementById('userLinks').style.display='flex'; navigateTo('adminDash'); loadAdminData(); return; }
            try { await signInWithEmailAndPassword(auth, e, p); } catch(err) { Swal.fire('Error','Invalid','error'); }
        };
        window.logout = () => signOut(auth).then(()=>location.reload());
        window.saveProfile = async () => { const upd = { fullName: document.getElementById('edName').value, phone: document.getElementById('edPhone').value, wilaya: document.getElementById('edWilaya').value }; await updateDoc(doc(db,"users",currentUser.uid), upd); closeModal('profileModal'); Swal.fire('Updated'); };

        // --- Parent ---
        window.searchCompanions = async () => {
            const spec = document.getElementById('searchSpec').value, wilaya = document.getElementById('searchWilaya').value;
            const resDiv = document.getElementById('searchResults'); resDiv.innerHTML = 'Loading...';
            const snap = await getDocs(query(collection(db, "users"), where("role","==","companion")));
            let html = '';
            snap.forEach(d => {
                const u = d.data();
                if(u.isAvailable && u.specialty === spec) {
                    if(wilaya !== wilayas[0].ar && u.wilaya !== wilaya) return;
                    html += `<div class="req-card" style="align-items:center;">
                        <img src="${u.photoURL||'https://via.placeholder.com/60'}" style="width:60px; height:60px; border-radius:50%; object-fit:cover;">
                        <h4 style="margin:5px 0;">${u.fullName}</h4><span style="color:var(--secondary); font-size:0.9rem;">${u.specialty}</span>
                        <p style="font-size:0.8rem; color:#666;">ğŸ“ ${u.wilaya}</p>
                        <button class="full-btn" style="margin-top:10px; padding:8px;" onclick="openBook('${u.uid}')">Ø­Ø¬Ø²</button>
                    </div>`;
                }
            });
            resDiv.innerHTML = html || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        };

        window.openBook = (id) => { document.getElementById('bkCompId').value=id; document.getElementById('bookingModal').classList.add('open'); };
        window.submitBooking = async () => {
            const data = {
                parentId: currentUser.uid, parentName: currentUser.fullName, parentPhone: currentUser.phone,
                companionId: document.getElementById('bkCompId').value, childName: document.getElementById('bkChild').value,
                childDetails: `${document.getElementById('bkAge').value} Ø³Ù†Ø©`, reqType: document.getElementById('bkType').value,
                status: 'pending', timestamp: serverTimestamp()
            };
            await addDoc(collection(db, "requests"), data);
            await addDoc(collection(db, "notifications"), { targetId: data.companionId, msg: `Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯`, read:false, timestamp: serverTimestamp() });
            closeModal('bookingModal'); Swal.fire('Sent'); loadParentReqs();
        };

        async function loadParentReqs() {
            const snap = await getDocs(query(collection(db,"requests"), where("parentId","==",currentUser.uid), orderBy('timestamp','desc')));
            let html = '', total=0, acc=0, rej=0, pend=0;
            snap.forEach(d => {
                const r = d.data(); total++;
                if(r.status==='accepted') acc++; else if(r.status==='rejected') rej++; else pend++;
                const stText = r.status==='accepted'?'Ù…Ù‚Ø¨ÙˆÙ„':r.status==='rejected'?'Ù…Ù„ØºÙŠ':'Ø§Ù†ØªØ¸Ø§Ø±';
                let rateBtn = (r.status === 'accepted' && !r.rating) ? `<button class="full-btn" style="margin-top:5px; background:gold; color:black;" onclick="openRate('${d.id}')">ØªÙ‚ÙŠÙŠÙ…</button>` : '';
                if(r.rating) rateBtn = `<div style="color:gold;">ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…: ${r.rating} â˜…</div>`;

                html += `<div class="req-card ${r.status}">
                    <div style="display:flex; justify-content:space-between;"><strong>${r.childName}</strong> <span>${stText}</span></div>
                    <div style="font-size:0.8rem; color:#888;">${r.timestamp?.toDate().toLocaleString('ar')}</div>
                    ${r.status==='accepted'?`<div style="color:green;">ğŸ“ ${r.parentPhone}</div>`:''}
                    ${rateBtn}
                </div>`;
            });
            document.getElementById('parentReqs').innerHTML = html;
            document.getElementById('pTotal').innerText=total; document.getElementById('pAccepted').innerText=acc; document.getElementById('pRejected').innerText=rej; document.getElementById('pPending').innerText=pend;
        }

        window.openRate = (id) => { document.getElementById('rateReqId').value=id; document.getElementById('rateModal').classList.add('open'); };
        window.setRate = (n) => document.getElementById('starValue').value = n;
        window.submitRating = async () => {
            await updateDoc(doc(db, "requests", document.getElementById('rateReqId').value), { rating: document.getElementById('starValue').value, review: document.getElementById('rateReview').value });
            closeModal('rateModal'); Swal.fire('Ø´ÙƒØ±Ø§Ù‹'); loadParentReqs();
        };

        // --- Companion ---
        window.toggleAvail = async () => { if(currentUser) await updateDoc(doc(db,"users",currentUser.uid),{isAvailable:document.getElementById('availToggle').checked}); };
        async function loadCompReqs() {
            const snap = await getDocs(query(collection(db,"requests"), where("companionId","==",currentUser.uid), orderBy('timestamp','desc')));
            let html = '', t=0, a=0, p=0, r=0;
            snap.forEach(d => {
                const r = d.data(); t++; if(r.status==='accepted') a++; else if(r.status==='pending') p++; else r++;
                const acts = r.status==='pending' ? `<button class="btn-green" style="background:#10b981; color:white; padding:5px 10px; border-radius:5px;" onclick="ansReq('${d.id}','accepted','${r.parentId}')">Ù‚Ø¨ÙˆÙ„</button><button class="btn-red" style="background:#ef4444; color:white; padding:5px 10px; border-radius:5px;" onclick="ansReq('${d.id}','rejected','${r.parentId}')">Ø±ÙØ¶</button>` : `<b>${r.status}</b>`;
                html += `<div class="req-card ${r.status}"><div><strong>Ù…Ù†: ${r.parentName}</strong></div><div style="background:#f9f9f9; padding:5px;">${r.childName}<br>${r.childDetails}</div><div style="margin-top:5px;">${acts}</div>${r.status==='accepted'?`<div style="color:green;">ğŸ“ ${r.parentPhone}</div>`:''}</div>`;
            });
            document.getElementById('compReqs').innerHTML = html;
            document.getElementById('stTotal').innerText=t; document.getElementById('stAccepted').innerText=a; document.getElementById('stRejected').innerText=r;
        }
        window.ansReq = async (rid, st, pid) => { await updateDoc(doc(db,"requests",rid),{status:st}); await addDoc(collection(db,"notifications"),{targetId:pid, msg:`Ø·Ù„Ø¨Ùƒ ${st==='accepted'?'Ù…Ù‚Ø¨ÙˆÙ„':'Ù…Ø±ÙÙˆØ¶'}`, read:false, timestamp:serverTimestamp()}); loadCompReqs(); };

        // --- Admin ---
        window.loadAdminData = async () => {
            const uSnap = await getDocs(collection(db, "users"));
            const rSnap = await getDocs(collection(db, "requests"));
            const mSnap = await getDocs(collection(db, "messages"));
            document.getElementById('adUsersCount').innerText = uSnap.size; document.getElementById('adReqsCount').innerText = rSnap.size; document.getElementById('adMsgsCount').innerText = mSnap.size;
            let logs='', msgs='', usersHtml='';
            rSnap.forEach(d => { if(d.data().status==='accepted') logs+=`<div style="padding:10px; border-bottom:1px solid #eee;">Ù‚Ø¨ÙˆÙ„: ${d.data().childName}</div>`; });
            document.getElementById('logsList').innerHTML = logs;
            mSnap.forEach(d => msgs+=`<div style="padding:10px; border-bottom:1px solid #eee;">${d.data().msg} <br> <small>${d.data().email}</small></div>`);
            document.getElementById('reportsList').innerHTML = msgs;
            uSnap.forEach(d => { const u=d.data(); usersHtml+=`<tr><td>${u.fullName}</td><td>${u.role}</td><td>${u.password_stored||'***'}</td><td>${u.isBlocked?'Blocked':'Active'}</td><td><button onclick="toggleBlock('${d.id}',${u.isBlocked})">Action</button></td></tr>`; });
            document.getElementById('usersTable').innerHTML = usersHtml;
        };
        window.toggleBlock = async(id,s) => { await updateDoc(doc(db,"users",id),{isBlocked:!s}); loadAdminData(); };
        window.sendAdminNotif = async () => {
            const t=document.getElementById('notifTarget').value, m=document.getElementById('notifMsg').value;
            if(!m) return;
            let q=collection(db,"users"); if(t!=='all') q=query(q,where("role","==",t));
            const s=await getDocs(q); s.forEach(u=>addDoc(collection(db,"notifications"),{targetId:u.id, msg:`ÙØ±ÙŠÙ‚ Ù…Ø±Ø§ÙÙ‚: ${m}`, read:false, timestamp:serverTimestamp()}));
            Swal.fire('Sent');
        };

        // --- Utils ---
        window.openModal = (id, type) => { 
            if(id==='infoModal') { const t=document.getElementById('infoTitle'),c=document.getElementById('infoContent'); if(type==='about') {t.innerText='Ù…Ù† Ù†Ø­Ù†';c.innerText='Ù…Ù†ØµØ© Ø¬Ø²Ø§Ø¦Ø±ÙŠØ©...';} if(type==='privacy') {t.innerText='Ø§Ù„Ø®ØµÙˆØµÙŠØ©';c.innerText='Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¢Ù…Ù†Ø©...';} }
            document.getElementById(id).classList.add('open'); 
        };
        window.openContact = (t) => { document.getElementById('contactTitle').innerText = t==='report'?'Ø¥Ø¨Ù„Ø§Øº':'Ø§ØªØµÙ„'; document.getElementById('contactType').value=t; document.getElementById('contactModal').classList.add('open'); };
        window.sendContact = async () => { await addDoc(collection(db,"messages"),{name:document.getElementById('cntName').value, email:document.getElementById('cntEmail').value, msg:document.getElementById('cntMsg').value, type:document.getElementById('contactType').value, timestamp:serverTimestamp()}); closeModal('contactModal'); Swal.fire('Sent'); };
        window.openNotif = () => { document.getElementById('notifModal').classList.add('open'); document.getElementById('notifBadge').style.display='none'; };
        async function loadNotifications() {
            const snap = await getDocs(query(collection(db,"notifications"), where("targetId","==",currentUser.uid), orderBy('timestamp','desc')));
            let h='', c=0; snap.forEach(d=>{ if(!d.data().read) c++; h+=`<div style="padding:10px; border-bottom:1px solid #eee;">${d.data().msg}<br><small>${d.data().timestamp?.toDate().toLocaleString()}</small></div>`; });
            document.getElementById('notifList').innerHTML = h; if(c>0) { const b=document.getElementById('notifBadge'); b.style.display='flex'; b.innerText=c; }
        }

    </script>
</body>
</html>
