<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مرافق | Morafik - مرافقة طفلك بأمان</title>
    
    <!-- الخطوط والأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- مكتبة التنبيهات -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        /* --- المتغيرات والتأسيس --- */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-bg: #f8f9fa;
            --glass: rgba(255, 255, 255, 0.95);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Tajawal', sans-serif; outline: none; }
        
        body { 
            background-color: var(--light-bg); 
            color: #333; 
            overflow-x: hidden; 
            min-height: 100vh; 
        }

        /* --- الخلفية الثابتة مع حركة الزوم --- */
        .fixed-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            /* صورة الأخصائية النفسية المبتسمة */
            background: url('https://images.unsplash.com/photo-1573496359142-b8d87734a5a2?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') center/cover no-repeat;
            z-index: -10;
            animation: bgZoom 20s infinite alternate; /* حركة الزوم */
        }

        @keyframes bgZoom {
            0% { transform: scale(1); }
            100% { transform: scale(1.15); }
        }

        .bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); /* تعتيم الخلفية لإبراز النص */
            z-index: -9;
        }

        /* --- الهيدر (القائمة العلوية) --- */
        header { 
            background: rgba(255, 255, 255, 0.95); 
            backdrop-filter: blur(10px); 
            padding: 15px 5%; 
            display: flex; justify-content: space-between; align-items: center; 
            position: fixed; width: 100%; top: 0; z-index: 2000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .logo { font-size: 22px; font-weight: 900; color: var(--secondary-color); display: flex; align-items: center; gap: 8px; }
        .nav-links { display: flex; gap: 15px; align-items: center; }
        .nav-links button { background: none; border: none; font-size: 16px; font-weight: 600; cursor: pointer; color: #333; transition: 0.3s; }
        .nav-links button:hover { color: var(--secondary-color); }
        .lang-btn { border: 2px solid var(--secondary-color) !important; border-radius: 20px; padding: 4px 15px; font-size: 14px; }

        /* --- الصفحة الرئيسية (Hero) --- */
        .hero-section {
            height: 100vh;
            width: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            padding: 0 20px;
            padding-top: 80px; /* مسافة علوية لمنع النص من الاختفاء خلف الهيدر */
            position: relative;
            z-index: 1;
            transition: opacity 0.5s ease;
        }

        .big-title {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 20px;
            text-shadow: 0 4px 15px rgba(0,0,0,0.6);
            line-height: 1.2;
        }

        .hero-sub {
            font-size: 1.4rem;
            opacity: 0.95;
            max-width: 600px;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .btn-hero {
            padding: 15px 60px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 20px rgba(52, 152, 219, 0.4);
            transition: transform 0.3s;
        }
        .btn-hero:hover { transform: scale(1.05); background: #2980b9; }

        /* تعديلات للموبايل */
        @media (max-width: 768px) {
            .big-title { font-size: 2.2rem; }
            .hero-sub { font-size: 1.1rem; }
            .hero-section { padding-top: 100px; justify-content: flex-start; } /* رفع المحتوى قليلاً */
        }

        /* --- حاوية الصفحات المنبثقة (Sweep Up) --- */
        .page-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #f8f9fa;
            z-index: 1500; /* فوق الهيرو */
            display: flex;
            justify-content: center;
            align-items: center; /* توسيط عمودي */
            padding-top: 80px;
            padding-bottom: 20px;
            
            /* إعدادات الحركة */
            transform: translateY(100%); /* مخفية في الأسفل */
            transition: transform 0.6s cubic-bezier(0.7, 0, 0.3, 1);
            overflow-y: auto;
        }

        /* الكلاس الذي يفعل ظهور الصفحة */
        .page-container.active {
            transform: translateY(0);
        }

        /* --- تصميم النماذج (Forms) --- */
        .form-box {
            width: 100%;
            max-width: 450px;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
            margin: auto; /* لضمان التوسيط */
        }

        .form-box h2 { margin-bottom: 25px; color: var(--primary-color); }

        input, select {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 12px;
            background: #fff;
            font-size: 1rem;
        }
        
        .role-switch {
            display: flex;
            background: #f0f2f5;
            padding: 5px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .role-switch button {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 10px;
            font-weight: bold;
            color: #666;
            transition: 0.3s;
        }
        .role-switch button.active {
            background: white;
            color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
        }

        /* --- تنسيقات لوحة التحكم --- */
        .dashboard-content {
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }
        .req-card {
            background: white;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            border-right: 5px solid var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* Loader */
        #loadingScreen { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top-color: var(--secondary-color); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- الخلفية الثابتة -->
    <div class="fixed-bg"></div>
    <div class="bg-overlay"></div>
    
    <!-- شاشة التحميل -->
    <div id="loadingScreen"><div class="spinner"></div></div>

    <!-- الهيدر -->
    <header>
        <div class="logo">
            <i class="fas fa-hands-helping"></i> 
            <span>مرافق | Morafik</span>
        </div>
        <div class="nav-links">
            <button class="lang-btn" onclick="alert('تغيير اللغة قريباً')">FR / AR</button>
            
            <!-- روابط الزوار -->
            <div id="guestNav">
                <button onclick="goHome()">الرئيسية</button>
                <button onclick="openPage('loginSection')">دخول</button>
            </div>

            <!-- روابط المستخدم المسجل -->
            <div id="userNav" style="display:none;">
                <button onclick="logout()" style="color: var(--accent-color);">خروج</button>
            </div>
        </div>
    </header>

    <!-- 1. الصفحة الرئيسية (Hero) -->
    <section id="heroSection" class="hero-section">
        <h1 class="big-title">مرافقة طفلك بأمان</h1>
        <p class="hero-sub">
            نربطك بأفضل المرافقين والأخصائيين النفسيين المؤهلين لضمان راحة وسلامة طفلك في المدرسة والحياة اليومية.
        </p>
        <button class="btn-hero" onclick="openPage('registerSection')">ابدأ الآن</button>
    </section>

    <!-- 2. صفحة التسجيل (منبثقة من الأسفل) -->
    <div id="registerSection" class="page-container">
        <div class="form-box">
            <h2>إنشاء حساب جديد</h2>
            
            <div class="role-switch">
                <button class="active" id="btnRoleParent" onclick="setRole('parent')">ولي أمر</button>
                <button id="btnRoleComp" onclick="setRole('companion')">مرافق</button>
            </div>

            <input type="text" id="regName" placeholder="الاسم الكامل">
            <input type="email" id="regEmail" placeholder="البريد الإلكتروني">
            <input type="tel" id="regPhone" placeholder="رقم الهاتف">
            
            <!-- سيتم ملء الولايات بالجافاسكربت -->
            <select id="regWilaya">
                <option value="" disabled selected>اختر الولاية</option>
            </select>

            <div id="compFields" style="display:none;">
                <select id="regSpec">
                    <option value="مرافق طفل التوحد">مرافق طفل التوحد</option>
                    <option value="أخصائي نفساني">أخصائي نفساني</option>
                </select>
                <div style="border: 2px dashed #ddd; padding: 15px; border-radius: 12px; margin-bottom: 15px; cursor: pointer;">
                    <label>ارفع الشهادة (PDF)</label>
                    <input type="file" id="regDoc" accept="application/pdf" style="margin-bottom:0; padding:5px;">
                </div>
            </div>

            <input type="password" id="regPass" placeholder="كلمة المرور">
            <input type="password" id="regConfPass" placeholder="تأكيد كلمة المرور">

            <button class="submit-btn" onclick="handleRegister()">تسجيل</button>
            
            <div style="margin-top: 20px; font-size: 0.9rem;">
                لديك حساب بالفعل؟ <a href="#" onclick="openPage('loginSection')" style="color:var(--secondary-color); font-weight:bold;">دخول</a>
            </div>
        </div>
    </div>

    <!-- 3. صفحة الدخول (منبثقة من الأسفل) -->
    <div id="loginSection" class="page-container">
        <div class="form-box">
            <h2>تسجيل الدخول</h2>
            <input type="text" id="loginEmail" placeholder="البريد الإلكتروني">
            <input type="password" id="loginPass" placeholder="كلمة المرور">
            <button class="submit-btn" onclick="handleLogin()">دخول</button>
            <div style="margin-top: 20px; font-size: 0.9rem;">
                ليس لديك حساب؟ <a href="#" onclick="openPage('registerSection')" style="color:var(--secondary-color); font-weight:bold;">إنشاء حساب</a>
            </div>
        </div>
    </div>

    <!-- 4. لوحات التحكم (Dashboards) -->
    
    <!-- لوحة الولي -->
    <div id="parentDash" class="page-container" style="align-items: flex-start;">
        <div class="dashboard-content">
            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05);">
                <h2 style="color: var(--primary-color);">مرحباً، <span id="pName"></span></h2>
                <p>ابحث عن المرافق المناسب لطفلك</p>
                <div style="display:flex; gap:10px; margin-top:15px; flex-wrap:wrap;">
                    <select id="searchSpec" style="margin:0; flex:1; min-width: 200px;">
                        <option value="مرافق طفل التوحد">مرافق طفل التوحد</option>
                        <option value="أخصائي نفساني">أخصائي نفساني</option>
                    </select>
                    <select id="searchWilaya" style="margin:0; flex:1; min-width: 200px;">
                        <option value="" disabled selected>الولاية</option>
                    </select>
                    <button class="submit-btn" style="width: auto; padding: 0 30px; margin:0;" onclick="searchCompanions()">بحث</button>
                </div>
            </div>
            <div id="searchResults"></div>
            <h3 style="margin: 20px 0;">طلباتي</h3>
            <div id="parentReqs"></div>
        </div>
    </div>

    <!-- لوحة المرافق -->
    <div id="companionDash" class="page-container" style="align-items: flex-start;">
        <div class="dashboard-content">
            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <h2 style="color: var(--primary-color);">لوحة المرافق</h2>
                <p>مرحباً، <span id="cName"></span></p>
                <div style="margin-top: 10px;">
                    <input type="checkbox" id="availToggle" onchange="toggleAvail()" style="width: auto; margin: 0;">
                    <label>متاح للعمل حالياً</label>
                </div>
            </div>
            <h3>الطلبات الواردة</h3>
            <div id="compReqs" style="margin-top: 15px;"></div>
        </div>
    </div>

    <!-- Javascript Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, getDocs, query, where, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // إعدادات الفايربيس
        const firebaseConfig = { apiKey: "AIzaSyC5dRvQZE1kMSsYojrMiyuQurnQwEleo3o", authDomain: "mourafik-e9161.firebaseapp.com", projectId: "mourafik-e9161", storageBucket: "mourafik-e9161.firebasestorage.app", messagingSenderId: "133465287328", appId: "1:133465287328:web:9de5b3bd709099d885b7c5", measurementId: "G-MDJXPZ7G5L" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // متغيرات عامة
        let selectedRole = 'parent';
        let currentUser = null;
        
        // قائمة الولايات
        const wilayas = ["01 Adrar","02 Chlef","03 Laghouat","04 Oum El Bouaghi","05 Batna","06 Béjaïa","07 Biskra","08 Béchar","09 Blida","10 Bouira","11 Tamanrasset","12 Tébessa","13 Tlemcen","14 Tiaret","15 Tizi Ouzou","16 Alger","17 Djelfa","18 Jijel","19 Sétif","20 Saïda","21 Skikda","22 Sidi Bel Abbès","23 Annaba","24 Guelma","25 Constantine","26 Médéa","27 Mostaganem","28 M'Sila","29 Mascara","30 Ouargla","31 Oran","32 El Bayadh","33 Illizi","34 Bordj Bou Arréridj","35 Boumerdès","36 El Tarf","37 Tindouf","38 Tissemsilt","39 El Oued","40 Khenchela","41 Souk Ahras","42 Tipaza","43 Mila","44 Aïn Defla","45 Naâma","46 Aïn Témouchent","47 Ghardaïa","48 Relizane","49 Timimoun","50 Bordj Badji Mokhtar","51 Ouled Djellal","52 Béni Abbès","53 In Salah","54 In Guezzam","55 Touggourt","56 Djanet","57 El M'Ghair","58 El Meniaa"];

        // --- دوال التهيئة ---
        function initSelects() {
            const opts = wilayas.map(w => `<option value="${w}">${w}</option>`).join('');
            if(document.getElementById('regWilaya')) document.getElementById('regWilaya').innerHTML += opts;
            if(document.getElementById('searchWilaya')) document.getElementById('searchWilaya').innerHTML += opts;
        }
        initSelects();

        // --- دوال التنقل والحركة (Core Navigation) ---
        
        // فتح صفحة (حركة Sweep Up)
        window.openPage = (pageId) => {
            // إغلاق أي صفحة مفتوحة حالياً
            document.querySelectorAll('.page-container').forEach(el => el.classList.remove('active'));
            
            // فتح الصفحة المطلوبة بعد تأخير بسيط
            setTimeout(() => {
                const target = document.getElementById(pageId);
                if(target) target.classList.add('active');
            }, 10);
        };

        // العودة للرئيسية
        window.goHome = () => {
            // إخفاء جميع الصفحات (تعود للأسفل)
            document.querySelectorAll('.page-container').forEach(el => el.classList.remove('active'));
        };

        // تبديل الدور (ولي / مرافق)
        window.setRole = (role) => {
            selectedRole = role;
            const isParent = role === 'parent';
            document.getElementById('btnRoleParent').className = isParent ? 'active' : '';
            document.getElementById('btnRoleComp').className = isParent ? '' : 'active';
            document.getElementById('compFields').style.display = isParent ? 'none' : 'block';
        };

        // --- منطق الفايربيس (Firebase Logic) ---

        // التسجيل
        window.handleRegister = async () => {
            const email = document.getElementById('regEmail').value;
            const pass = document.getElementById('regPass').value;
            const name = document.getElementById('regName').value;
            const phone = document.getElementById('regPhone').value;
            const wilaya = document.getElementById('regWilaya').value;

            if(!email || !pass || !name) return Swal.fire('تنبيه', 'يرجى ملء الحقول الأساسية', 'warning');

            try {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                const uid = cred.user.uid;
                
                const userData = {
                    uid: uid,
                    fullName: name,
                    email: email,
                    phone: phone,
                    wilaya: wilaya,
                    role: selectedRole,
                    createdAt: serverTimestamp()
                };

                if (selectedRole === 'companion') {
                    userData.specialty = document.getElementById('regSpec').value;
                    userData.isAvailable = true;
                }

                await setDoc(doc(db, "users", uid), userData);
                Swal.fire('نجاح', 'تم إنشاء الحساب بنجاح', 'success');
                
            } catch (err) {
                Swal.fire('خطأ', err.message, 'error');
            }
        };

        // الدخول
        window.handleLogin = async () => {
            const email = document.getElementById('loginEmail').value;
            const pass = document.getElementById('loginPass').value;
            
            try {
                await signInWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                Swal.fire('خطأ', 'بيانات الدخول غير صحيحة', 'error');
            }
        };

        // الخروج
        window.logout = () => signOut(auth).then(() => window.location.reload());

        // مراقب حالة المستخدم
        onAuthStateChanged(auth, async (user) => {
            document.getElementById('loadingScreen').style.display = 'none';
            
            if (user) {
                // مستخدم مسجل
                document.getElementById('guestNav').style.display = 'none';
                document.getElementById('userNav').style.display = 'block';
                
                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists()) {
                    currentUser = snap.data();
                    
                    // توجيه للوحة التحكم المناسبة
                    if(currentUser.role === 'parent') {
                        document.getElementById('pName').innerText = currentUser.fullName;
                        loadParentReqs();
                        openPage('parentDash');
                    } else if(currentUser.role === 'companion') {
                        document.getElementById('cName').innerText = currentUser.fullName;
                        loadCompReqs();
                        openPage('companionDash');
                    }
                }
            } else {
                // زائر
                document.getElementById('guestNav').style.display = 'block';
                document.getElementById('userNav').style.display = 'none';
                goHome();
            }
        });

        // --- وظائف لوحة التحكم ---

        // بحث الولي
        window.searchCompanions = async () => {
            const spec = document.getElementById('searchSpec').value;
            const wilaya = document.getElementById('searchWilaya').value;
            const resDiv = document.getElementById('searchResults');
            
            resDiv.innerHTML = '<p style="text-align:center; color:#666;">جاري البحث...</p>';
            
            const q = query(collection(db, "users"), 
                where("role", "==", "companion"), 
                where("specialty", "==", spec),
                where("wilaya", "==", wilaya)
            );
            
            const snap = await getDocs(q);
            if(snap.empty) {
                resDiv.innerHTML = '<p style="text-align:center; color:#999;">لا يوجد مرافقين متاحين في هذه المنطقة حالياً.</p>';
            } else {
                let html = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    html += `
                    <div class="req-card">
                        <div>
                            <strong>${d.fullName}</strong><br>
                            <span style="font-size:0.9rem; color:#666;">${d.specialty}</span>
                        </div>
                        <button class="submit-btn" style="width:auto; padding:8px 20px; font-size:0.9rem;" onclick="bookCompanion('${d.uid}')">حجز</button>
                    </div>`;
                });
                resDiv.innerHTML = html;
            }
        };

        // إرسال طلب حجز (يجب تعريفه في window ليعمل مع onclick في HTML)
        window.bookCompanion = async (compId) => {
            if(!currentUser) return;
            const { value: childName } = await Swal.fire({
                title: 'ادخل اسم الطفل',
                input: 'text',
                showCancelButton: true,
                confirmButtonText: 'إرسال الطلب',
                cancelButtonText: 'إلغاء'
            });

            if (childName) {
                await addDoc(collection(db, "requests"), {
                    parentId: currentUser.uid,
                    parentName: currentUser.fullName,
                    companionId: compId,
                    childName: childName,
                    status: 'pending',
                    timestamp: serverTimestamp()
                });
                Swal.fire('تم', 'تم إرسال طلب الحجز بنجاح', 'success');
                loadParentReqs();
            }
        };

        // تحميل طلبات الولي
        async function loadParentReqs() {
            const q = query(collection(db, "requests"), where("parentId", "==", currentUser.uid));
            const snap = await getDocs(q);
            let html = '';
            snap.forEach(doc => {
                const r = doc.data();
                let statusColor = r.status === 'pending' ? 'orange' : r.status === 'accepted' ? 'green' : 'red';
                let statusText = r.status === 'pending' ? 'قيد الانتظار' : r.status === 'accepted' ? 'تم القبول' : 'مرفوض';
                
                html += `
                <div class="req-card" style="border-right-color: ${statusColor};">
                    <div><strong>الطفل:</strong> ${r.childName}</div>
                    <div style="font-weight:bold; color:${statusColor}">${statusText}</div>
                </div>`;
            });
            document.getElementById('parentReqs').innerHTML = html || '<p style="text-align:center; color:#999">لا توجد طلبات</p>';
        }

        // تحميل طلبات المرافق
        async function loadCompReqs() {
            const q = query(collection(db, "requests"), where("companionId", "==", currentUser.uid));
            const snap = await getDocs(q);
            let html = '';
            snap.forEach(doc => {
                const r = doc.data();
                html += `
                <div class="req-card">
                    <div>
                        <strong>من:</strong> ${r.parentName}<br>
                        <strong>الطفل:</strong> ${r.childName}
                    </div>
                    <div>
                        ${r.status === 'pending' ? 
                        `<button onclick="updateReq('${doc.id}', 'accepted')" style="background:green; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; margin-left:5px;">قبول</button>
                         <button onclick="updateReq('${doc.id}', 'rejected')" style="background:red; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">رفض</button>` 
                        : `<span style="font-weight:bold">${r.status}</span>`}
                    </div>
                </div>`;
            });
            document.getElementById('compReqs').innerHTML = html || '<p style="text-align:center; color:#999">لا توجد طلبات واردة</p>';
        }

        window.updateReq = async (id, status) => {
            await updateDoc(doc(db, "requests", id), { status: status });
            loadCompReqs();
        };

        window.toggleAvail = async () => {
            if(!currentUser) return;
            const val = document.getElementById('availToggle').checked;
            await updateDoc(doc(db, "users", currentUser.uid), { isAvailable: val });
        };

    </script>
</body>
</html>
